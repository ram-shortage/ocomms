---
phase: 37-e2e-test-fixes
plan: 02
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - e2e/tests/security/mfa.spec.ts
  - e2e/tests/security/session.spec.ts
  - e2e/tests/security/headers.spec.ts
autonomous: true

must_haves:
  truths:
    - "MFA tests pass with demo-seed users"
    - "Session tests verify auth state correctly"
    - "Security header tests validate response headers"
  artifacts:
    - path: "e2e/tests/security/mfa.spec.ts"
      provides: "MFA E2E tests"
    - path: "e2e/tests/security/session.spec.ts"
      provides: "Session E2E tests"
    - path: "e2e/tests/security/headers.spec.ts"
      provides: "Security headers E2E tests"
---

<objective>
Fix security E2E tests (MFA, session, headers) to work with demo-seed data.

Purpose: Security tests verify critical security features (SEC2-*). These tests must pass to confirm the security implementation is working correctly.

Output: All 12 security tests passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/37-e2e-test-fixes/37-CONTEXT.md
@e2e/tests/security/mfa.spec.ts
@e2e/tests/security/session.spec.ts
@e2e/tests/security/headers.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix MFA Setup Flow Test</name>
  <files>
    e2e/tests/security/mfa.spec.ts
  </files>
  <action>
Fix `MFA setup flow shows QR code` test (line 21):

1. Read the test to understand expected flow
2. Identify failing selectors
3. Update to match actual MFA setup UI:
   - Settings navigation
   - Security tab/section
   - Enable MFA button
   - QR code display
   - TOTP input field

Common issues:
- Settings page navigation
- MFA enable button selector
- QR code image selector
  </action>
  <verify>
```bash
npm run test:e2e:demo -- --grep "MFA setup flow shows QR code"
```
  </verify>
  <done>
MFA setup test passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix MFA Verification Test</name>
  <files>
    e2e/tests/security/mfa.spec.ts
  </files>
  <action>
Fix `MFA verification with valid code` test (line 52):

This test likely needs:
1. A way to generate valid TOTP codes for testing
2. Mock or test TOTP secret
3. Proper input field selectors

If the test uses a fixed secret, ensure demo-seed users have it configured.
If generating codes dynamically, ensure the TOTP library is properly integrated.
  </action>
  <verify>
```bash
npm run test:e2e:demo -- --grep "MFA verification with valid code"
```
  </verify>
  <done>
MFA verification test passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix MFA Backup Codes Test</name>
  <files>
    e2e/tests/security/mfa.spec.ts
  </files>
  <action>
Fix `MFA backup codes can be used` test (line 95):

1. Ensure backup codes are properly displayed during setup
2. Verify backup code input works
3. Check backup code validation flow
  </action>
  <verify>
```bash
npm run test:e2e:demo -- --grep "MFA backup codes can be used"
```
  </verify>
  <done>
Backup codes test passes
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix MFA Disable Test</name>
  <files>
    e2e/tests/security/mfa.spec.ts
  </files>
  <action>
Fix `MFA can be disabled` test (line 131):

1. Navigate to security settings
2. Find and click disable MFA button
3. Confirm disabling (may require password or code)
4. Verify MFA is disabled
  </action>
  <verify>
```bash
npm run test:e2e:demo -- --grep "MFA can be disabled"
```
  </verify>
  <done>
MFA disable test passes
  </done>
</task>

<task type="auto">
  <name>Task 5: Fix Session Tests</name>
  <files>
    e2e/tests/security/session.spec.ts
  </files>
  <action>
Fix all session tests:

1. `session persists across page reload` (line 20):
   - Verify auth cookies persist after reload
   - Check user remains authenticated

2. `logout clears session` (line 36):
   - Find logout button/action
   - Verify redirect to login
   - Verify cookies cleared

3. `session revocation works` (line 56):
   - May need admin/API access to revoke
   - Verify revoked session can't access protected routes

4. `session expires after inactivity` (line 161 in mfa.spec.ts):
   - May need to mock time or use short timeout
   - Verify session expires correctly
  </action>
  <verify>
```bash
npm run test:e2e:demo -- --grep "session"
```
  </verify>
  <done>
All session tests pass
  </done>
</task>

<task type="auto">
  <name>Task 6: Fix Security Headers Tests</name>
  <files>
    e2e/tests/security/headers.spec.ts
  </files>
  <action>
Fix all security headers tests:

1. `CSP header is present and configured` (line 11):
   - Make API request and check response headers
   - Verify Content-Security-Policy header exists
   - Verify nonce-based configuration

2. `security headers are present` (line 35):
   - Check X-Frame-Options
   - Check X-Content-Type-Options
   - Check Strict-Transport-Security (if HTTPS)
   - Check other security headers

3. `no sensitive info in error messages` (line 64):
   - Trigger error responses
   - Verify no stack traces or sensitive data

4. `rate limiting works` (line 90):
   - Make multiple rapid requests
   - Verify 429 response after limit
   - Note: May interfere with other tests, run in isolation

For header tests, use page.request or fetch API:
```typescript
const response = await page.request.get('/api/some-endpoint');
expect(response.headers()['content-security-policy']).toContain('nonce-');
```
  </action>
  <verify>
```bash
npm run test:e2e:demo -- --grep "security headers"
```
  </verify>
  <done>
All security headers tests pass
  </done>
</task>

<task type="auto">
  <name>Task 7: Run All Security Tests</name>
  <files>
    e2e/tests/security/*.spec.ts
  </files>
  <action>
Run complete security test suite:

```bash
npm run test:e2e:demo -- e2e/tests/security/
```

Address any remaining failures and verify all 12 tests pass.
  </action>
  <verify>
All security tests (mfa, session, headers) pass
  </verify>
  <done>
Security test suite passes completely (12 tests)
  </done>
</task>

</tasks>

<verification>
MFA Tests:
- [ ] MFA setup flow shows QR code
- [ ] MFA verification with valid code
- [ ] MFA backup codes can be used
- [ ] MFA can be disabled
- [ ] session expires after inactivity

Session Tests:
- [ ] session persists across page reload
- [ ] logout clears session
- [ ] session revocation works

Headers Tests:
- [ ] CSP header is present and configured
- [ ] security headers are present
- [ ] no sensitive info in error messages
- [ ] rate limiting works
</verification>

<success_criteria>
- All 12 security E2E tests pass
- Tests don't interfere with each other (especially rate limit test)
- MFA tests work with demo-seed user data
</success_criteria>

<output>
After completion, create `.planning/phases/37-e2e-test-fixes/37-02-SUMMARY.md`
</output>
