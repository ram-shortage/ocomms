---
phase: 37-e2e-test-fixes
plan: 03
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - e2e/tests/workspace/discovery.spec.ts
  - e2e/tests/workspace/switcher.spec.ts
autonomous: true

must_haves:
  truths:
    - "Workspace discovery tests pass with 4 workspaces"
    - "Workspace switcher tests pass with multiple workspaces"
    - "Multi-user tests work with demo-seed users"
  artifacts:
    - path: "e2e/tests/workspace/discovery.spec.ts"
      provides: "Workspace discovery E2E tests"
    - path: "e2e/tests/workspace/switcher.spec.ts"
      provides: "Workspace switcher E2E tests"
---

<objective>
Fix workspace E2E tests (discovery, switcher) to work with demo-seed data.

Purpose: Workspace tests verify WKSP2-* requirements including browsing, joining, switching workspaces, and join request workflows.

Output: All 14 workspace tests passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/37-e2e-test-fixes/37-CONTEXT.md
@e2e/tests/workspace/discovery.spec.ts
@e2e/tests/workspace/switcher.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Workspace Discovery Tests</name>
  <files>
    e2e/tests/workspace/discovery.spec.ts
  </files>
  <action>
Fix all discovery tests (8 tests):

1. `user can browse available workspaces` (line 16):
   - Navigate to browse workspaces page
   - Verify workspace list displays
   - With demo-seed, should see 4 workspaces

2. `user can search workspaces` (line 61):
   - Enter search term in search input
   - Verify filtered results
   - Test with demo workspace names (Acme, TechStart, etc.)

3. `user can join open workspace` (line 89):
   - Find an open workspace Alice isn't in (if any)
   - Click join button
   - Verify joined successfully
   - Note: With demo-seed, Alice is in all 4 workspaces

4. `request to join locked workspace` (line 120):
   - Find locked workspace
   - Click request to join
   - Verify request sent UI

5. `workspace join request creates pending request` (line 147):
   - Submit join request
   - Verify pending state

6. `owner approves join request` (line 171):
   - Switch to owner account
   - Find pending request
   - Approve it
   - Verify user now has access

7. `multi-user: owner approves join request` (line 209):
   - Similar to above but tests multi-browser scenario
   - May need Playwright's browser contexts

8. `user joining open workspace appears in switcher` (line 245):
   - Join workspace
   - Open workspace switcher
   - Verify new workspace appears

Key demo-seed considerations:
- Alice and Bob are in all 4 workspaces
- May need to create test workspace or use different user
- Consider using Carol/David who may have different memberships
  </action>
  <verify>
```bash
npm run test:e2e:demo -- e2e/tests/workspace/discovery.spec.ts
```
  </verify>
  <done>
All discovery tests pass (8 tests)
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Workspace Switcher Tests</name>
  <files>
    e2e/tests/workspace/switcher.spec.ts
  </files>
  <action>
Fix all switcher tests (6 tests):

1. `user can see list of workspaces` (line 15):
   - Open workspace switcher
   - Verify all user's workspaces listed
   - Demo-seed: Alice has 4 workspaces

2. `user can switch workspaces` (line 36):
   - Open switcher
   - Click different workspace
   - Verify URL and content changes

3. `workspace switcher shows unread counts` (line 67):
   - Ensure workspace has unread messages
   - Open switcher
   - Verify unread count badge displays

4. `workspace switcher shows browse workspaces link` (line 87):
   - Open switcher
   - Verify "Browse Workspaces" link exists

5. `last visited workspace/channel is stored` (line 104):
   - Navigate to specific workspace/channel
   - Close/reopen app
   - Verify returns to last location

6. `switching workspace updates sidebar content` (line 128):
   - Switch workspace
   - Verify sidebar shows new workspace's channels

Switcher selector considerations:
- Find the switcher trigger button (usually workspace icon)
- Switcher dropdown/popover
- Workspace items in list
  </action>
  <verify>
```bash
npm run test:e2e:demo -- e2e/tests/workspace/switcher.spec.ts
```
  </verify>
  <done>
All switcher tests pass (6 tests)
  </done>
</task>

<task type="auto">
  <name>Task 3: Run All Workspace Tests</name>
  <files>
    e2e/tests/workspace/*.spec.ts
  </files>
  <action>
Run complete workspace test suite:

```bash
npm run test:e2e:demo -- e2e/tests/workspace/
```

Address any remaining failures and ensure all 14 tests pass.
  </action>
  <verify>
All workspace tests pass (14 total)
  </verify>
  <done>
Workspace test suite passes completely
  </done>
</task>

</tasks>

<verification>
Discovery Tests:
- [ ] user can browse available workspaces
- [ ] user can search workspaces
- [ ] user can join open workspace
- [ ] request to join locked workspace
- [ ] workspace join request creates pending request
- [ ] owner approves join request
- [ ] multi-user: owner approves join request
- [ ] user joining open workspace appears in switcher

Switcher Tests:
- [ ] user can see list of workspaces
- [ ] user can switch workspaces
- [ ] workspace switcher shows unread counts
- [ ] workspace switcher shows browse workspaces link
- [ ] last visited workspace/channel is stored
- [ ] switching workspace updates sidebar content
</verification>

<success_criteria>
- All 14 workspace E2E tests pass
- Tests work with demo-seed's 4 workspaces
- Multi-user tests properly simulate different users
</success_criteria>

<output>
After completion, create `.planning/phases/37-e2e-test-fixes/37-03-SUMMARY.md`
</output>
