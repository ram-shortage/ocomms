---
phase: 37-e2e-test-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/tests/regression/core-flows.spec.ts
  - e2e/pages/channel.page.ts
  - e2e/fixtures/test-fixtures.ts
autonomous: true

must_haves:
  truths:
    - "Core flow tests pass with demo-seed data"
    - "Selectors are specific and don't match multiple elements"
    - "Navigation waits ensure page is ready before assertions"
  artifacts:
    - path: "e2e/tests/regression/core-flows.spec.ts"
      provides: "Core regression tests"
      contains: "getBy"
---

<objective>
Fix core flow regression tests to work with demo-seed data.

Purpose: The core-flows.spec.ts tests are fundamental smoke tests that verify basic authentication, messaging, threads, reactions, and search. These must pass before other tests can be considered valid.

Output: All 5 core flow tests passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/37-e2e-test-fixes/37-CONTEXT.md
@e2e/tests/regression/core-flows.spec.ts
@e2e/pages/channel.page.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix "user can sign in and access workspace" Test</name>
  <files>
    e2e/tests/regression/core-flows.spec.ts
  </files>
  <action>
The test fails looking for `locator('nav')`. Fix by:

1. Check what element actually exists on the workspace page
2. Update the selector to match the actual sidebar/navigation element
3. Add appropriate wait for page load

Current failing assertion:
```typescript
await expect(page.locator('nav')).toBeVisible();
```

Likely fix - use the sidebar component that actually exists:
```typescript
await expect(page.locator('[data-testid="sidebar"]')).toBeVisible();
// Or find the actual sidebar element
await expect(page.locator('aside, [class*="sidebar"]').first()).toBeVisible();
```
  </action>
  <verify>
Test `user can sign in and access workspace` passes when run individually:
```bash
npm run test:e2e:demo -- --grep "user can sign in and access workspace"
```
  </verify>
  <done>
Authentication test passes with updated selector
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix "user can send and receive messages" Test</name>
  <files>
    e2e/tests/regression/core-flows.spec.ts
    e2e/pages/channel.page.ts
  </files>
  <action>
The test fails looking for channel header with `getByRole('heading', { level: 1 })`.

1. Check channel.page.ts `channelHeader` locator
2. Update to match actual DOM structure
3. Ensure navigation to channel completes before checking header

Current failing code in channel.page.ts:57:
```typescript
async expectChannelName(name: string) {
  await expect(this.channelHeader).toContainText(name);
}
```

Where `channelHeader` is likely:
```typescript
channelHeader = this.page.getByRole('heading', { level: 1 });
```

Fix by finding the actual channel name element in the UI.
  </action>
  <verify>
Test `user can send and receive messages` passes when run individually
  </verify>
  <done>
Messaging test passes with updated selectors
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix "user can create and reply to threads" Test</name>
  <files>
    e2e/tests/regression/core-flows.spec.ts
  </files>
  <action>
The test fails looking for `getByRole('list', { name: /messages/i })`.

1. Check if message list has an aria-label
2. Update selector to match actual message container
3. Ensure messages are loaded before interacting

Current failing assertion:
```typescript
const messageList = page.getByRole('list', { name: /messages/i });
await expect(messageList).toBeVisible();
```

Likely fix:
```typescript
// Wait for any message to appear
await page.locator('[data-message-id]').first().waitFor({ state: 'visible' });
// Or use the actual container
await page.locator('[class*="message-list"], [data-testid="messages"]').waitFor();
```
  </action>
  <verify>
Test `user can create and reply to threads` passes when run individually
  </verify>
  <done>
Thread test passes with updated selectors
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix "user can react to messages" Test</name>
  <files>
    e2e/tests/regression/core-flows.spec.ts
  </files>
  <action>
The test fails because `locator('[data-message-id]')` finds no elements.

1. Check actual message element structure in the UI
2. Update selector to match how messages are rendered
3. Add wait for messages to load after navigation

Current failing code:
```typescript
const message = page.locator('[data-message-id]').first();
await expect(message).toBeVisible();
```

Fix approach:
- First navigate to a channel with existing messages (demo-seed has messages)
- Wait for message list to load
- Find message using actual DOM structure
  </action>
  <verify>
Test `user can react to messages` passes when run individually
  </verify>
  <done>
Reaction test passes with updated selectors
  </done>
</task>

<task type="auto">
  <name>Task 5: Fix "user can send direct messages" Test</name>
  <files>
    e2e/tests/regression/core-flows.spec.ts
  </files>
  <action>
The test fails with strict mode violation - `getByRole('button', { name: /new message/i })` matches 2 elements.

1. Use more specific selector:
```typescript
// Use exact match
const newDmButton = page.getByRole('button', { name: 'New Message', exact: true });
// Or use first() if both buttons do the same thing
const newDmButton = page.getByRole('button', { name: /new message/i }).first();
```

2. Consider the context - if one button is in sidebar and one in header, use locator chaining:
```typescript
const sidebar = page.locator('[data-testid="sidebar"]');
const newDmButton = sidebar.getByRole('button', { name: /new message/i });
```
  </action>
  <verify>
Test `user can send direct messages` passes when run individually
  </verify>
  <done>
DM test passes with specific selector
  </done>
</task>

<task type="auto">
  <name>Task 6: Fix "user can search messages" Test</name>
  <files>
    e2e/tests/regression/core-flows.spec.ts
  </files>
  <action>
Analyze and fix the search test:

1. Identify failing selectors in the test
2. Update to match actual search UI components
3. Ensure search results load before assertions

Common issues:
- Search input selector
- Search results container selector
- Wait for search results to appear
  </action>
  <verify>
Test `user can search messages` passes when run individually
  </verify>
  <done>
Search test passes with updated selectors
  </done>
</task>

<task type="auto">
  <name>Task 7: Run All Core Flow Tests</name>
  <files>
    e2e/tests/regression/core-flows.spec.ts
  </files>
  <action>
Run the complete core-flows.spec.ts file to verify all fixes work together:

```bash
npm run test:e2e:demo -- --grep "core flows regression"
```

If any tests fail:
1. Debug the specific failure
2. Apply targeted fix
3. Re-run until all pass
  </action>
  <verify>
All tests in core-flows.spec.ts pass (6 tests)
  </verify>
  <done>
Core flow regression suite passes completely
  </done>
</task>

</tasks>

<verification>
- [ ] `user can sign in and access workspace` passes
- [ ] `user can send and receive messages` passes
- [ ] `user can create and reply to threads` passes
- [ ] `user can react to messages` passes
- [ ] `user can send direct messages` passes
- [ ] `user can search messages` passes
- [ ] All 6 core flow tests pass when run together
</verification>

<success_criteria>
- All core-flows.spec.ts tests pass with demo-seed data
- Selectors are robust and don't rely on unstable attributes
- No timing-based flakiness
</success_criteria>

<output>
After completion, create `.planning/phases/37-e2e-test-fixes/37-01-SUMMARY.md`
</output>
