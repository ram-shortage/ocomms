---
phase: 29-stabilization
plan: 06
type: execute
wave: 2
depends_on: []
files_modified:
  - src/lib/actions/user-group.ts
  - src/app/api/notes/personal/route.ts
  - src/app/api/channels/[channelId]/pins/route.ts
  - src/server/socket/handlers/notification.ts
autonomous: true

must_haves:
  truths:
    - "Group handle lookup requires session and org membership"
    - "Personal notes API validates workspace membership"
    - "Pins API uses batch author lookup"
    - "Notification handler uses batch settings lookup"
  artifacts:
    - path: "src/lib/actions/user-group.ts"
      provides: "Auth for getGroupByHandle"
      contains: "session"
    - path: "src/app/api/notes/personal/route.ts"
      provides: "Workspace membership validation"
      contains: "Not authorized"
    - path: "src/app/api/channels/[channelId]/pins/route.ts"
      provides: "Batch author lookup"
      contains: "inArray"
  key_links:
    - from: "pins route"
      to: "batch query"
      via: "inArray for authors"
      pattern: "inArray.*users"
---

<objective>
Fix low severity quick fixes: L-4, L-5, L-6, L-7 per CONTEXT.md decision.

Purpose: Close remaining "quick fix" low severity items (L-1, L-2, L-3 deferred as complex).
Output: Four small auth and query optimizations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-stabilization/29-RESEARCH.md
@CODE_REVIEW_04.MD

Source files:
@src/lib/actions/user-group.ts
@src/app/api/notes/personal/route.ts
@src/app/api/channels/[channelId]/pins/route.ts
@src/server/socket/handlers/notification.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix L-4 and L-5 - Add auth to group handle lookup and personal notes</name>
  <files>src/lib/actions/user-group.ts, src/app/api/notes/personal/route.ts</files>
  <action>
**L-4: Group handle lookup (user-group.ts)**

Locate `getGroupByHandle` function (around lines 371-391).

Add session and organization membership check:
```typescript
export async function getGroupByHandle(handle: string, organizationId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  // Verify requester is in the organization
  const membership = await db.query.members.findFirst({
    where: and(
      eq(members.organizationId, organizationId),
      eq(members.userId, session.user.id)
    ),
  });
  if (!membership) {
    throw new Error("Not authorized to lookup groups in this organization");
  }

  // ... existing lookup logic
}
```

**L-5: Personal notes API (notes/personal/route.ts)**

Locate the GET and POST handlers.

Add workspace membership validation:
```typescript
export async function GET(request: Request) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user?.id) {
    return Response.json({ error: "Unauthorized" }, { status: 401 });
  }

  const { searchParams } = new URL(request.url);
  const workspaceId = searchParams.get("workspaceId");

  if (!workspaceId) {
    return Response.json({ error: "Workspace ID required" }, { status: 400 });
  }

  // Verify workspace membership
  const membership = await db.query.members.findFirst({
    where: and(
      eq(members.organizationId, workspaceId),
      eq(members.userId, session.user.id)
    ),
  });
  if (!membership) {
    return Response.json({ error: "Not authorized" }, { status: 403 });
  }

  // ... existing note fetch logic
}
```

Do the same for POST handler.
  </action>
  <verify>
Read modified files and confirm:
- getGroupByHandle requires session + org membership
- Personal notes GET requires session + workspace membership
- Personal notes POST requires session + workspace membership
- Appropriate error responses returned
  </verify>
  <done>
Group handle lookup and personal notes API require proper authorization
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix L-6 and L-7 - Batch queries for pins and notification settings</name>
  <files>src/app/api/channels/[channelId]/pins/route.ts, src/server/socket/handlers/notification.ts</files>
  <action>
**L-6: Pins API batch author lookup (pins/route.ts)**

Locate the section that fetches author info per pin (around lines 62-80).

Replace N+1 pattern:
```typescript
// BEFORE (N+1):
const pinsWithAuthors = await Promise.all(
  pins.map(async (pin) => ({
    ...pin,
    author: await db.query.users.findFirst({ where: eq(users.id, pin.userId) }),
  }))
);

// AFTER (batch):
const authorIds = [...new Set(pins.map(p => p.message.userId).filter(Boolean))];
const authorsMap = new Map<string, User>();

if (authorIds.length > 0) {
  const authors = await db.query.users.findMany({
    where: inArray(users.id, authorIds),
  });
  for (const author of authors) {
    authorsMap.set(author.id, author);
  }
}

const pinsWithAuthors = pins.map(pin => ({
  ...pin,
  author: authorsMap.get(pin.message.userId),
}));
```

Import `inArray` from drizzle-orm.

**L-7: Notification settings batch fetch (notification.ts)**

Locate the notification broadcast section (around lines 18-92 and 126-259) where per-user settings are fetched.

Replace N+1 pattern:
```typescript
// BEFORE (N+1):
for (const userId of recipientIds) {
  const settings = await getUserNotificationSettings(userId);
  // ...
}

// AFTER (batch):
const settingsMap = new Map<string, NotificationSettings>();

if (recipientIds.length > 0) {
  const allSettings = await db.query.notificationSettings.findMany({
    where: inArray(notificationSettings.userId, recipientIds),
  });
  for (const setting of allSettings) {
    settingsMap.set(setting.userId, setting);
  }
}

// Use settingsMap.get(userId) with fallback to defaults
for (const userId of recipientIds) {
  const settings = settingsMap.get(userId) ?? defaultSettings;
  // ...
}
```
  </action>
  <verify>
Read modified files and confirm:
- Pins API collects unique author IDs and fetches in single query
- Notification handler collects unique user IDs for settings and fetches in single query
- Both use inArray for batch lookup
- No N+1 loops remain for these specific queries
  </verify>
  <done>
Pins and notification handlers use batch queries instead of N+1 patterns
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm run lint` - should pass
2. Run `npm run typecheck` - should pass
3. Run `npm test` - existing tests should pass
4. Manual test: View channel pins - should load quickly
5. Manual test: @channel mention - should not cause noticeable delay
</verification>

<success_criteria>
- L-4 closed: Group handle lookup requires session + org membership
- L-5 closed: Personal notes API validates workspace membership
- L-6 closed: Pins API uses batch author lookup
- L-7 closed: Notification handler uses batch settings lookup
- No new N+1 queries introduced
- L-1, L-2, L-3 deferred (documented in roadmap)
</success_criteria>

<output>
After completion, create `.planning/phases/29-stabilization/29-06-SUMMARY.md`
</output>
