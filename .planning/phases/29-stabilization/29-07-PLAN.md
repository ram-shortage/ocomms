---
phase: 29-stabilization
plan: 07
type: execute
wave: 3
depends_on: ["29-01"]
files_modified:
  - src/server/socket/__tests__/notes-handlers.test.ts
  - src/server/socket/__tests__/typing-handlers.test.ts
  - src/server/socket/__tests__/presence-handlers.test.ts
autonomous: true

must_haves:
  truths:
    - "Tests verify unauthorized users cannot subscribe to note rooms"
    - "Tests verify unauthorized users cannot broadcast typing events"
    - "Tests verify unauthorized users cannot fetch presence for other workspaces"
  artifacts:
    - path: "src/server/socket/__tests__/notes-handlers.test.ts"
      provides: "Authorization tests for notes handlers"
      min_lines: 50
    - path: "src/server/socket/__tests__/typing-handlers.test.ts"
      provides: "Authorization tests for typing handlers"
      min_lines: 50
    - path: "src/server/socket/__tests__/presence-handlers.test.ts"
      provides: "Authorization tests for presence handlers"
      min_lines: 30
  key_links:
    - from: "test files"
      to: "source files"
      via: "source code validation pattern"
      pattern: "expect\\(source\\)\\.toContain"
---

<objective>
Create unit tests proving security fixes for H-1, M-1, M-7 are in place.

Purpose: Verify socket handler authorization checks are correctly implemented (TEST-01, TEST-03).
Output: Test files that validate authorization patterns in notes, typing, and presence handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-stabilization/29-RESEARCH.md
@.planning/phases/29-stabilization/29-01-SUMMARY.md (after Plan 01 completes)

Pattern reference:
@src/server/socket/__tests__/authz.test.ts
@src/server/socket/__tests__/thread-handlers.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notes handler authorization tests</name>
  <files>src/server/socket/__tests__/notes-handlers.test.ts</files>
  <action>
Create test file using source validation pattern (similar to thread-handlers.test.ts):

```typescript
import { describe, it, expect } from "vitest";
import * as fs from "fs";
import * as path from "path";

describe("Notes Handler Authorization (H-1 fix)", () => {
  const sourcePath = path.resolve(__dirname, "../handlers/notes.ts");
  const source = fs.readFileSync(sourcePath, "utf-8");

  describe("note:subscribe authorization", () => {
    it("imports authorization helpers from authz", () => {
      expect(source).toContain("isChannelMember");
      expect(source).toContain("isOrganizationMember");
    });

    it("checks channel membership before joining channel note room", () => {
      // Verify authorization check exists before socket.join for channelId
      const subscribeSection = source.slice(
        source.indexOf('socket.on("note:subscribe"'),
        source.indexOf('socket.on("note:unsubscribe"')
      );
      expect(subscribeSection).toContain("isChannelMember");
      expect(subscribeSection).toContain("Not authorized");
    });

    it("checks organization membership before joining personal note room", () => {
      const subscribeSection = source.slice(
        source.indexOf('socket.on("note:subscribe"'),
        source.indexOf('socket.on("note:unsubscribe"')
      );
      expect(subscribeSection).toContain("isOrganizationMember");
    });
  });

  describe("note:broadcast authorization", () => {
    it("checks channel membership before broadcasting to channel note room", () => {
      const broadcastSection = source.slice(
        source.indexOf('socket.on("note:broadcast"')
      );
      expect(broadcastSection).toContain("isChannelMember");
      expect(broadcastSection).toContain("Not authorized");
    });
  });
});
```
  </action>
  <verify>
Run `npm test src/server/socket/__tests__/notes-handlers.test.ts`:
- All tests pass
- Tests confirm authorization imports exist
- Tests confirm membership checks before room join/broadcast
  </verify>
  <done>
Notes handler tests verify H-1 authorization fix is in place
  </done>
</task>

<task type="auto">
  <name>Task 2: Create typing handler authorization tests</name>
  <files>src/server/socket/__tests__/typing-handlers.test.ts</files>
  <action>
Update or create test file to validate M-7 fix:

```typescript
import { describe, it, expect } from "vitest";
import * as fs from "fs";
import * as path from "path";

describe("Typing Handler Authorization (M-7 fix)", () => {
  const sourcePath = path.resolve(__dirname, "../handlers/typing.ts");
  const source = fs.readFileSync(sourcePath, "utf-8");

  describe("authorization imports", () => {
    it("imports channel and conversation authorization helpers", () => {
      expect(source).toContain("isChannelMember");
      expect(source).toContain("isConversationParticipant");
    });
  });

  describe("typing:start authorization", () => {
    it("checks channel membership for channel typing", () => {
      const startSection = source.slice(
        source.indexOf('socket.on("typing:start"'),
        source.indexOf('socket.on("typing:stop"')
      );
      expect(startSection).toContain("isChannelMember");
    });

    it("checks conversation participation for DM typing", () => {
      const startSection = source.slice(
        source.indexOf('socket.on("typing:start"'),
        source.indexOf('socket.on("typing:stop"')
      );
      expect(startSection).toContain("isConversationParticipant");
    });

    it("emits error for unauthorized typing attempts", () => {
      const startSection = source.slice(
        source.indexOf('socket.on("typing:start"'),
        source.indexOf('socket.on("typing:stop"')
      );
      expect(startSection).toContain("Not authorized");
    });
  });

  describe("typing:stop authorization", () => {
    it("checks membership before broadcasting stop event", () => {
      const stopSection = source.slice(
        source.indexOf('socket.on("typing:stop"'),
        source.indexOf("disconnect") // Or end of file
      );
      // Should have similar auth checks
      expect(stopSection).toMatch(/isChannelMember|isConversationParticipant/);
    });
  });
});
```
  </action>
  <verify>
Run `npm test src/server/socket/__tests__/typing-handlers.test.ts`:
- All tests pass
- Tests confirm authorization helpers are imported
- Tests confirm membership checks exist for both channel and DM typing
  </verify>
  <done>
Typing handler tests verify M-7 authorization fix is in place
  </done>
</task>

<task type="auto">
  <name>Task 3: Update presence handler authorization tests</name>
  <files>src/server/socket/__tests__/presence-handlers.test.ts</files>
  <action>
Update existing presence-handlers.test.ts to validate M-1 fix.

Add tests for organization membership check:

```typescript
import { describe, it, expect } from "vitest";
import * as fs from "fs";
import * as path from "path";

describe("Presence Handler Authorization (M-1 fix)", () => {
  // Read the main socket index where presence:fetch is handled
  const sourcePath = path.resolve(__dirname, "../index.ts");
  const source = fs.readFileSync(sourcePath, "utf-8");

  describe("presence:fetch authorization", () => {
    it("imports organization membership helper", () => {
      expect(source).toContain("isOrganizationMember");
    });

    it("validates workspace membership before fetching presence", () => {
      // Find presence:fetch handler section
      const presenceSection = source.slice(
        source.indexOf('presence:fetch'),
        source.indexOf('presence:fetch') + 500 // Reasonable section size
      );
      expect(presenceSection).toContain("isOrganizationMember");
    });

    it("emits error for unauthorized workspace presence requests", () => {
      const presenceSection = source.slice(
        source.indexOf('presence:fetch'),
        source.indexOf('presence:fetch') + 500
      );
      expect(presenceSection).toContain("Not authorized");
    });
  });
});
```

If presence-handlers.test.ts already has tests, add these as a new describe block.
  </action>
  <verify>
Run `npm test src/server/socket/__tests__/presence-handlers.test.ts`:
- All tests pass
- Tests confirm isOrganizationMember is imported in socket/index.ts
- Tests confirm membership check exists in presence:fetch handler
  </verify>
  <done>
Presence handler tests verify M-1 authorization fix is in place
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm test -- --reporter=verbose` to see all tests
2. Verify no test failures
3. Run `npm run lint` - no lint errors in test files
4. Tests prove security fixes are in place (source validation pattern)
</verification>

<success_criteria>
- notes-handlers.test.ts validates H-1 fix (channel/org membership for notes)
- typing-handlers.test.ts validates M-7 fix (channel/DM membership for typing)
- presence-handlers.test.ts validates M-1 fix (org membership for presence)
- All tests pass
- Tests use source validation pattern from existing codebase
</success_criteria>

<output>
After completion, create `.planning/phases/29-stabilization/29-07-SUMMARY.md`
</output>
