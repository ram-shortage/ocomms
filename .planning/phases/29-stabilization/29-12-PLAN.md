---
phase: 29-stabilization
plan: 12
type: execute
wave: 5
depends_on: ["29-07", "29-08", "29-09", "29-10", "29-11"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All security fixes verified in place"
    - "All new tests pass"
    - "No regressions in existing tests"
    - "BUG-26-01 user status fixed"
  artifacts: []
  key_links: []
---

<objective>
Final verification checkpoint for Phase 29 stabilization.

Purpose: Confirm all security fixes are in place, tests pass, and bugs are resolved before marking v0.5.0 complete.
Output: Verified stable state ready for production.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-stabilization/29-RESEARCH.md
@CODE_REVIEW_04.MD

Prior plan summaries:
@.planning/phases/29-stabilization/29-01-SUMMARY.md
@.planning/phases/29-stabilization/29-02-SUMMARY.md
@.planning/phases/29-stabilization/29-03-SUMMARY.md
@.planning/phases/29-stabilization/29-04-SUMMARY.md
@.planning/phases/29-stabilization/29-05-SUMMARY.md
@.planning/phases/29-stabilization/29-06-SUMMARY.md
@.planning/phases/29-stabilization/29-07-SUMMARY.md
@.planning/phases/29-stabilization/29-08-SUMMARY.md
@.planning/phases/29-stabilization/29-09-SUMMARY.md
@.planning/phases/29-stabilization/29-10-SUMMARY.md
@.planning/phases/29-stabilization/29-11-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full test suite</name>
  <files></files>
  <action>
Run the complete test suite and capture results:

```bash
npm test -- --reporter=verbose 2>&1 | tee test-results.txt
```

Verify:
- All tests pass (no failures)
- No test timeouts
- No unhandled promise rejections

If any tests fail, investigate and fix before proceeding.

Also run linting and type checking:
```bash
npm run lint
npm run typecheck
```
  </action>
  <verify>
- `npm test` exits with code 0
- `npm run lint` exits with code 0
- `npm run typecheck` exits with code 0
  </verify>
  <done>
All automated checks pass (tests, lint, types)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify security fixes are in place</name>
  <files></files>
  <action>
Run source validation checks to confirm security fixes:

```bash
# H-1: Notes auth
grep -n "isChannelMember\|isOrganizationMember" src/server/socket/handlers/notes.ts

# M-1: Presence auth
grep -n "isOrganizationMember" src/server/socket/index.ts

# M-7: Typing auth
grep -n "isChannelMember\|isConversationParticipant" src/server/socket/handlers/typing.ts

# M-8: User status auth
grep -n "Unauthorized\|Not authorized" src/lib/actions/user-status.ts

# M-9: Group members auth
grep -n "Not authorized" src/lib/actions/user-group.ts

# M-10: Link preview auth
grep -n "isChannelMember\|Not authorized" src/lib/actions/link-preview.ts

# M-11: Thread pagination
grep -n "MAX_PAGE_SIZE\|Math.min\|cursor" src/server/socket/handlers/thread.ts

# M-12: Array caps
grep -n "MAX_IDS" src/server/socket/index.ts src/server/socket/handlers/unread.ts

# M-13: Notification limits
grep -n "MAX_NOTIFICATION_LIMIT\|inArray" src/server/socket/handlers/notification.ts
```

Confirm all expected patterns are present.
  </action>
  <verify>
Each grep returns results showing the security fix is in place:
- H-1: isChannelMember in notes.ts
- M-1: isOrganizationMember in index.ts presence handler
- M-7: isChannelMember/isConversationParticipant in typing.ts
- M-8: Auth checks in user-status.ts
- M-9: Auth checks in user-group.ts
- M-10: Message access check in link-preview.ts
- M-11: Pagination in thread.ts
- M-12: MAX_IDS in presence/unread handlers
- M-13: Limit cap and inArray in notification.ts
  </verify>
  <done>
All security fixes from CODE_REVIEW_04.MD verified in source code
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 29 stabilization:
1. Security fixes for H-1, M-1 through M-13 (excluding deferred L-1, L-2, L-3)
2. Bug fix for BUG-26-01 (user status persistence)
3. Quick fixes for L-4 through L-7
4. Unit tests for all security fixes
5. Feature tests for v0.5.0 actions (scheduled messages, reminders, bookmarks, guests, analytics)
6. Integration test for guest-group restriction
  </what-built>
  <how-to-verify>
**1. Security Fixes (spot check)**
- Open the app and try to access data outside your workspace (should fail)
- Verify typing indicators only work in channels you're a member of

**2. User Status Bug (BUG-26-01)**
- Click your avatar in the sidebar
- Set a custom status (emoji + text)
- Set an expiration (e.g., "1 hour")
- Click Save
- Verify status appears in sidebar immediately
- Reload page - status should persist
- Clear status - should remove immediately

**3. Test Results**
- Review test output from Task 1
- Confirm no flaky tests or timeouts
- Check test count increased from baseline

**4. Code Quality**
- Run `npm run lint` - should pass
- Run `npm run typecheck` - should pass

**5. Deferred Items**
Confirm these are NOT fixed (deferred to future):
- L-1: Audit log streaming (complex)
- L-2: Admin export batching (complex)
- L-3: Distributed rate limiting (complex)
- M-4: Attachment auth (needs design decision)
- M-5: Upload quotas (needs design decision)
- M-6: CSP hardening (needs deployment config)
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 29 is complete when:
1. All automated tests pass
2. Security fixes are verified in source code
3. User manually confirms BUG-26-01 is fixed
4. User confirms the app is stable
</verification>

<success_criteria>
- TEST-01: Unit tests exist for v0.5.0 backend services (scheduled messages, reminders, bookmarks, status, guests, analytics, user groups)
- TEST-02: Integration test verifies guest-group restriction
- TEST-03: Socket.IO tests cover security fixes for real-time features
- TEST-04: Server action tests verify authorization
- TEST-05: Authorization tests for guest restrictions included
- TEST-07: BUG-26-01 fixed
- All HIGH and MEDIUM severity findings from CODE_REVIEW_04.MD addressed
- Quick-fix LOW severity items (L-4 through L-7) addressed
- Complex LOW severity items (L-1, L-2, L-3) documented as deferred
</success_criteria>

<output>
After completion, create `.planning/phases/29-stabilization/29-12-SUMMARY.md` with:
- Final test count and pass rate
- Security findings closure summary
- Bug fixes summary
- Deferred items documented for future
- v0.5.0 ready for production statement
</output>
