---
phase: 29-stabilization
plan: 09
type: execute
wave: 3
depends_on: ["29-03", "29-04"]
files_modified:
  - src/server/socket/__tests__/thread-handlers.test.ts
  - src/server/socket/__tests__/unread-handlers.test.ts
  - src/server/socket/__tests__/notification-handlers.test.ts
autonomous: true

must_haves:
  truths:
    - "Tests verify thread reply validation and retry logic"
    - "Tests verify thread pagination limits"
    - "Tests verify array size caps in presence/unread handlers"
    - "Tests verify notification limit capping"
  artifacts:
    - path: "src/server/socket/__tests__/thread-handlers.test.ts"
      provides: "Tests for thread validation, retry, pagination"
      min_lines: 60
    - path: "src/server/socket/__tests__/unread-handlers.test.ts"
      provides: "Tests for array size caps"
      min_lines: 30
    - path: "src/server/socket/__tests__/notification-handlers.test.ts"
      provides: "Tests for limit capping and batch queries"
      min_lines: 40
  key_links:
    - from: "test files"
      to: "source files"
      via: "source validation pattern"
      pattern: "expect\\(source\\)\\.toContain"
---

<objective>
Create unit tests proving security fixes for M-2, M-3, M-11, M-12, M-13 are in place.

Purpose: Verify thread handler validation, pagination, and DoS prevention are correctly implemented (TEST-01, TEST-03).
Output: Test files that validate thread safety, pagination, and input caps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-stabilization/29-RESEARCH.md
@.planning/phases/29-stabilization/29-03-SUMMARY.md (after Plan 03)
@.planning/phases/29-stabilization/29-04-SUMMARY.md (after Plan 04)

Pattern reference:
@src/server/socket/__tests__/thread-handlers.test.ts (existing)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update thread handler tests for M-2, M-3, M-11 fixes</name>
  <files>src/server/socket/__tests__/thread-handlers.test.ts</files>
  <action>
Update existing thread-handlers.test.ts to validate the new fixes:

```typescript
import { describe, it, expect } from "vitest";
import * as fs from "fs";
import * as path from "path";

describe("Thread Handler Security Fixes", () => {
  const sourcePath = path.resolve(__dirname, "../handlers/thread.ts");
  const source = fs.readFileSync(sourcePath, "utf-8");

  describe("Message length validation (M-3)", () => {
    it("imports MAX_MESSAGE_LENGTH constant", () => {
      expect(source).toMatch(/MAX_MESSAGE_LENGTH|maxMessageLength/i);
    });

    it("validates content length before insert", () => {
      // Should check length and emit error if too long
      expect(source).toContain("character limit");
    });
  });

  describe("Sequence race condition handling (M-2)", () => {
    it("implements retry logic for sequence conflicts", () => {
      // Should have retry loop or similar pattern
      expect(source).toMatch(/retry|MAX_RETRIES|attempt/i);
    });

    it("handles unique constraint violation (23505)", () => {
      expect(source).toContain("23505");
    });
  });

  describe("Thread reply pagination (M-11)", () => {
    it("defines maximum page size constant", () => {
      expect(source).toMatch(/MAX_PAGE_SIZE|maxPageSize|MAX_LIMIT/i);
    });

    it("clamps limit to prevent abuse", () => {
      // Should have Math.min or similar clamping
      expect(source).toContain("Math.min");
    });

    it("supports cursor-based pagination", () => {
      expect(source).toMatch(/cursor|offset|nextCursor|hasMore/i);
    });
  });

  // Keep existing authorization tests...
  describe("Thread reply authorization (existing)", () => {
    it("verifies channel membership for replies in channels", () => {
      expect(source).toContain("isChannelMember");
    });

    it("verifies conversation participation for replies in DMs", () => {
      expect(source).toContain("isConversationParticipant");
    });
  });
});
```

Merge with any existing tests in thread-handlers.test.ts.
  </action>
  <verify>
Run `npm test src/server/socket/__tests__/thread-handlers.test.ts`:
- All tests pass
- Tests validate M-2 (retry logic for 23505)
- Tests validate M-3 (message length check)
- Tests validate M-11 (pagination with limit clamping)
  </verify>
  <done>
Thread handler tests verify M-2, M-3, M-11 fixes are in place
  </done>
</task>

<task type="auto">
  <name>Task 2: Update unread and presence handler tests for M-12 fix</name>
  <files>src/server/socket/__tests__/unread-handlers.test.ts, src/server/socket/__tests__/presence-handlers.test.ts</files>
  <action>
Update existing test files to validate array size caps:

**unread-handlers.test.ts:**
```typescript
import { describe, it, expect } from "vitest";
import * as fs from "fs";
import * as path from "path";

describe("Unread Handler DoS Prevention (M-12)", () => {
  const sourcePath = path.resolve(__dirname, "../handlers/unread.ts");
  const source = fs.readFileSync(sourcePath, "utf-8");

  describe("Array size caps", () => {
    it("defines maximum IDs per request", () => {
      expect(source).toMatch(/MAX_IDS|maxIds|MAX_IDS_PER_REQUEST/i);
    });

    it("checks array length before processing", () => {
      // Should have length check and error emission
      expect(source).toContain(".length");
      expect(source).toContain("Maximum");
    });
  });
});
```

**presence-handlers.test.ts** (add to existing):
```typescript
describe("Presence Handler DoS Prevention (M-12)", () => {
  const socketSourcePath = path.resolve(__dirname, "../index.ts");
  const socketSource = fs.readFileSync(socketSourcePath, "utf-8");

  describe("Array size caps in presence:fetch", () => {
    it("caps userIds array size", () => {
      const presenceSection = socketSource.slice(
        socketSource.indexOf("presence:fetch"),
        socketSource.indexOf("presence:fetch") + 800
      );
      expect(presenceSection).toMatch(/MAX_IDS|maxIds|length/i);
    });
  });
});
```
  </action>
  <verify>
Run tests:
- `npm test src/server/socket/__tests__/unread-handlers.test.ts`
- `npm test src/server/socket/__tests__/presence-handlers.test.ts`

All tests pass, validating M-12 array size caps.
  </verify>
  <done>
Unread and presence handler tests verify M-12 array size cap fixes are in place
  </done>
</task>

<task type="auto">
  <name>Task 3: Update notification handler tests for M-13 fix</name>
  <files>src/server/socket/__tests__/notification-handlers.test.ts</files>
  <action>
Update existing notification-handlers.test.ts to validate M-13 fix:

```typescript
import { describe, it, expect } from "vitest";
import * as fs from "fs";
import * as path from "path";

describe("Notification Handler DoS Prevention (M-13)", () => {
  const sourcePath = path.resolve(__dirname, "../handlers/notification.ts");
  const source = fs.readFileSync(sourcePath, "utf-8");

  describe("Limit capping", () => {
    it("defines maximum notification limit", () => {
      expect(source).toMatch(/MAX_NOTIFICATION_LIMIT|MAX_LIMIT|maxLimit/i);
    });

    it("clamps incoming limit value", () => {
      expect(source).toContain("Math.min");
    });
  });

  describe("Batch channel queries", () => {
    it("uses inArray for batch channel lookup", () => {
      expect(source).toContain("inArray");
    });

    it("collects unique channel IDs before query", () => {
      // Should collect IDs into array/set before single query
      expect(source).toMatch(/new Set|channelIds|uniqueIds/i);
    });
  });
});
```

Merge with any existing notification handler tests.
  </action>
  <verify>
Run `npm test src/server/socket/__tests__/notification-handlers.test.ts`:
- All tests pass
- Tests validate M-13 limit capping
- Tests validate M-13 batch channel queries (inArray pattern)
  </verify>
  <done>
Notification handler tests verify M-13 limit capping and batch query fixes are in place
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm test` - all socket handler tests pass
2. Run `npm run lint` - no lint errors
3. Tests use source validation pattern consistently
4. Tests cover all M-2, M-3, M-11, M-12, M-13 fixes
</verification>

<success_criteria>
- thread-handlers.test.ts validates M-2 (retry), M-3 (length), M-11 (pagination)
- unread-handlers.test.ts validates M-12 (array caps)
- presence-handlers.test.ts validates M-12 (array caps)
- notification-handlers.test.ts validates M-13 (limit cap, batch queries)
- All tests pass in CI
</success_criteria>

<output>
After completion, create `.planning/phases/29-stabilization/29-09-SUMMARY.md`
</output>
