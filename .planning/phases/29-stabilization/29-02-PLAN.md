---
phase: 29-stabilization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions/user-status.ts
  - src/lib/actions/user-group.ts
  - src/lib/actions/link-preview.ts
autonomous: true

must_haves:
  truths:
    - "User status lookup requires session and shared organization membership"
    - "Group member list requires requester to be in group's organization"
    - "Link preview fetch requires message access verification"
  artifacts:
    - path: "src/lib/actions/user-status.ts"
      provides: "Session and org membership checks for getUserStatus"
      contains: "Not authorized"
    - path: "src/lib/actions/user-group.ts"
      provides: "Organization membership check for getGroupMembers"
      contains: "isOrganizationMember"
    - path: "src/lib/actions/link-preview.ts"
      provides: "Message access verification for getLinkPreviews"
      contains: "isChannelMember"
  key_links:
    - from: "src/lib/actions/user-status.ts"
      to: "src/lib/auth"
      via: "session check"
      pattern: "auth\\.api\\.getSession"
    - from: "src/lib/actions/link-preview.ts"
      to: "message access check"
      via: "channel/conversation membership"
      pattern: "(isChannelMember|isConversationParticipant)"
---

<objective>
Fix M-8 (user status auth), M-9 (group member auth), and M-10 (link preview auth) security vulnerabilities.

Purpose: Close 3 MEDIUM severity findings in server actions that leak data across organizations.
Output: Server actions with proper session and organization scoping.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-stabilization/29-RESEARCH.md
@CODE_REVIEW_04.MD

Source files to modify:
@src/lib/actions/user-status.ts
@src/lib/actions/user-group.ts
@src/lib/actions/link-preview.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix M-8 - Add authentication and org scoping to user status lookup</name>
  <files>src/lib/actions/user-status.ts</files>
  <action>
Locate `getUserStatus` function (around lines 138-143 per CODE_REVIEW).

Add session verification and organization membership check:

```typescript
export async function getUserStatus(userId: string, organizationId?: string) {
  // Require authentication
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  // If organizationId provided, verify requester is also a member
  if (organizationId) {
    const requesterMembership = await db.query.members.findFirst({
      where: and(
        eq(members.organizationId, organizationId),
        eq(members.userId, session.user.id)
      ),
    });
    if (!requesterMembership) {
      throw new Error("Not authorized to view user status in this organization");
    }

    // Also verify target user is in the same organization
    const targetMembership = await db.query.members.findFirst({
      where: and(
        eq(members.organizationId, organizationId),
        eq(members.userId, userId)
      ),
    });
    if (!targetMembership) {
      return null; // User not in this org, return nothing
    }
  } else {
    // Without organizationId, only allow self-lookup
    if (session.user.id !== userId) {
      throw new Error("Organization context required for cross-user status lookup");
    }
  }

  // ... existing status fetch logic
}
```

Import `members` schema and `and`, `eq` from drizzle-orm if not already imported.
  </action>
  <verify>
Read the modified file and confirm:
- `getUserStatus` requires a valid session
- With organizationId: verifies both requester and target are org members
- Without organizationId: only allows self-lookup
- Appropriate error messages are thrown
  </verify>
  <done>
User status lookup requires authentication and organization membership verification
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix M-9 - Add organization membership check to group member list</name>
  <files>src/lib/actions/user-group.ts</files>
  <action>
Locate `getGroupMembers` function (around lines 346-365 per CODE_REVIEW).

Add organization membership verification:

```typescript
export async function getGroupMembers(groupId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  // Get the group to find its organization
  const group = await db.query.userGroups.findFirst({
    where: eq(userGroups.id, groupId),
  });
  if (!group) {
    throw new Error("Group not found");
  }

  // Verify requester is in the group's organization
  const membership = await db.query.members.findFirst({
    where: and(
      eq(members.organizationId, group.organizationId),
      eq(members.userId, session.user.id)
    ),
  });
  if (!membership) {
    throw new Error("Not authorized to view members of this group");
  }

  // ... existing member fetch logic
  // Consider hiding email for non-admins (optional enhancement)
}
```

Also check `getGroupByHandle` (L-4 from CODE_REVIEW, around lines 371-391) - add similar session + org check.
  </action>
  <verify>
Read the modified file and confirm:
- `getGroupMembers` requires a valid session
- `getGroupMembers` verifies requester is in the group's organization
- `getGroupByHandle` (if it exists) also has session + org verification
- Error messages are appropriate
  </verify>
  <done>
Group member list and handle lookup require organization membership verification
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix M-10 - Add message access check to link preview fetch</name>
  <files>src/lib/actions/link-preview.ts</files>
  <action>
Locate `getLinkPreviews` or similar function (around lines 24-49 per CODE_REVIEW).

Add message context and membership verification:

```typescript
export async function getLinkPreviews(messageId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  // Get message to find its context (channel or DM)
  const message = await db.query.messages.findFirst({
    where: eq(messages.id, messageId),
    columns: { channelId: true, conversationId: true },
  });
  if (!message) {
    throw new Error("Message not found");
  }

  // Verify access based on context
  if (message.channelId) {
    const membership = await db.query.channelMembers.findFirst({
      where: and(
        eq(channelMembers.channelId, message.channelId),
        eq(channelMembers.userId, session.user.id)
      ),
    });
    if (!membership) {
      throw new Error("Not authorized to view this message");
    }
  } else if (message.conversationId) {
    const participant = await db.query.conversationParticipants.findFirst({
      where: and(
        eq(conversationParticipants.conversationId, message.conversationId),
        eq(conversationParticipants.userId, session.user.id)
      ),
    });
    if (!participant) {
      throw new Error("Not authorized to view this message");
    }
  }

  // ... existing link preview fetch logic
}
```

Import necessary schemas (messages, channelMembers, conversationParticipants) and drizzle operators.
  </action>
  <verify>
Read the modified file and confirm:
- `getLinkPreviews` requires a valid session
- Gets message to determine channel/conversation context
- Verifies channel membership or conversation participation
- Throws appropriate errors for unauthorized access
  </verify>
  <done>
Link preview fetch requires message access verification via channel/conversation membership
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm run lint` - should pass
2. Run `npm run typecheck` - should pass
3. Run `npm test` - existing tests should pass
4. Read each modified file and verify authorization checks are in place
</verification>

<success_criteria>
- M-8 closed: User status lookup requires session + org membership
- M-9 closed: Group member list requires org membership
- L-4 closed: Group handle lookup requires session + org membership (bonus fix)
- M-10 closed: Link preview fetch requires message access verification
- All checks follow existing patterns from channels.test.ts
</success_criteria>

<output>
After completion, create `.planning/phases/29-stabilization/29-02-SUMMARY.md`
</output>
