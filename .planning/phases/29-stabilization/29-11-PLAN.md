---
phase: 29-stabilization
plan: 11
type: execute
wave: 4
depends_on: []
files_modified:
  - src/lib/actions/__tests__/guest.test.ts
  - src/lib/actions/__tests__/analytics.test.ts
autonomous: true

must_haves:
  truths:
    - "Tests cover guest invite, redeem, and access control"
    - "Tests verify guests cannot access user groups"
    - "Tests cover analytics data retrieval and authorization"
  artifacts:
    - path: "src/lib/actions/__tests__/guest.test.ts"
      provides: "Unit tests for guest actions"
      min_lines: 100
    - path: "src/lib/actions/__tests__/analytics.test.ts"
      provides: "Unit tests for analytics actions"
      min_lines: 60
  key_links:
    - from: "test files"
      to: "source actions"
      via: "database mocking pattern"
      pattern: "vi\\.mock\\(\"@/db\""
---

<objective>
Create unit tests for v0.5.0 server actions: guests and analytics (TEST-01, TEST-02, TEST-05).

Purpose: Provide test coverage for Phase 28 features including guest restrictions (GUST-07).
Output: Comprehensive tests covering guest lifecycle and admin analytics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-stabilization/29-RESEARCH.md

Pattern reference:
@src/lib/actions/__tests__/channels.test.ts

Source files to test:
@src/lib/actions/guest.ts
@src/lib/actions/analytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create guest action tests</name>
  <files>src/lib/actions/__tests__/guest.test.ts</files>
  <action>
Create comprehensive tests for guest operations:

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";
import {
  createGuestInvite,
  redeemGuestInvite,
  removeGuest,
  extendGuestAccess,
  getGuestChannelAccess,
} from "../guest";

// Standard mocks
vi.mock("next/headers", () => ({
  headers: vi.fn().mockResolvedValue(new Headers()),
}));
vi.mock("next/cache", () => ({ revalidatePath: vi.fn() }));

const mockGetSession = vi.fn();
vi.mock("@/lib/auth", () => ({
  auth: { api: { getSession: (...args: unknown[]) => mockGetSession(...args) } },
}));

const mockFindFirst = vi.fn();
const mockFindMany = vi.fn();
const mockInsert = vi.fn();
const mockUpdate = vi.fn();
const mockDelete = vi.fn();

vi.mock("@/db", () => ({
  db: {
    query: {
      members: { findFirst: (...args: unknown[]) => mockFindFirst(...args) },
      guestInvites: { findFirst: (...args: unknown[]) => mockFindFirst(...args) },
      guestChannelAccess: { findMany: (...args: unknown[]) => mockFindMany(...args) },
      channels: { findMany: (...args: unknown[]) => mockFindMany(...args) },
    },
    insert: (...args: unknown[]) => mockInsert(...args),
    update: (...args: unknown[]) => mockUpdate(...args),
    delete: (...args: unknown[]) => mockDelete(...args),
    transaction: vi.fn((cb) => cb({
      insert: (...args: unknown[]) => mockInsert(...args),
      update: (...args: unknown[]) => mockUpdate(...args),
    })),
  },
}));

vi.mock("@/server/queue/guest-expiration.queue", () => ({
  guestExpirationQueue: {
    add: vi.fn().mockResolvedValue({ id: "job-123" }),
    getJob: vi.fn().mockResolvedValue({ remove: vi.fn() }),
  },
}));

describe("Guest Actions", () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockGetSession.mockResolvedValue({ user: { id: "user-123" } });
  });

  describe("createGuestInvite", () => {
    it("rejects non-admin", async () => {
      mockFindFirst.mockResolvedValueOnce({ id: "member-1", role: "member" });

      await expect(
        createGuestInvite({
          email: "guest@example.com",
          organizationId: "org-1",
          channelIds: ["ch-1"],
        })
      ).rejects.toThrow("Only admins can invite guests");
    });

    it("creates invite for admin", async () => {
      mockFindFirst.mockResolvedValueOnce({ id: "member-1", role: "admin" });
      mockInsert.mockReturnValue({
        values: () => ({ returning: () => Promise.resolve([{ id: "inv-1", token: "abc123" }]) }),
      });

      const result = await createGuestInvite({
        email: "guest@example.com",
        organizationId: "org-1",
        channelIds: ["ch-1", "ch-2"],
        expiresAt: new Date(Date.now() + 86400000),
      });

      expect(result.token).toBeDefined();
    });
  });

  describe("redeemGuestInvite", () => {
    it("rejects expired invite", async () => {
      mockFindFirst.mockResolvedValueOnce({
        id: "inv-1",
        expiresAt: new Date(Date.now() - 60000), // expired
      });

      await expect(redeemGuestInvite("invalid-token")).rejects.toThrow("expired");
    });

    it("creates guest membership from valid invite", async () => {
      const futureDate = new Date(Date.now() + 86400000);
      mockFindFirst.mockResolvedValueOnce({
        id: "inv-1",
        email: "guest@example.com",
        organizationId: "org-1",
        channelIds: JSON.stringify(["ch-1"]),
        expiresAt: futureDate,
        redeemedAt: null,
      });
      mockInsert.mockReturnValue({
        values: () => ({ returning: () => Promise.resolve([{ id: "member-1" }]) }),
      });
      mockUpdate.mockReturnValue({
        set: () => ({ where: () => Promise.resolve() }),
      });

      const result = await redeemGuestInvite("valid-token");

      expect(result.success).toBe(true);
    });
  });

  describe("getGuestChannelAccess", () => {
    it("returns channel IDs for guest", async () => {
      mockFindMany.mockResolvedValueOnce([
        { channelId: "ch-1" },
        { channelId: "ch-2" },
      ]);

      const result = await getGuestChannelAccess("user-123", "org-1");

      expect(result).toEqual(["ch-1", "ch-2"]);
    });

    it("returns empty array for non-guest", async () => {
      mockFindMany.mockResolvedValueOnce([]);

      const result = await getGuestChannelAccess("user-123", "org-1");

      expect(result).toEqual([]);
    });
  });

  describe("removeGuest", () => {
    it("rejects non-admin removal", async () => {
      mockFindFirst
        .mockResolvedValueOnce({ id: "member-1", role: "member" }); // requester

      await expect(removeGuest("guest-user-id", "org-1")).rejects.toThrow("Only admins");
    });

    it("removes guest for admin", async () => {
      mockFindFirst
        .mockResolvedValueOnce({ id: "member-1", role: "admin" }) // requester is admin
        .mockResolvedValueOnce({ id: "member-2", isGuest: true }); // target is guest
      mockDelete.mockReturnValue({ where: () => Promise.resolve() });

      await removeGuest("guest-user-id", "org-1");

      expect(mockDelete).toHaveBeenCalled();
    });
  });
});
```
  </action>
  <verify>
Run `npm test src/lib/actions/__tests__/guest.test.ts`:
- All tests pass
- Tests cover invite, redeem, access, remove operations
- Tests verify admin-only actions
  </verify>
  <done>
Guest action tests provide coverage for GUST-01 through GUST-08
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analytics action tests</name>
  <files>src/lib/actions/__tests__/analytics.test.ts</files>
  <action>
Create tests for analytics operations:

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";
import {
  getMessageVolume,
  getActiveUsers,
  getChannelActivity,
  getStorageUsage,
} from "../analytics";

// Standard mocks
vi.mock("next/headers", () => ({
  headers: vi.fn().mockResolvedValue(new Headers()),
}));

const mockGetSession = vi.fn();
vi.mock("@/lib/auth", () => ({
  auth: { api: { getSession: (...args: unknown[]) => mockGetSession(...args) } },
}));

const mockFindFirst = vi.fn();
const mockFindMany = vi.fn();
const mockSelect = vi.fn();

vi.mock("@/db", () => ({
  db: {
    query: {
      members: { findFirst: (...args: unknown[]) => mockFindFirst(...args) },
      messages: { findMany: (...args: unknown[]) => mockFindMany(...args) },
      channels: { findMany: (...args: unknown[]) => mockFindMany(...args) },
      attachments: { findMany: (...args: unknown[]) => mockFindMany(...args) },
    },
    select: (...args: unknown[]) => mockSelect(...args),
  },
}));

describe("Analytics Actions", () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockGetSession.mockResolvedValue({ user: { id: "user-123" } });
  });

  describe("Authorization", () => {
    it("rejects unauthenticated user", async () => {
      mockGetSession.mockResolvedValue(null);

      await expect(getMessageVolume("org-1", {})).rejects.toThrow("Unauthorized");
    });

    it("rejects non-admin", async () => {
      mockFindFirst.mockResolvedValueOnce({ id: "member-1", role: "member" });

      await expect(getMessageVolume("org-1", {})).rejects.toThrow("Admin access required");
    });
  });

  describe("getMessageVolume (ANLY-01)", () => {
    it("returns message counts by date for admin", async () => {
      mockFindFirst.mockResolvedValueOnce({ id: "member-1", role: "admin" });
      mockFindMany.mockResolvedValueOnce([
        { date: "2026-01-20", count: 150 },
        { date: "2026-01-21", count: 200 },
      ]);

      const result = await getMessageVolume("org-1", {
        startDate: new Date("2026-01-20"),
        endDate: new Date("2026-01-21"),
      });

      expect(result).toHaveLength(2);
    });
  });

  describe("getActiveUsers (ANLY-02)", () => {
    it("returns DAU/WAU/MAU metrics", async () => {
      mockFindFirst.mockResolvedValueOnce({ id: "member-1", role: "admin" });
      // Mock the distinct user counts
      mockSelect.mockReturnValue({
        from: () => ({
          where: () => ({
            then: (resolve: (v: unknown) => void) => resolve([{ count: 42 }]),
          }),
        }),
      });

      const result = await getActiveUsers("org-1");

      expect(result).toHaveProperty("dau");
      expect(result).toHaveProperty("wau");
      expect(result).toHaveProperty("mau");
    });
  });

  describe("getChannelActivity (ANLY-03)", () => {
    it("returns channel rankings", async () => {
      mockFindFirst.mockResolvedValueOnce({ id: "member-1", role: "admin" });
      mockFindMany.mockResolvedValueOnce([
        { channelId: "ch-1", name: "general", messageCount: 500 },
        { channelId: "ch-2", name: "random", messageCount: 300 },
      ]);

      const result = await getChannelActivity("org-1");

      expect(result[0].name).toBe("general");
      expect(result[0].messageCount).toBe(500);
    });
  });

  describe("getStorageUsage (ANLY-07)", () => {
    it("returns storage breakdown", async () => {
      mockFindFirst.mockResolvedValueOnce({ id: "member-1", role: "admin" });
      mockFindMany.mockResolvedValueOnce([
        { size: 1024 * 1024 }, // 1MB
        { size: 2 * 1024 * 1024 }, // 2MB
      ]);

      const result = await getStorageUsage("org-1");

      expect(result.totalBytes).toBe(3 * 1024 * 1024);
    });
  });
});
```
  </action>
  <verify>
Run `npm test src/lib/actions/__tests__/analytics.test.ts`:
- All tests pass
- Tests verify admin-only access
- Tests cover message volume, active users, channel activity, storage
  </verify>
  <done>
Analytics action tests provide coverage for ANLY-01 through ANLY-08
  </done>
</task>

<task type="auto">
  <name>Task 3: Create integration test for guest-group restriction (TEST-02)</name>
  <files>src/lib/actions/__tests__/guest-group-restriction.test.ts</files>
  <action>
Create integration-style test verifying GUST-07 (guests cannot be added to user groups):

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";
import { addMemberToGroup } from "../user-group";

// Standard mocks
vi.mock("next/headers", () => ({
  headers: vi.fn().mockResolvedValue(new Headers()),
}));
vi.mock("next/cache", () => ({ revalidatePath: vi.fn() }));

const mockGetSession = vi.fn();
vi.mock("@/lib/auth", () => ({
  auth: { api: { getSession: (...args: unknown[]) => mockGetSession(...args) } },
}));

const mockFindFirst = vi.fn();
vi.mock("@/db", () => ({
  db: {
    query: {
      userGroups: { findFirst: (...args: unknown[]) => mockFindFirst(...args) },
      members: { findFirst: (...args: unknown[]) => mockFindFirst(...args) },
      userGroupMembers: { findFirst: (...args: unknown[]) => mockFindFirst(...args) },
    },
    insert: vi.fn().mockReturnValue({
      values: () => ({ returning: () => Promise.resolve([{ id: "ugm-1" }]) }),
    }),
  },
}));

describe("Guest-Group Restriction (GUST-07, TEST-02)", () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockGetSession.mockResolvedValue({ user: { id: "admin-123" } });
  });

  it("prevents adding guest to user group", async () => {
    // Admin is making the request
    mockFindFirst
      .mockResolvedValueOnce({ id: "group-1", organizationId: "org-1" }) // group exists
      .mockResolvedValueOnce({ id: "admin-member", role: "admin" }) // requester is admin
      .mockResolvedValueOnce({ id: "guest-member", isGuest: true }); // target is guest

    await expect(
      addMemberToGroup("group-1", "guest-user-id")
    ).rejects.toThrow("Guests cannot be added to user groups");
  });

  it("allows adding regular member to user group", async () => {
    mockFindFirst
      .mockResolvedValueOnce({ id: "group-1", organizationId: "org-1" })
      .mockResolvedValueOnce({ id: "admin-member", role: "admin" })
      .mockResolvedValueOnce({ id: "regular-member", isGuest: false }) // not a guest
      .mockResolvedValueOnce(null); // not already in group

    const result = await addMemberToGroup("group-1", "regular-user-id");

    expect(result).toBeDefined();
  });

  it("prevents guest from viewing user groups list", async () => {
    // This tests that guests see no groups in autocomplete
    mockGetSession.mockResolvedValue({ user: { id: "guest-user" } });
    mockFindFirst.mockResolvedValueOnce({ id: "guest-member", isGuest: true });

    // Assuming getGroupsForMention checks guest status
    // The actual implementation may vary
  });
});
```

Note: If `addMemberToGroup` doesn't exist exactly as written, adjust to match actual function names from `user-group.ts`.
  </action>
  <verify>
Run `npm test src/lib/actions/__tests__/guest-group-restriction.test.ts`:
- Tests pass
- Guest rejection test validates GUST-07
- Integration test validates cross-feature interaction (TEST-02)
  </verify>
  <done>
Guest-group restriction test validates GUST-07 and satisfies TEST-02 requirement
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm test` - all tests pass
2. Run `npm run lint` - no lint errors
3. Tests cover Phase 28 features (guests, analytics)
4. Integration test validates guest-group restriction
</verification>

<success_criteria>
- guest.test.ts covers GUST requirements (invite, redeem, access, remove, extend)
- analytics.test.ts covers ANLY requirements (volume, users, activity, storage)
- guest-group-restriction.test.ts validates GUST-07 (TEST-02 integration test)
- All tests verify admin-only access where required
- Tests use established mocking pattern
</success_criteria>

<output>
After completion, create `.planning/phases/29-stabilization/29-11-SUMMARY.md`
</output>
