---
phase: 29-stabilization
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - src/lib/actions/user-status.ts
  - src/components/status/status-editor.tsx
  - src/components/workspace/workspace-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User status persists to database after save"
    - "UI refreshes to show saved status after save operation"
    - "Status appears in sidebar on page reload"
  artifacts:
    - path: "src/lib/actions/user-status.ts"
      provides: "Working status persistence"
      exports: ["setUserStatus"]
    - path: "src/components/status/status-editor.tsx"
      provides: "Status editor with working save"
      contains: "handleSave"
  key_links:
    - from: "src/components/status/status-editor.tsx"
      to: "src/lib/actions/user-status.ts"
      via: "setUserStatus call"
      pattern: "setUserStatus"
---

<objective>
Investigate and fix BUG-26-01: User status not persisting after save.

Purpose: Status feature is currently broken - saves appear to succeed but data doesn't persist.
Output: Working user status that persists to database and displays correctly after save/reload.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-stabilization/29-RESEARCH.md
@.planning/todos/pending/2026-01-21-phase26-status-bugs.md

Source files:
@src/lib/actions/user-status.ts
@src/components/status/status-editor.tsx
@src/components/workspace/workspace-sidebar.tsx
@src/db/schema/user-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose user status persistence issue</name>
  <files>src/lib/actions/user-status.ts, src/components/status/status-editor.tsx</files>
  <action>
Read and trace the code flow to identify where the bug occurs:

1. **Check setUserStatus action** (user-status.ts):
   - Verify the upsert logic is correct
   - Check if db.insert/db.update is being called correctly
   - Look for any async/await issues that might cause silent failures
   - Check if the function returns the saved status

2. **Check StatusEditor component** (status-editor.tsx):
   - Verify handleSave calls setUserStatus correctly
   - Check if form data is being passed correctly (emoji, text, expiresAt, dndEnabled)
   - Look for any state synchronization issues
   - Check if onClose callback updates parent state

3. **Check data flow from sidebar**:
   - How is currentStatus fetched and passed to StatusEditor?
   - Is there a re-fetch after save or does it rely on revalidatePath?
   - Does the sidebar component refresh after status save?

Add temporary console.log statements to trace:
```typescript
// In setUserStatus:
console.log("setUserStatus called with:", input);
// After db operation:
console.log("setUserStatus result:", result);

// In StatusEditor handleSave:
console.log("handleSave input:", { emoji, text, expiresAt, dndEnabled });
```

Run the app and test status save to see where the flow breaks.
  </action>
  <verify>
After adding logging and testing:
- Identify whether the issue is in: action not being called, action not saving to DB, or UI not refreshing
- Document the root cause found
  </verify>
  <done>
Root cause of BUG-26-01 identified through code analysis and logging
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix the user status persistence bug</name>
  <files>src/lib/actions/user-status.ts, src/components/status/status-editor.tsx, src/components/workspace/workspace-sidebar.tsx</files>
  <action>
Based on diagnosis from Task 1, implement the fix.

**Common issues and fixes:**

If issue is in **setUserStatus action**:
- Fix the upsert logic (check if existing status query is correct)
- Ensure returning clause returns the saved record
- Add explicit error handling with throws instead of silent failures

If issue is in **StatusEditor component**:
- Ensure handleSave awaits the action call
- Pass all required fields to setUserStatus
- Call onClose with the new status to update parent state

If issue is in **data refresh**:
- Ensure revalidatePath triggers proper refresh
- Or add explicit state update in parent after successful save:
```typescript
// In sidebar:
const handleStatusSaved = (newStatus: UserStatus) => {
  setMyStatus(newStatus);
  setStatusEditorOpen(false);
};
```

If issue is in **cache invalidation**:
- Use more specific revalidatePath (e.g., the actual workspace path)
- Or use server action return value to update client state directly

**Expected fix pattern:**
```typescript
// In status-editor.tsx handleSave:
const handleSave = async () => {
  setIsLoading(true);
  try {
    const savedStatus = await setUserStatus({
      emoji: selectedEmoji,
      text: statusText,
      expiresAt: getExpirationDate(expiration),
      dndEnabled,
    });

    // Update parent state directly with returned status
    if (onStatusSaved) {
      onStatusSaved(savedStatus);
    }
    onClose();
  } catch (error) {
    console.error("Failed to save status:", error);
    // Show error to user
  } finally {
    setIsLoading(false);
  }
};
```

Remove temporary console.log statements after fix is verified.
  </action>
  <verify>
Test the fix:
1. Open status editor
2. Set emoji, text, expiration, DND
3. Click Save
4. Status should appear in sidebar immediately
5. Reload page - status should persist
6. Check database directly: `SELECT * FROM user_statuses WHERE user_id = '...'`
  </verify>
  <done>
User status saves correctly, persists to database, and displays in UI after save and page reload
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Manual test: Set status -> verify in sidebar -> reload -> verify persists
2. Manual test: Set expiration -> verify expiration job scheduled
3. Manual test: Enable DND -> verify notifications blocked
4. Run `npm run lint` and `npm run typecheck`
5. Run existing tests: `npm test`
</verification>

<success_criteria>
- BUG-26-01 fixed: User status persists after save
- Status displays in sidebar immediately after save (no reload needed)
- Status persists across page reloads
- Status expiration and DND continue to work
- Requirements STAT-02 through STAT-06 now functional
</success_criteria>

<output>
After completion, create `.planning/phases/29-stabilization/29-05-SUMMARY.md`
</output>
