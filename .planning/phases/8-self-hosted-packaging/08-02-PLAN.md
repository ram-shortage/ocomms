---
phase: 08-self-hosted-packaging
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/backup.sh
  - scripts/restore.sh
autonomous: true

must_haves:
  truths:
    - "Admin can backup all data"
    - "Admin can restore from backup"
    - "Backups include database and are compressed"
    - "Restore process is safe with confirmation"
  artifacts:
    - path: "scripts/backup.sh"
      provides: "PostgreSQL backup with pg_dump custom format"
      contains: "pg_dump -Fc"
    - path: "scripts/restore.sh"
      provides: "PostgreSQL restore with safety confirmation"
      contains: "pg_restore"
  key_links:
    - from: "scripts/backup.sh"
      to: "docker-compose.yml db service"
      via: "mounted /backups volume"
      pattern: "BACKUP_DIR"
    - from: "scripts/restore.sh"
      to: "docker-compose.yml db service"
      via: "pg_restore to ocomms database"
      pattern: "pg_restore.*ocomms"
---

<objective>
Create backup and restore scripts for PostgreSQL data management.

Purpose: Enable admins to backup and restore all platform data for disaster recovery.
Output: Shell scripts for pg_dump backup and pg_restore recovery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/8-self-hosted-packaging/08-RESEARCH.md
@.planning/phases/8-self-hosted-packaging/08-01-SUMMARY.md

# Docker setup from Plan 01
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backup script</name>
  <files>scripts/backup.sh</files>
  <action>
Create scripts/backup.sh with the following:

1. Shebang and strict mode:
   ```bash
   #!/bin/bash
   set -euo pipefail
   ```

2. Configuration variables with defaults:
   - BACKUP_DIR: defaults to /backups
   - TIMESTAMP: $(date +%Y%m%d_%H%M%S)
   - BACKUP_FILE: ${BACKUP_DIR}/ocomms_${TIMESTAMP}.dump
   - RETENTION_DAYS: defaults to 7
   - PGUSER: defaults to postgres
   - PGDATABASE: defaults to ocomms

3. Pre-flight checks:
   - Verify backup directory exists (mkdir -p)
   - Verify pg_dump is available

4. Backup execution:
   - Use pg_dump with custom format (-Fc) for compression and selective restore
   - Database: ocomms
   - Output to BACKUP_FILE

5. Backup verification:
   - Run pg_restore --list on backup file to verify integrity
   - Print backup file path and size

6. Retention cleanup:
   - Find and delete .dump files older than RETENTION_DAYS
   - Print count of cleaned files

7. Exit message with backup location

Script should be idempotent and safe to run multiple times.
  </action>
  <verify>
    - `cat scripts/backup.sh` shows pg_dump -Fc command
    - `bash -n scripts/backup.sh` validates syntax
    - Script has executable permission hint in comments
  </verify>
  <done>
    Backup script creates compressed PostgreSQL dumps with retention cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create restore script</name>
  <files>scripts/restore.sh</files>
  <action>
Create scripts/restore.sh with the following:

1. Shebang and strict mode:
   ```bash
   #!/bin/bash
   set -euo pipefail
   ```

2. Usage validation:
   - First argument is required (backup file path)
   - Print usage message if missing
   - Verify backup file exists

3. Configuration variables:
   - PGUSER: defaults to postgres
   - PGDATABASE: defaults to ocomms

4. Safety confirmation:
   - Print WARNING about destructive operation
   - Prompt for confirmation (y/N)
   - Exit if not confirmed

5. Pre-restore preparation:
   - Terminate existing connections to database:
     ```sql
     SELECT pg_terminate_backend(pid)
     FROM pg_stat_activity
     WHERE datname = 'ocomms' AND pid <> pg_backend_pid();
     ```
   - Drop database if exists
   - Create fresh database

6. Restore execution:
   - Use pg_restore with --clean --if-exists flags
   - Restore from specified backup file to ocomms database

7. Success message with restored file path

Script must be safe - requires explicit confirmation before destructive action.
  </action>
  <verify>
    - `cat scripts/restore.sh` shows confirmation prompt
    - `cat scripts/restore.sh` shows pg_restore command
    - `bash -n scripts/restore.sh` validates syntax
  </verify>
  <done>
    Restore script safely recovers database from backup with confirmation.
  </done>
</task>

</tasks>

<verification>
1. Scripts exist and are valid bash:
   - scripts/backup.sh passes `bash -n` check
   - scripts/restore.sh passes `bash -n` check

2. Backup script features:
   - Uses pg_dump -Fc (custom format)
   - Has retention cleanup
   - Verifies backup integrity

3. Restore script features:
   - Requires backup file argument
   - Has safety confirmation prompt
   - Terminates connections before restore
</verification>

<success_criteria>
- Admin can run backup.sh inside db container to create backup
- Admin can run restore.sh inside db container to restore from backup
- Backups are compressed with pg_dump custom format
- Restore requires explicit confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/8-self-hosted-packaging/08-02-SUMMARY.md`
</output>
