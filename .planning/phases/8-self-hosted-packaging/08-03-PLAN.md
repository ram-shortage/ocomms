---
phase: 08-self-hosted-packaging
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/export-data.ts
  - src/app/api/admin/export/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can export all data in standard format"
    - "Export includes organization, channels, messages, members"
    - "Export format is JSON for data portability"
    - "Export creates manifest with metadata"
  artifacts:
    - path: "scripts/export-data.ts"
      provides: "CLI data export script"
      contains: "exportData"
    - path: "src/app/api/admin/export/route.ts"
      provides: "HTTP endpoint for data export"
      exports: ["POST"]
  key_links:
    - from: "scripts/export-data.ts"
      to: "src/db/schema"
      via: "Drizzle queries"
      pattern: "db\\.query\\."
    - from: "src/app/api/admin/export/route.ts"
      to: "scripts/export-data.ts"
      via: "shared export logic"
      pattern: "exportOrganizationData"
---

<objective>
Create data export functionality for admin data portability.

Purpose: Enable admins to export all organization data in JSON format for GDPR compliance and data portability.
Output: Export script for CLI usage and API endpoint for admin dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/8-self-hosted-packaging/08-RESEARCH.md
@.planning/phases/8-self-hosted-packaging/08-01-SUMMARY.md

# Database schema for export
@src/db/schema/index.ts
@src/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data export script</name>
  <files>scripts/export-data.ts</files>
  <action>
Create scripts/export-data.ts with the following:

1. Imports:
   - drizzle from drizzle-orm/postgres-js
   - postgres from postgres
   - fs, path from node
   - Schema imports from @/db/schema

2. Create database connection (similar to src/db/index.ts):
   - Use DATABASE_URL env var
   - Create drizzle instance with schema

3. Export functions:

   a. exportOrganizationData(organizationId: string, outputDir: string):
      - Query organization with all related data:
        - Organization details
        - Members (with user info, excluding passwords)
        - Channels (with members, messages)
        - Direct messages (with participants, messages)
        - Reactions
        - Pinned messages
        - Notifications
        - Channel notification settings
        - Read states
      - Write to JSON files in timestamped directory:
        - organization.json (org details)
        - members.json (all members)
        - channels.json (channels with messages)
        - direct-messages.json (DMs with messages)
        - manifest.json (export metadata)

   b. Main function:
      - Parse CLI args for organizationId and outputDir
      - Call exportOrganizationData
      - Close database connection
      - Print export location

4. Manifest structure:
   ```json
   {
     "exportDate": "ISO timestamp",
     "format": "JSON",
     "version": "1.0",
     "organizationId": "uuid",
     "tables": ["organizations", "members", "channels", ...],
     "counts": { "members": N, "channels": N, "messages": N }
   }
   ```

5. Run with: `tsx scripts/export-data.ts <org-id> <output-dir>`
  </action>
  <verify>
    - `cat scripts/export-data.ts` shows exportOrganizationData function
    - Script imports from drizzle-orm
    - Script creates manifest.json
  </verify>
  <done>
    Export script queries all organization data and writes to JSON files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin export API endpoint</name>
  <files>src/app/api/admin/export/route.ts</files>
  <action>
Create src/app/api/admin/export/route.ts with the following:

1. Imports:
   - NextResponse from next/server
   - auth from @/lib/auth
   - db from @/db
   - Schema tables for querying
   - headers from next/headers

2. POST handler:
   - Authenticate user via auth.api.getSession
   - Verify user is owner of the organization (check member role)
   - Accept JSON body with organizationId

3. Export logic (inline, similar to script):
   - Query all organization data
   - Build export object with:
     - organization
     - members (without sensitive auth data)
     - channels (with messages)
     - directMessages (with messages)
     - manifest

4. Response:
   - Set Content-Type: application/json
   - Set Content-Disposition: attachment; filename="ocomms-export-{timestamp}.json"
   - Return JSON blob of all data

5. Error handling:
   - 401 for unauthenticated
   - 403 for non-owner users
   - 404 for organization not found
   - 500 for export errors

Note: This is a simple JSON response endpoint. For very large organizations,
a background job pattern would be better, but JSON download is sufficient for
most self-hosted deployments.
  </action>
  <verify>
    - `cat src/app/api/admin/export/route.ts` shows POST handler
    - Handler checks user is organization owner
    - Response includes Content-Disposition header
  </verify>
  <done>
    Admin API endpoint allows authenticated owners to download organization data as JSON.
  </done>
</task>

</tasks>

<verification>
1. Files exist:
   - scripts/export-data.ts
   - src/app/api/admin/export/route.ts

2. Script features:
   - Exports organization with all related data
   - Creates manifest with counts
   - Outputs to timestamped directory

3. API features:
   - Requires authentication
   - Requires owner role
   - Returns downloadable JSON
</verification>

<success_criteria>
- Admin can run CLI export script to export organization data
- Admin can call POST /api/admin/export to download data as JSON
- Export includes all organization data (members, channels, messages)
- Export format is standard JSON for portability
</success_criteria>

<output>
After completion, create `.planning/phases/8-self-hosted-packaging/08-03-SUMMARY.md`
</output>
