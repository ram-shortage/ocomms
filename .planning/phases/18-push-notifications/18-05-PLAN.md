---
phase: 18-push-notifications
plan: 05
type: execute
wave: 4
depends_on: ["18-03", "18-04"]
files_modified:
  - src/components/pwa/PWAProvider.tsx
  - src/app/(app)/workspace/[workspaceId]/settings/page.tsx
autonomous: false

must_haves:
  truths:
    - "Push permission prompt shows after PWA engagement"
    - "User can access push settings from workspace settings"
    - "Clicking notification opens correct conversation/channel"
    - "DM triggers push to recipient"
    - "Mention triggers push to mentioned user"
  artifacts:
    - path: "src/components/pwa/PWAProvider.tsx"
      provides: "Push prompt integration"
      contains: "PushPermissionPrompt"
    - path: "src/app/(app)/workspace/[workspaceId]/settings/page.tsx"
      provides: "Settings page with push panel"
      contains: "PushSettingsPanel"
  key_links:
    - from: "src/components/pwa/PWAProvider.tsx"
      to: "src/components/push/PushPermissionPrompt.tsx"
      via: "conditional render"
      pattern: "PushPermissionPrompt"
---

<objective>
Integrate push UI components and verify end-to-end push notification flow.

Purpose: Make push notifications accessible to users through the app UI, and verify the complete flow from message send to notification click works correctly.

Output: Push components integrated into app layout and settings, verified push flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-push-notifications/18-RESEARCH.md
@.planning/phases/18-push-notifications/18-03-SUMMARY.md
@.planning/phases/18-push-notifications/18-04-SUMMARY.md
@src/components/pwa/PWAProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate push prompt into PWAProvider</name>
  <files>
    - src/components/pwa/PWAProvider.tsx
  </files>
  <action>
Add push permission prompt to PWAProvider to show after engagement:

1. Import the prompt component:
```typescript
import { PushPermissionPrompt } from "@/components/push";
```

2. Add state for tracking prompt dismissal:
```typescript
const [pushPromptDismissed, setPushPromptDismissed] = useState(false);
```

3. Load dismissal state from localStorage on mount:
```typescript
useEffect(() => {
  const dismissed = localStorage.getItem("push-prompt-dismissed");
  if (dismissed) {
    setPushPromptDismissed(true);
  }
}, []);
```

4. Add handler for dismissal:
```typescript
const handlePushDismiss = () => {
  setPushPromptDismissed(true);
  localStorage.setItem("push-prompt-dismissed", "true");
};
```

5. Add push prompt to render, shown after engagement threshold is met (same engagement tracking as install prompt per Phase 15):
```typescript
// Show push prompt after engagement, if not dismissed and not already installed
// The engagement check should already exist from Phase 15
{hasEngaged && !pushPromptDismissed && (
  <div className="fixed bottom-20 right-4 z-50 max-w-sm">
    <PushPermissionPrompt
      onDismiss={handlePushDismiss}
      onSubscribed={handlePushDismiss}
    />
  </div>
)}
```

Position it above the install prompt if both are showing. The engagement tracking from Phase 15 (3 pages OR 30 seconds) determines when to show the prompt.
  </action>
  <verify>
Start dev server, navigate through app. After engagement threshold, push prompt should appear. Dismissing should persist across page loads.
  </verify>
  <done>
Push prompt shows after engagement, dismissal persists in localStorage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add push settings to workspace settings page</name>
  <files>
    - src/app/(app)/workspace/[workspaceId]/settings/page.tsx
  </files>
  <action>
Add push settings panel to workspace settings page:

1. Check if settings page exists. If not, create it at `src/app/(app)/workspace/[workspaceId]/settings/page.tsx`.

2. Import and add PushSettingsPanel:
```typescript
import { PushSettingsPanel } from "@/components/push";
```

3. Add section for notifications in the settings page:
```typescript
<section className="space-y-4">
  <h2 className="text-xl font-semibold">Notifications</h2>
  <PushSettingsPanel />
</section>
```

If the settings page doesn't exist yet, create a basic settings page structure:
```typescript
export default function SettingsPage() {
  return (
    <div className="container max-w-2xl py-8 space-y-8">
      <h1 className="text-2xl font-bold">Settings</h1>

      <section className="space-y-4">
        <h2 className="text-xl font-semibold">Notifications</h2>
        <PushSettingsPanel />
      </section>
    </div>
  );
}
```

This gives users a dedicated place to manage their push notification settings beyond the initial prompt.
  </action>
  <verify>
Navigate to /workspace/{id}/settings - push settings panel should be visible with current subscription status.
  </verify>
  <done>
Push settings accessible from workspace settings page.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify end-to-end push flow</name>
  <what-built>
Complete push notification infrastructure:
- VAPID configuration
- Push subscription storage
- Service worker push handlers
- Push delivery for DMs and mentions
- UI components for permission and settings
  </what-built>
  <how-to-verify>
Prerequisites:
1. Generate VAPID keys: `npx web-push generate-vapid-keys`
2. Add to .env.local:
   - VAPID_PUBLIC_KEY=<public key>
   - VAPID_PRIVATE_KEY=<private key>
   - VAPID_SUBJECT=mailto:test@example.com
   - NEXT_PUBLIC_VAPID_PUBLIC_KEY=<same public key>
3. Restart dev server

Test flow (requires two user accounts):

**Test 1: Enable push**
1. Login as User A in Chrome/Firefox (not Safari initially)
2. Navigate around until push prompt appears
3. Click "Enable Notifications" - browser permission dialog should appear
4. Grant permission - prompt should dismiss
5. Check /workspace/{id}/settings - should show "Disable Notifications" button

**Test 2: DM push (PUSH-03)**
1. Keep User A's browser open but switch to a different tab or minimize
2. In another browser/incognito, login as User B
3. Send a DM to User A
4. User A should receive a push notification with message preview
5. Click the notification - should open the DM conversation

**Test 3: Mention push (PUSH-04)**
1. User A is in a channel, browser backgrounded
2. User B posts a message with @UserA mention
3. User A should receive push notification "UserB mentioned you"
4. Click notification - should open the channel

**Test 4: No self-notification**
1. As User A with push enabled, send a message
2. User A should NOT receive a push for their own message

**Test 5: Unsubscribe**
1. Go to /workspace/{id}/settings
2. Click "Disable Notifications"
3. Send test DM - no push should be received
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe which tests failed and with what behavior.
  </resume-signal>
</task>

</tasks>

<verification>
1. Push prompt appears after engagement threshold
2. Push settings panel shows correct state
3. DM triggers push to recipient
4. Mention triggers push to mentioned user
5. Clicking notification opens correct URL
6. Unsubscribe works correctly
</verification>

<success_criteria>
- PUSH-01: VAPID keys configured (via env vars)
- PUSH-02: User can subscribe to push (double-permission pattern)
- PUSH-03: User receives push for DMs
- PUSH-04: User receives push for mentions
- PUSH-05: Clicking notification opens conversation
- PUSH-06: Per-channel settings already exist (channelNotificationSettings table)
</success_criteria>

<output>
After completion, create `.planning/phases/18-push-notifications/18-05-SUMMARY.md`
</output>
