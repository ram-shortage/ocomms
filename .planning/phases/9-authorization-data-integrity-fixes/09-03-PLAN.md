---
phase: 09-authorization-data-integrity-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/socket/handlers/reaction.ts
autonomous: true

must_haves:
  truths:
    - "reaction:toggle validates user is member of channel/DM where message exists"
    - "reaction:get validates user is member of channel/DM where message exists"
    - "Unauthorized reaction operations are rejected with error"
  artifacts:
    - path: "src/server/socket/handlers/reaction.ts"
      provides: "Authorization checks on reaction event handlers"
      contains: "channelMembers"
  key_links:
    - from: "src/server/socket/handlers/reaction.ts"
      to: "@/db/schema"
      via: "imports membership tables"
      pattern: "channelMembers|conversationParticipants"
---

<objective>
Add channel/DM membership validation to reaction event handlers.

Purpose: Currently, reaction:toggle and reaction:get accept any messageId without verifying the user has access to the message's channel/DM. An attacker could add reactions to or read reactions from messages in channels they don't belong to.

Output: Reaction handlers that validate the user is a member of the channel/DM containing the message before allowing reaction operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/server/socket/handlers/reaction.ts
@src/server/socket/handlers/message.ts (reference for membership validation pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper function for message access validation</name>
  <files>src/server/socket/handlers/reaction.ts</files>
  <action>
Add imports at top of file:
- `channelMembers` from `@/db/schema`
- `conversationParticipants` from `@/db/schema`

Add a helper function after imports:

```typescript
async function validateMessageAccess(
  userId: string,
  messageId: string
): Promise<{ authorized: boolean; message?: { channelId: string | null; conversationId: string | null } }> {
  // Get message to find which channel/DM it belongs to
  const [message] = await db
    .select({ channelId: messages.channelId, conversationId: messages.conversationId })
    .from(messages)
    .where(eq(messages.id, messageId))
    .limit(1);

  if (!message) {
    return { authorized: false };
  }

  // Validate membership in channel or conversation
  if (message.channelId) {
    const membership = await db
      .select()
      .from(channelMembers)
      .where(and(eq(channelMembers.channelId, message.channelId), eq(channelMembers.userId, userId)))
      .limit(1);
    return { authorized: membership.length > 0, message };
  } else if (message.conversationId) {
    const participation = await db
      .select()
      .from(conversationParticipants)
      .where(and(eq(conversationParticipants.conversationId, message.conversationId), eq(conversationParticipants.userId, userId)))
      .limit(1);
    return { authorized: participation.length > 0, message };
  }

  return { authorized: false };
}
```

Import `and` from `drizzle-orm` (already have `eq`).
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
Helper function exists that validates user has access to the message's channel/DM.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add authorization to reaction handlers</name>
  <files>src/server/socket/handlers/reaction.ts</files>
  <action>
Update both handlers to use validateMessageAccess:

1. **handleReactionToggle** (line ~16):
   - At the start of the function (after getting userId), call:
     ```typescript
     const { authorized, message } = await validateMessageAccess(userId, messageId);
     if (!authorized) {
       socket.emit("error", { message: "Not authorized to react to this message" });
       return;
     }
     ```
   - The function already queries the message later for room determination - can simplify by using `message` from validation
   - Update the room name determination to use the validated message data instead of re-querying

2. **handleGetReactions** (line ~103):
   - At the start of the function, call:
     ```typescript
     const { authorized } = await validateMessageAccess(socket.data.userId, messageId);
     if (!authorized) {
       callback({ success: false });
       return;
     }
     ```
   - Only proceed with fetching reactions if authorized
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Manual test: User not in channel tries reaction:toggle on a message in that channel - should receive error.
  </verify>
  <done>
Both reaction handlers validate channel/DM membership before performing operations.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Test scenario:
   - User A is member of Channel X, User B is not
   - Message M exists in Channel X
   - User B tries reaction:toggle on message M - should receive error
   - User B tries reaction:get on message M - should receive success: false
   - User A performs same operations - should succeed
</verification>

<success_criteria>
- reaction:toggle validates membership before adding/removing reaction
- reaction:get validates membership before returning reactions
- Unauthorized attempts receive appropriate error responses
- Authorized attempts work exactly as before
- Reaction broadcasts still go to correct room
</success_criteria>

<output>
After completion, create `.planning/phases/9-authorization-data-integrity-fixes/09-03-SUMMARY.md`
</output>
