---
phase: 09-authorization-data-integrity-fixes
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions/channel.ts
  - src/lib/actions/conversation.ts
autonomous: true

must_haves:
  truths:
    - "createChannel validates user is member of the organization"
    - "getChannels/getUserChannels validate user is member of the organization"
    - "joinChannel validates user is member of the organization"
    - "createConversation validates user is member of the organization"
    - "All participants in createConversation are validated as org members"
    - "Cross-org requests are rejected with error"
  artifacts:
    - path: "src/lib/actions/channel.ts"
      provides: "Organization membership validation on channel actions"
      contains: "members"
    - path: "src/lib/actions/conversation.ts"
      provides: "Organization membership validation on conversation actions"
      contains: "members"
  key_links:
    - from: "src/lib/actions/channel.ts"
      to: "@/db/schema"
      via: "queries members table for org validation"
      pattern: "members.*organizationId"
    - from: "src/lib/actions/conversation.ts"
      to: "@/db/schema"
      via: "queries members table for org validation"
      pattern: "members.*organizationId"
---

<objective>
Add organization membership validation to channel and conversation server actions.

Purpose: Currently, createChannel, getChannels, getUserChannels, joinChannel, and createConversation accept any organizationId without verifying the user is a member. An attacker could create channels in organizations they don't belong to, view channel lists of other orgs, or start DMs with users from other orgs.

Output: Server actions that validate organization membership before allowing operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/actions/channel.ts
@src/lib/actions/conversation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add organization validation to channel.ts actions</name>
  <files>src/lib/actions/channel.ts</files>
  <action>
Add a helper function at the top of the file (after imports):

```typescript
async function validateOrgMembership(userId: string, organizationId: string): Promise<boolean> {
  const membership = await db.query.members.findFirst({
    where: and(
      eq(members.userId, userId),
      eq(members.organizationId, organizationId)
    ),
  });
  return !!membership;
}
```

Update these functions to validate org membership:

1. **createChannel** (line ~17):
   - After session check, add:
   ```typescript
   const isOrgMember = await validateOrgMembership(session.user.id, formData.organizationId);
   if (!isOrgMember) throw new Error("Not a member of this organization");
   ```

2. **getChannels** (line ~52):
   - After session check, add:
   ```typescript
   const isOrgMember = await validateOrgMembership(session.user.id, organizationId);
   if (!isOrgMember) throw new Error("Not a member of this organization");
   ```

3. **getUserChannels** (line ~69):
   - After session check, add:
   ```typescript
   const isOrgMember = await validateOrgMembership(session.user.id, organizationId);
   if (!isOrgMember) throw new Error("Not a member of this organization");
   ```

4. **joinChannel** (line ~85):
   - After getting channel, add org membership check:
   ```typescript
   const isOrgMember = await validateOrgMembership(session.user.id, channel.organizationId);
   if (!isOrgMember) throw new Error("Not a member of this organization");
   ```

5. **getWorkspaceMembers** (line ~252):
   - After session check, add:
   ```typescript
   const isOrgMember = await validateOrgMembership(session.user.id, organizationId);
   if (!isOrgMember) throw new Error("Not a member of this organization");
   ```

Import `and` from drizzle-orm (already have `eq`).
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
All channel actions that accept organizationId validate user is a member of that organization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add organization validation to conversation.ts actions</name>
  <files>src/lib/actions/conversation.ts</files>
  <action>
Add a helper function at the top (after imports):

```typescript
async function validateOrgMembership(userId: string, organizationId: string): Promise<boolean> {
  const membership = await db.query.members.findFirst({
    where: and(
      eq(members.userId, userId),
      eq(members.organizationId, organizationId)
    ),
  });
  return !!membership;
}
```

Import `members` from `@/db/schema` (if not already imported).

Update createConversation (line ~10):

1. After session check, validate the requesting user is an org member:
```typescript
const isOrgMember = await validateOrgMembership(session.user.id, formData.organizationId);
if (!isOrgMember) throw new Error("Not a member of this organization");
```

2. Validate ALL participants are members of the organization:
```typescript
// Validate all participants are org members
for (const participantId of formData.participantIds) {
  const isParticipantMember = await validateOrgMembership(participantId, formData.organizationId);
  if (!isParticipantMember) {
    throw new Error("One or more participants are not members of this organization");
  }
}
```

Place this validation BEFORE the existing conversation check and creation logic.

Import `and` from drizzle-orm (already have `eq`).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Manual test: Try to create a conversation with a user from a different organization - should throw error.
  </verify>
  <done>
createConversation validates all users involved are members of the specified organization.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Test scenario:
   - User A is in Org X, User B is in Org Y
   - User A tries createChannel in Org Y - should throw "Not a member of this organization"
   - User A tries createConversation in Org X with User B as participant - should throw error about participants
   - User A creates channel/conversation in Org X - should succeed
</verification>

<success_criteria>
- createChannel rejects requests for organizations user isn't a member of
- getChannels/getUserChannels reject cross-org queries
- joinChannel verifies user belongs to the channel's organization
- createConversation verifies all participants are org members
- getWorkspaceMembers rejects cross-org queries
- Authorized requests work exactly as before
</success_criteria>

<output>
After completion, create `.planning/phases/9-authorization-data-integrity-fixes/09-05-SUMMARY.md`
</output>
