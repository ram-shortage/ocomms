---
phase: 09-authorization-data-integrity-fixes
plan: 08
type: execute
wave: 2
depends_on: []
files_modified:
  - src/app/api/admin/export/route.ts
autonomous: true

must_haves:
  truths:
    - "Export only includes data from the requesting user's organization membership"
    - "Notification filtering only returns notifications for the requested org's channels"
    - "Cannot export data from an organization user doesn't own"
  artifacts:
    - path: "src/app/api/admin/export/route.ts"
      provides: "Properly scoped data export"
      contains: "filter.*conversationId"
  key_links:
    - from: "src/app/api/admin/export/route.ts"
      to: "@/db/schema"
      via: "filters notifications to org channels and conversations"
      pattern: "filter.*channelIds"
---

<objective>
Fix export endpoint to properly scope all data to the requesting organization.

Purpose: The current export has two issues:
1. Line 81: Membership check queries any membership, not specifically user's membership for the requested org
2. Line 220-224: Notification filtering for conversationIds doesn't verify they belong to the org

Output: Export endpoint that properly validates ownership and scopes all data to the organization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/admin/export/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ownership check to properly validate user's org membership</name>
  <files>src/app/api/admin/export/route.ts</files>
  <action>
Fix the ownership verification logic (lines 76-95).

**Current broken logic:**
```typescript
// Verify user is owner of the organization
const membership = await db.query.members.findFirst({
  where: eq(members.organizationId, organizationId),  // Gets ANY member
});

// Find user's membership
const userMembership = await db.query.members.findFirst({
  where: eq(members.userId, session.user.id),  // Gets ANY of user's memberships
});

// Check if user's membership is for this org and is owner
const isOwner =
  userMembership?.organizationId === organizationId &&
  userMembership?.role === "owner";
```

**Replace with correct single query:**
```typescript
// Verify user is owner of the organization
const userMembership = await db.query.members.findFirst({
  where: and(
    eq(members.organizationId, organizationId),
    eq(members.userId, session.user.id)
  ),
});

const isOwner = userMembership?.role === "owner";

if (!isOwner) {
  return NextResponse.json(
    { error: "Only organization owners can export data" },
    { status: 403 }
  );
}
```

Import `and` from drizzle-orm (already have `eq`).

Remove the redundant first `membership` query that wasn't being used properly.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Export correctly validates that requesting user is owner of the specific organization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix notification filtering to scope conversation notifications to org</name>
  <files>src/app/api/admin/export/route.ts</files>
  <action>
Fix the notification filtering (lines 214-226).

**Current broken logic:**
```typescript
// Filter to only notifications for this org's channels/conversations
const orgNotifications = userNotifications.filter(
  (n) =>
    (n.channelId && channelIds.includes(n.channelId)) ||
    n.conversationId  // BUG: includes ALL conversation notifications, not just this org's
);
```

**Replace with correct logic:**
```typescript
// Get conversation IDs that belong to this org (already have orgConversations)
const conversationIds = orgConversations.map((c) => c.id);

// Filter to only notifications for this org's channels/conversations
const orgNotifications = userNotifications.filter(
  (n) =>
    (n.channelId && channelIds.includes(n.channelId)) ||
    (n.conversationId && conversationIds.includes(n.conversationId))
);
```

Move the `conversationIds` extraction BEFORE the notification loop (around line 210, after orgConversations is populated).

This ensures conversation notifications are also scoped to the organization being exported.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Manual test: Export with user who has DMs in multiple orgs - export should only contain DMs from the requested org.
  </verify>
  <done>
Export notification filtering correctly scopes to organization's channels AND conversations.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Test scenarios:
   - User owns Org A but not Org B
   - Try to export Org B - should get 403 error
   - Export Org A - should succeed with only Org A's data
   - User has DMs in both orgs - export should only include Org A's DM notifications
</verification>

<success_criteria>
- Export endpoint correctly validates requesting user owns the organization
- Notifications are scoped to both channels AND conversations within the org
- Cannot export data from organizations user doesn't own
- Export includes all appropriate data for the organization
</success_criteria>

<output>
After completion, create `.planning/phases/9-authorization-data-integrity-fixes/09-08-SUMMARY.md`
</output>
