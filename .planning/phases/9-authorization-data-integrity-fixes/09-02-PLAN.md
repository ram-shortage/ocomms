---
phase: 09-authorization-data-integrity-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/socket/handlers/thread.ts
autonomous: true

must_haves:
  truths:
    - "thread:reply validates user is member of channel/DM where parent message exists"
    - "thread:join validates user is member of channel/DM where thread's parent message exists"
    - "thread:getReplies validates user is member of channel/DM before returning replies"
    - "Unauthorized thread operations are rejected with error"
  artifacts:
    - path: "src/server/socket/handlers/thread.ts"
      provides: "Authorization checks on all thread event handlers"
      contains: "channelMembers"
  key_links:
    - from: "src/server/socket/handlers/thread.ts"
      to: "@/db/schema"
      via: "imports membership tables"
      pattern: "channelMembers|conversationParticipants"
---

<objective>
Add channel/DM membership validation to all thread event handlers.

Purpose: Currently, thread:reply, thread:join, thread:leave, and thread:getReplies accept any threadId without verifying the user has access to the parent message's channel/DM. An attacker could read/write thread replies in channels they don't belong to.

Output: Thread handlers that validate the user is a member of the channel/DM containing the parent message before allowing any thread operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/server/socket/handlers/thread.ts
@src/server/socket/handlers/message.ts (reference for membership validation pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper function for thread access validation</name>
  <files>src/server/socket/handlers/thread.ts</files>
  <action>
Add a helper function at the top of thread.ts (after imports):

```typescript
async function validateThreadAccess(
  userId: string,
  threadId: string
): Promise<{ authorized: boolean; parent?: typeof messages.$inferSelect }> {
  // Get parent message to find which channel/DM it belongs to
  const [parent] = await db
    .select()
    .from(messages)
    .where(and(eq(messages.id, threadId), isNull(messages.deletedAt)))
    .limit(1);

  if (!parent) {
    return { authorized: false };
  }

  // Validate membership in channel or conversation
  if (parent.channelId) {
    const membership = await db
      .select()
      .from(channelMembers)
      .where(and(eq(channelMembers.channelId, parent.channelId), eq(channelMembers.userId, userId)))
      .limit(1);
    return { authorized: membership.length > 0, parent };
  } else if (parent.conversationId) {
    const participation = await db
      .select()
      .from(conversationParticipants)
      .where(and(eq(conversationParticipants.conversationId, parent.conversationId), eq(conversationParticipants.userId, userId)))
      .limit(1);
    return { authorized: participation.length > 0, parent };
  }

  return { authorized: false };
}
```

Add necessary imports:
- Import `channelMembers` from `@/db/schema` (already have messages imported)
- Import `conversationParticipants` from `@/db/schema`
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
Helper function exists that looks up parent message and validates membership in its channel/DM.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add authorization to all thread handlers</name>
  <files>src/server/socket/handlers/thread.ts</files>
  <action>
Update each handler to use validateThreadAccess:

1. **handleThreadReply** (line ~15):
   - handleThreadReply already looks up parent message - reuse that lookup
   - AFTER getting parent, add membership check before inserting reply:
   ```typescript
   if (parent.channelId) {
     const membership = await db.select().from(channelMembers)
       .where(and(eq(channelMembers.channelId, parent.channelId), eq(channelMembers.userId, userId)))
       .limit(1);
     if (membership.length === 0) {
       socket.emit("error", { message: "Not authorized to reply in this thread" });
       callback?.({ success: false });
       return;
     }
   } else if (parent.conversationId) {
     const participation = await db.select().from(conversationParticipants)
       .where(and(eq(conversationParticipants.conversationId, parent.conversationId), eq(conversationParticipants.userId, userId)))
       .limit(1);
     if (participation.length === 0) {
       socket.emit("error", { message: "Not authorized to reply in this thread" });
       callback?.({ success: false });
       return;
     }
   }
   ```

2. **handleJoinThread** (line ~158):
   - Call validateThreadAccess(socket.data.userId, data.threadId)
   - If not authorized, emit error and return WITHOUT joining room
   - Only call socket.join() if authorized

3. **handleLeaveThread** (line ~167):
   - No authorization needed - user can always leave a room they're in

4. **handleGetReplies** (line ~176):
   - Call validateThreadAccess(socket.data.userId, data.threadId)
   - If not authorized, call callback({ success: false }) and return
   - Only return replies if authorized
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Manual test: User not in channel tries to call thread:reply for a message in that channel - should receive error.
  </verify>
  <done>
All thread handlers (reply, join, getReplies) validate channel/DM membership before performing operations.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Test scenario:
   - User A is member of Channel X, User B is not
   - Message M exists in Channel X with some replies
   - User B tries thread:join for message M - should receive error
   - User B tries thread:getReplies for message M - should receive success: false
   - User B tries thread:reply to message M - should receive error
   - User A performs same operations - should succeed
</verification>

<success_criteria>
- thread:reply validates membership before creating reply
- thread:join validates membership before joining thread room
- thread:getReplies validates membership before returning replies
- Unauthorized attempts receive appropriate error responses
- Authorized attempts work exactly as before
</success_criteria>

<output>
After completion, create `.planning/phases/9-authorization-data-integrity-fixes/09-02-SUMMARY.md`
</output>
