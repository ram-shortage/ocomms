---
phase: 09-authorization-data-integrity-fixes
plan: 07
type: execute
wave: 2
depends_on: []
files_modified:
  - src/db/schema/channel.ts
  - src/db/schema/conversation.ts
  - prisma/migrations (new migration)
autonomous: true

must_haves:
  truths:
    - "User deletion does not violate foreign key constraints"
    - "Channel createdBy references remain valid after user deletion (set to system user or null)"
    - "Conversation createdBy references remain valid after user deletion"
  artifacts:
    - path: "src/db/schema/channel.ts"
      provides: "createdBy FK with onDelete behavior that doesn't violate constraints"
      contains: "onDelete"
    - path: "src/db/schema/conversation.ts"
      provides: "createdBy FK with onDelete behavior that doesn't violate constraints"
      contains: "onDelete"
  key_links:
    - from: "src/db/schema/channel.ts"
      to: "src/db/schema/auth.ts"
      via: "createdBy references users.id"
      pattern: "references.*users.id"
---

<objective>
Fix foreign key constraint violation when deleting users who created channels or conversations.

Purpose: Currently, channels.createdBy and conversations.createdBy have `onDelete: "set null"`, but the columns are marked as `notNull()`. When a user is deleted, the DB tries to set null on a NOT NULL column, causing a constraint violation.

Output: Schema changes that allow user deletion without constraint violations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/db/schema/channel.ts (line 15-17: createdBy is notNull but onDelete is set null)
@src/db/schema/conversation.ts (line 12-14: same issue)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix channel.ts createdBy FK constraint</name>
  <files>src/db/schema/channel.ts</files>
  <action>
The issue is that `createdBy` is marked `notNull()` but `onDelete: "set null"`.

Two options:
A) Remove notNull() - allow createdBy to be null when user deleted
B) Change to onDelete: "restrict" - prevent deleting users who created channels

Option A is better for user management (allows deleting users cleanly).

Update line 15-17 in channel.ts:

**From:**
```typescript
createdBy: text("created_by")
  .notNull()
  .references(() => users.id, { onDelete: "set null" }),
```

**To:**
```typescript
createdBy: text("created_by")
  .references(() => users.id, { onDelete: "set null" }),
```

This removes the `.notNull()` constraint, allowing NULL values when the creator is deleted.

Note: Existing rows will still have createdBy values - this just allows future NULLs.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
channels.createdBy allows NULL values, enabling SET NULL on user deletion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix conversation.ts createdBy FK constraint</name>
  <files>src/db/schema/conversation.ts</files>
  <action>
Same fix for conversations.

Update line 12-14:

**From:**
```typescript
createdBy: text("created_by")
  .notNull()
  .references(() => users.id, { onDelete: "set null" }),
```

**To:**
```typescript
createdBy: text("created_by")
  .references(() => users.id, { onDelete: "set null" }),
```

This removes the `.notNull()` constraint.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
conversations.createdBy allows NULL values, enabling SET NULL on user deletion.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate and run database migration</name>
  <files>Database migration</files>
  <action>
Generate and apply the migration:

```bash
npx drizzle-kit generate
npx drizzle-kit push
```

The migration should alter the columns to remove the NOT NULL constraint.

After migration, verify by checking the column definition:
```sql
SELECT column_name, is_nullable
FROM information_schema.columns
WHERE table_name IN ('channels', 'conversations')
  AND column_name = 'created_by';
```

Expected: is_nullable = 'YES' for both.
  </action>
  <verify>
Migration runs without errors.
Test: Can delete a user who created a channel - channel.createdBy becomes NULL, no FK violation.
  </verify>
  <done>
Database schema allows NULL in createdBy columns, user deletion no longer violates FK constraints.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Migration applies successfully
3. Test scenario:
   - User A creates Channel X
   - Admin deletes User A
   - Channel X still exists with createdBy = NULL
   - No constraint violation errors
</verification>

<success_criteria>
- channels.createdBy column allows NULL
- conversations.createdBy column allows NULL
- Deleting a user who created channels/conversations succeeds
- Foreign key SET NULL behavior works correctly
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/9-authorization-data-integrity-fixes/09-07-SUMMARY.md`
</output>
