---
phase: 19-mobile-layout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/layout.tsx
  - src/app/globals.css
  - src/lib/pwa/use-is-mobile.ts
  - src/lib/pwa/index.ts
  - src/app/(workspace)/[workspaceSlug]/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Safe area CSS functions work on notched devices (viewportFit: cover enabled)"
    - "Browser pull-to-refresh is disabled globally (overscroll-behavior-y: contain)"
    - "Full-height containers use dvh not vh (keyboard doesn't break layout)"
    - "useIsMobile hook detects mobile viewport without hydration mismatch"
  artifacts:
    - path: "src/app/layout.tsx"
      provides: "Viewport metadata with viewportFit and interactiveWidget"
      contains: "viewportFit: \"cover\""
    - path: "src/app/globals.css"
      provides: "Global overscroll behavior and touch target utility"
      contains: "overscroll-behavior-y: contain"
    - path: "src/lib/pwa/use-is-mobile.ts"
      provides: "SSR-safe mobile detection hook"
      exports: ["useIsMobile"]
    - path: "src/app/(workspace)/[workspaceSlug]/layout.tsx"
      provides: "Responsive container with dvh height"
      contains: "h-dvh"
  key_links:
    - from: "src/lib/pwa/use-is-mobile.ts"
      to: "useSyncExternalStore"
      via: "matchMedia listener"
      pattern: "useSyncExternalStore"
---

<objective>
Establish CSS and viewport foundations for mobile layout support.

Purpose: Enable safe-area CSS functions, prevent browser pull-to-refresh conflicts, fix virtual keyboard issues with dvh, and provide SSR-safe mobile detection hook.

Output: Viewport config with safe-area support, global CSS utilities, useIsMobile hook, and updated container heights.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-mobile-layout/19-RESEARCH.md

Reference files:
@src/app/layout.tsx
@src/app/globals.css
@src/lib/pwa/use-online-status.ts (pattern to follow for useIsMobile)
@src/app/(workspace)/[workspaceSlug]/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update viewport config and global CSS</name>
  <files>src/app/layout.tsx, src/app/globals.css</files>
  <action>
    In src/app/layout.tsx, update the viewport export to add:
    - viewportFit: "cover" (REQUIRED for safe-area-inset-* CSS functions to work)
    - interactiveWidget: "resizes-content" (Chrome/Firefox keyboard resize, harmless on Safari)

    The viewport export should look like:
    ```typescript
    export const viewport: Viewport = {
      themeColor: "#000000",
      width: "device-width",
      initialScale: 1,
      maximumScale: 1,
      userScalable: false,
      viewportFit: "cover",
      interactiveWidget: "resizes-content",
    };
    ```

    In src/app/globals.css, add to the @layer base section (after the existing rules):
    - body { overscroll-behavior-y: contain; } to disable browser pull-to-refresh globally

    Also add a @layer utilities section with a touch-target utility:
    ```css
    @layer utilities {
      .touch-target {
        @apply min-h-11 min-w-11;
      }
    }
    ```
  </action>
  <verify>
    - Check viewport meta in browser DevTools shows viewport-fit=cover
    - Pull down on mobile Chrome/Safari should NOT trigger browser refresh
    - Run `npm run build` to verify no TypeScript errors
  </verify>
  <done>
    Viewport config includes viewportFit: "cover" and interactiveWidget: "resizes-content".
    Global CSS disables browser overscroll and provides touch-target utility class.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useIsMobile hook</name>
  <files>src/lib/pwa/use-is-mobile.ts, src/lib/pwa/index.ts</files>
  <action>
    Create src/lib/pwa/use-is-mobile.ts following the useSyncExternalStore pattern from use-online-status.ts:

    ```typescript
    "use client";

    import { useSyncExternalStore } from "react";

    const MOBILE_BREAKPOINT = 768; // md breakpoint in Tailwind

    function getIsMobile(): boolean {
      if (typeof window === "undefined") return false;
      return window.innerWidth < MOBILE_BREAKPOINT;
    }

    function subscribeIsMobile(callback: () => void) {
      if (typeof window === "undefined") return () => {};

      const mediaQuery = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`);
      mediaQuery.addEventListener("change", callback);

      return () => mediaQuery.removeEventListener("change", callback);
    }

    export function useIsMobile() {
      return useSyncExternalStore(
        subscribeIsMobile,
        getIsMobile,
        () => false // Server snapshot - assume desktop for SSR (CSS handles initial mobile render)
      );
    }
    ```

    Update src/lib/pwa/index.ts barrel export to include:
    - export { useIsMobile } from "./use-is-mobile";

    Why SSR returns false: CSS responsive classes handle initial render correctly.
    The hook is only needed for JS-based logic decisions, not layout switching.
  </action>
  <verify>
    - Import { useIsMobile } from "@/lib/pwa" works
    - Hook returns true on narrow viewport (< 768px), false on wide
    - No hydration mismatch errors in console on page load
  </verify>
  <done>
    useIsMobile hook exists, exported from barrel, uses useSyncExternalStore with matchMedia.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update workspace layout to use dvh</name>
  <files>src/app/(workspace)/[workspaceSlug]/layout.tsx</files>
  <action>
    Update the container div from `h-screen` to `h-dvh`.

    Change:
    ```tsx
    <div className="flex h-screen">
    ```

    To:
    ```tsx
    <div className="flex h-dvh">
    ```

    Why: dvh (dynamic viewport height) accounts for browser chrome and virtual keyboards.
    h-screen uses 100vh which breaks on mobile Safari when keyboard opens.

    No other changes to this file in this task - responsive sidebar/tabs switching comes in Plan 02.
  </action>
  <verify>
    - Open app on mobile Safari with keyboard visible - layout should not overflow
    - Use Chrome DevTools mobile emulation with keyboard overlay
    - Verify `h-dvh` class is present in rendered HTML
  </verify>
  <done>
    Workspace layout uses h-dvh for keyboard-safe full-height container.
  </done>
</task>

</tasks>

<verification>
1. Viewport meta tag in page source shows viewport-fit=cover
2. CSS rule `overscroll-behavior-y: contain` applies to body
3. `.touch-target` utility available in Tailwind
4. `useIsMobile` hook importable and reactive to viewport changes
5. Workspace container uses `h-dvh` class
6. No hydration mismatch errors in browser console
7. `npm run build` completes without errors
</verification>

<success_criteria>
- Safe-area CSS functions (env(safe-area-inset-*)) are enabled via viewportFit
- Browser native pull-to-refresh disabled via overscroll-behavior
- Virtual keyboard doesn't break layout via dvh
- Mobile detection hook ready for use in Plan 02
- All existing functionality continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/19-mobile-layout/19-01-SUMMARY.md`
</output>
