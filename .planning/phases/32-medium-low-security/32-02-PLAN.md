---
phase: 32-medium-low-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/user-storage.ts
  - src/db/schema/index.ts
  - src/lib/security/storage-quota.ts
  - src/app/api/upload/route.ts
  - src/components/settings/storage-usage.tsx
  - src/app/(workspace)/[workspaceSlug]/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User storage usage is tracked per upload"
    - "Warning toast appears at 80% quota"
    - "Upload blocked at 100% quota with clear message"
    - "User can view current storage usage in settings"
  artifacts:
    - path: "src/db/schema/user-storage.ts"
      provides: "User storage quota tracking table"
      contains: "userStorage"
    - path: "src/lib/security/storage-quota.ts"
      provides: "Quota checking and updating utilities"
      exports: ["checkQuota", "updateUsage", "getUserStorage"]
    - path: "src/components/settings/storage-usage.tsx"
      provides: "Storage usage display component"
      exports: ["StorageUsage"]
  key_links:
    - from: "src/app/api/upload/route.ts"
      to: "src/lib/security/storage-quota.ts"
      via: "checkQuota before upload"
      pattern: "checkQuota|updateUsage"
---

<objective>
Implement per-user storage quota tracking with 1GB default, warning at 80%, and blocking at 100%.

Purpose: Prevent storage abuse with configurable per-user limits (SEC2-10)
Output: Storage tracking schema, quota utilities, upload integration, settings display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-medium-low-security/32-CONTEXT.md
@.planning/phases/32-medium-low-security/32-RESEARCH.md

@src/db/schema/file-attachment.ts
@src/app/api/upload/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage quota schema and utilities</name>
  <files>
    src/db/schema/user-storage.ts
    src/db/schema/index.ts
    src/lib/security/storage-quota.ts
  </files>
  <action>
1. Create `src/db/schema/user-storage.ts`:
   ```typescript
   import { pgTable, text, bigint, timestamp } from "drizzle-orm/pg-core";
   import { relations } from "drizzle-orm";
   import { users } from "./auth";

   export const userStorage = pgTable("user_storage", {
     userId: text("user_id").primaryKey().references(() => users.id, { onDelete: "cascade" }),
     usedBytes: bigint("used_bytes", { mode: "number" }).notNull().default(0),
     quotaBytes: bigint("quota_bytes", { mode: "number" }).notNull().default(1073741824), // 1GB
     updatedAt: timestamp("updated_at").notNull().defaultNow(),
   });

   export const userStorageRelations = relations(userStorage, ({ one }) => ({
     user: one(users, {
       fields: [userStorage.userId],
       references: [users.id],
     }),
   }));
   ```

2. Update `src/db/schema/index.ts`:
   - Add `export * from "./user-storage";`

3. Run `npx drizzle-kit generate` then `npx drizzle-kit push`

4. Create `src/lib/security/storage-quota.ts`:
   ```typescript
   import { db } from "@/db";
   import { userStorage } from "@/db/schema";
   import { eq } from "drizzle-orm";

   const DEFAULT_QUOTA = 1073741824; // 1GB in bytes
   const WARNING_THRESHOLD = 0.8; // 80%

   export type QuotaCheckResult = {
     allowed: boolean;
     currentUsage: number;
     quota: number;
     percentUsed: number;
     showWarning: boolean;
   };

   export async function getOrCreateUserStorage(userId: string) {
     let storage = await db.query.userStorage.findFirst({
       where: eq(userStorage.userId, userId),
     });

     if (!storage) {
       const [created] = await db.insert(userStorage)
         .values({ userId, usedBytes: 0, quotaBytes: DEFAULT_QUOTA })
         .returning();
       storage = created;
     }

     return storage;
   }

   export async function checkQuota(userId: string, uploadSizeBytes: number): Promise<QuotaCheckResult> {
     const storage = await getOrCreateUserStorage(userId);
     const projectedUsage = storage.usedBytes + uploadSizeBytes;
     const percentUsed = projectedUsage / storage.quotaBytes;

     return {
       allowed: projectedUsage <= storage.quotaBytes,
       currentUsage: storage.usedBytes,
       quota: storage.quotaBytes,
       percentUsed: Math.min(percentUsed, 1),
       showWarning: percentUsed >= WARNING_THRESHOLD && percentUsed < 1,
     };
   }

   export async function updateUsage(userId: string, deltaSizeBytes: number): Promise<void> {
     const storage = await getOrCreateUserStorage(userId);
     await db.update(userStorage)
       .set({
         usedBytes: Math.max(0, storage.usedBytes + deltaSizeBytes),
         updatedAt: new Date(),
       })
       .where(eq(userStorage.userId, userId));
   }

   export async function getUserStorage(userId: string) {
     return getOrCreateUserStorage(userId);
   }

   export function formatBytes(bytes: number): string {
     if (bytes === 0) return "0 B";
     const k = 1024;
     const sizes = ["B", "KB", "MB", "GB"];
     const i = Math.floor(Math.log(bytes) / Math.log(k));
     return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
   }
   ```
  </action>
  <verify>
    - `npm run build` succeeds
    - `npx drizzle-kit push` succeeds
    - Import and test: checkQuota returns correct structure
  </verify>
  <done>
    - user_storage table created in database
    - Quota utilities exported and functional
    - Default 1GB quota, 80% warning threshold
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate quota into upload API and add settings display</name>
  <files>
    src/app/api/upload/route.ts
    src/components/settings/storage-usage.tsx
    src/app/(workspace)/[workspaceSlug]/settings/page.tsx
  </files>
  <action>
1. Update `src/app/api/upload/route.ts`:
   a. Add import: `import { checkQuota, updateUsage } from "@/lib/security/storage-quota";`

   b. After authentication check, before processing file:
      ```typescript
      // Check storage quota
      const fileSize = file.size; // or calculate from buffer
      const quotaCheck = await checkQuota(session.user.id, fileSize);

      if (!quotaCheck.allowed) {
        return NextResponse.json(
          {
            error: "Storage quota exceeded",
            details: {
              currentUsage: quotaCheck.currentUsage,
              quota: quotaCheck.quota,
              percentUsed: quotaCheck.percentUsed,
            },
          },
          { status: 413 } // Payload Too Large
        );
      }
      ```

   c. After successful file save, update usage:
      ```typescript
      await updateUsage(session.user.id, fileSize);
      ```

   d. Include showWarning in success response:
      ```typescript
      return NextResponse.json({
        ...fileData,
        quotaWarning: quotaCheck.showWarning,
        quotaPercentUsed: quotaCheck.percentUsed,
      });
      ```

2. Create `src/components/settings/storage-usage.tsx`:
   ```tsx
   "use client";

   import { useState } from "react";
   import { Button } from "@/components/ui/button";
   import { Progress } from "@/components/ui/progress";
   import { formatBytes } from "@/lib/security/storage-quota";

   interface StorageData {
     usedBytes: number;
     quotaBytes: number;
   }

   export function StorageUsage() {
     const [storage, setStorage] = useState<StorageData | null>(null);
     const [loading, setLoading] = useState(false);

     const fetchStorage = async () => {
       setLoading(true);
       try {
         const res = await fetch("/api/user/storage");
         if (res.ok) {
           setStorage(await res.json());
         }
       } finally {
         setLoading(false);
       }
     };

     const percentUsed = storage
       ? Math.round((storage.usedBytes / storage.quotaBytes) * 100)
       : 0;

     return (
       <div className="space-y-4">
         <div className="flex items-center justify-between">
           <h3 className="text-lg font-medium">Storage Usage</h3>
           <Button variant="outline" size="sm" onClick={fetchStorage} disabled={loading}>
             {loading ? "Loading..." : storage ? "Refresh" : "View Usage"}
           </Button>
         </div>

         {storage && (
           <div className="space-y-2">
             <Progress value={percentUsed} className="h-2" />
             <p className="text-sm text-muted-foreground">
               {formatBytes(storage.usedBytes)} of {formatBytes(storage.quotaBytes)} used ({percentUsed}%)
             </p>
             {percentUsed >= 80 && (
               <p className="text-sm text-yellow-600">
                 You are approaching your storage limit. Consider deleting unused files.
               </p>
             )}
           </div>
         )}
       </div>
     );
   }
   ```

3. Create API route `src/app/api/user/storage/route.ts`:
   ```typescript
   import { NextResponse } from "next/server";
   import { auth } from "@/lib/auth";
   import { headers } from "next/headers";
   import { getUserStorage } from "@/lib/security/storage-quota";

   export async function GET() {
     const session = await auth.api.getSession({ headers: await headers() });
     if (!session?.user) {
       return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
     }

     const storage = await getUserStorage(session.user.id);
     return NextResponse.json({
       usedBytes: storage.usedBytes,
       quotaBytes: storage.quotaBytes,
     });
   }
   ```

4. Update settings page to include StorageUsage:
   - Find the settings page and add <StorageUsage /> component in appropriate section
   - Import StorageUsage from "@/components/settings/storage-usage"

5. Update upload UI to show warning toast when quotaWarning is true:
   - In the component that handles upload response, check for quotaWarning
   - Show toast: "You're using over 80% of your storage quota"
  </action>
  <verify>
    - Upload a file -> usedBytes increases in user_storage table
    - Upload when at >80% capacity -> warning toast shows
    - Upload when at 100% capacity -> 413 error returned
    - Settings page shows "View Usage" button that loads storage info
    - `npm run build` succeeds
  </verify>
  <done>
    - Uploads check quota before processing
    - Uploads blocked at 100% with clear error
    - Warning shown at 80%
    - Settings page shows storage usage on demand
  </done>
</task>

</tasks>

<verification>
1. Upload file -> user_storage.usedBytes updated
2. Upload large file when near quota -> warning toast
3. Upload when over quota -> 413 error with details
4. Settings page -> View Usage shows progress bar
5. Delete file -> usedBytes decreases (if delete triggers updateUsage)
6. `npm run lint` passes
7. `npm run build` succeeds
</verification>

<success_criteria>
- Storage usage tracked per user with 1GB default
- Warning toast at 80% (non-blocking)
- Upload blocked at 100% with clear message
- User can view current usage in settings on demand
- Admins can set per-user quota overrides (via direct DB update for now)
</success_criteria>

<output>
After completion, create `.planning/phases/32-medium-low-security/32-02-SUMMARY.md`
</output>
