---
phase: 32-medium-low-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/security/breach-check.ts
  - src/db/schema/password-history.ts
  - src/db/schema/index.ts
  - src/lib/auth.ts
  - src/components/auth/register-form.tsx
  - src/components/settings/change-password-form.tsx
autonomous: true

must_haves:
  truths:
    - "Password 'password123' shows breach warning on registration"
    - "Breach warning can be dismissed with confirmation"
    - "Password change checks against last 5 passwords"
    - "Reused password shows error and blocks change"
  artifacts:
    - path: "src/lib/security/breach-check.ts"
      provides: "Bloom filter password breach checking"
      exports: ["isPasswordBreached", "initBreachFilter"]
    - path: "src/db/schema/password-history.ts"
      provides: "Password history tracking for reuse check"
      contains: "passwordHistory"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/security/breach-check.ts"
      via: "import in before hook"
      pattern: "isPasswordBreached"
    - from: "src/lib/auth.ts"
      to: "src/db/schema/password-history.ts"
      via: "query in after hook"
      pattern: "passwordHistory"
---

<objective>
Implement password breach checking using local bloom filter and password history to prevent reuse of last 5 passwords.

Purpose: Prevent users from using commonly breached passwords (SEC2-09) and reusing recent passwords (SEC2-20)
Output: Breach check utility, password history schema, integrated auth hooks
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-medium-low-security/32-CONTEXT.md
@.planning/phases/32-medium-low-security/32-RESEARCH.md

@src/lib/auth.ts
@src/lib/password-validation.ts
@src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bloom filter breach check and password history schema</name>
  <files>
    src/lib/security/breach-check.ts
    src/db/schema/password-history.ts
    src/db/schema/index.ts
  </files>
  <action>
1. Install bloom-filters package:
   `npm install bloom-filters`

2. Create `src/lib/security/breach-check.ts`:
   - Import BloomFilter from 'bloom-filters'
   - Create a hardcoded array of top 100 most common breached passwords (password, 123456, password123, admin, letmein, welcome, monkey, dragon, master, qwerty, 111111, abc123, login, admin123, 123456789, password1, etc.)
   - Initialize BloomFilter.from(passwords, 0.01) - 1% false positive rate
   - Export `isPasswordBreached(password: string): boolean` that checks filter.has(password.toLowerCase())
   - Add inline comment explaining this is a subset; production could use larger list

3. Create `src/db/schema/password-history.ts`:
   - Create passwordHistory table with:
     - id: uuid primary key
     - userId: text references users.id (onDelete cascade)
     - passwordHash: varchar(255) - bcrypt hash
     - createdAt: timestamp defaultNow
   - Add index on userId
   - Export passwordHistoryRelations (one user -> many history entries)

4. Update `src/db/schema/index.ts`:
   - Add `export * from "./password-history";`

5. Run `npx drizzle-kit generate` then `npx drizzle-kit push` to create table
  </action>
  <verify>
    - `npm run build` compiles without errors
    - `npx drizzle-kit push` succeeds
    - Bloom filter test: import and call isPasswordBreached("password") returns true, isPasswordBreached("xK9#mP2$nQ7@") returns false
  </verify>
  <done>
    - Bloom filter initialized with common passwords
    - isPasswordBreached function exported and working
    - password_history table exists in database
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate breach check and password history into auth hooks</name>
  <files>
    src/lib/auth.ts
    src/components/auth/register-form.tsx
    src/components/settings/change-password-form.tsx
  </files>
  <action>
1. Update `src/lib/auth.ts`:
   a. Add imports:
      - `import { isPasswordBreached } from "./security/breach-check";`
      - `import { passwordHistory } from "@/db/schema";`
      - `import bcrypt from "bcryptjs";`

   b. In the BEFORE hook for /sign-up/email:
      - After password complexity validation, check isPasswordBreached(password)
      - If breached and NO `bypassBreachWarning: true` in body, return APIError with:
        message: "This password appeared in data breaches. Choose a different one."
        code: "PASSWORD_BREACHED" (custom code for UI handling)
      - If bypassBreachWarning is true, allow to proceed (user dismissed warning)

   c. In the BEFORE hook for /change-password:
      - Check isPasswordBreached for newPassword (same logic as signup)
      - Query password history for userId (from session):
        ```typescript
        const history = await db.query.passwordHistory.findMany({
          where: eq(passwordHistory.userId, session.user.id),
          orderBy: desc(passwordHistory.createdAt),
          limit: 5
        });
        ```
      - Check newPassword against all history hashes using bcrypt.compare
      - If ANY match, throw APIError "You cannot reuse your last 5 passwords"

   d. In the AFTER hook for /change-password (on success):
      - Get password hash from the user record (or hash the newPassword)
      - Insert into passwordHistory: { userId, passwordHash }
      - Delete oldest entries if > 5 exist for this user

2. Update `src/components/auth/register-form.tsx`:
   - Add state: `const [breachWarning, setBreachWarning] = useState(false);`
   - On form submit error, check if error.code === "PASSWORD_BREACHED"
   - If so, show dismissable warning dialog with:
     - Text: "This password appeared in data breaches. Choose a different one."
     - "Choose Different Password" button (closes dialog, focuses password field)
     - "I understand the risk, use anyway" button (sets bypassBreachWarning=true, resubmits)
   - Use existing dialog/alert component patterns from codebase

3. Update `src/components/settings/change-password-form.tsx`:
   - Same breach warning logic as register form
   - Show "password reused" error as regular form error (no bypass option)
  </action>
  <verify>
    - Register with "password" -> breach warning dialog appears
    - Click "use anyway" -> registration proceeds
    - Change password to one of last 5 -> error shown
    - `npm run build` succeeds
  </verify>
  <done>
    - Breached passwords trigger dismissable warning on registration
    - Password reuse blocked on change password
    - Password history stored on successful password change
  </done>
</task>

</tasks>

<verification>
1. Manual test: Register with password "password123" -> breach warning appears
2. Manual test: Dismiss warning and register anyway -> account created
3. Manual test: Change password to previous password -> reuse error
4. Manual test: Change password to new password -> success, history stored
5. `npm run lint` passes
6. `npm run build` succeeds
</verification>

<success_criteria>
- Common breached passwords (password, 123456, admin, etc.) trigger warning
- Warning is dismissable with "I understand" confirmation
- Password change checks against last 5 passwords in history
- Password reuse is blocked (not dismissable)
- No regressions in existing auth flow
</success_criteria>

<output>
After completion, create `.planning/phases/32-medium-low-security/32-01-SUMMARY.md`
</output>
