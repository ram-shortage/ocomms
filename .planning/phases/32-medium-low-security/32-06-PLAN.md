---
phase: 32-medium-low-security
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth.ts
  - src/db/schema/auth.ts
  - src/components/settings/mfa-setup.tsx
  - src/app/(workspace)/[workspaceSlug]/settings/security/page.tsx
  - src/lib/auth-client.ts
autonomous: false

must_haves:
  truths:
    - "User can enable MFA with TOTP authenticator app"
    - "QR code displayed for TOTP setup"
    - "10 backup codes generated and shown once"
    - "MFA verification required on login when enabled"
    - "Password confirmation required before enabling MFA"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "better-auth with twoFactor plugin"
      contains: "twoFactor"
    - path: "src/components/settings/mfa-setup.tsx"
      provides: "MFA setup UI with QR code"
      exports: ["MFASetup"]
  key_links:
    - from: "src/components/settings/mfa-setup.tsx"
      to: "better-auth twoFactor"
      via: "authClient.twoFactor.enable"
      pattern: "twoFactor\\.enable"
---

<objective>
Implement TOTP-based MFA using better-auth's twoFactor plugin with QR code setup and backup codes.

Purpose: Add optional two-factor authentication for enhanced account security (SEC2-21)
Output: MFA plugin configuration, setup UI with QR code, backup code display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-medium-low-security/32-CONTEXT.md
@.planning/phases/32-medium-low-security/32-RESEARCH.md

@src/lib/auth.ts
@src/lib/auth-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure better-auth twoFactor plugin</name>
  <files>
    src/lib/auth.ts
    src/lib/auth-client.ts
    src/db/schema/auth.ts
  </files>
  <action>
1. Install qrcode package for client-side QR generation:
   `npm install qrcode`
   `npm install -D @types/qrcode`

2. Update `src/lib/auth.ts` to add twoFactor plugin:
   ```typescript
   import { twoFactor } from "better-auth/plugins";

   export const auth = betterAuth({
     // ... existing config ...
     plugins: [
       organization({
         // ... existing org config ...
       }),
       twoFactor({
         issuer: "OComms",
         skipVerificationOnEnable: false, // Require code verification before activating
         totpOptions: {
           digits: 6,
           period: 30, // 30-second window
         },
         backupCodeOptions: {
           amount: 10, // 10 backup codes per user decision
           length: 10, // 10 character codes
         },
       }),
     ],
   });
   ```

3. Update `src/lib/auth-client.ts` to include twoFactor client:
   ```typescript
   import { twoFactorClient } from "better-auth/client/plugins";

   export const authClient = createAuthClient({
     baseURL: process.env.NEXT_PUBLIC_APP_URL,
     plugins: [
       organizationClient(),
       twoFactorClient(),
     ],
   });

   // Export typed client methods
   export const { twoFactor } = authClient;
   ```

4. Run database migration (better-auth twoFactor adds columns to user table):
   - better-auth should auto-manage schema, but verify:
   - Check if twoFactorEnabled, twoFactorSecret columns exist
   - If using drizzle, may need to add to schema/auth.ts:
   ```typescript
   // If needed, add to users table:
   twoFactorEnabled: boolean("two_factor_enabled").default(false),
   twoFactorSecret: text("two_factor_secret"),
   ```
   - Run `npx drizzle-kit push` if schema changed
  </action>
  <verify>
    - `npm run build` succeeds
    - authClient.twoFactor methods available (enable, verify, disable)
    - Database has twoFactorEnabled column
  </verify>
  <done>
    - better-auth twoFactor plugin configured
    - Client-side twoFactor methods available
    - Database schema updated for MFA
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MFA setup UI</name>
  <files>
    src/components/settings/mfa-setup.tsx
    src/app/(workspace)/[workspaceSlug]/settings/security/page.tsx
  </files>
  <action>
1. Create `src/components/settings/mfa-setup.tsx`:
   ```tsx
   "use client";

   import { useState } from "react";
   import QRCode from "qrcode";
   import { authClient } from "@/lib/auth-client";
   import { Button } from "@/components/ui/button";
   import { Input } from "@/components/ui/input";
   import { Label } from "@/components/ui/label";
   import {
     Dialog,
     DialogContent,
     DialogDescription,
     DialogHeader,
     DialogTitle,
   } from "@/components/ui/dialog";
   import {
     Card,
     CardContent,
     CardDescription,
     CardHeader,
     CardTitle,
   } from "@/components/ui/card";
   import { toast } from "sonner";
   import { Copy, Shield, ShieldCheck, ShieldOff } from "lucide-react";

   interface MFASetupProps {
     enabled: boolean;
     onStatusChange: () => void;
   }

   type SetupStep = "idle" | "password" | "qr" | "verify" | "backup" | "complete";

   export function MFASetup({ enabled, onStatusChange }: MFASetupProps) {
     const [step, setStep] = useState<SetupStep>("idle");
     const [password, setPassword] = useState("");
     const [qrDataUrl, setQrDataUrl] = useState<string | null>(null);
     const [totpUri, setTotpUri] = useState<string | null>(null);
     const [backupCodes, setBackupCodes] = useState<string[]>([]);
     const [verifyCode, setVerifyCode] = useState("");
     const [loading, setLoading] = useState(false);
     const [error, setError] = useState<string | null>(null);

     const startSetup = () => {
       setStep("password");
       setError(null);
     };

     const handlePasswordSubmit = async () => {
       setLoading(true);
       setError(null);

       try {
         const { data, error } = await authClient.twoFactor.enable({
           password,
         });

         if (error) {
           setError(error.message || "Failed to start MFA setup");
           return;
         }

         if (data?.totpURI) {
           // Generate QR code from TOTP URI
           const qr = await QRCode.toDataURL(data.totpURI);
           setQrDataUrl(qr);
           setTotpUri(data.totpURI);
           setBackupCodes(data.backupCodes || []);
           setStep("qr");
         }
       } catch (err) {
         setError("An error occurred");
       } finally {
         setLoading(false);
       }
     };

     const handleVerify = async () => {
       setLoading(true);
       setError(null);

       try {
         const { error } = await authClient.twoFactor.verifyTotp({
           code: verifyCode,
         });

         if (error) {
           setError(error.message || "Invalid code");
           return;
         }

         setStep("backup");
       } catch (err) {
         setError("Verification failed");
       } finally {
         setLoading(false);
       }
     };

     const handleComplete = () => {
       setStep("complete");
       onStatusChange();
       toast.success("Two-factor authentication enabled");
     };

     const handleDisable = async () => {
       setLoading(true);
       try {
         const { error } = await authClient.twoFactor.disable({
           password,
         });

         if (error) {
           toast.error(error.message || "Failed to disable MFA");
           return;
         }

         onStatusChange();
         toast.success("Two-factor authentication disabled");
         setStep("idle");
       } finally {
         setLoading(false);
       }
     };

     const copyBackupCodes = () => {
       navigator.clipboard.writeText(backupCodes.join("\n"));
       toast.success("Backup codes copied to clipboard");
     };

     if (enabled) {
       return (
         <Card>
           <CardHeader>
             <CardTitle className="flex items-center gap-2">
               <ShieldCheck className="h-5 w-5 text-green-500" />
               Two-Factor Authentication Enabled
             </CardTitle>
             <CardDescription>
               Your account is protected with two-factor authentication.
             </CardDescription>
           </CardHeader>
           <CardContent>
             <Dialog>
               <Button variant="destructive" onClick={() => setStep("password")}>
                 Disable 2FA
               </Button>
               {step === "password" && (
                 <div className="mt-4 space-y-4">
                   <Label>Enter password to disable 2FA</Label>
                   <Input
                     type="password"
                     value={password}
                     onChange={(e) => setPassword(e.target.value)}
                     placeholder="Your password"
                   />
                   <Button onClick={handleDisable} disabled={loading}>
                     {loading ? "Disabling..." : "Confirm Disable"}
                   </Button>
                 </div>
               )}
             </Dialog>
           </CardContent>
         </Card>
       );
     }

     return (
       <Card>
         <CardHeader>
           <CardTitle className="flex items-center gap-2">
             <Shield className="h-5 w-5" />
             Two-Factor Authentication
           </CardTitle>
           <CardDescription>
             Add an extra layer of security to your account using an authenticator app.
           </CardDescription>
         </CardHeader>
         <CardContent>
           {step === "idle" && (
             <Button onClick={startSetup}>
               Enable Two-Factor Authentication
             </Button>
           )}

           {step === "password" && (
             <div className="space-y-4">
               <Label>Enter your password to continue</Label>
               <Input
                 type="password"
                 value={password}
                 onChange={(e) => setPassword(e.target.value)}
                 placeholder="Your password"
               />
               {error && <p className="text-sm text-red-500">{error}</p>}
               <div className="flex gap-2">
                 <Button onClick={handlePasswordSubmit} disabled={loading || !password}>
                   {loading ? "Loading..." : "Continue"}
                 </Button>
                 <Button variant="outline" onClick={() => setStep("idle")}>
                   Cancel
                 </Button>
               </div>
             </div>
           )}

           {step === "qr" && qrDataUrl && (
             <div className="space-y-4">
               <p className="text-sm text-muted-foreground">
                 Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)
               </p>
               <div className="flex justify-center">
                 <img src={qrDataUrl} alt="TOTP QR Code" className="border rounded" />
               </div>
               <p className="text-xs text-muted-foreground text-center">
                 Or enter manually: {totpUri?.split("secret=")[1]?.split("&")[0]}
               </p>
               <Button onClick={() => setStep("verify")} className="w-full">
                 I&apos;ve scanned the code
               </Button>
             </div>
           )}

           {step === "verify" && (
             <div className="space-y-4">
               <Label>Enter the 6-digit code from your authenticator app</Label>
               <Input
                 type="text"
                 value={verifyCode}
                 onChange={(e) => setVerifyCode(e.target.value.replace(/\D/g, "").slice(0, 6))}
                 placeholder="000000"
                 maxLength={6}
                 className="text-center text-2xl tracking-widest"
               />
               {error && <p className="text-sm text-red-500">{error}</p>}
               <Button onClick={handleVerify} disabled={loading || verifyCode.length !== 6}>
                 {loading ? "Verifying..." : "Verify Code"}
               </Button>
             </div>
           )}

           {step === "backup" && (
             <div className="space-y-4">
               <p className="text-sm font-medium">
                 Save your backup codes
               </p>
               <p className="text-sm text-muted-foreground">
                 These codes can be used to access your account if you lose your authenticator.
                 Each code can only be used once. Store them safely!
               </p>
               <div className="bg-muted p-4 rounded font-mono text-sm">
                 {backupCodes.map((code, i) => (
                   <div key={i}>{code}</div>
                 ))}
               </div>
               <div className="flex gap-2">
                 <Button variant="outline" onClick={copyBackupCodes}>
                   <Copy className="h-4 w-4 mr-2" />
                   Copy Codes
                 </Button>
                 <Button onClick={handleComplete}>
                   I&apos;ve saved my codes
                 </Button>
               </div>
             </div>
           )}
         </CardContent>
       </Card>
     );
   }
   ```

2. Create or update security settings page `src/app/(workspace)/[workspaceSlug]/settings/security/page.tsx`:
   ```tsx
   import { auth } from "@/lib/auth";
   import { headers } from "next/headers";
   import { redirect } from "next/navigation";
   import { MFASetup } from "@/components/settings/mfa-setup";

   export default async function SecuritySettingsPage() {
     const session = await auth.api.getSession({ headers: await headers() });

     if (!session?.user) {
       redirect("/login");
     }

     // Get MFA status from user record
     const user = session.user as { twoFactorEnabled?: boolean };

     return (
       <div className="space-y-6">
         <div>
           <h2 className="text-2xl font-bold">Security Settings</h2>
           <p className="text-muted-foreground">
             Manage your account security settings
           </p>
         </div>

         <MFASetup
           enabled={user.twoFactorEnabled ?? false}
           onStatusChange={() => {
             // Refresh page to get updated status
             window.location.reload();
           }}
         />
       </div>
     );
   }
   ```

3. Add security settings link to navigation if not exists:
   - Check existing settings page structure
   - Add link to /settings/security
  </action>
  <verify>
    - Navigate to settings > security
    - Click "Enable 2FA" -> password prompt
    - Enter password -> QR code displayed
    - Scan with authenticator app, enter code -> backup codes shown
    - Save codes, complete setup -> MFA enabled
    - `npm run build` succeeds
  </verify>
  <done>
    - MFA setup UI with QR code display
    - Password confirmation before enabling
    - 10 backup codes generated and shown
    - MFA can be disabled with password
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>TOTP-based MFA setup flow with QR code and backup codes</what-built>
  <how-to-verify>
    1. Go to Settings > Security
    2. Click "Enable Two-Factor Authentication"
    3. Enter your password
    4. Scan QR code with Google Authenticator or Authy
    5. Enter 6-digit code from app
    6. Verify 10 backup codes are displayed
    7. Click "I've saved my codes"
    8. Log out and log back in
    9. Verify you're prompted for 2FA code
    10. Enter code from authenticator app
    11. Verify login succeeds
  </how-to-verify>
  <resume-signal>Type "approved" if MFA flow works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. MFA setup shows password confirmation first
2. QR code generates correctly and scans in authenticator app
3. Code verification works with correct code
4. Backup codes (10) displayed and can be copied
5. MFA status persists after page refresh
6. Login requires 2FA code when enabled
7. Backup code works for login (use once, then invalid)
8. MFA can be disabled with password
9. `npm run lint` passes
10. `npm run build` succeeds
</verification>

<success_criteria>
- User can enable MFA with TOTP authenticator app
- QR code displayed for easy setup
- 10 backup codes generated and shown once
- Password confirmation required before enabling MFA
- MFA verification required on login when enabled
</success_criteria>

<output>
After completion, create `.planning/phases/32-medium-low-security/32-06-SUMMARY.md`
</output>
