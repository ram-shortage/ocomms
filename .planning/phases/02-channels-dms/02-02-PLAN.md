---
phase: 02-channels-dms
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/components/channel/channel-header.tsx
  - src/components/channel/channel-settings.tsx
  - src/components/channel/invite-to-channel-dialog.tsx
  - src/lib/actions/channel.ts
  - src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx
  - src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/settings/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Member can leave a channel they joined"
    - "Member can set channel topic (short status line)"
    - "Member can set channel description (longer explanation)"
    - "Member can create a private channel"
    - "Admin can invite members to private channel"
  artifacts:
    - path: "src/components/channel/channel-header.tsx"
      provides: "Channel header with topic display and edit"
      exports: ["ChannelHeader"]
    - path: "src/components/channel/channel-settings.tsx"
      provides: "Channel description editing"
      exports: ["ChannelSettings"]
    - path: "src/components/channel/invite-to-channel-dialog.tsx"
      provides: "Invite member to private channel"
      exports: ["InviteToChannelDialog"]
    - path: "src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx"
      provides: "Individual channel view"
      min_lines: 30
  key_links:
    - from: "src/components/channel/channel-header.tsx"
      to: "src/lib/actions/channel.ts"
      via: "updateChannelTopic action"
      pattern: "updateChannelTopic"
    - from: "src/components/channel/invite-to-channel-dialog.tsx"
      to: "src/lib/actions/channel.ts"
      via: "inviteToChannel action"
      pattern: "inviteToChannel"
---

<objective>
Implement channel leave functionality, topic/description editing, private channel creation, and private channel invitation.

Purpose: Complete channel management features. Members need to leave channels, customize channel metadata, and handle private channel access.

Output: Full channel lifecycle management including leave, edit topic/description, create private channels, and invite to private channels.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/db/schema/channel.ts (channel schema from 02-01)
@src/lib/actions/channel.ts (channel actions from 02-01)
@src/components/channel/create-channel-dialog.tsx (create dialog pattern from 02-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Channel View with Leave and Topic/Description</name>
  <files>
    src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx
    src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/settings/page.tsx
    src/components/channel/channel-header.tsx
    src/components/channel/channel-settings.tsx
    src/lib/actions/channel.ts
  </files>
  <action>
Create channel view page and management features.

**1. Add server actions to src/lib/actions/channel.ts:**

```typescript
export async function leaveChannel(channelId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  // Check if user is the only admin
  const members = await db.query.channelMembers.findMany({
    where: eq(channelMembers.channelId, channelId),
  });

  const admins = members.filter((m) => m.role === "admin");
  const isOnlyAdmin = admins.length === 1 && admins[0].userId === session.user.id;

  if (isOnlyAdmin && members.length > 1) {
    throw new Error("Cannot leave: you are the only admin. Promote another member first.");
  }

  await db.delete(channelMembers).where(
    and(
      eq(channelMembers.channelId, channelId),
      eq(channelMembers.userId, session.user.id)
    )
  );

  revalidatePath(`/`);
  return { success: true };
}

export async function updateChannelTopic(channelId: string, topic: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  // Verify user is channel member
  const membership = await db.query.channelMembers.findFirst({
    where: and(
      eq(channelMembers.channelId, channelId),
      eq(channelMembers.userId, session.user.id)
    ),
  });

  if (!membership) throw new Error("Not a channel member");

  await db.update(channels)
    .set({ topic, updatedAt: new Date() })
    .where(eq(channels.id, channelId));

  revalidatePath(`/`);
  return { success: true };
}

export async function updateChannelDescription(channelId: string, description: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  // Verify user is channel admin
  const membership = await db.query.channelMembers.findFirst({
    where: and(
      eq(channelMembers.channelId, channelId),
      eq(channelMembers.userId, session.user.id)
    ),
  });

  if (!membership || membership.role !== "admin") {
    throw new Error("Only channel admins can update description");
  }

  await db.update(channels)
    .set({ description, updatedAt: new Date() })
    .where(eq(channels.id, channelId));

  revalidatePath(`/`);
  return { success: true };
}

export async function getChannel(organizationId: string, slug: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  const channel = await db.query.channels.findFirst({
    where: and(
      eq(channels.organizationId, organizationId),
      eq(channels.slug, slug)
    ),
    with: {
      members: {
        with: {
          user: true,
        },
      },
    },
  });

  if (!channel) return null;

  // Check access for private channels
  if (channel.isPrivate) {
    const isMember = channel.members.some((m) => m.userId === session.user.id);
    if (!isMember) return null;
  }

  return channel;
}
```

**2. Channel Page (src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx):**
Server component that:
- Fetches channel by slug using getChannel
- Shows 404 if channel not found or inaccessible
- Renders ChannelHeader with channel name, topic, member count
- Shows placeholder for messages ("Messages coming in Phase 3")
- Settings link for channel admins

**3. Channel Header (src/components/channel/channel-header.tsx):**
Client component with:
- Channel name with # prefix
- Editable topic line (click to edit inline, save on blur/enter)
- Member count and dropdown to view members
- Leave channel button (with confirmation dialog)
- Settings gear icon link (for admins only)

**4. Channel Settings Page (src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/settings/page.tsx):**
Server component for channel admin settings:
- Edit description (textarea)
- Member list with role management
- Delete channel option (future, leave placeholder)

**5. Channel Settings Component (src/components/channel/channel-settings.tsx):**
Client component with:
- Description textarea with save button
- Calls updateChannelDescription action
- Shows success/error feedback
  </action>
  <verify>
1. Navigate to channel page: /{workspace}/channels/{channel-slug}
2. Edit topic inline, verify it saves
3. Leave channel, verify redirect to workspace home and channel removed from sidebar
4. As admin, access settings and edit description
  </verify>
  <done>
- Channel page displays channel info with topic
- Members can edit channel topic inline
- Members can leave channels (with admin protection)
- Admins can edit channel description in settings
  </done>
</task>

<task type="auto">
  <name>Task 2: Private Channels and Invitations</name>
  <files>
    src/components/channel/create-channel-dialog.tsx
    src/components/channel/invite-to-channel-dialog.tsx
    src/lib/actions/channel.ts
  </files>
  <action>
Enable private channel creation and member invitation.

**1. Update create-channel-dialog.tsx:**
Enable the isPrivate checkbox (was disabled in 02-01):
- Checkbox labeled "Make channel private"
- Helper text: "Private channels are only visible to invited members"
- When checked, passes isPrivate: true to createChannel action

**2. Add invitation action to src/lib/actions/channel.ts:**

```typescript
export async function inviteToChannel(channelId: string, userId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  // Verify inviter is channel admin
  const inviterMembership = await db.query.channelMembers.findFirst({
    where: and(
      eq(channelMembers.channelId, channelId),
      eq(channelMembers.userId, session.user.id)
    ),
  });

  if (!inviterMembership || inviterMembership.role !== "admin") {
    throw new Error("Only channel admins can invite members");
  }

  // Verify channel is private (public channels use join, not invite)
  const channel = await db.query.channels.findFirst({
    where: eq(channels.id, channelId),
  });

  if (!channel) throw new Error("Channel not found");
  if (!channel.isPrivate) throw new Error("Public channels don't require invitations");

  // Verify target user is workspace member
  const orgMembers = await db.query.members.findMany({
    where: eq(members.organizationId, channel.organizationId),
  });

  const isOrgMember = orgMembers.some((m) => m.userId === userId);
  if (!isOrgMember) throw new Error("User is not a workspace member");

  // Add to channel
  await db.insert(channelMembers).values({
    channelId,
    userId,
    role: "member",
  }).onConflictDoNothing();

  revalidatePath(`/`);
  return { success: true };
}

export async function getWorkspaceMembers(organizationId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  const orgMembers = await db.query.members.findMany({
    where: eq(members.organizationId, organizationId),
    with: {
      user: true,
    },
  });

  return orgMembers;
}
```

Note: Need to import `members` from schema - this references the better-auth members table.

**3. Invite to Channel Dialog (src/components/channel/invite-to-channel-dialog.tsx):**
Client component with:
- Receives channelId and organizationId props
- Fetches workspace members via getWorkspaceMembers
- Displays list of members not already in channel
- Select member(s) with checkboxes
- "Invite" button calls inviteToChannel for each selected member
- Success toast showing invited member names

**4. Update Channel Header/Settings:**
- Show "Invite Members" button in header for private channel admins
- Opens InviteToChannelDialog
- Only visible for private channels and admin users

**5. Update Channel Directory:**
- Private channels show lock icon
- Private channels user is member of show in directory with "Joined" badge
- Private channels user is not member of are hidden from directory (already handled in getChannels filter)
  </action>
  <verify>
1. Create a private channel via dialog (check isPrivate checkbox)
2. Verify private channel appears in your sidebar but not in others' directory
3. As channel admin, invite another workspace member
4. Verify invited member can now see and access the private channel
  </verify>
  <done>
- CHAN-02: Members can create private channels
- CHAN-06: Admins can invite members to private channels
- Private channels hidden from non-members in directory
- Invited members gain access to private channels
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Leave functionality:**
   - Member can leave any channel they joined
   - Cannot leave if only admin with other members
   - After leaving, channel removed from sidebar

2. **Topic/Description:**
   - Any member can edit topic
   - Only admins can edit description
   - Changes persist and display correctly

3. **Private channels:**
   - Create private channel via dialog
   - Private channel hidden from non-members
   - Admin can invite workspace members
   - Invited members can access private channel

4. **Build verification:**
   - `npm run build` completes without errors
</verification>

<success_criteria>
- CHAN-02 (create private channel): isPrivate checkbox creates private channel
- CHAN-05 (leave channel): Leave button removes member from channel
- CHAN-06 (invite to private): Admin can invite members to private channel
- CHAN-07 (topic/description): Members can set topic, admins can set description
</success_criteria>

<output>
After completion, create `.planning/phases/02-channels-dms/02-02-SUMMARY.md`
</output>
