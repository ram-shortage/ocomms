---
phase: 02-channels-dms
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/channel.ts
  - src/db/schema/index.ts
  - src/components/channel/create-channel-dialog.tsx
  - src/components/channel/channel-list.tsx
  - src/components/channel/channel-directory.tsx
  - src/app/(workspace)/[workspaceSlug]/page.tsx
  - src/app/(workspace)/[workspaceSlug]/channels/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Member can create a public channel with name and optional description"
    - "Member can browse channel directory showing all public channels"
    - "Member can join a public channel from directory"
    - "Member sees their joined channels in sidebar"
  artifacts:
    - path: "src/db/schema/channel.ts"
      provides: "Channel and channel_members tables"
      contains: "pgTable.*channels"
    - path: "src/components/channel/create-channel-dialog.tsx"
      provides: "Channel creation UI"
      exports: ["CreateChannelDialog"]
    - path: "src/components/channel/channel-directory.tsx"
      provides: "Browse and join channels UI"
      exports: ["ChannelDirectory"]
  key_links:
    - from: "src/components/channel/create-channel-dialog.tsx"
      to: "src/db/schema/channel.ts"
      via: "server action insert"
      pattern: "db\\.insert\\(channels\\)"
    - from: "src/components/channel/channel-directory.tsx"
      to: "src/db/schema/channel.ts"
      via: "server action query"
      pattern: "db\\.select.*channels"
---

<objective>
Create channel database schema and implement public channel creation, browsing, and joining functionality.

Purpose: Establish channel primitives as conversation containers. Channels provide workspace-scoped spaces for group communication.

Output: Members can create public channels, browse the channel directory, and join channels. Joined channels appear in a sidebar list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/db/schema/auth.ts (organizations table for workspace reference)
@src/db/schema/index.ts (barrel export pattern)
@src/lib/auth.ts (better-auth config with organization plugin)
@src/app/(workspace)/[workspaceSlug]/page.tsx (current workspace page)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Channel Schema</name>
  <files>
    src/db/schema/channel.ts
    src/db/schema/index.ts
  </files>
  <action>
Create channel schema following the established Drizzle patterns from auth.ts:

**src/db/schema/channel.ts:**
```typescript
import { pgTable, text, timestamp, boolean, uuid, uniqueIndex } from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";
import { organizations, users } from "./auth";

export const channels = pgTable("channels", {
  id: uuid("id").primaryKey().defaultRandom(),
  organizationId: uuid("organization_id")
    .notNull()
    .references(() => organizations.id, { onDelete: "cascade" }),
  name: text("name").notNull(),
  slug: text("slug").notNull(),
  description: text("description"),
  topic: text("topic"),
  isPrivate: boolean("is_private").notNull().default(false),
  createdBy: uuid("created_by")
    .notNull()
    .references(() => users.id, { onDelete: "set null" }),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
}, (table) => [
  uniqueIndex("channels_org_slug_idx").on(table.organizationId, table.slug),
]);

export const channelMembers = pgTable("channel_members", {
  id: uuid("id").primaryKey().defaultRandom(),
  channelId: uuid("channel_id")
    .notNull()
    .references(() => channels.id, { onDelete: "cascade" }),
  userId: uuid("user_id")
    .notNull()
    .references(() => users.id, { onDelete: "cascade" }),
  role: text("role").notNull().default("member"), // member, admin
  joinedAt: timestamp("joined_at").notNull().defaultNow(),
}, (table) => [
  uniqueIndex("channel_members_unique_idx").on(table.channelId, table.userId),
]);

export const channelsRelations = relations(channels, ({ one, many }) => ({
  organization: one(organizations, {
    fields: [channels.organizationId],
    references: [organizations.id],
  }),
  creator: one(users, {
    fields: [channels.createdBy],
    references: [users.id],
  }),
  members: many(channelMembers),
}));

export const channelMembersRelations = relations(channelMembers, ({ one }) => ({
  channel: one(channels, {
    fields: [channelMembers.channelId],
    references: [channels.id],
  }),
  user: one(users, {
    fields: [channelMembers.userId],
    references: [users.id],
  }),
}));
```

Key design decisions:
- Unique index on (organization_id, slug) ensures unique channel names per workspace
- isPrivate boolean differentiates public vs private channels
- Channel creator automatically becomes admin member (handled in application logic)
- createdBy uses "set null" on delete to preserve channel if creator leaves

**Update src/db/schema/index.ts** to export channel schema:
```typescript
export * from "./auth";
export * from "./profile";
export * from "./channel";
```

After creating schema, run `npm run db:push` to apply to database.
  </action>
  <verify>
Run `npm run db:push` - should complete without errors.
Run `npx drizzle-kit studio` briefly to confirm channels and channel_members tables exist with correct columns.
  </verify>
  <done>
channels and channel_members tables exist in database with correct foreign keys and indexes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Channel CRUD and Directory UI</name>
  <files>
    src/components/channel/create-channel-dialog.tsx
    src/components/channel/channel-list.tsx
    src/components/channel/channel-directory.tsx
    src/app/(workspace)/[workspaceSlug]/page.tsx
    src/app/(workspace)/[workspaceSlug]/channels/page.tsx
    src/lib/actions/channel.ts
  </files>
  <action>
Create channel UI components and server actions following Phase 1 patterns (client components with server actions).

**1. Server Actions (src/lib/actions/channel.ts):**
```typescript
"use server";

import { db } from "@/db";
import { channels, channelMembers } from "@/db/schema";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { eq, and } from "drizzle-orm";
import { revalidatePath } from "next/cache";

function slugify(name: string): string {
  return name
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-|-$/g, "");
}

export async function createChannel(formData: {
  organizationId: string;
  name: string;
  description?: string;
  isPrivate?: boolean;
}) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  const slug = slugify(formData.name);

  // Create channel and add creator as admin member in transaction
  const [channel] = await db.transaction(async (tx) => {
    const [newChannel] = await tx.insert(channels).values({
      organizationId: formData.organizationId,
      name: formData.name,
      slug,
      description: formData.description || null,
      isPrivate: formData.isPrivate || false,
      createdBy: session.user.id,
    }).returning();

    await tx.insert(channelMembers).values({
      channelId: newChannel.id,
      userId: session.user.id,
      role: "admin",
    });

    return [newChannel];
  });

  revalidatePath(`/`);
  return channel;
}

export async function getChannels(organizationId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  // Get all public channels + private channels user is member of
  const allChannels = await db.query.channels.findMany({
    where: eq(channels.organizationId, organizationId),
    with: {
      members: true,
    },
  });

  return allChannels.filter(
    (ch) => !ch.isPrivate || ch.members.some((m) => m.userId === session.user.id)
  );
}

export async function getUserChannels(organizationId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  const userMemberships = await db.query.channelMembers.findMany({
    where: eq(channelMembers.userId, session.user.id),
    with: {
      channel: true,
    },
  });

  return userMemberships
    .filter((m) => m.channel.organizationId === organizationId)
    .map((m) => m.channel);
}

export async function joinChannel(channelId: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  // Check channel exists and is public
  const channel = await db.query.channels.findFirst({
    where: eq(channels.id, channelId),
  });

  if (!channel) throw new Error("Channel not found");
  if (channel.isPrivate) throw new Error("Cannot join private channel directly");

  await db.insert(channelMembers).values({
    channelId,
    userId: session.user.id,
    role: "member",
  }).onConflictDoNothing();

  revalidatePath(`/`);
  return { success: true };
}
```

**2. Create Channel Dialog (src/components/channel/create-channel-dialog.tsx):**
Client component with shadcn Dialog, form for name + description, calls createChannel action.
- Name field (required, min 2 chars)
- Description field (optional textarea)
- isPrivate checkbox (for Phase 02-02, include but disable for now with "Coming soon" tooltip)
- Submit creates channel and closes dialog
- Use shadcn/ui Dialog, Input, Textarea, Button, Checkbox

**3. Channel List (src/components/channel/channel-list.tsx):**
Server component that displays user's joined channels in sidebar format.
- Receives organizationId prop
- Fetches user's channels via getUserChannels
- Renders list with # prefix and channel name
- Links to /{workspaceSlug}/channels/{channelSlug}
- Shows "No channels yet" empty state with link to browse directory

**4. Channel Directory (src/components/channel/channel-directory.tsx):**
Client component for browsing and joining channels.
- Fetches all visible channels via getChannels
- Shows channel name, description, member count
- "Join" button for channels user hasn't joined
- "Joined" badge for channels user is member of
- Private channels show lock icon

**5. Update Workspace Page (src/app/(workspace)/[workspaceSlug]/page.tsx):**
Add sidebar layout with:
- ChannelList on left
- Main content area
- "Browse Channels" link
- "Create Channel" button opening CreateChannelDialog

**6. Channel Directory Page (src/app/(workspace)/[workspaceSlug]/channels/page.tsx):**
New page showing ChannelDirectory component.
- Title "Channel Directory"
- ChannelDirectory component
- Back link to workspace home

Install shadcn/ui Dialog component if not present: `npx shadcn@latest add dialog`
  </action>
  <verify>
1. Build passes: `npm run build`
2. Create a test channel via UI, verify it appears in channel list
3. Browse channel directory, verify all public channels visible
4. Join a channel from directory, verify it appears in sidebar
  </verify>
  <done>
- Members can create public channels with name and description
- Channel list shows user's joined channels in sidebar
- Channel directory shows all public channels
- Members can join public channels from directory
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Schema verification:**
   - Run `npm run db:push` succeeds
   - Tables channels, channel_members exist with correct structure

2. **Functional verification:**
   - Create channel form works (name required, description optional)
   - New channel appears in creator's channel list
   - Channel directory shows all public channels
   - Join button adds user to channel
   - Joined channels appear in sidebar

3. **Build verification:**
   - `npm run build` completes without errors
   - No TypeScript errors
</verification>

<success_criteria>
- CHAN-01 (create public channel): Member can create public channel via dialog
- CHAN-03 (browse directory): Channel directory page shows all public channels
- CHAN-04 (join public channel): Join button in directory adds user to channel
- Channel list in sidebar shows user's joined channels
</success_criteria>

<output>
After completion, create `.planning/phases/02-channels-dms/02-01-SUMMARY.md`
</output>
