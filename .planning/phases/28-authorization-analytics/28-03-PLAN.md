---
phase: 28-authorization-analytics
plan: 03
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - src/lib/actions/user-group.ts
  - src/lib/mentions.ts
  - src/lib/actions/message.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create user groups with unique handles (UGRP-01, UGRP-05)"
    - "Admin can add/remove members from groups (UGRP-04)"
    - "Mention parser detects group handles (UGRP-02)"
    - "Group mentions only notify members who are in the channel (UGRP-06)"
  artifacts:
    - path: "src/lib/actions/user-group.ts"
      provides: "User group CRUD operations"
      exports: ["createUserGroup", "updateUserGroup", "deleteUserGroup", "addGroupMember", "removeGroupMember", "getUserGroups", "getGroupMembers", "getGroupByHandle"]
    - path: "src/lib/mentions.ts"
      provides: "Extended mention parsing with group support"
      exports: ["parseMentions", "ParsedMention"]
  key_links:
    - from: "src/lib/actions/user-group.ts"
      to: "src/db/schema/user-group.ts"
      via: "Drizzle CRUD operations"
      pattern: "db\\.insert.*userGroups|db\\.delete.*userGroups"
    - from: "src/lib/mentions.ts"
      to: "src/lib/actions/user-group.ts"
      via: "group handle lookup"
      pattern: "getGroupByHandle"
---

<objective>
Create user group server actions and extend the mention system for group handles.

Purpose: Backend for user group management and the critical UGRP-06 requirement that group mentions only notify channel members who are also in the group.

Output: User group CRUD actions, extended mention parser, message send integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/28-authorization-analytics/28-CONTEXT.md
@.planning/phases/28-authorization-analytics/28-RESEARCH.md
@.planning/phases/28-authorization-analytics/28-01-SUMMARY.md
@src/lib/mentions.ts
@src/lib/actions/admin.ts
@src/db/schema/channel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user group server actions</name>
  <files>src/lib/actions/user-group.ts</files>
  <action>
Create server actions for user group management. Admin-only for create/update/delete/members.

**createUserGroup(organizationId, name, handle, description?):**
- UGRP-01: Create named user group
- UGRP-05: Validate handle uniqueness within workspace
- Normalize handle to lowercase, alphanumeric + underscore only
- Verify admin access
- Insert into userGroups, return created group

**updateUserGroup(groupId, updates: { name?, handle?, description? }):**
- Verify admin access to the group's organization
- If handle changed, verify uniqueness
- Update userGroups record

**deleteUserGroup(groupId):**
- Verify admin access
- Delete group (cascade deletes memberships)

**addGroupMember(groupId, userId):**
- UGRP-04: Add member
- Verify admin access
- Verify user is member of the organization
- GUST-07: Verify user is NOT a guest (guests cannot be in user groups)
- Insert into userGroupMembers

**removeGroupMember(groupId, userId):**
- UGRP-04: Remove member
- Verify admin access
- Delete from userGroupMembers

**getUserGroups(organizationId):**
- For admin: return all groups in workspace
- For non-admin: return only groups user belongs to
- Context decision: Users only see groups they belong to

**getGroupMembers(groupId):**
- UGRP-03: Allow viewing members by clicking mention
- Return array of { userId, name, email, image }
- No admin restriction (anyone can see group members)

**getGroupByHandle(organizationId, handle):**
- Lookup group by handle for mention resolution
- Returns group with member count
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/actions/user-group.ts`</verify>
  <done>User group CRUD actions with admin access control and guest exclusion</done>
</task>

<task type="auto">
  <name>Task 2: Extend mention system for groups</name>
  <files>src/lib/mentions.ts</files>
  <action>
Extend the existing mention parser to support group mentions.

**Update ParsedMention interface:**
```typescript
export interface ParsedMention {
  type: "user" | "channel" | "here" | "group"; // Add "group"
  value: string;
  start: number;
  end: number;
  raw: string;
}
```

**Update parseMentions function:**
- Group mentions use same @handle syntax as users
- Cannot distinguish in regex - both are alphanumeric handles
- Add optional parameter: `organizationId?: string`
- If organizationId provided, check each potential user mention against group handles
- If handle matches a group in the workspace, type = "group"
- If no match, type = "user" (existing behavior)

**Add extractMentionedGroups function:**
```typescript
export function extractMentionedGroups(content: string): string[] {
  const mentions = parseMentions(content);
  return mentions
    .filter((m) => m.type === "group")
    .map((m) => m.value);
}
```

**Update highlightMentions:**
- Add styling for group mentions (purple background to distinguish from users/channel)
- Group mentions clickable (handled in UI layer)

Note: The actual group lookup happens in the notification logic, not in parsing. The parser just identifies potential group handles. The notification sender resolves group -> members.
  </action>
  <verify>
Existing tests pass: `npm test -- mentions`
Manual test: parseMentions("Hello @designers") identifies "designers" as potential mention
  </verify>
  <done>Mention system extended to recognize group handles</done>
</task>

<task type="auto">
  <name>Task 3: Integrate group mentions into message notifications</name>
  <files>src/lib/actions/message.ts or relevant notification handler</files>
  <action>
Find where message notifications are sent and add group mention handling.

**UGRP-02: Group mention notifies all group members**
**UGRP-06: Only notify members who are ALSO in the channel**

When a message is sent:
1. Parse mentions from content
2. For each group mention:
   a. Lookup group by handle in the workspace
   b. Get all group member userIds
   c. Get all channel member userIds
   d. Intersect: notifyUserIds = groupMembers âˆ© channelMembers
   e. Add to notification list

The intersection prevents notification spam to users who can't see the channel.

**Implementation location:**
- Find existing mention notification logic (likely in message.ts or a notification utility)
- Add group mention handling after user mention handling
- Use getGroupByHandle and getGroupMembers from user-group.ts

**Add helper function:**
```typescript
async function getGroupMentionRecipients(
  organizationId: string,
  channelId: string,
  groupHandle: string
): Promise<string[]> {
  // Get group members
  const group = await getGroupByHandle(organizationId, groupHandle);
  if (!group) return [];

  const groupMembers = await getGroupMembers(group.id);
  const groupUserIds = new Set(groupMembers.map(m => m.userId));

  // Get channel members
  const channelMembers = await db.query.channelMembers.findMany({
    where: eq(channelMembers.channelId, channelId),
  });
  const channelUserIds = new Set(channelMembers.map(m => m.userId));

  // Intersection
  return [...groupUserIds].filter(id => channelUserIds.has(id));
}
```
  </action>
  <verify>
TypeScript compiles.
Manual test: Send message with @grouphandle, verify only channel members in group get notification.
  </verify>
  <done>Group mentions notify only members who are in both the group AND the channel</done>
</task>

</tasks>

<verification>
- [ ] User group CRUD operations work (create, update, delete)
- [ ] Group members can be added and removed
- [ ] Guests cannot be added to groups (GUST-07)
- [ ] Handle uniqueness enforced per workspace
- [ ] Group mentions parsed correctly
- [ ] Group mention notifications respect channel membership (UGRP-06)
</verification>

<success_criteria>
User group backend complete:
- Admin can create groups with unique @handles
- Admin can manage group membership
- Guests excluded from groups
- Group mentions notify only channel-intersected members
</success_criteria>

<output>
After completion, create `.planning/phases/28-authorization-analytics/28-03-SUMMARY.md`
</output>
