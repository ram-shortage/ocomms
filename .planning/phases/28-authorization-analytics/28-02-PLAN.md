---
phase: 28-authorization-analytics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/chart.tsx
  - src/components/ui/tabs.tsx
  - src/lib/actions/analytics.ts
autonomous: true

must_haves:
  truths:
    - "Chart and Tabs shadcn components installed"
    - "Analytics server actions return message volume by day"
    - "Analytics server actions return active users (DAU/WAU/MAU)"
    - "Analytics server actions return channel activity ranking"
    - "Analytics server actions return storage usage"
    - "All analytics queries filter by date range"
  artifacts:
    - path: "src/components/ui/chart.tsx"
      provides: "Recharts wrapper component"
      contains: "ChartContainer"
    - path: "src/components/ui/tabs.tsx"
      provides: "Tab navigation component"
      contains: "TabsTrigger"
    - path: "src/lib/actions/analytics.ts"
      provides: "Analytics data fetching"
      exports: ["getMessageVolume", "getActiveUsers", "getChannelActivity", "getStorageUsage", "getPeakUsageTimes"]
  key_links:
    - from: "src/lib/actions/analytics.ts"
      to: "src/db/schema/message.ts"
      via: "Drizzle aggregate queries"
      pattern: "count\\(\\)|groupBy"
---

<objective>
Install analytics UI components and create analytics server actions.

Purpose: Provides data fetching layer and chart components needed for the analytics dashboard. Runs in parallel with schema creation (Plan 01) since this plan only needs existing tables (messages, members, file_attachments).

Output: shadcn chart/tabs components installed, analytics server actions with aggregate queries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/28-authorization-analytics/28-CONTEXT.md
@.planning/phases/28-authorization-analytics/28-RESEARCH.md
@src/lib/actions/admin.ts
@src/db/schema/message.ts
@src/db/schema/file-attachment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn chart and tabs components</name>
  <files>src/components/ui/chart.tsx, src/components/ui/tabs.tsx</files>
  <action>
Install shadcn components using CLI:

```bash
npx shadcn@latest add chart
npx shadcn@latest add tabs
```

These will:
- Add chart.tsx with ChartContainer, ChartConfig types, and Recharts integration
- Add tabs.tsx with Tabs, TabsList, TabsTrigger, TabsContent components
- Install recharts as dependency if not present

Verify files created in src/components/ui/.
  </action>
  <verify>
Files exist: src/components/ui/chart.tsx, src/components/ui/tabs.tsx
Import works: `import { ChartContainer } from "@/components/ui/chart"`
Import works: `import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs"`
  </verify>
  <done>Chart and Tabs components installed and importable</done>
</task>

<task type="auto">
  <name>Task 2: Create analytics server actions</name>
  <files>src/lib/actions/analytics.ts</files>
  <action>
Create analytics server actions with admin-only access. Follow patterns from admin.ts.

**Helper function:**
```typescript
async function verifyAdminAccess(organizationId: string): Promise<void> {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  const membership = await db.query.members.findFirst({
    where: and(
      eq(members.userId, session.user.id),
      eq(members.organizationId, organizationId)
    ),
  });

  if (!membership || (membership.role !== "owner" && membership.role !== "admin")) {
    throw new Error("Only admins can view analytics");
  }
}
```

**getMessageVolume(organizationId, startDate, endDate):**
- ANLY-01: Message volume over time
- Query messages table grouped by DATE(createdAt)
- Filter by organization via channel membership
- Return array of { date: string, count: number }
- Use Drizzle sql`` for DATE() function

**getActiveUsers(organizationId, startDate, endDate):**
- ANLY-02: DAU/WAU/MAU
- Count distinct message authors in time periods
- DAU: each day in range
- WAU: rolling 7-day windows
- MAU: rolling 30-day windows
- Return { dau: number[], wau: number, mau: number, trend: "up"|"down"|"flat" }

**getChannelActivity(organizationId, startDate, endDate):**
- ANLY-03: Top 10 channels by message count
- Group by channelId, count messages
- Join to get channel names
- Order by count DESC, limit 10
- Return array of { channelId, channelName, messageCount }

**getPeakUsageTimes(organizationId, startDate, endDate):**
- ANLY-06: Hourly distribution
- Extract HOUR from createdAt, count per hour
- Return array of { hour: number (0-23), count: number }

**getStorageUsage(organizationId):**
- ANLY-07: File storage usage
- Sum file sizes from file_attachments via messages
- Group by channel for breakdown
- Return { total: number, byChannel: { channelId, channelName, bytes }[] }

All functions:
- ANLY-08: Aggregate only (no individual user data exposed)
- ANLY-04: Accept date range parameters
- Call verifyAdminAccess first
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/actions/analytics.ts`
Test queries work (manual verification in next plan)
  </verify>
  <done>Analytics server actions created with aggregate queries and admin access control</done>
</task>

</tasks>

<verification>
- [ ] `npx shadcn@latest add chart` and `npx shadcn@latest add tabs` complete
- [ ] chart.tsx and tabs.tsx exist in src/components/ui/
- [ ] analytics.ts exports all required functions
- [ ] TypeScript compiles without errors
- [ ] All queries use aggregate functions (no individual user data)
</verification>

<success_criteria>
Analytics foundation ready:
- shadcn chart component installed (ChartContainer, Recharts)
- shadcn tabs component installed
- Server actions for message volume, active users, channel activity, peak times, storage
- All queries admin-only and aggregate-only
</success_criteria>

<output>
After completion, create `.planning/phases/28-authorization-analytics/28-02-SUMMARY.md`
</output>
