---
phase: 28-authorization-analytics
plan: 07
type: execute
wave: 3
depends_on: ["28-02"]
files_modified:
  - src/app/(workspace)/[workspaceSlug]/settings/analytics/page.tsx
  - src/components/analytics/analytics-dashboard.tsx
  - src/components/analytics/message-volume-chart.tsx
  - src/components/analytics/active-users-card.tsx
  - src/components/analytics/channel-activity-table.tsx
  - src/components/analytics/storage-usage-card.tsx
  - src/components/analytics/peak-times-chart.tsx
  - src/components/analytics/date-range-picker.tsx
  - src/components/analytics/export-button.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can access analytics dashboard (ANLY-01 through ANLY-08)"
    - "Dashboard shows message volume over time with line chart"
    - "Dashboard shows DAU/WAU/MAU with trends"
    - "Dashboard shows top 10 channel activity"
    - "Dashboard shows peak usage times (hourly)"
    - "Dashboard shows storage usage by channel"
    - "Admin can filter by date range with presets"
    - "Admin can export data to CSV"
  artifacts:
    - path: "src/app/(workspace)/[workspaceSlug]/settings/analytics/page.tsx"
      provides: "Analytics dashboard page"
      contains: "AnalyticsDashboard"
    - path: "src/components/analytics/analytics-dashboard.tsx"
      provides: "Main dashboard with tabs"
      exports: ["AnalyticsDashboard"]
    - path: "src/components/analytics/message-volume-chart.tsx"
      provides: "Line chart for message volume"
      exports: ["MessageVolumeChart"]
    - path: "src/components/analytics/export-button.tsx"
      provides: "CSV export functionality"
      exports: ["ExportButton"]
  key_links:
    - from: "src/components/analytics/analytics-dashboard.tsx"
      to: "src/lib/actions/analytics.ts"
      via: "data fetching"
      pattern: "getMessageVolume|getActiveUsers|getChannelActivity"
    - from: "src/components/analytics/message-volume-chart.tsx"
      to: "src/components/ui/chart.tsx"
      via: "Recharts components"
      pattern: "ChartContainer|LineChart"
---

<objective>
Create the analytics dashboard UI with charts, metrics, and export functionality.

Purpose: Admin dashboard showing aggregate workspace metrics. Implements ANLY-01 through ANLY-08.

Output: Analytics page with tabbed sections, charts, date filtering, and CSV export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/28-authorization-analytics/28-CONTEXT.md
@.planning/phases/28-authorization-analytics/28-RESEARCH.md
@.planning/phases/28-authorization-analytics/28-02-SUMMARY.md
@src/components/ui/chart.tsx
@src/components/ui/tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics dashboard page and layout</name>
  <files>src/app/(workspace)/[workspaceSlug]/settings/analytics/page.tsx, src/components/analytics/analytics-dashboard.tsx, src/components/analytics/date-range-picker.tsx</files>
  <action>
Create admin-only analytics dashboard.

**src/app/(workspace)/[workspaceSlug]/settings/analytics/page.tsx:**
- Admin access check
- Render AnalyticsDashboard component
- Title: "Workspace Analytics"

**src/components/analytics/analytics-dashboard.tsx:**

Per CONTEXT.md: Tabbed sections like Vercel dashboard - clean, data-focused.

Layout:
- Header: Title, Date Range Picker, Refresh Button, Export Button
- Tabs: Messages, Users, Channels, Storage

State:
- dateRange: { start: Date, end: Date }
- Data for each tab (lazy load on tab switch)
- isLoading states

```typescript
<Tabs defaultValue="messages">
  <div className="flex items-center justify-between mb-6">
    <TabsList>
      <TabsTrigger value="messages">Messages</TabsTrigger>
      <TabsTrigger value="users">Users</TabsTrigger>
      <TabsTrigger value="channels">Channels</TabsTrigger>
      <TabsTrigger value="storage">Storage</TabsTrigger>
    </TabsList>
    <div className="flex items-center gap-2">
      <DateRangePicker value={dateRange} onChange={setDateRange} />
      <Button variant="outline" onClick={refresh}>Refresh</Button>
      <ExportButton data={currentTabData} />
    </div>
  </div>

  <TabsContent value="messages">
    <MessageVolumeChart data={messageData} />
    <PeakTimesChart data={peakData} />
  </TabsContent>
  // ... other tabs
</Tabs>
```

**src/components/analytics/date-range-picker.tsx:**
ANLY-04: Filter by date range

- Quick presets: 7d, 30d, 90d, 1 year (buttons)
- Custom range picker (date inputs)
- Default: Last 30 days
- Max range: 1 year (per research - performance consideration)

Per CONTEXT.md: Manual refresh only (no auto-polling).
  </action>
  <verify>
Navigate to /[workspace]/settings/analytics as admin.
See tabbed dashboard.
Date range picker works with presets and custom.
Non-admin cannot access.
  </verify>
  <done>Analytics dashboard page with tabs and date filtering</done>
</task>

<task type="auto">
  <name>Task 2: Create chart and metric components</name>
  <files>src/components/analytics/message-volume-chart.tsx, src/components/analytics/active-users-card.tsx, src/components/analytics/channel-activity-table.tsx, src/components/analytics/storage-usage-card.tsx, src/components/analytics/peak-times-chart.tsx</files>
  <action>
Create individual analytics components using shadcn chart.

**src/components/analytics/message-volume-chart.tsx:**
ANLY-01: Message volume over time
- Line chart using Recharts via ChartContainer
- X-axis: dates, Y-axis: message count
- Tooltip showing date and count
- Responsive container

```typescript
import { ChartContainer } from "@/components/ui/chart";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from "recharts";

const chartConfig = {
  messages: { label: "Messages", color: "hsl(var(--chart-1))" },
};

export function MessageVolumeChart({ data }: { data: { date: string; count: number }[] }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>Message Volume</CardTitle>
      </CardHeader>
      <CardContent>
        <ChartContainer config={chartConfig} className="h-[300px]">
          <LineChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="date" />
            <YAxis />
            <Tooltip />
            <Line type="monotone" dataKey="count" stroke="var(--color-messages)" />
          </LineChart>
        </ChartContainer>
      </CardContent>
    </Card>
  );
}
```

**src/components/analytics/active-users-card.tsx:**
ANLY-02: DAU/WAU/MAU
- Card with three metrics
- Each shows number + trend indicator (up/down arrow + percentage)
- Sparkline optional (small inline chart)

**src/components/analytics/channel-activity-table.tsx:**
ANLY-03: Top 10 channels
- Table: Rank, Channel Name, Message Count, % of Total
- Per CONTEXT.md: Top 10, rest aggregated as "Other"

**src/components/analytics/storage-usage-card.tsx:**
ANLY-07: Storage usage
- Total storage used (formatted: "1.2 GB")
- Breakdown by channel (horizontal bar chart or table)
- Top 5 channels + "Other"

**src/components/analytics/peak-times-chart.tsx:**
ANLY-06: Hourly distribution
- Bar chart with 24 bars (0-23 hours)
- Y-axis: message count
- Highlights peak hours
  </action>
  <verify>
Each chart renders with sample data.
Charts are responsive.
Dark mode styling works.
  </verify>
  <done>Analytics visualization components created</done>
</task>

<task type="auto">
  <name>Task 3: Create CSV export functionality</name>
  <files>src/components/analytics/export-button.tsx</files>
  <action>
ANLY-05: Export to CSV with granularity options.

**src/components/analytics/export-button.tsx:**

- Dropdown button: "Export CSV"
- Options: Hourly, Daily, Weekly (granularity per CONTEXT.md)
- On click: Generate CSV client-side, trigger download

```typescript
function exportToCSV(data: Record<string, unknown>[], filename: string) {
  if (data.length === 0) return;

  const headers = Object.keys(data[0]);
  const csvRows = [
    headers.join(","),
    ...data.map(row =>
      headers.map(h => {
        const val = row[h];
        const str = String(val ?? "");
        return str.includes(",") || str.includes('"')
          ? `"${str.replace(/"/g, '""')}"`
          : str;
      }).join(",")
    ),
  ];

  const csvContent = "\uFEFF" + csvRows.join("\n"); // BOM for Excel
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  link.click();

  URL.revokeObjectURL(url);
}
```

**Export flow:**
1. User selects granularity
2. Fetch data at that granularity (may need additional server action or aggregate client-side)
3. Generate CSV
4. Trigger download

Filename format: `{workspace}-analytics-{tab}-{startDate}-{endDate}.csv`

Per research: Client-side export for reasonable datasets. Large exports may need warning.
  </action>
  <verify>
Click Export, select granularity.
CSV file downloads.
File opens in Excel/Sheets correctly.
Data matches what's shown in dashboard.
  </verify>
  <done>CSV export with granularity options working</done>
</task>

</tasks>

<verification>
- [ ] Analytics page accessible to admins only
- [ ] Message volume line chart displays correctly (ANLY-01)
- [ ] DAU/WAU/MAU metrics shown with trends (ANLY-02)
- [ ] Top 10 channel activity ranking (ANLY-03)
- [ ] Date range filtering works (ANLY-04)
- [ ] CSV export works with granularity options (ANLY-05)
- [ ] Peak usage times chart shows hourly distribution (ANLY-06)
- [ ] Storage usage shown with breakdown (ANLY-07)
- [ ] All data is aggregate only (ANLY-08)
- [ ] Manual refresh works (no auto-polling)
</verification>

<success_criteria>
Analytics dashboard complete:
- Tabbed sections: Messages, Users, Channels, Storage
- Charts and metrics for all ANLY requirements
- Date range filtering with presets
- CSV export with granularity
- Manual refresh, no auto-polling
</success_criteria>

<output>
After completion, create `.planning/phases/28-authorization-analytics/28-07-SUMMARY.md`
</output>
