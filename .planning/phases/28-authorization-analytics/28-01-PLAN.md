---
phase: 28-authorization-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/user-group.ts
  - src/db/schema/guest.ts
  - src/db/schema/index.ts
  - drizzle/0XXX_user_groups_guests.sql
autonomous: true

must_haves:
  truths:
    - "User groups table exists with org-scoped unique handles"
    - "Guest channel access table exists for channel-scoped permissions"
    - "Guest invites table exists for shareable link tokens"
    - "Members table extended with guest fields (isGuest, guestExpiresAt, guestSoftLocked, guestJobId)"
  artifacts:
    - path: "src/db/schema/user-group.ts"
      provides: "UserGroup and UserGroupMember tables"
      exports: ["userGroups", "userGroupMembers", "userGroupRelations", "userGroupMemberRelations"]
    - path: "src/db/schema/guest.ts"
      provides: "GuestChannelAccess and GuestInvite tables"
      exports: ["guestChannelAccess", "guestInvites", "guestChannelAccessRelations", "guestInviteRelations"]
    - path: "drizzle/0XXX_user_groups_guests.sql"
      provides: "Migration for all new tables"
      contains: "CREATE TABLE"
  key_links:
    - from: "src/db/schema/user-group.ts"
      to: "src/db/schema/auth.ts"
      via: "foreign key references"
      pattern: "references.*organizations|references.*users"
    - from: "src/db/schema/guest.ts"
      to: "src/db/schema/auth.ts"
      via: "foreign key to members table"
      pattern: "references.*members"
---

<objective>
Create database schema for user groups and guest accounts.

Purpose: Foundation tables needed for group mentions, guest access control, and guest expiration. All subsequent plans depend on these tables existing.

Output: Two new schema files, migration SQL, updated schema index.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-authorization-analytics/28-CONTEXT.md
@.planning/phases/28-authorization-analytics/28-RESEARCH.md
@src/db/schema/auth.ts
@src/db/schema/channel.ts
@src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user groups schema</name>
  <files>src/db/schema/user-group.ts</files>
  <action>
Create user groups schema following existing patterns from auth.ts:

**userGroups table:**
- id: uuid, primary key, defaultRandom
- organizationId: text, FK to organizations.id, cascade delete
- name: text, not null (display name like "Design Team")
- handle: text, not null (mentionable handle like "designers")
- description: text, nullable
- createdBy: text, FK to users.id, set null on delete
- createdAt: timestamp, not null, defaultNow
- updatedAt: timestamp, not null, defaultNow
- Unique index on (organizationId, handle) for UGRP-05

**userGroupMembers table:**
- id: uuid, primary key, defaultRandom
- groupId: uuid, FK to userGroups.id, cascade delete
- userId: text, FK to users.id, cascade delete
- addedAt: timestamp, not null, defaultNow
- Unique index on (groupId, userId)
- Index on userId for efficient "my groups" lookup

**Relations:**
- userGroups -> organization (one)
- userGroups -> createdBy user (one)
- userGroups -> members (many via userGroupMembers)
- userGroupMembers -> group (one)
- userGroupMembers -> user (one)

Export: userGroups, userGroupMembers, userGroupRelations, userGroupMemberRelations
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/db/schema/user-group.ts`</verify>
  <done>User group tables defined with org-scoped unique handles constraint</done>
</task>

<task type="auto">
  <name>Task 2: Create guest schema and extend members</name>
  <files>src/db/schema/guest.ts, src/db/schema/auth.ts</files>
  <action>
**Create src/db/schema/guest.ts:**

**guestChannelAccess table:**
- id: uuid, primary key, defaultRandom
- memberId: text, FK to members.id, cascade delete
- channelId: uuid, FK to channels.id, cascade delete
- grantedAt: timestamp, not null, defaultNow
- Unique index on (memberId, channelId)
- Index on memberId for efficient access lookups

**guestInvites table:**
- id: uuid, primary key, defaultRandom
- organizationId: text, FK to organizations.id, cascade delete
- token: text, not null, unique (nanoid for shareable link)
- createdBy: text, FK to users.id, cascade delete
- expiresAt: timestamp, nullable (GUST-08 guest expiration)
- channelIds: text, not null (JSON array of allowed channel UUIDs)
- usedBy: text, nullable, FK to users.id, set null on delete
- usedAt: timestamp, nullable
- createdAt: timestamp, not null, defaultNow

**Relations for both tables.**

**Extend src/db/schema/auth.ts member table:**
Add four new columns to the member table:
- isGuest: boolean, not null, default false
- guestExpiresAt: timestamp, nullable
- guestSoftLocked: boolean, not null, default false
- guestJobId: text, nullable (for BullMQ expiration job tracking)

Note: The members table is managed by better-auth organization plugin. Add columns via ALTER TABLE in migration, not by modifying the pgTable definition directly. Only add the columns to the schema type for TypeScript.

Actually, since this project uses Drizzle with explicit schema, add the columns to the member pgTable definition in auth.ts.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/db/schema/guest.ts src/db/schema/auth.ts`</verify>
  <done>Guest access tables defined and members table extended with guest fields</done>
</task>

<task type="auto">
  <name>Task 3: Create migration and update schema index</name>
  <files>drizzle/0XXX_user_groups_guests.sql, src/db/schema/index.ts</files>
  <action>
**Generate migration:**
Run `npm run db:generate` to create migration file.

The migration should contain:
- CREATE TABLE user_groups with columns and unique index
- CREATE TABLE user_group_members with columns, unique index, and userId index
- CREATE TABLE guest_channel_access with columns, unique index, and memberId index
- CREATE TABLE guest_invites with columns and unique token index
- ALTER TABLE members ADD COLUMN is_guest, guest_expires_at, guest_soft_locked, guest_job_id

**Update src/db/schema/index.ts:**
Add exports:
```typescript
export * from "./user-group";
export * from "./guest";
```

**Run migration:**
`npm run db:push` to apply changes.

**Verify tables exist:**
`psql` or Drizzle Studio to confirm tables created.
  </action>
  <verify>
Run `npm run db:push` succeeds.
Query database: tables user_groups, user_group_members, guest_channel_access, guest_invites exist.
Members table has is_guest, guest_expires_at, guest_soft_locked, guest_job_id columns.
  </verify>
  <done>Migration applied, all tables exist in database, schema exports updated</done>
</task>

</tasks>

<verification>
- [ ] `npm run db:push` completes without errors
- [ ] All new tables visible in database
- [ ] TypeScript imports work: `import { userGroups, guestInvites } from "@/db/schema"`
- [ ] Members table has guest columns
</verification>

<success_criteria>
Schema foundation complete:
- userGroups and userGroupMembers tables with org-scoped unique handles
- guestChannelAccess table for channel-scoped permissions
- guestInvites table for shareable invite links
- members table extended with isGuest, guestExpiresAt, guestSoftLocked, guestJobId
</success_criteria>

<output>
After completion, create `.planning/phases/28-authorization-analytics/28-01-SUMMARY.md`
</output>
