---
phase: 28-authorization-analytics
plan: 04
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - src/lib/actions/guest.ts
  - src/server/queue/guest-expiration.queue.ts
  - src/workers/guest-expiration.worker.ts
  - src/workers/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create guest invite links for specific channels (GUST-01, GUST-02)"
    - "Admin can set guest expiration dates (GUST-08)"
    - "Admin can remove guest access (GUST-05)"
    - "Guest expiration triggers soft lock after 24-hour grace period"
  artifacts:
    - path: "src/lib/actions/guest.ts"
      provides: "Guest management operations"
      exports: ["createGuestInvite", "redeemGuestInvite", "removeGuestAccess", "extendGuestExpiration", "getGuestInvites", "getGuestChannelAccess"]
    - path: "src/server/queue/guest-expiration.queue.ts"
      provides: "BullMQ queue for guest expiration"
      exports: ["guestExpirationQueue", "GuestExpirationJobData"]
    - path: "src/workers/guest-expiration.worker.ts"
      provides: "Worker that soft-locks expired guests"
      exports: ["createGuestExpirationWorker"]
  key_links:
    - from: "src/lib/actions/guest.ts"
      to: "src/server/queue/guest-expiration.queue.ts"
      via: "job scheduling"
      pattern: "guestExpirationQueue\\.add"
    - from: "src/workers/guest-expiration.worker.ts"
      to: "src/db/schema/auth.ts"
      via: "soft lock update"
      pattern: "guestSoftLocked.*true"
---

<objective>
Create guest account server actions and expiration worker.

Purpose: Backend for guest invites, access management, and automatic expiration. Follows the shareable link model from CONTEXT.md where admins generate links for specific channels.

Output: Guest management actions, BullMQ queue and worker for expiration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/28-authorization-analytics/28-CONTEXT.md
@.planning/phases/28-authorization-analytics/28-RESEARCH.md
@.planning/phases/28-authorization-analytics/28-01-SUMMARY.md
@src/workers/status-expiration.worker.ts
@src/server/queue/status-expiration.queue.ts
@src/lib/actions/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create guest server actions</name>
  <files>src/lib/actions/guest.ts</files>
  <action>
Create server actions for guest management. Follow patterns from admin.ts.

**createGuestInvite(organizationId, channelIds, expiresAt?):**
- GUST-01: Create invite for external user
- GUST-02: Specify allowed channels
- GUST-08: Optional expiration date
- Verify admin access
- Generate unique token using nanoid(21)
- Store channelIds as JSON string
- Return { token, inviteUrl: `/join/${token}` }

**redeemGuestInvite(token):**
- Called when someone visits the invite link
- Find invite by token
- Check if not already used
- Check if not expired (invite expiration, not guest expiration)
- Create user if needed (or link to existing)
- Create member record with isGuest=true, guestExpiresAt from invite
- Create guestChannelAccess records for each channel
- Mark invite as used (usedBy, usedAt)
- If guestExpiresAt set, schedule expiration job (24h grace period)
- Return { success, organizationSlug }

**removeGuestAccess(memberId):**
- GUST-05: Admin removes guest
- Verify admin access
- Cancel any pending expiration job
- Delete guestChannelAccess records
- Delete member record

**extendGuestExpiration(memberId, newExpiresAt):**
- Admin can extend or clear expiration
- Verify admin access
- Update member.guestExpiresAt
- Cancel old expiration job if exists
- Schedule new job if newExpiresAt provided
- Clear guestSoftLocked if was locked

**getGuestInvites(organizationId):**
- Admin: list all invites for workspace
- Return with usage status and expiration

**getGuestChannelAccess(memberId):**
- Get channels a guest can access
- Used for authorization checks

**getWorkspaceGuests(organizationId):**
- Admin: list all guests in workspace
- Include their allowed channels and expiration status
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/actions/guest.ts`</verify>
  <done>Guest management actions created with invite links and expiration scheduling</done>
</task>

<task type="auto">
  <name>Task 2: Create guest expiration queue and worker</name>
  <files>src/server/queue/guest-expiration.queue.ts, src/workers/guest-expiration.worker.ts, src/workers/index.ts</files>
  <action>
Follow existing patterns from status-expiration.queue.ts and status-expiration.worker.ts.

**src/server/queue/guest-expiration.queue.ts:**
```typescript
import { Queue } from "bullmq";
import { getQueueConnection } from "./connection";

export interface GuestExpirationJobData {
  memberId: string;
}

export const guestExpirationQueue = new Queue<GuestExpirationJobData>(
  "guest-expiration",
  {
    connection: getQueueConnection(),
    defaultJobOptions: {
      attempts: 3,
      backoff: {
        type: "exponential",
        delay: 1000,
      },
      removeOnComplete: { count: 100 },
      removeOnFail: { count: 500 },
    },
  }
);
```

**src/workers/guest-expiration.worker.ts:**
Create worker following status-expiration.worker.ts pattern:

1. Receive job with memberId
2. Fetch member record
3. **Critical:** Check jobId matches member.guestJobId (prevent race condition)
4. If mismatch (admin extended), skip silently
5. If match:
   a. Set guestSoftLocked = true (24-hour grace period approach)
   b. Optionally: Send notification to guest about expiration
6. Log completion

The soft lock means guest can view but not post. UI will show "access expired" message.

**Update src/workers/index.ts:**
Import and register the new worker:
```typescript
import { createGuestExpirationWorker } from "./guest-expiration.worker";
// In startWorkers or equivalent
createGuestExpirationWorker();
```
  </action>
  <verify>
TypeScript compiles for all files.
Worker starts without errors: check logs when running `npm run worker`
  </verify>
  <done>Guest expiration queue and worker created with race condition protection</done>
</task>

<task type="auto">
  <name>Task 3: Add guest access authorization checks</name>
  <files>src/lib/actions/channel.ts, src/lib/actions/message.ts</files>
  <action>
Add authorization checks to enforce guest channel restrictions.

**GUST-02: Guest access restricted to specified channels only**

Find channel access checks and add guest handling:

**In channel access verification:**
```typescript
// Existing pattern: check channel membership
const member = await db.query.channelMembers.findFirst({...});

// For guests: also check guestChannelAccess
if (membership?.isGuest) {
  const guestAccess = await db.query.guestChannelAccess.findFirst({
    where: and(
      eq(guestChannelAccess.memberId, membership.id),
      eq(guestChannelAccess.channelId, channelId)
    ),
  });
  if (!guestAccess) {
    throw new Error("Guest does not have access to this channel");
  }

  // Check soft lock
  if (membership.guestSoftLocked) {
    throw new Error("Guest access has expired");
  }
}
```

**In message send:**
- Check guest soft lock before allowing message post
- If soft locked, return error: "Your guest access has expired. Please contact an admin."

**GUST-06: Guest cannot see full member directory**
Find member list queries and filter for guests:
- Guests should only see members of their allowed channels
- Add filter to getWorkspaceMembers or similar

**Context decision from CONTEXT.md:**
- Guests CAN send messages, react, upload files in allowed channels (GUST-04)
- Guests CANNOT initiate DMs, but can reply to member-initiated DMs
- Find DM creation logic and add guest check
  </action>
  <verify>
Test: Guest accessing unauthorized channel returns error.
Test: Soft-locked guest cannot post messages.
Test: Guest cannot initiate DM.
  </verify>
  <done>Guest access restrictions enforced in channel and message handlers</done>
</task>

</tasks>

<verification>
- [ ] Guest invite link can be generated by admin
- [ ] Invite link can be redeemed to create guest account
- [ ] Guest only has access to specified channels
- [ ] Guest expiration schedules BullMQ job
- [ ] Expiration job soft-locks guest (race condition protected)
- [ ] Soft-locked guest can view but not post
- [ ] Admin can extend expiration and unlock
- [ ] Guest cannot access unauthorized channels
</verification>

<success_criteria>
Guest backend complete:
- Shareable invite links with channel restrictions
- Automatic expiration via BullMQ
- 24-hour grace period (soft lock)
- Access control enforced throughout app
</success_criteria>

<output>
After completion, create `.planning/phases/28-authorization-analytics/28-04-SUMMARY.md`
</output>
