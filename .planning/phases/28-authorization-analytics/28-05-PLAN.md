---
phase: 28-authorization-analytics
plan: 05
type: execute
wave: 3
depends_on: ["28-03"]
files_modified:
  - src/app/(workspace)/[workspaceSlug]/settings/user-groups/page.tsx
  - src/components/user-group/user-group-list.tsx
  - src/components/user-group/user-group-form.tsx
  - src/components/user-group/group-member-manager.tsx
  - src/components/message/mention-autocomplete.tsx
  - src/components/user-group/group-mention-popup.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see user groups management page in settings"
    - "Admin can create/edit/delete user groups"
    - "Admin can add/remove members from groups"
    - "Mention autocomplete shows tabs for Users and Groups"
    - "Clicking group mention shows popup with member list (UGRP-03)"
  artifacts:
    - path: "src/app/(workspace)/[workspaceSlug]/settings/user-groups/page.tsx"
      provides: "User groups settings page"
      contains: "UserGroupList"
    - path: "src/components/user-group/user-group-list.tsx"
      provides: "List of user groups with actions"
      exports: ["UserGroupList"]
    - path: "src/components/message/mention-autocomplete.tsx"
      provides: "Tabbed autocomplete with groups"
      contains: "activeTab"
    - path: "src/components/user-group/group-mention-popup.tsx"
      provides: "Popup card for group mentions"
      exports: ["GroupMentionPopup"]
  key_links:
    - from: "src/app/(workspace)/[workspaceSlug]/settings/user-groups/page.tsx"
      to: "src/lib/actions/user-group.ts"
      via: "server action calls"
      pattern: "getUserGroups|createUserGroup"
    - from: "src/components/message/mention-autocomplete.tsx"
      to: "src/lib/actions/user-group.ts"
      via: "group search"
      pattern: "getUserGroups"
---

<objective>
Create user groups admin UI and extend mention autocomplete with group tab.

Purpose: Admin interface for managing user groups and the mention picker that lets users select group mentions.

Output: User groups settings page, management components, tabbed autocomplete, group mention popup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/28-authorization-analytics/28-CONTEXT.md
@.planning/phases/28-authorization-analytics/28-03-SUMMARY.md
@src/components/message/mention-autocomplete.tsx
@src/app/(workspace)/[workspaceSlug]/settings/admin/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user groups settings page</name>
  <files>src/app/(workspace)/[workspaceSlug]/settings/user-groups/page.tsx, src/components/user-group/user-group-list.tsx, src/components/user-group/user-group-form.tsx</files>
  <action>
Create admin-only user groups management page.

**src/app/(workspace)/[workspaceSlug]/settings/user-groups/page.tsx:**
- Admin access check (redirect if not admin)
- Fetch user groups for workspace
- Render UserGroupList component
- Title: "User Groups"
- Description: "Create groups for @mentions"

**src/components/user-group/user-group-list.tsx:**
- Display list of groups with name, handle, member count
- Each row has Edit and Delete buttons
- "Create Group" button at top
- Empty state: "No user groups yet. Create one to enable @group mentions."
- Delete confirmation dialog

**src/components/user-group/user-group-form.tsx:**
- Modal form for create/edit
- Fields: Name (required), Handle (required, auto-lowercase), Description (optional)
- Handle validation: alphanumeric + underscore, no spaces
- Handle uniqueness check on blur
- Save button calls createUserGroup or updateUserGroup
- Loading state during save

Layout follows existing settings pages pattern.
  </action>
  <verify>
Navigate to /[workspace]/settings/user-groups as admin.
Create, edit, delete group works.
Non-admin cannot access page.
  </verify>
  <done>User groups settings page with CRUD operations</done>
</task>

<task type="auto">
  <name>Task 2: Create group member manager</name>
  <files>src/components/user-group/group-member-manager.tsx</files>
  <action>
Create component for managing group membership.

**GroupMemberManager props:**
- groupId: string
- onClose: () => void

**Features:**
- Show current members with avatar, name, email
- Remove button on each member row
- "Add Member" section with member search/select
- Search filters workspace members
- Exclude guests (GUST-07) - show tooltip "Guests cannot be added to groups"
- Exclude already-added members

**UI pattern:**
- Use Sheet or Dialog
- Member list with remove buttons
- Combobox/search for adding members
- Confirmation before remove
- Loading states

**Actions:**
- addGroupMember(groupId, userId) on select
- removeGroupMember(groupId, userId) on remove click
- Refresh member list after changes
  </action>
  <verify>
Open member manager for a group.
Add member works.
Remove member works.
Guests cannot be added.
  </verify>
  <done>Group member management UI with guest exclusion</done>
</task>

<task type="auto">
  <name>Task 3: Add group tab to mention autocomplete and popup</name>
  <files>src/components/message/mention-autocomplete.tsx, src/components/user-group/group-mention-popup.tsx</files>
  <action>
**Update src/components/message/mention-autocomplete.tsx:**

Add tabbed interface per CONTEXT.md decision:
- Tab headers: "Users" | "Groups"
- State: activeTab
- Filter logic splits by tab

```typescript
const [activeTab, setActiveTab] = useState<"users" | "groups">("users");

// Fetch groups for workspace (passed as prop or fetched)
// Filter groups same way as members

// Tab header UI
<div className="flex border-b text-sm">
  <button
    className={cn("px-3 py-1.5", activeTab === "users" && "border-b-2 border-primary font-medium")}
    onClick={() => setActiveTab("users")}
  >
    Users
  </button>
  <button
    className={cn("px-3 py-1.5", activeTab === "groups" && "border-b-2 border-primary font-medium")}
    onClick={() => setActiveTab("groups")}
  >
    Groups
  </button>
</div>

// Render filtered members or filtered groups based on tab
```

Groups display:
- Icon: Users icon (multiple people) or "@" badge
- Name: Group name
- Handle: @handle
- Member count

On select: insert @handle into message

**Create src/components/user-group/group-mention-popup.tsx:**

UGRP-03: Click group mention to view members

- Triggered by clicking rendered @group mention in message
- Popup card (not full modal) positioned near click
- Shows: Group name, description, member list (avatar + name)
- "View All Members" link if > 5 members
- Light/quick feel per CONTEXT.md
- Click outside closes

Use Popover component for positioning.
  </action>
  <verify>
Type "@" in message input, see tabs.
Switch to Groups tab, see groups.
Select group, inserts @handle.
Click group mention in message, popup shows members.
  </verify>
  <done>Tabbed mention autocomplete and group mention popup</done>
</task>

</tasks>

<verification>
- [ ] User groups settings page accessible to admins
- [ ] Can create group with name and handle
- [ ] Handle uniqueness enforced with error message
- [ ] Can add/remove group members
- [ ] Guests cannot be added (GUST-07 enforced in UI)
- [ ] Mention autocomplete has Users/Groups tabs
- [ ] Selecting group inserts @handle
- [ ] Clicking group mention shows member popup
</verification>

<success_criteria>
User groups UI complete:
- Full admin management interface
- Member management with guest exclusion
- Tabbed mention picker
- Group mention popup for member viewing
</success_criteria>

<output>
After completion, create `.planning/phases/28-authorization-analytics/28-05-SUMMARY.md`
</output>
