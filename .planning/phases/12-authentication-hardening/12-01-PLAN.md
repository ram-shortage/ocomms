---
phase: 12-authentication-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/lockout.ts
  - src/db/schema/index.ts
  - src/lib/auth.ts
  - src/lib/password-validation.ts
autonomous: true

must_haves:
  truths:
    - "Weak passwords rejected at signup with specific feedback"
    - "Failed login attempts tracked per account"
    - "Progressive delays enforced between failed attempts"
    - "Account locks after 5 failed attempts"
  artifacts:
    - path: "src/db/schema/lockout.ts"
      provides: "Lockout tracking table schema"
      contains: "userLockout"
    - path: "src/lib/password-validation.ts"
      provides: "Password complexity validation"
      exports: ["validatePasswordComplexity"]
    - path: "src/lib/auth.ts"
      provides: "Auth hooks for lockout and password validation"
      contains: "createAuthMiddleware"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/db/schema/lockout.ts"
      via: "lockout queries in hooks"
      pattern: "userLockout"
    - from: "src/lib/auth.ts"
      to: "src/lib/password-validation.ts"
      via: "import for signup validation"
      pattern: "validatePasswordComplexity"
---

<objective>
Implement server-side authentication hardening with password complexity validation and account lockout tracking.

Purpose: Fulfill SEC-04 (password strength) and SEC-07 (account lockout) requirements by adding database-backed lockout tracking and complexity validation hooks to better-auth.

Output: Lockout schema, password validation helper, and auth hooks that enforce security rules on every login/signup attempt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-authentication-hardening/12-CONTEXT.md
@.planning/phases/12-authentication-hardening/12-RESEARCH.md

@src/lib/auth.ts
@src/db/schema/auth.ts
@src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lockout schema and password validation helper</name>
  <files>
    src/db/schema/lockout.ts
    src/db/schema/index.ts
    src/lib/password-validation.ts
  </files>
  <action>
1. Create `src/db/schema/lockout.ts`:
   - Create `userLockout` table with:
     - `userId` (text, primary key, references user.id with cascade delete)
     - `failedAttempts` (integer, default 0)
     - `lastFailedAt` (timestamp, nullable)
     - `lockedUntil` (timestamp, nullable)
     - `lockoutCount` (integer, default 0) - for progressive escalation
     - `updatedAt` (timestamp, defaultNow)
   - Export both singular and plural forms for consistency

2. Update `src/db/schema/index.ts`:
   - Add `export * from "./lockout"`

3. Create `src/lib/password-validation.ts`:
   - Export `validatePasswordComplexity(password: string): string[]`
   - Returns array of error messages (empty if valid)
   - Rules from CONTEXT.md:
     - Minimum 8 characters
     - At least one uppercase letter
     - At least one lowercase letter
     - At least one number
     - At least one symbol (non-alphanumeric)
   - Return specific messages like "Password needs an uppercase letter"

4. Run `npx drizzle-kit push` to apply schema changes
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Schema push completes without error
    - `src/db/schema/lockout.ts` exports userLockout table
    - `src/lib/password-validation.ts` exports validatePasswordComplexity
  </verify>
  <done>
    Lockout table exists in database, password validation helper ready for use in auth hooks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auth hooks for lockout and password validation</name>
  <files>
    src/lib/auth.ts
  </files>
  <action>
Add better-auth hooks to enforce security rules. Import from research patterns:

1. Add imports at top:
   - `import { createAuthMiddleware, APIError } from "better-auth/api"`
   - `import { userLockout } from "@/db/schema/lockout"`
   - `import { validatePasswordComplexity } from "./password-validation"`
   - `import { eq } from "drizzle-orm"`

2. Add helper functions (inside auth.ts or as separate helpers):

   `getProgressiveDelay(failedAttempts: number): number`
   - Returns milliseconds to wait: [0, 1000, 2000, 5000, 10000]
   - Index by min(failedAttempts, 4)

   `getLockoutDuration(lockoutCount: number): number`
   - Returns milliseconds: [15*60*1000, 30*60*1000, 60*60*1000]
   - 1st lockout: 15 min, 2nd: 30 min, 3rd+: 1 hour
   - Index by min(lockoutCount, 2)

3. Add `hooks` property to betterAuth config:

   `before: createAuthMiddleware(async (ctx) => { ... })`

   For path `/sign-in/email`:
   - Get email from ctx.body
   - Look up user by email, then get lockout record by userId
   - If lockedUntil exists and is in future: throw APIError("FORBIDDEN", { message: "Unable to log in. Check your email for assistance." })
   - If failed attempts exist and lastFailedAt recent: check progressive delay
   - If not enough time passed: throw APIError("TOO_MANY_REQUESTS", { message: "Please wait before trying again" })

   For paths `/sign-up/email` or `/change-password`:
   - Get password from ctx.body.password or ctx.body.newPassword
   - Call validatePasswordComplexity
   - If errors: throw APIError("BAD_REQUEST", { message: errors.join(". ") })

   `after: createAuthMiddleware(async (ctx) => { ... })`

   For path `/sign-in/email`:
   - Check ctx.context.returned for error
   - Get user by email from ctx.body
   - If login failed (error exists):
     - Upsert lockout record, increment failedAttempts
     - If failedAttempts >= 5:
       - Calculate lockoutDuration from getLockoutDuration(lockoutCount)
       - Set lockedUntil = now + lockoutDuration
       - Increment lockoutCount
       - (Email sending will be added in plan 03)
   - If login succeeded:
     - Reset failedAttempts to 0, lockedUntil to null (keep lockoutCount for progressive escalation history)

IMPORTANT SECURITY NOTES from research:
- Check lockout FIRST (before password verification) to prevent timing attacks
- Use vague error message for lockout ("Unable to log in") - don't confirm account exists
- Use upsert pattern for lockout records (user may not have one yet)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Manual test: Try signup with weak password "test1234" - should be rejected
    - Manual test: Try signup with strong password "Test123!@#" - should proceed
    - Manual test: Login with wrong password 5 times - should see progressive delays then lockout
  </verify>
  <done>
    Auth hooks intercept login/signup requests, validate password complexity, track failures, and enforce lockout with progressive delays.
  </done>
</task>

</tasks>

<verification>
1. Password complexity enforced:
   - Signup with "password" fails with specific feedback
   - Signup with "Password1!" succeeds

2. Lockout tracking works:
   - Failed login increments failedAttempts in user_lockouts table
   - Successful login resets failedAttempts

3. Progressive delays active:
   - After 1st failure: 1 second delay before retry
   - After 4th failure: 10 second delay

4. Lockout triggers at 5 failures:
   - 5th failed login sets lockedUntil
   - Subsequent attempts rejected with "Unable to log in" message
</verification>

<success_criteria>
- Weak passwords rejected at signup with actionable feedback
- Failed login attempts tracked in database
- Progressive delays enforced (1s, 2s, 5s, 10s)
- Account locked after 5 failed attempts
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-authentication-hardening/12-01-SUMMARY.md`
</output>
