---
phase: 12-authentication-hardening
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/lib/email.ts
  - src/lib/auth.ts
  - src/app/(auth)/forgot-password/page.tsx
  - src/components/auth/forgot-password-form.tsx
  - src/components/auth/login-form.tsx
  - src/lib/actions/admin.ts
  - src/components/workspace/member-list.tsx
autonomous: true

must_haves:
  truths:
    - "Locked users receive email with unlock instructions"
    - "Password reset clears lockout state"
    - "Forgot password page allows users to request reset"
    - "Admins can unlock accounts from members page"
  artifacts:
    - path: "src/lib/email.ts"
      provides: "Unlock email sending function"
      exports: ["sendUnlockEmail"]
    - path: "src/app/(auth)/forgot-password/page.tsx"
      provides: "Forgot password route"
      min_lines: 5
    - path: "src/components/auth/forgot-password-form.tsx"
      provides: "Password reset request form"
      exports: ["ForgotPasswordForm"]
    - path: "src/lib/actions/admin.ts"
      provides: "Admin unlock server action"
      exports: ["adminUnlockUser"]
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/email.ts"
      via: "sendUnlockEmail on lockout"
      pattern: "sendUnlockEmail"
    - from: "src/components/workspace/member-list.tsx"
      to: "src/lib/actions/admin.ts"
      via: "unlock button calls adminUnlockUser"
      pattern: "adminUnlockUser"
---

<objective>
Complete the unlock flow with email notifications, forgot-password UI, password reset integration, and admin unlock capability.

Purpose: Provide locked users with a clear path to regain access (via email), and give admins the ability to manually unlock accounts. This fulfills the CONTEXT.md requirements for unlock mechanisms.

Output: Unlock email function, forgot-password page, password reset hook that clears lockout, admin unlock action and UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-authentication-hardening/12-CONTEXT.md
@.planning/phases/12-authentication-hardening/12-RESEARCH.md
@.planning/phases/12-authentication-hardening/12-01-SUMMARY.md

@src/lib/email.ts
@src/lib/auth.ts
@src/components/auth/login-form.tsx
@src/app/(workspace)/[workspaceSlug]/settings/members/page.tsx
@src/components/workspace/member-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unlock email and password reset integration</name>
  <files>
    src/lib/email.ts
    src/lib/auth.ts
  </files>
  <action>
1. Add unlock email function to `src/lib/email.ts`:
   ```typescript
   export async function sendUnlockEmail({
     to,
     resetUrl,
   }: {
     to: string;
     resetUrl: string;
   }) {
     await transporter.sendMail({
       from: process.env.EMAIL_FROM,
       to,
       subject: "Account Access - OComms",
       html: `
         <h1>Account Access</h1>
         <p>We noticed multiple failed login attempts on your account.</p>
         <p>If this was you, you can wait for the lockout to expire or reset your password:</p>
         <a href="${resetUrl}">Reset Password</a>
         <p>If this wasn't you, we recommend changing your password immediately.</p>
       `,
     });
   }
   ```

2. Update `src/lib/auth.ts` after hook:
   - When lockout is triggered (failedAttempts >= 5):
     - Generate password reset URL: `${process.env.NEXT_PUBLIC_APP_URL}/forgot-password?email=${encodeURIComponent(email)}`
     - Fire-and-forget: `void sendUnlockEmail({ to: email, resetUrl })`
   - Import sendUnlockEmail from "./email"

3. Add password reset success hook to `src/lib/auth.ts`:
   - In the `after` hook, check for path `/reset-password`
   - If successful (no error in ctx.context.returned):
     - Get user from the reset context (may need to decode from token or check ctx.body)
     - Clear lockout: set failedAttempts = 0, lockedUntil = null
     - Keep lockoutCount for escalation history
   - Note: better-auth's reset-password endpoint may not expose user directly - if so, implement as a separate hook or track via email in verification table

IMPORTANT from research:
- Fire-and-forget email to prevent timing attacks (already pattern in existing code)
- Password reset must bypass lockout immediately
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - When account locks (5 failed attempts), email is sent (check logs or SMTP)
    - Password reset clears lockout state in database
  </verify>
  <done>
    Locked users receive unlock email, password reset clears lockout state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create forgot-password page and update login form</name>
  <files>
    src/app/(auth)/forgot-password/page.tsx
    src/components/auth/forgot-password-form.tsx
    src/components/auth/login-form.tsx
  </files>
  <action>
1. Create `src/components/auth/forgot-password-form.tsx`:
   - "use client" directive
   - Use existing UI components (Card, Input, Button, Label)
   - Form with email input
   - On submit:
     - Call `authClient.forgetPassword({ email, redirectTo: "/login" })`
     - Show success message: "If an account exists with this email, you'll receive a password reset link."
     - Use vague message to prevent account enumeration
   - Handle loading state
   - Link back to login page

2. Create `src/app/(auth)/forgot-password/page.tsx`:
   - Import and render ForgotPasswordForm
   - Follow pattern from login/page.tsx and signup/page.tsx
   - Optionally pre-fill email from query param if provided (from unlock email link)

3. Update `src/components/auth/login-form.tsx`:
   - Add "Forgot password?" link below the password field
   - Link to /forgot-password
   - Style as subtle link (text-sm text-gray-600 hover:underline)

Note: better-auth client exports `forgetPassword` method. Check auth-client.ts exports and add if not present.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Navigate to /login - see "Forgot password?" link
    - Click link - arrives at /forgot-password page
    - Enter email and submit - see success message
    - Check that password reset email is sent (if SMTP configured)
  </verify>
  <done>
    Users can request password reset from forgot-password page, login page links to it.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add admin unlock capability</name>
  <files>
    src/lib/actions/admin.ts
    src/components/workspace/member-list.tsx
  </files>
  <action>
1. Create `src/lib/actions/admin.ts`:
   ```typescript
   "use server";

   import { auth } from "@/lib/auth";
   import { db } from "@/db";
   import { userLockout } from "@/db/schema/lockout";
   import { members } from "@/db/schema";
   import { eq, and } from "drizzle-orm";
   import { headers } from "next/headers";

   export async function adminUnlockUser(userId: string, organizationId: string) {
     const session = await auth.api.getSession({ headers: await headers() });
     if (!session) throw new Error("Unauthorized");

     // Verify caller is admin/owner in the same organization as target user
     const callerMembership = await db.query.members.findFirst({
       where: and(
         eq(members.userId, session.user.id),
         eq(members.organizationId, organizationId)
       ),
     });

     if (!callerMembership || (callerMembership.role !== "owner" && callerMembership.role !== "admin")) {
       throw new Error("Only admins can unlock accounts");
     }

     // Verify target user is in the same organization
     const targetMembership = await db.query.members.findFirst({
       where: and(
         eq(members.userId, userId),
         eq(members.organizationId, organizationId)
       ),
     });

     if (!targetMembership) {
       throw new Error("User not in organization");
     }

     // Clear lockout
     await db.update(userLockout)
       .set({
         failedAttempts: 0,
         lockedUntil: null,
         updatedAt: new Date(),
       })
       .where(eq(userLockout.userId, userId));

     return { success: true };
   }
   ```

2. Update `src/components/workspace/member-list.tsx`:
   - Add import for adminUnlockUser
   - Add state to track which users are locked (need to fetch or pass this info)
   - For admin/owner users, show "Unlock" button next to locked members
   - On click: call adminUnlockUser with userId and organizationId
   - Show loading state during action
   - Refresh or update UI on success

   Note: May need to add a query to check lockout status for each member, or add lockout info to the member list data passed from the page. Consider a simple approach first - show unlock button for all non-self members if admin, handle "not locked" case gracefully in the action.

   Simpler approach: Add unlock button that's always visible to admins (it's harmless to "unlock" a user who isn't locked). The action will just reset their lockout record.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - As admin, navigate to workspace settings -> members
    - See unlock option for other members
    - Click unlock - action succeeds
    - Verify lockout record cleared in database
  </verify>
  <done>
    Admins can unlock user accounts from the workspace members page.
  </done>
</task>

</tasks>

<verification>
1. Lockout email flow:
   - Lock an account (5 failed logins)
   - Check email for unlock message with reset link
   - Click link -> arrives at forgot-password page

2. Forgot password page:
   - Submit email -> see success message
   - Reset email sent (if SMTP configured)

3. Password reset clears lockout:
   - While locked, complete password reset flow
   - Verify lockedUntil is cleared in database
   - Can now log in with new password

4. Admin unlock:
   - As admin, go to members page
   - Click unlock for a user
   - Verify their lockout record is cleared
</verification>

<success_criteria>
- Locked users receive email with instructions
- Forgot-password page functional
- Password reset clears lockout state
- Admins can unlock accounts from members page
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-authentication-hardening/12-03-SUMMARY.md`
</output>
