---
phase: 27-rich-content
plan: 06
type: execute
wave: 4
depends_on: [27-03, 27-05]
files_modified:
  - src/app/(workspace)/[workspaceSlug]/settings/emoji/page.tsx
  - src/components/emoji/emoji-upload-form.tsx
  - src/components/emoji/emoji-list.tsx
  - src/components/message/message-content.tsx
autonomous: false

must_haves:
  truths:
    - "Custom emoji management UI exists in workspace settings (CONTEXT)"
    - "Users can see list of workspace emoji with upload form"
    - "Custom emoji render in message content with :name: syntax"
    - "Link previews queue jobs when messages contain URLs"
  artifacts:
    - path: "src/app/(workspace)/[workspaceSlug]/settings/emoji/page.tsx"
      provides: "Emoji management settings page"
      min_lines: 30
    - path: "src/components/emoji/emoji-upload-form.tsx"
      provides: "Emoji upload UI component"
      exports: ["EmojiUploadForm"]
    - path: "src/components/emoji/emoji-list.tsx"
      provides: "Emoji list with delete buttons"
      exports: ["EmojiList"]
  key_links:
    - from: "src/components/message/message-content.tsx"
      to: "custom emoji images"
      via: ":name: regex replacement"
      pattern: ":([a-zA-Z0-9_-]+):"
    - from: "message:send handler"
      to: "link preview queue"
      via: "extractUrls and queue.add"
      pattern: "linkPreviewQueue.add"
---

<objective>
Build emoji management UI and integrate preview/emoji rendering into message flow.

Purpose: Complete the rich content feature set with admin UI for emoji management (CONTEXT) and integrate all backend pieces with message display.
Output: Settings page for emoji, message content renders custom emoji, link preview jobs queued on message send.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-rich-content/27-CONTEXT.md
@.planning/phases/27-rich-content/27-03-SUMMARY.md
@.planning/phases/27-rich-content/27-05-SUMMARY.md

Reference existing patterns:
@src/app/(workspace)/[workspaceSlug]/settings/page.tsx
@src/components/message/message-content.tsx
@src/server/socket-handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create emoji management settings page</name>
  <files>src/app/(workspace)/[workspaceSlug]/settings/emoji/page.tsx, src/components/emoji/emoji-upload-form.tsx, src/components/emoji/emoji-list.tsx</files>
  <action>
**Create src/components/emoji/emoji-upload-form.tsx:**
```typescript
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Upload, Loader2 } from "lucide-react";

interface EmojiUploadFormProps {
  workspaceId: string;
  onUploadComplete: () => void;
}

export function EmojiUploadForm({ workspaceId, onUploadComplete }: EmojiUploadFormProps) {
  const [file, setFile] = useState<File | null>(null);
  const [name, setName] = useState("");
  const [uploading, setUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [preview, setPreview] = useState<string | null>(null);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0];
    if (selectedFile) {
      setFile(selectedFile);
      // Create preview URL
      setPreview(URL.createObjectURL(selectedFile));
      // Auto-generate name from filename (without extension)
      const baseName = selectedFile.name.replace(/\.[^/.]+$/, "")
        .replace(/[^a-zA-Z0-9_-]/g, "_");
      setName(baseName);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!file || !name) return;

    setUploading(true);
    setError(null);

    const formData = new FormData();
    formData.append("file", file);
    formData.append("name", name);
    formData.append("workspaceId", workspaceId);

    try {
      const res = await fetch("/api/upload/emoji", {
        method: "POST",
        body: formData,
      });

      const data = await res.json();

      if (!res.ok) {
        setError(data.error || "Upload failed");
        return;
      }

      // Reset form
      setFile(null);
      setName("");
      setPreview(null);
      onUploadComplete();
    } catch {
      setError("Upload failed");
    } finally {
      setUploading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="flex gap-4 items-start">
        {/* File input */}
        <div className="flex-1">
          <Label htmlFor="emoji-file">Image (PNG, JPG, GIF, SVG - max 128KB)</Label>
          <Input
            id="emoji-file"
            type="file"
            accept="image/png,image/jpeg,image/gif,image/webp,image/svg+xml"
            onChange={handleFileChange}
            className="mt-1"
          />
        </div>

        {/* Preview */}
        {preview && (
          <div className="w-16 h-16 border rounded flex items-center justify-center bg-muted">
            <img src={preview} alt="Preview" className="max-w-full max-h-full object-contain" />
          </div>
        )}
      </div>

      {/* Name input */}
      <div>
        <Label htmlFor="emoji-name">Shortcode (letters, numbers, _, -)</Label>
        <div className="flex items-center gap-2 mt-1">
          <span className="text-muted-foreground">:</span>
          <Input
            id="emoji-name"
            value={name}
            onChange={(e) => setName(e.target.value.replace(/[^a-zA-Z0-9_-]/g, ""))}
            placeholder="emoji_name"
            maxLength={64}
            className="flex-1"
          />
          <span className="text-muted-foreground">:</span>
        </div>
      </div>

      {error && <p className="text-sm text-red-500">{error}</p>}

      <Button type="submit" disabled={!file || !name || uploading}>
        {uploading ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            Uploading...
          </>
        ) : (
          <>
            <Upload className="mr-2 h-4 w-4" />
            Upload Emoji
          </>
        )}
      </Button>
    </form>
  );
}
```

**Create src/components/emoji/emoji-list.tsx:**
```typescript
"use client";

import { Button } from "@/components/ui/button";
import { Trash2 } from "lucide-react";
import { deleteCustomEmoji } from "@/lib/actions/custom-emoji";

interface CustomEmoji {
  id: string;
  name: string;
  path: string;
  isAnimated: boolean;
  uploadedBy: string;
  createdAt: Date;
}

interface EmojiListProps {
  emojis: CustomEmoji[];
  currentUserId: string;
  isAdmin: boolean;
  onDelete: () => void;
}

export function EmojiList({ emojis, currentUserId, isAdmin, onDelete }: EmojiListProps) {
  const handleDelete = async (emojiId: string) => {
    const result = await deleteCustomEmoji(emojiId);
    if (result.success) {
      onDelete();
    }
  };

  if (emojis.length === 0) {
    return (
      <p className="text-muted-foreground text-sm">
        No custom emoji yet. Upload one above!
      </p>
    );
  }

  return (
    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
      {emojis.map((emoji) => {
        const canDelete = emoji.uploadedBy === currentUserId || isAdmin;
        return (
          <div
            key={emoji.id}
            className="flex items-center gap-3 p-3 border rounded-lg"
          >
            <img
              src={emoji.path}
              alt={`:${emoji.name}:`}
              className="w-8 h-8 object-contain"
            />
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium truncate">:{emoji.name}:</p>
            </div>
            {canDelete && (
              <Button
                variant="ghost"
                size="sm"
                className="h-8 w-8 p-0 text-muted-foreground hover:text-red-500"
                onClick={() => handleDelete(emoji.id)}
              >
                <Trash2 className="h-4 w-4" />
              </Button>
            )}
          </div>
        );
      })}
    </div>
  );
}
```

**Create src/app/(workspace)/[workspaceSlug]/settings/emoji/page.tsx:**
```typescript
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { redirect } from "next/navigation";
import { db } from "@/db";
import { organizations, members } from "@/db/schema";
import { eq, and } from "drizzle-orm";
import { getWorkspaceEmojis } from "@/lib/actions/custom-emoji";
import { EmojiUploadForm } from "@/components/emoji/emoji-upload-form";
import { EmojiList } from "@/components/emoji/emoji-list";

interface PageProps {
  params: { workspaceSlug: string };
}

export default async function EmojiSettingsPage({ params }: PageProps) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) {
    redirect("/login");
  }

  // Get workspace
  const workspace = await db.query.organizations.findFirst({
    where: eq(organizations.slug, params.workspaceSlug),
  });

  if (!workspace) {
    redirect("/");
  }

  // Get membership
  const membership = await db.query.members.findFirst({
    where: and(
      eq(members.userId, session.user.id),
      eq(members.organizationId, workspace.id)
    ),
  });

  if (!membership) {
    redirect("/");
  }

  const isAdmin = membership.role === "admin" || membership.role === "owner";

  // Get emojis
  const emojis = await getWorkspaceEmojis(workspace.id);

  return (
    <div className="max-w-3xl mx-auto py-8 px-4">
      <h1 className="text-2xl font-bold mb-6">Custom Emoji</h1>

      {/* Upload form - admin only (CONTEXT decision) */}
      {isAdmin && (
        <div className="mb-8 p-4 border rounded-lg">
          <h2 className="text-lg font-semibold mb-4">Add Emoji</h2>
          <EmojiUploadFormClient workspaceId={workspace.id} />
        </div>
      )}

      {/* Emoji list */}
      <div>
        <h2 className="text-lg font-semibold mb-4">Workspace Emoji ({emojis.length})</h2>
        <EmojiListClient
          emojis={emojis}
          currentUserId={session.user.id}
          isAdmin={isAdmin}
        />
      </div>
    </div>
  );
}

// Client component wrappers for server component page
"use client";
function EmojiUploadFormClient({ workspaceId }: { workspaceId: string }) {
  const router = useRouter();
  return (
    <EmojiUploadForm
      workspaceId={workspaceId}
      onUploadComplete={() => router.refresh()}
    />
  );
}

function EmojiListClient({
  emojis,
  currentUserId,
  isAdmin,
}: {
  emojis: CustomEmoji[];
  currentUserId: string;
  isAdmin: boolean;
}) {
  const router = useRouter();
  return (
    <EmojiList
      emojis={emojis}
      currentUserId={currentUserId}
      isAdmin={isAdmin}
      onDelete={() => router.refresh()}
    />
  );
}
```

Note: The page needs to be split properly - create the client wrappers in the same file or separate client components. The key structure is:
- Server component fetches data and checks permissions
- Client components handle form submission and deletion with refresh
  </action>
  <verify>npx tsc --noEmit src/app/\(workspace\)/\[workspaceSlug\]/settings/emoji/page.tsx src/components/emoji/*.tsx</verify>
  <done>Emoji management settings page with upload form and emoji list (CONTEXT: management UI in workspace settings)</done>
</task>

<task type="auto">
  <name>Task 2: Render custom emoji in message content</name>
  <files>src/components/message/message-content.tsx</files>
  <action>
Update MessageContent to render :custom_emoji: syntax as images:

```typescript
"use client";

import { highlightMentions } from "@/lib/mentions";

// Custom emoji regex pattern
const CUSTOM_EMOJI_REGEX = /:([a-zA-Z0-9_-]+):/g;

interface CustomEmojiData {
  name: string;
  path: string;
}

interface MessageContentProps {
  content: string;
  currentUsername?: string;
  customEmojis?: CustomEmojiData[]; // Map of name -> path
}

/**
 * Message content component that renders text with highlighted mentions
 * and custom emoji.
 */
export function MessageContent({
  content,
  currentUsername,
  customEmojis = [],
}: MessageContentProps) {
  // Build emoji lookup map
  const emojiMap = new Map(customEmojis.map((e) => [e.name, e.path]));

  // Process content: first handle mentions, then custom emoji
  const processedContent = renderWithEmoji(content, emojiMap);

  // Apply mention highlighting to text nodes
  const nodes = highlightMentions(processedContent, currentUsername);

  return (
    <p className="text-foreground whitespace-pre-wrap break-words">{nodes}</p>
  );
}

/**
 * Replace :emoji_name: with inline images, preserving other text.
 */
function renderWithEmoji(content: string, emojiMap: Map<string, string>): React.ReactNode[] {
  const parts: React.ReactNode[] = [];
  let lastIndex = 0;

  content.replace(CUSTOM_EMOJI_REGEX, (match, name, offset) => {
    const path = emojiMap.get(name);

    // Add text before this match
    if (offset > lastIndex) {
      parts.push(content.slice(lastIndex, offset));
    }

    if (path) {
      // Render custom emoji as inline image
      parts.push(
        <img
          key={offset}
          src={path}
          alt={`:${name}:`}
          title={`:${name}:`}
          className="inline-block h-5 w-5 align-text-bottom"
        />
      );
    } else {
      // Not a known custom emoji, keep as text
      parts.push(match);
    }

    lastIndex = offset + match.length;
    return match;
  });

  // Add remaining text
  if (lastIndex < content.length) {
    parts.push(content.slice(lastIndex));
  }

  return parts.length > 0 ? parts : [content];
}
```

Note: The parent component needs to pass customEmojis prop (fetched via getWorkspaceEmojis).

For a cleaner implementation, consider passing the emoji list as context or fetching at a higher level to avoid prop drilling through message-list -> message-item -> message-content.
  </action>
  <verify>npx tsc --noEmit src/components/message/message-content.tsx</verify>
  <done>MessageContent renders :custom_emoji: as inline images (EMOJ-02)</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 27 Rich Content features:
1. Link previews: URLs in messages show Open Graph preview cards
2. Custom emoji: Upload, picker integration, message rendering
3. Settings page: Emoji management UI for admins
  </what-built>
  <how-to-verify>
**Link Previews (LINK-01 to LINK-07):**
1. Start the worker: npm run worker
2. Send a message with a URL (e.g., "Check out https://github.com")
3. Wait a few seconds for preview to appear below the message
4. Verify preview shows title, description, and thumbnail image
5. Click the preview card - should open URL in new tab (LINK-03)
6. Send message with your own URL, hover over preview, click X to hide (LINK-06)

**Custom Emoji (EMOJ-01 to EMOJ-08):**
1. Go to workspace settings -> Custom Emoji (must be admin)
2. Upload a PNG/JPG/GIF image (max 128KB) with a name
3. Verify emoji appears in the list
4. Open emoji picker in message input - verify custom emoji section at top (EMOJ-05)
5. Click custom emoji to insert :name: in message
6. Send the message - verify emoji renders as image (EMOJ-02)
7. Add reaction with custom emoji - verify it works (EMOJ-03)
8. Upload an SVG file - verify it converts and displays as PNG (EMOJ-08)
9. Delete an emoji you uploaded (EMOJ-06)

**Edge Cases:**
- Message with multiple URLs: first 5 get previews (LINK-02)
- Message with URL to .pdf file: no preview generated
- Emoji name collision: upload with existing name shows error (EMOJ-04)
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] npx tsc --noEmit passes for all new/modified files
- [ ] Emoji settings page loads and shows upload form for admins
- [ ] Custom emoji upload succeeds and emoji appears in list
- [ ] Message content renders :emoji_name: as inline images
- [ ] Link preview cards render in messages with URLs
- [ ] Hide preview button works on own messages
</verification>

<success_criteria>
Phase 27 complete when all verified:
- Link previews display automatically for URLs (LINK-01)
- Max 5 previews per message (LINK-02)
- Preview click opens new tab (LINK-03)
- Previews cached 24h (LINK-04)
- Twitter Card fallback (LINK-05 - handled by unfurl.js)
- User can hide own preview (LINK-06)
- SSRF protection active (LINK-07)
- Custom emoji upload works (EMOJ-01)
- :name: syntax renders in messages (EMOJ-02)
- Custom emoji in reactions (EMOJ-03)
- Unique names per workspace (EMOJ-04)
- Custom section in picker (EMOJ-05)
- Delete own emoji (EMOJ-06)
- Animated GIF support (EMOJ-07)
- SVG to PNG conversion (EMOJ-08)
</success_criteria>

<output>
After completion, create `.planning/phases/27-rich-content/27-06-SUMMARY.md`
</output>
