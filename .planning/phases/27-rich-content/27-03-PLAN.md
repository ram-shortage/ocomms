---
phase: 27-rich-content
plan: 03
type: execute
wave: 3
depends_on: [27-02]
files_modified:
  - src/components/message/link-preview-card.tsx
  - src/components/message/message-item.tsx
  - src/lib/actions/link-preview.ts
  - src/lib/socket-events.ts
autonomous: true

must_haves:
  truths:
    - "URLs in messages display Open Graph preview cards (LINK-01)"
    - "Preview shows title, description, image with domain text"
    - "Clicking preview opens URL in new tab (LINK-03)"
    - "User can hide preview on messages they sent (LINK-06)"
  artifacts:
    - path: "src/components/message/link-preview-card.tsx"
      provides: "Preview card component"
      exports: ["LinkPreviewCard"]
      min_lines: 50
    - path: "src/lib/actions/link-preview.ts"
      provides: "Server actions for preview management"
      exports: ["hideLinkPreview", "getMessagePreviews"]
  key_links:
    - from: "src/components/message/message-item.tsx"
      to: "src/components/message/link-preview-card.tsx"
      via: "import and render"
      pattern: "LinkPreviewCard"
    - from: "socket listener"
      to: "preview state update"
      via: "linkPreview:ready event"
      pattern: "linkPreview:ready"
---

<objective>
Build link preview UI with card component and message integration.

Purpose: Display rich preview cards for URLs in messages, letting users see content context without leaving the app (LINK-01, LINK-03).
Output: LinkPreviewCard component rendered in messages with hide functionality for own messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-rich-content/27-CONTEXT.md
@.planning/phases/27-rich-content/27-02-SUMMARY.md

Reference existing patterns:
@src/components/message/message-item.tsx
@src/components/message/file-attachment.tsx
@src/lib/actions/reminder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create link preview card component</name>
  <files>src/components/message/link-preview-card.tsx</files>
  <action>
Create a medium card layout component for link previews:

```typescript
"use client";

import { X } from "lucide-react";
import { Button } from "@/components/ui/button";

interface LinkPreviewCardProps {
  preview: {
    id: string;
    url: string;
    title: string | null;
    description: string | null;
    imageUrl: string | null;
    siteName: string | null;
  };
  canHide: boolean; // True if current user sent this message
  onHide?: (previewId: string) => void;
}

export function LinkPreviewCard({ preview, canHide, onHide }: LinkPreviewCardProps) {
  // Extract domain for display (CONTEXT: show domain text on cards)
  const domain = (() => {
    try {
      return new URL(preview.url).hostname.replace('www.', '');
    } catch {
      return preview.url;
    }
  })();

  // Skip rendering if no meaningful content
  if (!preview.title && !preview.description && !preview.imageUrl) {
    return null;
  }

  return (
    <a
      href={preview.url}
      target="_blank"
      rel="noopener noreferrer"
      className="group/preview block mt-2 max-w-md border rounded-lg overflow-hidden hover:bg-muted/50 transition-colors"
      onClick={(e) => e.stopPropagation()} // Prevent parent click handlers
    >
      <div className="flex">
        {/* Text content */}
        <div className="flex-1 p-3 min-w-0">
          {/* Site name / domain */}
          <div className="text-xs text-muted-foreground mb-1">
            {preview.siteName || domain}
          </div>

          {/* Title */}
          {preview.title && (
            <div className="font-medium text-sm text-foreground line-clamp-2 mb-1">
              {preview.title}
            </div>
          )}

          {/* Description (2-3 lines per CONTEXT) */}
          {preview.description && (
            <div className="text-xs text-muted-foreground line-clamp-3">
              {preview.description}
            </div>
          )}
        </div>

        {/* Thumbnail image (respect aspect ratio per CONTEXT) */}
        {preview.imageUrl && (
          <div className="w-24 h-24 shrink-0 bg-muted">
            <img
              src={preview.imageUrl}
              alt=""
              className="w-full h-full object-cover"
              onError={(e) => {
                // Hide broken images
                (e.target as HTMLImageElement).style.display = 'none';
              }}
            />
          </div>
        )}
      </div>

      {/* Hide button (X) for own messages - LINK-06 */}
      {canHide && onHide && (
        <Button
          variant="ghost"
          size="sm"
          className="absolute top-1 right-1 h-6 w-6 p-0 opacity-0 group-hover/preview:opacity-100 bg-background/80"
          onClick={(e) => {
            e.preventDefault();
            e.stopPropagation();
            onHide(preview.id);
          }}
        >
          <X className="h-3 w-3" />
          <span className="sr-only">Hide preview</span>
        </Button>
      )}
    </a>
  );
}
```

CONTEXT decisions applied:
- Medium card layout with title, description (2-3 lines), thumbnail to the side
- Show domain text on cards, skip favicon fetching
- Respect original image aspect ratio via object-cover
  </action>
  <verify>npx tsc --noEmit src/components/message/link-preview-card.tsx</verify>
  <done>LinkPreviewCard component renders preview with title, description, image, and hide button</done>
</task>

<task type="auto">
  <name>Task 2: Create server actions for preview management</name>
  <files>src/lib/actions/link-preview.ts</files>
  <action>
Create server actions following reminder.ts patterns:

```typescript
"use server";

import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { db } from "@/db";
import { linkPreviews, messageLinkPreviews, messages } from "@/db/schema";
import { eq, and } from "drizzle-orm";

export interface LinkPreview {
  id: string;
  url: string;
  title: string | null;
  description: string | null;
  imageUrl: string | null;
  siteName: string | null;
  position: number;
  hidden: boolean;
}

/**
 * Get all link previews for a message.
 * Returns non-hidden previews ordered by position.
 */
export async function getMessagePreviews(messageId: string): Promise<LinkPreview[]> {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) {
    throw new Error("Unauthorized");
  }

  const results = await db
    .select({
      id: linkPreviews.id,
      url: linkPreviews.url,
      title: linkPreviews.title,
      description: linkPreviews.description,
      imageUrl: linkPreviews.imageUrl,
      siteName: linkPreviews.siteName,
      position: messageLinkPreviews.position,
      hidden: messageLinkPreviews.hidden,
    })
    .from(messageLinkPreviews)
    .innerJoin(linkPreviews, eq(messageLinkPreviews.linkPreviewId, linkPreviews.id))
    .where(
      and(
        eq(messageLinkPreviews.messageId, messageId),
        eq(messageLinkPreviews.hidden, false)
      )
    )
    .orderBy(messageLinkPreviews.position);

  return results;
}

/**
 * Hide a link preview on a message the user owns.
 * LINK-06: User can dismiss/remove preview from message.
 */
export async function hideLinkPreview(
  messageId: string,
  previewId: string
): Promise<{ success: boolean; error?: string }> {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) {
    return { success: false, error: "Unauthorized" };
  }

  // Verify user owns the message
  const message = await db.query.messages.findFirst({
    where: eq(messages.id, messageId),
    columns: { authorId: true },
  });

  if (!message) {
    return { success: false, error: "Message not found" };
  }

  if (message.authorId !== session.user.id) {
    return { success: false, error: "Can only hide previews on your own messages" };
  }

  // Mark preview as hidden for this message
  await db
    .update(messageLinkPreviews)
    .set({ hidden: true })
    .where(
      and(
        eq(messageLinkPreviews.messageId, messageId),
        eq(messageLinkPreviews.linkPreviewId, previewId)
      )
    );

  return { success: true };
}
```
  </action>
  <verify>npx tsc --noEmit src/lib/actions/link-preview.ts</verify>
  <done>Server actions for fetching and hiding link previews created</done>
</task>

<task type="auto">
  <name>Task 3: Integrate previews into message-item</name>
  <files>src/components/message/message-item.tsx</files>
  <action>
Update MessageItem to render link previews:

1. Add previews prop to MessageItemProps:
```typescript
interface MessageItemProps {
  // ... existing props
  /** Link previews for this message */
  linkPreviews?: Array<{
    id: string;
    url: string;
    title: string | null;
    description: string | null;
    imageUrl: string | null;
    siteName: string | null;
  }>;
  onHidePreview?: (messageId: string, previewId: string) => void;
}
```

2. Import LinkPreviewCard:
```typescript
import { LinkPreviewCard } from "./link-preview-card";
```

3. Render previews after MessageContent and before attachments:
```typescript
{/* LINK-01: Link previews */}
{linkPreviews && linkPreviews.length > 0 && (
  <div className="flex flex-col gap-2 mt-2">
    {linkPreviews.map((preview) => (
      <LinkPreviewCard
        key={preview.id}
        preview={preview}
        canHide={isOwn}
        onHide={(previewId) => onHidePreview?.(message.id, previewId)}
      />
    ))}
  </div>
)}
```

Note: The parent component (channel-content, dm-content) will need to:
- Listen for linkPreview:ready Socket.IO events
- Maintain preview state per message
- Fetch initial previews when loading messages
- Call hideLinkPreview action when onHidePreview fires

This plan focuses on the component integration; Socket.IO listener integration happens in the parent components.
  </action>
  <verify>npx tsc --noEmit src/components/message/message-item.tsx</verify>
  <done>MessageItem renders LinkPreviewCard components with hide functionality for own messages</done>
</task>

</tasks>

<verification>
- [ ] npx tsc --noEmit passes for all modified files
- [ ] LinkPreviewCard renders title, description (line-clamped), image thumbnail
- [ ] Hide button only shows on hover for own messages
- [ ] hideLinkPreview action verifies message ownership
- [ ] getMessagePreviews filters out hidden previews
</verification>

<success_criteria>
Link preview UI complete:
- Preview cards display with title, description, thumbnail (LINK-01)
- Clicking card opens URL in new tab (LINK-03)
- User can hide previews on own messages via X button (LINK-06)
- Domain name shown on cards
</success_criteria>

<output>
After completion, create `.planning/phases/27-rich-content/27-03-SUMMARY.md`
</output>
