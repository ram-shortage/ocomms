---
phase: 27-rich-content
plan: 05
type: execute
wave: 3
depends_on: [27-04]
files_modified:
  - src/components/emoji/emoji-picker.tsx
  - src/components/message/reaction-picker.tsx
  - src/components/message/message-input.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Custom emoji appear in emoji picker alongside standard emoji (EMOJ-05)"
    - "Custom emoji section displays at top of picker (CONTEXT)"
    - "Custom emoji usable in reactions (EMOJ-03)"
    - "Custom emoji usable in messages with :name: syntax (EMOJ-02)"
    - "Emoji picker is lazy loaded to reduce initial bundle size"
  artifacts:
    - path: "src/components/emoji/emoji-picker.tsx"
      provides: "emoji-mart wrapper with custom emoji support"
      exports: ["EmojiPicker"]
      min_lines: 50
    - path: "src/components/message/reaction-picker.tsx"
      provides: "Reaction picker using new emoji-mart component"
  key_links:
    - from: "src/components/emoji/emoji-picker.tsx"
      to: "@emoji-mart/react"
      via: "import Picker"
      pattern: "emoji-mart"
    - from: "src/components/message/reaction-picker.tsx"
      to: "src/components/emoji/emoji-picker.tsx"
      via: "import EmojiPicker"
      pattern: "EmojiPicker"
---

<objective>
Replace frimousse with emoji-mart and integrate custom emoji support.

Purpose: Enable custom emoji in emoji picker for reactions and messages, with workspace-specific emoji appearing in dedicated section (EMOJ-02, EMOJ-03, EMOJ-05).
Output: emoji-mart based picker with custom emoji integration, reaction picker updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-rich-content/27-CONTEXT.md
@.planning/phases/27-rich-content/27-RESEARCH.md
@.planning/phases/27-rich-content/27-04-SUMMARY.md

Reference existing patterns:
@src/components/message/reaction-picker.tsx
@src/components/message/message-input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install emoji-mart and create wrapper component</name>
  <files>package.json, src/components/emoji/emoji-picker.tsx</files>
  <action>
**Install emoji-mart:**
```bash
npm install @emoji-mart/react @emoji-mart/data
```

**Create src/components/emoji/emoji-picker.tsx:**

Create a wrapper component that:
1. Integrates custom workspace emoji
2. Handles lazy loading of emoji data
3. Provides consistent API for reactions and message input

```typescript
"use client";

import { Suspense, lazy, useEffect, useState } from "react";

// Lazy load emoji-mart to reduce initial bundle (RESEARCH pitfall 3)
const Picker = lazy(() => import("@emoji-mart/react").then(mod => ({ default: mod.default })));

interface CustomEmojiData {
  id: string;
  name: string;
  path: string;
  isAnimated: boolean;
}

interface EmojiPickerProps {
  onSelect: (emoji: string) => void; // Native emoji or :custom_name:
  customEmojis?: CustomEmojiData[];
  autoFocus?: boolean;
}

export function EmojiPicker({ onSelect, customEmojis = [], autoFocus = false }: EmojiPickerProps) {
  const [data, setData] = useState<unknown>(null);

  // Lazy load emoji data
  useEffect(() => {
    import("@emoji-mart/data").then((mod) => {
      setData(mod.default);
    });
  }, []);

  if (!data) {
    return (
      <div className="flex h-[300px] items-center justify-center text-sm text-muted-foreground">
        Loading...
      </div>
    );
  }

  // Transform custom emojis to emoji-mart format
  // CONTEXT: Custom emoji section at top of picker
  const custom = customEmojis.length > 0 ? [{
    id: "workspace",
    name: "Workspace",
    emojis: customEmojis.map((e) => ({
      id: e.name, // Use name as ID for :name: syntax
      name: e.name,
      keywords: [e.name], // Searchable by name
      skins: [{ src: e.path }],
    })),
  }] : [];

  return (
    <Suspense
      fallback={
        <div className="flex h-[300px] items-center justify-center text-sm text-muted-foreground">
          Loading...
        </div>
      }
    >
      <Picker
        data={data}
        custom={custom}
        onEmojiSelect={(emoji: { native?: string; id?: string; src?: string }) => {
          if (emoji.native) {
            // Standard Unicode emoji
            onSelect(emoji.native);
          } else if (emoji.id) {
            // Custom emoji - use :name: format (EMOJ-02)
            onSelect(`:${emoji.id}:`);
          }
        }}
        autoFocus={autoFocus}
        theme="auto" // Respects system/app dark mode
        set="native" // Use native emoji rendering
        previewPosition="none"
        skinTonePosition="search"
        maxFrequentRows={2}
        // CONTEXT: Recently used includes both standard and custom combined
        // emoji-mart handles this automatically with frequentlyUsed
      />
    </Suspense>
  );
}
```

Note: emoji-mart renders its own styles. The component will inherit dark/light mode from the parent theme context.
  </action>
  <verify>npm ls @emoji-mart/react @emoji-mart/data && npx tsc --noEmit src/components/emoji/emoji-picker.tsx</verify>
  <done>emoji-mart installed, wrapper component created with custom emoji support and lazy loading</done>
</task>

<task type="auto">
  <name>Task 2: Update reaction picker to use emoji-mart</name>
  <files>src/components/message/reaction-picker.tsx</files>
  <action>
Replace frimousse with the new emoji-mart wrapper:

```typescript
"use client";

import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Button } from "@/components/ui/button";
import { SmilePlus } from "lucide-react";
import { useState } from "react";
import { EmojiPicker } from "@/components/emoji/emoji-picker";

interface CustomEmojiData {
  id: string;
  name: string;
  path: string;
  isAnimated: boolean;
}

interface ReactionPickerProps {
  onSelectEmoji: (emoji: string) => void;
  customEmojis?: CustomEmojiData[]; // Pass from parent
}

export function ReactionPicker({ onSelectEmoji, customEmojis = [] }: ReactionPickerProps) {
  const [open, setOpen] = useState(false);

  const handleSelect = (emoji: string) => {
    onSelectEmoji(emoji);
    setOpen(false);
  };

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button variant="ghost" size="sm" className="h-7 w-7 p-0 opacity-0 group-hover:opacity-100">
          <SmilePlus className="h-4 w-4" />
          <span className="sr-only">Add reaction</span>
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-[352px] p-0 border-0" align="start">
        <EmojiPicker
          onSelect={handleSelect}
          customEmojis={customEmojis}
        />
      </PopoverContent>
    </Popover>
  );
}
```

Key changes:
- Removed all frimousse imports and components
- Using new EmojiPicker component
- Added customEmojis prop to pass workspace emojis
- Popover content has no border/padding (emoji-mart handles styling)

The parent components (channel-content, dm-content) will need to:
1. Fetch workspace custom emojis via getWorkspaceEmojis action
2. Pass customEmojis array to ReactionPicker
  </action>
  <verify>npx tsc --noEmit src/components/message/reaction-picker.tsx</verify>
  <done>ReactionPicker uses emoji-mart with custom emoji support (EMOJ-03)</done>
</task>

<task type="auto">
  <name>Task 3: Add emoji picker to message input</name>
  <files>src/components/message/message-input.tsx</files>
  <action>
Add emoji picker button to message input for inserting emoji into messages (EMOJ-02):

1. Import components:
```typescript
import { SmilePlus } from "lucide-react";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { EmojiPicker } from "@/components/emoji/emoji-picker";
```

2. Add state and props for emoji picker:
```typescript
interface MessageInputProps {
  // ... existing props
  customEmojis?: Array<{
    id: string;
    name: string;
    path: string;
    isAnimated: boolean;
  }>;
}

// Inside component:
const [emojiPickerOpen, setEmojiPickerOpen] = useState(false);
```

3. Add emoji picker button next to the send button (before schedule dropdown if exists):
```typescript
{/* Emoji picker button */}
<Popover open={emojiPickerOpen} onOpenChange={setEmojiPickerOpen}>
  <PopoverTrigger asChild>
    <Button
      type="button"
      variant="ghost"
      size="sm"
      className="h-8 w-8 p-0"
    >
      <SmilePlus className="h-4 w-4" />
      <span className="sr-only">Insert emoji</span>
    </Button>
  </PopoverTrigger>
  <PopoverContent className="w-[352px] p-0 border-0" align="end">
    <EmojiPicker
      onSelect={(emoji) => {
        // Insert emoji at cursor position or append
        setMessage((prev) => prev + emoji);
        setEmojiPickerOpen(false);
      }}
      customEmojis={customEmojis}
    />
  </PopoverContent>
</Popover>
```

The emoji (native or :custom_name:) is inserted into the message text. When sent, custom emoji :name: syntax will be rendered by the message display component.
  </action>
  <verify>npx tsc --noEmit src/components/message/message-input.tsx</verify>
  <done>Message input has emoji picker button for inserting emoji (EMOJ-02)</done>
</task>

</tasks>

<verification>
- [ ] npm ls @emoji-mart/react shows installed
- [ ] npx tsc --noEmit passes for all files
- [ ] No frimousse imports remain in reaction-picker.tsx
- [ ] EmojiPicker renders custom emoji section at top (if customEmojis provided)
- [ ] Selecting custom emoji returns :name: format
- [ ] Message input emoji button inserts emoji into message text
</verification>

<success_criteria>
Emoji picker replacement complete:
- emoji-mart renders with custom emoji section at top (EMOJ-05, CONTEXT)
- Custom emoji usable in reactions (EMOJ-03)
- Custom emoji insertable in messages (EMOJ-02)
- Lazy loading prevents bundle bloat
- Dark mode support via theme="auto"
</success_criteria>

<output>
After completion, create `.planning/phases/27-rich-content/27-05-SUMMARY.md`
</output>
