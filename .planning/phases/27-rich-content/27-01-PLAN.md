---
phase: 27-rich-content
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/link-preview.ts
  - src/db/schema/custom-emoji.ts
  - src/db/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "Link previews can be cached and associated with messages"
    - "Custom emoji can be stored per workspace with unique names"
    - "Message-to-preview relationship tracks position and hidden state"
  artifacts:
    - path: "src/db/schema/link-preview.ts"
      provides: "link_previews and message_link_previews tables"
      exports: ["linkPreviews", "messageLinkPreviews"]
    - path: "src/db/schema/custom-emoji.ts"
      provides: "custom_emojis table"
      exports: ["customEmojis"]
  key_links:
    - from: "src/db/schema/message-link-preview table"
      to: "messages table"
      via: "messageId foreign key"
      pattern: "references.*messages"
    - from: "src/db/schema/custom-emoji"
      to: "organizations table"
      via: "workspaceId foreign key"
      pattern: "references.*organizations"
---

<objective>
Create database schema for link previews and custom emoji.

Purpose: Establish the data layer for caching link metadata (LINK-04) and storing workspace custom emoji (EMOJ-04).
Output: Two new schema files with tables, relations, and indexes for efficient querying.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-rich-content/27-CONTEXT.md
@.planning/phases/27-rich-content/27-RESEARCH.md

Reference existing schema patterns:
@src/db/schema/message.ts
@src/db/schema/bookmark.ts
@src/db/schema/file-attachment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create link preview schema</name>
  <files>src/db/schema/link-preview.ts</files>
  <action>
Create Drizzle schema for link preview caching:

**link_previews table** (canonical URL cache):
- id: uuid primary key
- url: text, unique, not null (canonical URL for cache lookup)
- title: varchar(500), nullable
- description: text, nullable
- imageUrl: text, nullable
- siteName: varchar(200), nullable
- fetchedAt: timestamp, not null, defaultNow
- expiresAt: timestamp, not null (24-hour TTL)

Indexes: url (unique), expiresAt (for cleanup)

**message_link_previews table** (junction):
- id: uuid primary key
- messageId: uuid, not null, references messages.id (onDelete cascade)
- linkPreviewId: uuid, not null, references linkPreviews.id (onDelete cascade)
- position: integer, not null, default 0 (order in message, LINK-02)
- hidden: boolean, not null, default false (LINK-06: user dismissed)

Indexes: messageId, unique on (messageId, linkPreviewId)

Add relations:
- messageLinkPreviews -> messages (one)
- messageLinkPreviews -> linkPreviews (one)

Follow patterns from bookmark.ts and file-attachment.ts for reference style.
  </action>
  <verify>npx tsc --noEmit src/db/schema/link-preview.ts</verify>
  <done>link_previews and message_link_previews tables defined with proper types, indexes, and relations</done>
</task>

<task type="auto">
  <name>Task 2: Create custom emoji schema</name>
  <files>src/db/schema/custom-emoji.ts</files>
  <action>
Create Drizzle schema for custom workspace emoji:

**custom_emojis table**:
- id: uuid primary key
- workspaceId: text, not null, references organizations.id (onDelete cascade)
- name: varchar(64), not null (emoji shortcode without colons)
- filename: varchar(255), not null (UUID.ext on disk)
- path: varchar(500), not null (public URL path /uploads/emoji/...)
- mimeType: varchar(100), not null
- sizeBytes: integer, not null
- isAnimated: boolean, not null, default false (EMOJ-07: GIF flag)
- uploadedBy: text, not null, references users.id (onDelete cascade)
- createdAt: timestamp, not null, defaultNow

Constraints:
- uniqueIndex on (workspaceId, name) - EMOJ-04: names unique within workspace

Indexes: workspaceId (for fetching all workspace emoji)

Add relations:
- customEmojis -> organizations (one, via workspaceId)
- customEmojis -> users (one, via uploadedBy)

Name validation pattern will be enforced at API level: [a-zA-Z0-9_-]+
  </action>
  <verify>npx tsc --noEmit src/db/schema/custom-emoji.ts</verify>
  <done>custom_emojis table defined with workspace-scoped uniqueness constraint on name</done>
</task>

<task type="auto">
  <name>Task 3: Export schemas and run migration</name>
  <files>src/db/schema/index.ts</files>
  <action>
Add exports to schema index:
- export * from "./link-preview";
- export * from "./custom-emoji";

After adding exports, generate migration:
npx drizzle-kit generate

Then push to database:
npx drizzle-kit push

Note: If database is not running, generation is sufficient - push can happen later.
  </action>
  <verify>npx tsc --noEmit && ls src/db/migrations/*.sql | tail -1</verify>
  <done>Schema exports added, migration generated, tables created in database</done>
</task>

</tasks>

<verification>
- [ ] npx tsc --noEmit passes for all schema files
- [ ] link_previews table has url unique constraint
- [ ] message_link_previews has cascade delete on message
- [ ] custom_emojis has (workspaceId, name) unique constraint
- [ ] drizzle-kit generate creates migration file
</verification>

<success_criteria>
Database schema ready for link preview caching (LINK-04) and custom emoji storage (EMOJ-04). Tables support:
- URL-based preview cache lookup with expiration
- Per-message preview association with position and hidden state
- Workspace-scoped custom emoji with unique names
</success_criteria>

<output>
After completion, create `.planning/phases/27-rich-content/27-01-SUMMARY.md`
</output>
