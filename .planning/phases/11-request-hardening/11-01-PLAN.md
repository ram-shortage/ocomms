---
phase: 11-request-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nginx/conf.d/default.conf
  - src/lib/auth.ts
autonomous: true

must_haves:
  truths:
    - "All responses include Content-Security-Policy header"
    - "All responses include X-Frame-Options, X-Content-Type-Options headers"
    - "Login endpoint returns 429 after excessive attempts"
    - "Signup endpoint returns 429 after excessive attempts"
  artifacts:
    - path: "nginx/conf.d/default.conf"
      provides: "Security headers including CSP"
      contains: "Content-Security-Policy"
    - path: "src/lib/auth.ts"
      provides: "Rate limiting configuration"
      contains: "rateLimit"
  key_links:
    - from: "nginx/conf.d/default.conf"
      to: "browser"
      via: "HTTP response headers"
      pattern: "add_header.*Content-Security-Policy"
    - from: "src/lib/auth.ts"
      to: "/api/auth endpoints"
      via: "better-auth rate limiting middleware"
      pattern: "rateLimit.*customRules"
---

<objective>
Add security headers to all responses and configure rate limiting for authentication endpoints.

Purpose: Protect against clickjacking (X-Frame-Options), XSS (CSP), MIME sniffing (X-Content-Type-Options), and brute force attacks (rate limiting).
Output: nginx config with CSP header, better-auth with rate limiting enabled.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@nginx/conf.d/default.conf
@src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Content-Security-Policy header to nginx</name>
  <files>nginx/conf.d/default.conf</files>
  <action>
Add Content-Security-Policy header to the HTTPS server block in nginx config.

CSP policy for OComms chat application:
- `default-src 'self'` - Only load resources from same origin by default
- `script-src 'self' 'unsafe-inline' 'unsafe-eval'` - Allow inline scripts (Next.js needs this)
- `style-src 'self' 'unsafe-inline'` - Allow inline styles (Tailwind, React)
- `img-src 'self' data: blob:` - Allow images from self, data URIs (avatars), and blob URLs
- `font-src 'self'` - Only fonts from same origin
- `connect-src 'self' wss: ws:` - Allow API calls and WebSocket connections
- `frame-ancestors 'self'` - Prevent embedding in iframes (clickjacking protection, replaces X-Frame-Options)
- `form-action 'self'` - Forms can only submit to same origin

Add this line after existing security headers in the HTTPS server block:
```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self' wss: ws:; frame-ancestors 'self'; form-action 'self'" always;
```

Keep existing headers:
- Strict-Transport-Security (HSTS) - already present
- X-Frame-Options SAMEORIGIN - keep as fallback for older browsers
- X-Content-Type-Options nosniff - already present
  </action>
  <verify>
Run `grep -E "(Content-Security-Policy|X-Frame-Options|X-Content-Type-Options)" nginx/conf.d/default.conf` - should show all 3 headers configured.
  </verify>
  <done>nginx config includes CSP header with appropriate policy for chat application</done>
</task>

<task type="auto">
  <name>Task 2: Configure better-auth rate limiting</name>
  <files>src/lib/auth.ts</files>
  <action>
Add rate limiting configuration to the betterAuth() call in src/lib/auth.ts.

Configure:
1. Global rate limit: 100 requests per 60 seconds (default production behavior, but make explicit)
2. Stricter limits for auth endpoints:
   - `/sign-in/email`: 5 requests per 60 seconds (prevent brute force)
   - `/sign-up/email`: 3 requests per 60 seconds (prevent abuse)
   - `/forgot-password`: 3 requests per 60 seconds (prevent email spam)

Add this to the betterAuth config object:

```typescript
rateLimit: {
  enabled: true,
  window: 60, // seconds
  max: 100, // requests per window
  customRules: {
    "/sign-in/email": {
      window: 60,
      max: 5,
    },
    "/sign-up/email": {
      window: 60,
      max: 3,
    },
    "/forgot-password": {
      window: 60,
      max: 3,
    },
  },
},
```

Place this after the `session` configuration and before the `plugins` array.

Note: better-auth uses in-memory storage by default which is fine for single-server deployments. For horizontal scaling, would need to switch to database or Redis storage (future enhancement).
  </action>
  <verify>
Run `grep -A 15 "rateLimit:" src/lib/auth.ts` - should show rate limit configuration with customRules for sign-in, sign-up, and forgot-password.
  </verify>
  <done>better-auth configured with global rate limiting and stricter limits on auth endpoints</done>
</task>

</tasks>

<verification>
1. `grep -E "(Content-Security-Policy|rateLimit)" nginx/conf.d/default.conf src/lib/auth.ts` - both files have required additions
2. `npm run build` - TypeScript compiles without errors
</verification>

<success_criteria>
- nginx config includes CSP header with self, inline scripts/styles, websocket connections
- auth.ts includes rateLimit configuration with customRules for auth endpoints
- Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-request-hardening/11-01-SUMMARY.md`
</output>
