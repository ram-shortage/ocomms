---
phase: 11-request-hardening
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Security headers visible in browser developer tools"
    - "Rate limiting returns 429 when limits exceeded"
    - "All SEC-02 and SEC-03 requirements satisfied"
  artifacts: []
  key_links: []
---

<objective>
Verify security headers are present on all responses and rate limiting blocks excessive requests.

Purpose: Confirm SEC-02 (security headers) and SEC-03 (rate limiting) requirements are met.
Output: Verification of working security controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/11-request-hardening/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify security headers in development</name>
  <files></files>
  <action>
Start the development server and verify security headers are present.

Since nginx with CSP runs in production Docker, for development testing:

1. Verify the nginx config syntax is valid:
```bash
docker run --rm -v $(pwd)/nginx/conf.d:/etc/nginx/conf.d:ro nginx:alpine nginx -t -c /etc/nginx/nginx.conf
```
Note: This will fail if nginx.conf isn't present, which is expected. The key is validating our user_conf.d file.

Alternative: Check the config file directly for required headers:
```bash
grep -E "add_header" nginx/conf.d/default.conf
```

Should show:
- Content-Security-Policy header
- Strict-Transport-Security header
- X-Frame-Options header
- X-Content-Type-Options header

2. Verify auth.ts has rate limiting enabled:
```bash
grep -B2 -A10 "rateLimit:" src/lib/auth.ts
```

Should show enabled: true and customRules for auth endpoints.
  </action>
  <verify>
`grep -c "add_header" nginx/conf.d/default.conf` returns 4 or more (CSP, HSTS, X-Frame-Options, X-Content-Type-Options).
`grep -c "customRules" src/lib/auth.ts` returns 1 or more.
  </verify>
  <done>Security header configuration verified in nginx config, rate limiting configured in auth.ts</done>
</task>

<task type="auto">
  <name>Task 2: Test rate limiting locally</name>
  <files></files>
  <action>
Test that rate limiting is working by making rapid requests to the sign-in endpoint.

1. Start the development server:
```bash
npm run dev &
sleep 5
```

2. Make rapid sign-in attempts (should hit rate limit of 5/minute):
```bash
for i in {1..7}; do
  curl -s -o /dev/null -w "%{http_code}\n" \
    -X POST http://localhost:3000/api/auth/sign-in/email \
    -H "Content-Type: application/json" \
    -d '{"email":"test@test.com","password":"wrong"}';
  sleep 0.5;
done
```

Expected: First 5 requests return 400 or 401 (auth failure), requests 6-7 return 429 (rate limited).

3. Check that rate limit headers are present in response:
```bash
curl -i -X POST http://localhost:3000/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"wrong"}'
```

Should include X-Retry-After header when rate limited.

4. Stop development server when done.
  </action>
  <verify>
After 5+ rapid requests to /api/auth/sign-in/email, response status code is 429.
  </verify>
  <done>Rate limiting confirmed working - returns 429 after exceeding request limit</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Security headers configured in nginx, rate limiting configured in better-auth</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Visit http://localhost:3000 and open browser DevTools (F12)
3. Go to Network tab, refresh page
4. Click on any request and check Response Headers
   - Note: In dev mode without nginx, you won't see nginx headers
   - BUT you can verify the config files are correct

5. Test rate limiting:
   - Go to login page
   - Enter wrong credentials 6+ times rapidly
   - After ~5 attempts, should see rate limit error (429) or error message about too many attempts

6. For full header testing (optional):
   - Run `docker-compose up --build` to test with nginx
   - Access via https://localhost (may need to accept self-signed cert warning)
   - Check DevTools Network tab for all security headers

Expected in production (with nginx):
- Content-Security-Policy: default-src 'self'; script-src...
- Strict-Transport-Security: max-age=3600
- X-Frame-Options: SAMEORIGIN
- X-Content-Type-Options: nosniff
  </how-to-verify>
  <resume-signal>Type "approved" if security headers are configured correctly and rate limiting works, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. nginx config contains all 4 security headers
2. auth.ts contains rate limiting with custom rules
3. Rate limiting returns 429 after exceeding limits
4. Human verified configuration is correct
</verification>

<success_criteria>
- SEC-02: All 4 security headers present in nginx config (CSP, HSTS, X-Frame-Options, X-Content-Type-Options)
- SEC-03: Rate limiting configured with stricter limits on login/signup (5 and 3 requests/minute respectively)
- Human verification confirms correct behavior
</success_criteria>

<output>
After completion, create `.planning/phases/11-request-hardening/11-02-SUMMARY.md`
</output>
