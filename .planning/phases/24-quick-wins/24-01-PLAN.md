---
phase: 24-quick-wins
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/socket/handlers/typing.ts
  - src/server/socket/index.ts
  - src/lib/hooks/use-typing.ts
  - src/components/message/typing-indicator.tsx
  - src/components/message/message-input.tsx
autonomous: true

must_haves:
  truths:
    - "User sees '[Name] is typing...' when another user composes a message"
    - "Multiple typers display as 'Alice, Bob are typing...' format"
    - "Indicator auto-hides after 5 seconds of inactivity"
    - "Indicator clears immediately when message is sent"
    - "Typing events throttled to max 1 per 3 seconds client-side"
  artifacts:
    - path: "src/server/socket/handlers/typing.ts"
      provides: "Server-side typing event handler"
      exports: ["handleTypingEvents"]
    - path: "src/lib/hooks/use-typing.ts"
      provides: "Client-side typing throttle hook"
      exports: ["useTyping"]
    - path: "src/components/message/typing-indicator.tsx"
      provides: "Typing indicator display component"
      exports: ["TypingIndicator"]
  key_links:
    - from: "src/components/message/message-input.tsx"
      to: "src/lib/hooks/use-typing.ts"
      via: "useTyping hook call on keystroke"
      pattern: "useTyping\\("
    - from: "src/lib/hooks/use-typing.ts"
      to: "socket"
      via: "emit typing:start/typing:stop"
      pattern: "socket\\.emit\\(\"typing:"
    - from: "src/server/socket/handlers/typing.ts"
      to: "socket room"
      via: "broadcast typing:update to channel/dm room"
      pattern: "socket\\.to\\(.*\\)\\.emit\\(\"typing:update\""
---

<objective>
Implement typing indicators for channels and DMs.

Purpose: Show real-time "[Name] is typing..." indicators when users compose messages (TYPE-01 to TYPE-05).
Output: Server handler, client hook, display component integrated into message input.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-quick-wins/24-CONTEXT.md
@.planning/phases/24-quick-wins/24-RESEARCH.md

# Existing socket patterns
@src/server/socket/handlers/presence.ts
@src/lib/socket-events.ts
@src/components/message/message-input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side typing handler</name>
  <files>
    src/server/socket/handlers/typing.ts
    src/server/socket/index.ts
  </files>
  <action>
Create typing handler following presence.ts pattern:

1. Create `src/server/socket/handlers/typing.ts`:
   - Export `handleTypingEvents(socket, io)` function
   - Listen for `typing:start` - broadcast `typing:update` with `isTyping: true` to channel/dm room (except sender)
   - Listen for `typing:stop` - broadcast `typing:update` with `isTyping: false` to channel/dm room (except sender)
   - Use `getRoomName.channel()` or `getRoomName.conversation()` based on targetType
   - Include userId, userName (from socket.data), targetId, isTyping in broadcast
   - Handle disconnect: automatically broadcast typing:stop for any active typing

2. Update `src/server/socket/index.ts`:
   - Import handleTypingEvents
   - Call it in the socket connection handler after other handlers

Note: typing:start, typing:stop, typing:update events already defined in socket-events.ts.
  </action>
  <verify>
Server starts without errors. Check handler registration in socket/index.ts.
  </verify>
  <done>
Typing events broadcast to room members when typing:start/stop received.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client-side typing hook with throttle</name>
  <files>
    src/lib/hooks/use-typing.ts
  </files>
  <action>
Create `src/lib/hooks/use-typing.ts`:

```typescript
const TYPING_THROTTLE_MS = 3000; // TYPE-05: max 1 per 3 seconds
const TYPING_TIMEOUT_MS = 5000;  // TYPE-03: auto-hide after 5 seconds

export function useTyping(targetId: string, targetType: "channel" | "dm") {
  // Use refs for lastEmit time and timeout
  // Return { emitTyping, stopTyping }

  // emitTyping():
  //   - Check if 3 seconds since last emit, if not return early (throttle)
  //   - Emit typing:start
  //   - Reset/set 5-second timeout to emit typing:stop

  // stopTyping():
  //   - Clear timeout
  //   - Emit typing:stop immediately

  // Cleanup on unmount: clear timeout, emit typing:stop
}
```

Important: Use refs not state to avoid stale closure issues. Follow pattern from RESEARCH.md.
  </action>
  <verify>
TypeScript compiles. Hook exports useTyping.
  </verify>
  <done>
Hook throttles typing events to max 1 per 3 seconds, auto-stops after 5 seconds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Typing indicator component and message input integration</name>
  <files>
    src/components/message/typing-indicator.tsx
    src/components/message/message-input.tsx
    src/components/message/index.ts
  </files>
  <action>
1. Create `src/components/message/typing-indicator.tsx`:
   - Props: targetId (channelId or conversationId)
   - Listen to socket `typing:update` events for matching targetId
   - Track typing users in Map (userId -> userName)
   - Display format per CONTEXT.md:
     - 1 user: "Alice is typing..."
     - 2 users: "Alice, Bob are typing..."
     - 3+ users: "Alice, Bob, and 3 others are typing..."
   - Reserved height always (h-5) to prevent layout shift
   - Styling: text-xs text-muted-foreground

2. Update `src/components/message/message-input.tsx`:
   - Import and use useTyping hook
   - Call emitTyping() on textarea onChange (every keystroke triggers throttled emit)
   - Call stopTyping() on successful message send (TYPE-04: clears immediately)
   - Add TypingIndicator component below the form (after rate limit message)

3. Export TypingIndicator from `src/components/message/index.ts`

Per CONTEXT.md: No animated dots, plain text only.
  </action>
  <verify>
`npm run build` succeeds. Open two browser windows, type in one, see indicator in other.
  </verify>
  <done>
Typing indicator shows below message input when another user types. Clears on send. Throttled at 3s.
  </done>
</task>

</tasks>

<verification>
1. Open app in two browser tabs as different users
2. Start typing in one tab
3. Other tab shows "[Name] is typing..." below input
4. Stop typing - indicator disappears after 5 seconds
5. Send message - indicator clears immediately
6. Rapid typing only sends ~1 event per 3 seconds (check Network/WS tab)
</verification>

<success_criteria>
- TYPE-01: Channel shows "[Name] is typing..." when user composes
- TYPE-02: Multiple typers formatted correctly
- TYPE-03: Auto-hide after 5 seconds inactivity
- TYPE-04: Clears immediately on send
- TYPE-05: Throttled to max 1 per 3 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/24-quick-wins/24-01-SUMMARY.md`
</output>
