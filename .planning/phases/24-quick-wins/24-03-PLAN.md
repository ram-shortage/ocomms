---
phase: 24-quick-wins
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/channel-category.ts
  - src/db/schema/channel.ts
  - src/db/schema/index.ts
  - src/lib/actions/channel-category.ts
  - src/components/channel/category-sidebar.tsx
  - src/components/channel/channel-list-client.tsx
  - src/components/workspace/workspace-sidebar.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Admin can create named channel categories"
    - "Channels can be assigned to a category"
    - "User can collapse/expand categories in sidebar"
    - "User can drag channels between categories (admin only)"
    - "Uncategorized channels display in separate section"
    - "Category sort order is configurable"
  artifacts:
    - path: "src/db/schema/channel-category.ts"
      provides: "Category and collapse state tables"
      exports: ["channelCategories", "userCategoryCollapseStates"]
    - path: "src/lib/actions/channel-category.ts"
      provides: "Category CRUD actions"
      exports: ["createCategory", "updateCategoryOrder", "assignChannelToCategory"]
    - path: "src/components/channel/category-sidebar.tsx"
      provides: "Drag-drop sortable category component"
      exports: ["CategorySidebar"]
  key_links:
    - from: "src/components/channel/category-sidebar.tsx"
      to: "@dnd-kit/sortable"
      via: "SortableContext for drag-drop"
      pattern: "SortableContext"
    - from: "src/components/workspace/workspace-sidebar.tsx"
      to: "src/components/channel/category-sidebar.tsx"
      via: "Replaces flat channel list"
      pattern: "CategorySidebar"
---

<objective>
Implement channel categories with drag-and-drop organization.

Purpose: Allow admins to organize channels into collapsible categories for better sidebar navigation (CCAT-01 to CCAT-06).
Output: Category schema, CRUD actions, dnd-kit sortable sidebar with collapse states.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-quick-wins/24-CONTEXT.md
@.planning/phases/24-quick-wins/24-RESEARCH.md

# Existing patterns
@src/db/schema/channel.ts
@src/components/channel/channel-list-client.tsx
@src/components/workspace/workspace-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit and create category schema</name>
  <files>
    package.json
    src/db/schema/channel-category.ts
    src/db/schema/channel.ts
    src/db/schema/index.ts
  </files>
  <action>
1. Install dnd-kit:
```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

2. Create `src/db/schema/channel-category.ts`:
```typescript
import { pgTable, text, timestamp, uuid, uniqueIndex, integer, boolean, index } from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";
import { organizations, users } from "./auth";

export const channelCategories = pgTable("channel_categories", {
  id: uuid("id").primaryKey().defaultRandom(),
  organizationId: text("organization_id")
    .notNull()
    .references(() => organizations.id, { onDelete: "cascade" }),
  name: text("name").notNull(),
  sortOrder: integer("sort_order").notNull().default(0),
  createdBy: text("created_by")
    .references(() => users.id, { onDelete: "set null" }),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
}, (table) => [
  index("channel_categories_org_idx").on(table.organizationId),
]);

export const userCategoryCollapseStates = pgTable("user_category_collapse_states", {
  id: uuid("id").primaryKey().defaultRandom(),
  userId: text("user_id")
    .notNull()
    .references(() => users.id, { onDelete: "cascade" }),
  categoryId: uuid("category_id")
    .notNull()
    .references(() => channelCategories.id, { onDelete: "cascade" }),
  isCollapsed: boolean("is_collapsed").notNull().default(false),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
}, (table) => [
  uniqueIndex("user_category_collapse_unique_idx").on(table.userId, table.categoryId),
]);

// Relations
export const channelCategoriesRelations = relations(channelCategories, ({ one, many }) => ({
  organization: one(organizations, {
    fields: [channelCategories.organizationId],
    references: [organizations.id],
  }),
}));
```

3. Update `src/db/schema/channel.ts`:
   - Add `categoryId` and `sortOrder` columns:
```typescript
categoryId: uuid("category_id").references(() => channelCategories.id, { onDelete: "set null" }),
sortOrder: integer("sort_order").notNull().default(0),
```
   - Add relation to channelCategories

4. Export from `src/db/schema/index.ts`

5. Run migration: `npx drizzle-kit push`
  </action>
  <verify>
`npm run build` succeeds. Tables created in database.
  </verify>
  <done>
dnd-kit installed. channelCategories and userCategoryCollapseStates tables exist. Channels have categoryId and sortOrder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Category server actions</name>
  <files>
    src/lib/actions/channel-category.ts
  </files>
  <action>
Create `src/lib/actions/channel-category.ts`:

```typescript
"use server";

// createCategory(organizationId, name)
// - Auth + org membership check
// - Insert with next sortOrder (max + 1)
// - Return category

// updateCategory(categoryId, { name?, sortOrder? })
// - Auth + admin check (only admins can manage categories)
// - Update fields
// - revalidatePath

// deleteCategory(categoryId)
// - Auth + admin check
// - Set categoryId=null for all channels in this category
// - Delete category
// - revalidatePath

// getCategories(organizationId)
// - Auth + org membership check
// - Return categories ordered by sortOrder
// - Include channel count per category

// assignChannelToCategory(channelId, categoryId)
// - Auth + admin check (CCAT-04: only admins can move channels)
// - Update channel.categoryId
// - revalidatePath

// reorderCategories(categoryIds: string[])
// - Auth + admin check
// - Update sortOrder for each category based on array position
// - revalidatePath

// toggleCategoryCollapse(categoryId, isCollapsed)
// - Auth check
// - Upsert user_category_collapse_states
// - No revalidate needed (client state)

// getCollapseStates(organizationId)
// - Auth check
// - Return user's collapse states for all categories
```

Important: Per CONTEXT.md, drag affordances hidden for non-admins (they can collapse but not reorder).
  </action>
  <verify>
TypeScript compiles. Actions are exported.
  </verify>
  <done>
Category CRUD actions work with proper permission checks. Collapse states per-user.
  </done>
</task>

<task type="auto">
  <name>Task 3: Category sidebar component with drag-drop</name>
  <files>
    src/components/channel/category-sidebar.tsx
    src/components/channel/channel-list-client.tsx
    src/components/workspace/workspace-sidebar.tsx
  </files>
  <action>
1. Create `src/components/channel/category-sidebar.tsx`:
   - Client component with DndContext from @dnd-kit/core
   - SortableContext for channels within each category
   - Per CONTEXT.md:
     - Collapsed categories show badge with total unread count
     - Empty categories auto-hide
     - Non-admin users see no drag affordances (check isAdmin prop)
   - useSortable for each channel item (only if isAdmin)
   - Handle DragEnd: call assignChannelToCategory if moving between categories
   - Each category header has collapse/expand toggle (ChevronRight/ChevronDown)
   - Call toggleCategoryCollapse on click
   - Load initial collapse states server-side to prevent flicker

2. Update `src/components/channel/channel-list-client.tsx`:
   - Extract channel link rendering to reusable SortableChannelItem component
   - Accept draggable prop to conditionally apply useSortable

3. Update `src/components/workspace/workspace-sidebar.tsx`:
   - Replace flat ChannelListClient with CategorySidebar
   - Pass categories, channels grouped by categoryId, collapse states, isAdmin
   - Uncategorized channels (categoryId=null) render in "Channels" section at bottom
   - Add "Create Category" button for admins (or in settings)

4. Add category management to admin settings or channel settings:
   - Create category dialog
   - Rename/delete category options

Per CONTEXT.md: Both drag-and-drop AND context menu for moving channels.
  </action>
  <verify>
`npm run build` succeeds. Categories display in sidebar. Collapse/expand works. Admin can drag channels between categories.
  </verify>
  <done>
Category sidebar renders with collapsible groups. Drag-drop works for admins. Collapse states persist per-user.
  </done>
</task>

</tasks>

<verification>
1. As admin, create a category "Engineering"
2. Drag a channel into the category
3. Category shows channel, collapse toggle works
4. Collapsed category shows unread badge
5. As non-admin user, categories visible but no drag handles
6. Collapse state persists across page refresh
7. Uncategorized channels appear in "Channels" section
</verification>

<success_criteria>
- CCAT-01: Admin can create named categories
- CCAT-02: Channels assignable to category
- CCAT-03: Collapse/expand per-user
- CCAT-04: Drag channels between categories (admin)
- CCAT-05: Uncategorized section exists
- CCAT-06: Category sort order configurable
</success_criteria>

<output>
After completion, create `.planning/phases/24-quick-wins/24-03-SUMMARY.md`
</output>
