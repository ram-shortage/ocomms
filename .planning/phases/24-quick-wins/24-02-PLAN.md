---
phase: 24-quick-wins
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/channel.ts
  - src/lib/actions/channel.ts
  - src/server/socket/handlers/message.ts
  - src/components/channel/channel-list-client.tsx
  - src/components/workspace/workspace-sidebar.tsx
  - src/components/channel/channel-settings.tsx
  - src/components/channel/archived-channels-section.tsx
  - src/lib/actions/search.ts
autonomous: true

must_haves:
  truths:
    - "Admin/creator can archive a channel making it read-only"
    - "Archived channels hidden from main sidebar, shown in collapsed 'Archived' section"
    - "Users cannot send messages to archived channels"
    - "Archived channels searchable (included by default)"
    - "Admin can unarchive channel to restore normal operation"
    - "Default channel (#general) cannot be archived"
  artifacts:
    - path: "src/db/schema/channel.ts"
      provides: "Archive columns on channels table"
      contains: "isArchived"
    - path: "src/lib/actions/channel.ts"
      provides: "Archive/unarchive server actions"
      exports: ["archiveChannel", "unarchiveChannel"]
    - path: "src/components/channel/archived-channels-section.tsx"
      provides: "Collapsed archived channels list in sidebar"
      exports: ["ArchivedChannelsSection"]
  key_links:
    - from: "src/server/socket/handlers/message.ts"
      to: "src/db/schema/channel.ts"
      via: "Check isArchived before accepting message"
      pattern: "isArchived.*true"
    - from: "src/components/workspace/workspace-sidebar.tsx"
      to: "src/components/channel/archived-channels-section.tsx"
      via: "Renders archived section at bottom"
      pattern: "ArchivedChannelsSection"
---

<objective>
Implement channel archiving with read-only state and sidebar organization.

Purpose: Allow admins to archive inactive channels, hiding them from the main sidebar while preserving searchability (ARCH-01 to ARCH-06).
Output: Schema changes, archive/unarchive actions, sidebar 'Archived' section, message blocking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-quick-wins/24-CONTEXT.md
@.planning/phases/24-quick-wins/24-RESEARCH.md

# Existing patterns
@src/db/schema/channel.ts
@src/lib/actions/channel.ts
@src/components/workspace/workspace-sidebar.tsx
@src/server/socket/handlers/message.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration for archive columns</name>
  <files>
    src/db/schema/channel.ts
  </files>
  <action>
Add archive fields to channels table in `src/db/schema/channel.ts`:

```typescript
// Add after isPrivate field:
isArchived: boolean("is_archived").notNull().default(false),
archivedAt: timestamp("archived_at"),
archivedBy: text("archived_by").references(() => users.id, { onDelete: "set null" }),
```

Run migration:
```bash
npx drizzle-kit generate
npx drizzle-kit migrate
```

Or if using push for dev: `npx drizzle-kit push`
  </action>
  <verify>
`npx drizzle-kit push` succeeds. Query `SELECT column_name FROM information_schema.columns WHERE table_name = 'channels'` shows new columns.
  </verify>
  <done>
Channels table has isArchived, archivedAt, archivedBy columns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Archive/unarchive server actions with permission checks</name>
  <files>
    src/lib/actions/channel.ts
    src/server/socket/handlers/message.ts
  </files>
  <action>
1. Add to `src/lib/actions/channel.ts`:

```typescript
export async function archiveChannel(channelId: string) {
  // Auth check
  // Get channel with members
  // ARCH-06: Check if slug === "general" - throw "The default channel cannot be archived"
  // Permission: must be channel admin or creator
  // Update: isArchived=true, archivedAt=new Date(), archivedBy=session.user.id
  // revalidatePath("/")
  return { success: true };
}

export async function unarchiveChannel(channelId: string) {
  // Auth check
  // Permission: must be channel admin or creator
  // Update: isArchived=false, archivedAt=null, archivedBy=null
  // revalidatePath("/")
  return { success: true };
}

export async function getArchivedChannels(organizationId: string) {
  // Auth check, org membership check
  // Return channels where isArchived=true and user has access (public or member of private)
}
```

2. Update `src/server/socket/handlers/message.ts`:
   - In handleSendMessage, before inserting message for channel targetType:
   - Query channel.isArchived
   - If true, emit error "Cannot send messages to archived channels" and return early with callback({ success: false })

3. Update `getChannels` and `getUserChannels` to filter out archived channels (isArchived !== true).
  </action>
  <verify>
TypeScript compiles. Test: Call archiveChannel on general channel should throw. Call on other channel should succeed.
  </verify>
  <done>
Archive/unarchive actions work with permission checks. Messages blocked to archived channels.
  </done>
</task>

<task type="auto">
  <name>Task 3: Sidebar 'Archived' section and channel settings UI</name>
  <files>
    src/components/channel/archived-channels-section.tsx
    src/components/workspace/workspace-sidebar.tsx
    src/components/channel/channel-settings.tsx
    src/components/channel/channel-content.tsx
    src/lib/actions/search.ts
  </files>
  <action>
1. Create `src/components/channel/archived-channels-section.tsx`:
   - Client component using useState for collapsed state (default: true/collapsed)
   - Fetch archived channels via getArchivedChannels
   - Display as collapsible section at bottom of sidebar
   - Per CONTEXT.md: Hidden entirely if no archived channels
   - Show channel links with Archive icon, clicking navigates to channel

2. Update `src/components/workspace/workspace-sidebar.tsx`:
   - Add ArchivedChannelsSection after DM section, before footer
   - Pass organizationId

3. Update `src/components/channel/channel-settings.tsx`:
   - Add Archive/Unarchive button for channel admins
   - If channel.isArchived, show "Unarchive Channel" button
   - If not archived, show "Archive Channel" button
   - Confirm dialog before archiving

4. Update channel content display (channel-content.tsx or channel-header.tsx):
   - If channel.isArchived, show banner: "This channel is archived. Messages are read-only."
   - Apply dimmed styling (opacity-75 or similar)

5. Update `src/lib/actions/search.ts`:
   - ARCH-02: Archived channels remain searchable
   - Include archived in search results by default
   - Add optional filter param to exclude archived if needed
  </action>
  <verify>
`npm run build` succeeds. Archive a channel, verify it moves to Archived section. Try sending message - should be blocked.
  </verify>
  <done>
Archived section appears in sidebar. Archive/unarchive works from settings. Archived channels searchable but read-only.
  </done>
</task>

</tasks>

<verification>
1. Archive a test channel from channel settings
2. Channel disappears from main list, appears in collapsed "Archived" section at bottom
3. Navigate to archived channel - see "archived" banner, cannot send messages
4. Search finds messages from archived channel
5. Unarchive channel - returns to main list
6. Try to archive #general - should be blocked with error
</verification>

<success_criteria>
- ARCH-01: Admin/creator can archive channel (read-only)
- ARCH-02: Archived channels searchable
- ARCH-03: Hidden from main sidebar
- ARCH-04: Browsable in Archived section
- ARCH-05: Admin can unarchive
- ARCH-06: Default channel (#general) cannot be archived
</success_criteria>

<output>
After completion, create `.planning/phases/24-quick-wins/24-02-SUMMARY.md`
</output>
