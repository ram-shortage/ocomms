---
phase: 22-file-uploads
plan: 03
type: execute
wave: 3
depends_on: ["22-01", "22-02"]
files_modified:
  - src/components/message/file-attachment.tsx
  - src/components/message/message-item.tsx
  - src/lib/socket-events.ts
  - server/socket-handlers.ts
  - src/db/schema/file-attachment.ts
autonomous: true

must_haves:
  truths:
    - "Image attachments display as inline previews in messages"
    - "Non-image attachments display as download links with filename and size"
    - "Files can be attached to channel messages"
    - "Files can be attached to DM messages"
    - "Attachments load with their messages"
  artifacts:
    - path: "src/components/message/file-attachment.tsx"
      provides: "Display component for image previews and file links"
      exports: ["FileAttachment"]
    - path: "src/components/message/message-item.tsx"
      provides: "Updated message component rendering attachments"
      contains: "FileAttachment"
    - path: "src/lib/socket-events.ts"
      provides: "Updated Message type with attachments"
      contains: "attachments"
    - path: "server/socket-handlers.ts"
      provides: "Updated message:send handler for attachments"
      contains: "attachmentIds"
  key_links:
    - from: "src/components/message/message-item.tsx"
      to: "src/components/message/file-attachment.tsx"
      via: "import FileAttachment"
      pattern: "FileAttachment"
    - from: "server/socket-handlers.ts"
      to: "src/db/schema/file-attachment.ts"
      via: "db.update(fileAttachments)"
      pattern: "fileAttachments"
---

<objective>
Create file attachment display component and integrate attachments into the message flow. Messages can include attachments that display as image previews or download links.

Purpose: Complete the file upload feature by showing attachments in messages. Images display inline for quick viewing; other files show as download links with filename and size.

Output: Messages with attached files display correctly in both channels and DMs with appropriate previews.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-file-uploads/22-RESEARCH.md
@.planning/phases/22-file-uploads/22-01-SUMMARY.md
@.planning/phases/22-file-uploads/22-02-SUMMARY.md

# Reference existing components
@src/components/message/message-item.tsx
@src/lib/socket-events.ts
@server/socket-handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FileAttachment display component</name>
  <files>src/components/message/file-attachment.tsx</files>
  <action>
Create `src/components/message/file-attachment.tsx`:

```typescript
interface FileAttachmentProps {
  attachment: {
    id: string;
    originalName: string;
    path: string;
    mimeType: string;
    sizeBytes: number;
    isImage: boolean;
  };
}
```

For images (isImage: true) (FILE-04):
- Use next/image for optimized display
- Wrap in anchor tag linking to full image
- Max width 400px, max height 300px
- Rounded corners, border
- Click opens in new tab

For non-images (FILE-05):
- Show as horizontal card with:
  - File type icon (FileText for PDF, File for others) from lucide-react
  - Filename (truncated if long)
  - File size (formatted: KB, MB)
  - Download icon
- Card is clickable anchor with download attribute
- Hover state for visual feedback

Create helper function formatBytes(bytes: number): string for file size display.

Use Tailwind classes matching existing message styling.
Support dark mode via theme-aware colors (uses next-themes from Phase 21).
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit
```

Manual check: Import component and render with mock data in message-item.
  </verify>
  <done>
FileAttachment renders images as clickable previews and non-images as download links with icon, filename, and size.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Message type and socket handlers for attachments</name>
  <files>src/lib/socket-events.ts, server/socket-handlers.ts, src/db/schema/file-attachment.ts</files>
  <action>
Update `src/lib/socket-events.ts`:

1. Add Attachment type:
```typescript
export interface Attachment {
  id: string;
  originalName: string;
  path: string;
  mimeType: string;
  sizeBytes: number;
  isImage: boolean;
}
```

2. Add attachments to Message interface:
```typescript
export interface Message {
  // ... existing fields
  attachments?: Attachment[];
}
```

3. Update ClientToServerEvents message:send:
```typescript
"message:send": (
  data: {
    targetId: string;
    targetType: "channel" | "dm";
    content: string;
    attachmentIds?: string[];  // NEW
  },
  callback?: (response: { success: boolean; messageId?: string }) => void
) => void;
```

Update `server/socket-handlers.ts`:

1. In message:send handler:
   - Accept attachmentIds from data
   - After message insert, if attachmentIds provided:
     - Update fileAttachments records to set messageId
     - Validate attachmentIds exist and belong to current user
   - Fetch attachments for the message
   - Include attachments array in message:new broadcast

2. Update message fetching (wherever messages are loaded):
   - Include attachments relation in query
   - Return attachments with message data

Update `src/db/schema/file-attachment.ts`:
- Add message relation if not already present (from Plan 01)
- Ensure messages schema has attachments relation (many-to-one)
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit
```

Test socket handler manually:
1. Upload file (gets attachment ID)
2. Send message with attachmentIds array
3. Verify message:new event includes attachments array
  </verify>
  <done>
Socket events support attachmentIds in message:send. Server links attachments to messages and broadcasts them with message:new event.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update MessageItem to render attachments</name>
  <files>src/components/message/message-item.tsx, src/components/message/message-list.tsx</files>
  <action>
Update `src/components/message/message-item.tsx`:

1. Add attachments to MessageItemProps:
```typescript
interface MessageItemProps {
  message: Message; // Message type now includes attachments
  // ... existing props
}
```

2. Import FileAttachment component

3. Render attachments below message content (before reactions):
```tsx
{!isDeleted && message.attachments && message.attachments.length > 0 && (
  <div className="flex flex-col gap-2 mt-2">
    {message.attachments.map((attachment) => (
      <FileAttachment key={attachment.id} attachment={attachment} />
    ))}
  </div>
)}
```

Update `src/components/message/message-list.tsx` (if needed):
- Ensure message data passed includes attachments
- Update any message fetching to include attachments

Verify message-input.tsx from Plan 02 correctly passes attachmentIds when sending.

Test both channels (FILE-08) and DMs (FILE-09) work identically.
  </action>
  <verify>
End-to-end test:
1. Start dev server
2. Login and open a channel
3. Attach an image file
4. Send message
5. Verify image displays as inline preview
6. Attach a PDF file
7. Send message
8. Verify PDF displays as download link with filename and size
9. Repeat steps 3-8 in a DM
10. Refresh page - attachments should still display
  </verify>
  <done>
Messages display attachments: images as inline previews (FILE-04), non-images as download links (FILE-05). Works in both channels (FILE-08) and DMs (FILE-09).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Image attachment displays as clickable inline preview
3. PDF attachment displays as download link with icon, name, size
4. Attachments appear in channel messages (FILE-08)
5. Attachments appear in DM messages (FILE-09)
6. Attachments persist and reload on page refresh
7. Multiple attachments on single message display correctly
8. Dark mode: attachments display with appropriate theming
</verification>

<success_criteria>
- FILE-04: Image files display inline preview in messages (jpg, png, gif, webp)
- FILE-05: Non-image files display as download link with filename and size
- FILE-08: User can attach files to messages in channels
- FILE-09: User can attach files to messages in DMs
- Attachments persist with messages and reload correctly
</success_criteria>

<output>
After completion, create `.planning/phases/22-file-uploads/22-03-SUMMARY.md`
</output>
