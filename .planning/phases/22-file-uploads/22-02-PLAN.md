---
phase: 22-file-uploads
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/components/message/file-upload-zone.tsx
  - src/components/message/upload-progress.tsx
  - src/lib/upload-file.ts
  - src/components/message/message-input.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag-and-drop files onto message input"
    - "User can click upload button to browse files"
    - "User sees progress indicator during upload"
    - "User can paste images from clipboard"
    - "User can cancel in-progress uploads"
  artifacts:
    - path: "src/components/message/file-upload-zone.tsx"
      provides: "Drag-drop zone with visual feedback"
      exports: ["FileUploadZone"]
    - path: "src/components/message/upload-progress.tsx"
      provides: "Progress indicator with cancel button"
      exports: ["UploadProgress"]
    - path: "src/lib/upload-file.ts"
      provides: "XHR upload function with progress callback"
      exports: ["uploadFile", "UploadResult"]
    - path: "src/components/message/message-input.tsx"
      provides: "Updated message input with file upload integration"
      contains: "FileUploadZone"
  key_links:
    - from: "src/components/message/message-input.tsx"
      to: "src/components/message/file-upload-zone.tsx"
      via: "import FileUploadZone"
      pattern: "FileUploadZone"
    - from: "src/components/message/file-upload-zone.tsx"
      to: "src/lib/upload-file.ts"
      via: "import uploadFile"
      pattern: "uploadFile"
    - from: "src/lib/upload-file.ts"
      to: "/api/upload/attachment"
      via: "XHR POST"
      pattern: "upload/attachment"
---

<objective>
Create file upload UI components and integrate them into the message input. Users can drag-drop files, click to browse, paste images from clipboard, and see upload progress.

Purpose: Provide intuitive file upload experience with visual feedback. Uses native HTML5 drag-drop API (no external libraries per research findings).

Output: Message input with integrated file upload zone, visible progress indicators, and staged attachments ready to send with messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-file-uploads/22-RESEARCH.md
@.planning/phases/22-file-uploads/22-01-SUMMARY.md

# Reference existing components
@src/components/message/message-input.tsx
@src/components/ui/button.tsx
@src/components/ui/textarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upload file utility with progress tracking</name>
  <files>src/lib/upload-file.ts</files>
  <action>
Create `src/lib/upload-file.ts` with XHR-based upload for progress tracking (fetch doesn't support upload progress):

```typescript
export interface UploadResult {
  id: string;
  path: string;
  originalName: string;
  mimeType: string;
  sizeBytes: number;
  isImage: boolean;
}

export interface UploadOptions {
  onProgress?: (percent: number) => void;
  signal?: AbortSignal; // For cancellation
}

export function uploadFile(
  file: File,
  options?: UploadOptions
): Promise<UploadResult>
```

Implementation:
1. Create XMLHttpRequest
2. Create FormData with file
3. Add upload.progress event listener -> onProgress(percent)
4. Add load event -> resolve with response JSON
5. Add error event -> reject with error
6. If signal provided, add abort listener to call xhr.abort()
7. POST to /api/upload/attachment

Handle errors:
- Network errors -> throw with clear message
- 400 responses -> throw with server error message (file too large, invalid type)
- 401 -> throw "Unauthorized"

Import MAX_FILE_SIZE from file-validation.ts to do client-side size check before upload (fail fast).
  </action>
  <verify>
Test in browser console:
```javascript
import { uploadFile } from '@/lib/upload-file';
// This won't work directly but verifies exports exist
```

Verify TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
uploadFile function handles XHR upload with progress callback, abort signal support, and proper error handling for all server responses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FileUploadZone and UploadProgress components</name>
  <files>src/components/message/file-upload-zone.tsx, src/components/message/upload-progress.tsx</files>
  <action>
Create `src/components/message/file-upload-zone.tsx`:

```typescript
interface FileUploadZoneProps {
  onFilesSelected: (files: File[]) => void;
  disabled?: boolean;
}
```

Features:
- Native HTML5 drag-drop (dragover, dragleave, drop events)
- Visual feedback: border changes when dragging over (use Tailwind border-primary bg-primary/5)
- Hidden file input triggered by button click
- Accept all file types (validation happens server-side)
- Support multiple files (up to 5 per FILE-01 research recommendation)
- Use Paperclip icon from lucide-react for upload button

Create `src/components/message/upload-progress.tsx`:

```typescript
interface UploadProgressProps {
  filename: string;
  progress: number; // 0-100
  onCancel?: () => void;
}
```

Features:
- Show filename (truncated if long)
- Progress bar using Radix Progress component (already in deps)
- Percentage text
- Cancel button (X icon) that calls onCancel
- Compact design to fit below message input

Use existing UI patterns:
- cn() for className merging
- Tailwind for styling
- lucide-react icons (Paperclip, X, Upload)
  </action>
  <verify>
Run TypeScript check:
```bash
npx tsc --noEmit
```

Manual verification in Storybook or dev server:
- FileUploadZone shows upload button
- Dragging file over zone changes visual state
- Clicking button opens file picker
- UploadProgress shows bar and cancel button
  </verify>
  <done>
FileUploadZone handles drag-drop and click-to-browse with visual feedback. UploadProgress shows filename, progress bar, percentage, and cancel button.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate file upload into MessageInput</name>
  <files>src/components/message/message-input.tsx</files>
  <action>
Update `src/components/message/message-input.tsx` to integrate file uploads:

1. Add state:
   - pendingUploads: Map of clientId -> { file, progress, abortController, result? }
   - stagedAttachments: array of uploaded attachment results

2. Add FileUploadZone below textarea:
   - Pass onFilesSelected handler
   - Handler: for each file, create clientId, AbortController, start upload
   - Update progress in pendingUploads map
   - On complete: add to stagedAttachments, remove from pendingUploads

3. Add paste handler on Textarea (FILE-10):
   - Check clipboardData.items for image types
   - If image found, prevent default and call onFilesSelected

4. Show UploadProgress for each item in pendingUploads

5. Show staged attachments preview:
   - Thumbnail for images
   - Icon + filename for other types
   - Remove button (X) to unstage

6. Modify sendMessage to include attachment IDs:
   - If stagedAttachments not empty, include attachmentIds array in message
   - Clear stagedAttachments after send

7. Handle upload errors:
   - Show error message briefly
   - Remove failed upload from pendingUploads

Note: Message send with attachments requires socket event update (Plan 03). For now, just pass attachmentIds - socket handler will be updated next plan.
  </action>
  <verify>
Start dev server and test manually:
1. Open channel or DM
2. Click upload button -> file picker opens
3. Drag file over input -> visual feedback shows
4. Drop file -> upload starts, progress shows
5. Upload completes -> staged attachment appears
6. Click X on staged attachment -> removes it
7. Paste image from clipboard -> upload starts
8. Cancel button during upload -> upload aborts
  </verify>
  <done>
Message input supports drag-drop (FILE-01), click-to-browse (FILE-02), progress indicator (FILE-03), clipboard paste (FILE-10), and staged attachments with remove option.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Drag file over message input -> visual feedback
3. Drop file -> upload starts with progress
4. Click upload button -> file picker opens
5. Paste image -> upload starts
6. Cancel button stops upload
7. Staged attachments display correctly
8. Remove button removes staged attachment
9. File over 25MB shows error before upload starts (client-side check)
</verification>

<success_criteria>
- FILE-01: User can drag-and-drop files onto message input to upload
- FILE-02: User can click upload button to browse and select files
- FILE-03: User sees progress indicator during file upload
- FILE-10: User can paste image from clipboard to upload
- Cancel functionality works for in-progress uploads
- Staged attachments visible with remove option
</success_criteria>

<output>
After completion, create `.planning/phases/22-file-uploads/22-02-SUMMARY.md`
</output>
