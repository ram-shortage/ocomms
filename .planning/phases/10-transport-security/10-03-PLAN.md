---
phase: 10-transport-security
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified: []
autonomous: false
user_setup:
  - service: "Let's Encrypt"
    why: "SSL certificate issuance requires valid domain and email"
    env_vars:
      - name: CERTBOT_EMAIL
        source: "Your email address for Let's Encrypt notifications"
    dashboard_config:
      - task: "Point domain DNS to server IP"
        location: "Your DNS provider (Cloudflare, Route53, etc.)"

must_haves:
  truths:
    - "HTTPS connection established with valid certificate"
    - "HTTP requests redirect to HTTPS"
    - "Database connection uses SSL encryption"
  artifacts: []
  key_links:
    - from: "https://your-domain.com"
      to: "nginx"
      via: "TLS handshake"
      pattern: "certificate valid"
    - from: "app container"
      to: "db container"
      via: "PostgreSQL SSL"
      pattern: "ssl_is_used returns true"
---

<objective>
Verify transport security is working end-to-end in production environment.

Purpose: Confirm all three success criteria are met (HTTPS redirect, auto-renewal, database SSL)
Output: Verified production deployment with encrypted transport
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-transport-security/10-RESEARCH.md
@.planning/phases/10-transport-security/10-01-SUMMARY.md
@.planning/phases/10-transport-security/10-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate PostgreSQL certificates</name>
  <files></files>
  <action>
Run the certificate generation script to create PostgreSQL SSL certificates:

```bash
bash scripts/generate-db-certs.sh
```

Verify certificates were created:
```bash
ls -la certs/postgres/
```

Expected: server.crt (644) and server.key (600) exist.

Do NOT commit these certificates to git. Add to .gitignore if not already present:
```
certs/postgres/
```
  </action>
  <verify>
Run: `ls -la certs/postgres/` shows server.crt and server.key with correct permissions
Run: `openssl x509 -in certs/postgres/server.crt -text -noout | grep "Subject: CN"` shows CN=postgres
  </verify>
  <done>
PostgreSQL SSL certificates generated and ready for container startup
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Transport security infrastructure:
- PostgreSQL SSL certificates generated
- docker-compose.yml configured for HTTPS and database SSL
- nginx configured for Let's Encrypt with HTTP->HTTPS redirect
- Database connection configured for SSL in production
- Health endpoint reports SSL status
  </what-built>
  <how-to-verify>
**Pre-deployment verification (local):**

1. Validate docker compose configuration:
   ```bash
   docker compose config
   ```
   Should show nginx with ports 80 and 443, jonasal/nginx-certbot image

2. Test database SSL locally (optional):
   ```bash
   docker compose up -d db
   # Wait for healthy
   docker compose exec db psql -U postgres -c "SHOW ssl"
   ```
   Should show "ssl = on"

**Production deployment verification:**

3. Deploy to production server with:
   - Domain DNS pointing to server
   - CERTBOT_EMAIL set in .env
   - CERTBOT_STAGING=1 initially (for testing)

4. After deployment, verify HTTPS:
   ```bash
   curl -I https://your-domain.com
   ```
   Should show 200 OK with Strict-Transport-Security header

5. Verify HTTP redirect:
   ```bash
   curl -I http://your-domain.com
   ```
   Should show 301 redirect to https://

6. Verify database SSL via health endpoint:
   ```bash
   curl https://your-domain.com/api/health
   ```
   Should show: `"database": {"connected": true, "ssl": true}`

7. Once staging certs work, set CERTBOT_STAGING=0 and redeploy for production certs
  </how-to-verify>
  <resume-signal>
Type "verified" if all checks pass, or describe any issues encountered.
Note: If you cannot test in production yet, type "deferred" to complete the phase with local verification only.
  </resume-signal>
</task>

</tasks>

<verification>
1. Certificates exist: `ls certs/postgres/server.crt certs/postgres/server.key`
2. Docker config valid: `docker compose config > /dev/null`
3. HTTPS working: `curl -I https://your-domain.com` returns 200 with HSTS header
4. Database SSL: Health endpoint shows ssl: true
</verification>

<success_criteria>
- PostgreSQL SSL certificates generated (not committed to git)
- HTTPS accessible with valid Let's Encrypt certificate
- HTTP requests redirect to HTTPS with 301
- Health endpoint confirms database SSL is active
- User has verified transport security in their environment
</success_criteria>

<output>
After completion, create `.planning/phases/10-transport-security/10-03-SUMMARY.md`
</output>
