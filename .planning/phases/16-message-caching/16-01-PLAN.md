---
phase: 16-message-caching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/cache/db.ts
  - src/lib/cache/messages.ts
  - src/lib/cache/init.ts
  - src/lib/cache/index.ts
autonomous: true

must_haves:
  truths:
    - "IndexedDB database can be opened without errors"
    - "Messages can be stored and retrieved by channel ID"
    - "Messages can be stored and retrieved by conversation ID"
    - "Messages older than 7 days can be deleted"
  artifacts:
    - path: "src/lib/cache/db.ts"
      provides: "Dexie database definition with CachedMessage schema"
      exports: ["db", "CachedMessage"]
    - path: "src/lib/cache/messages.ts"
      provides: "Message cache CRUD operations"
      exports: ["cacheMessage", "cacheMessages", "getCachedChannelMessages", "getCachedConversationMessages", "cleanupExpiredMessages", "updateMessageDeletion"]
    - path: "src/lib/cache/init.ts"
      provides: "Cache initialization with cleanup"
      exports: ["initializeCache"]
    - path: "src/lib/cache/index.ts"
      provides: "Public exports barrel"
  key_links:
    - from: "src/lib/cache/messages.ts"
      to: "src/lib/cache/db.ts"
      via: "db import"
      pattern: "import.*db.*from.*db"
    - from: "src/lib/cache/init.ts"
      to: "src/lib/cache/messages.ts"
      via: "cleanupExpiredMessages call"
      pattern: "cleanupExpiredMessages"
---

<objective>
Create IndexedDB message cache infrastructure using Dexie.js

Purpose: Establish the foundation for offline message reading by creating the IndexedDB schema and cache operations module. This enables Phase 16 Plan 02 to integrate caching into the UI.

Output: Complete cache module at src/lib/cache/ with database definition, CRUD operations, and initialization logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-message-caching/16-RESEARCH.md

# Existing code to reference
@src/lib/socket-events.ts (Message interface to map to CachedMessage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Dexie.js and create database schema</name>
  <files>
    - package.json
    - src/lib/cache/db.ts
  </files>
  <action>
Install Dexie.js dependencies:
```bash
npm install dexie dexie-react-hooks
```

Create src/lib/cache/db.ts with:
1. CachedMessage interface that maps from Message (socket-events.ts):
   - id: string (primary key, message UUID)
   - content: string
   - authorId: string
   - authorName: string | null
   - authorEmail: string
   - channelId: string | null
   - conversationId: string | null
   - parentId: string | null
   - replyCount: number
   - sequence: number
   - deletedAt: Date | null
   - createdAt: Date
   - updatedAt: Date
   - cachedAt: Date (for TTL cleanup - NOT in original Message)

2. Dexie database "OCommsCache" with TypeScript EntityTable:
```typescript
const db = new Dexie("OCommsCache") as Dexie & {
  messages: EntityTable<CachedMessage, "id">;
};
```

3. Version 1 schema with compound indexes for efficient queries:
   - Primary key: "id"
   - Compound index: "[channelId+sequence]" (for ordered channel messages)
   - Compound index: "[conversationId+sequence]" (for ordered DM messages)
   - Index: "cachedAt" (for TTL cleanup queries)

Export: db, CachedMessage type
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/lib/cache/db.ts
```
  </verify>
  <done>Dexie installed, database schema defined with proper indexes for channel/conversation queries and TTL cleanup</done>
</task>

<task type="auto">
  <name>Task 2: Create message cache operations module</name>
  <files>
    - src/lib/cache/messages.ts
  </files>
  <action>
Create src/lib/cache/messages.ts with cache operations:

1. Helper function messageToCache(message: Message): CachedMessage
   - Maps Message from socket-events.ts to CachedMessage
   - Handles optional fields: author?.name, author?.email, replyCount, deletedAt
   - Sets cachedAt to new Date()

2. cacheMessage(message: Message): Promise<void>
   - Wraps db.messages.put() in try/catch
   - Logs errors but doesn't throw (graceful degradation)

3. cacheMessages(messages: Message[]): Promise<void>
   - Uses db.messages.bulkPut() for batch operations (5-10x faster than loop)
   - Same error handling as cacheMessage

4. updateMessageDeletion(messageId: string, deletedAt: Date): Promise<void>
   - Updates existing cached message with deletedAt timestamp
   - Also updates cachedAt to refresh TTL

5. getCachedChannelMessages(channelId: string): Promise<CachedMessage[]>
   - Uses compound index: where("[channelId+sequence]").between([channelId, Dexie.minKey], [channelId, Dexie.maxKey])
   - Returns messages ordered by sequence

6. getCachedConversationMessages(conversationId: string): Promise<CachedMessage[]>
   - Same pattern as getCachedChannelMessages but with [conversationId+sequence]

7. cleanupExpiredMessages(): Promise<number>
   - Calculate cutoff: 7 days ago from now
   - Delete using: db.messages.where("cachedAt").below(cutoff).delete()
   - Return count of deleted messages
   - Log cleanup result

8. clearAllCache(): Promise<void>
   - Uses db.messages.clear()
   - For debugging/testing purposes

Constant: RETENTION_DAYS = 7
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/lib/cache/messages.ts
```
  </verify>
  <done>Cache operations module provides all CRUD functions needed for message caching with 7-day TTL</done>
</task>

<task type="auto">
  <name>Task 3: Create initialization and barrel exports</name>
  <files>
    - src/lib/cache/init.ts
    - src/lib/cache/index.ts
  </files>
  <action>
Create src/lib/cache/init.ts:

1. Module-level initialized flag to prevent multiple init
2. initializeCache(): Promise<void>
   - Early return if already initialized
   - Early return if typeof window === "undefined" (SSR check)
   - Call cleanupExpiredMessages() to purge old data on app start
   - Set initialized = true
   - Wrap in try/catch - log error but continue (IndexedDB may fail in private mode)
   - Log "[Cache] Initialized" on success

Create src/lib/cache/index.ts (barrel exports):

Export all public APIs:
- From db.ts: db, CachedMessage type
- From messages.ts: cacheMessage, cacheMessages, getCachedChannelMessages, getCachedConversationMessages, cleanupExpiredMessages, updateMessageDeletion, clearAllCache
- From init.ts: initializeCache
  </action>
  <verify>
TypeScript compiles and all exports resolve:
```bash
npx tsc --noEmit src/lib/cache/index.ts
```
  </verify>
  <done>Cache module has initialization logic and clean public API surface</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compilation:
```bash
npx tsc --noEmit
```

2. Build succeeds:
```bash
npm run build
```

3. Dependencies installed correctly:
```bash
npm ls dexie dexie-react-hooks
```

4. File structure exists:
```bash
ls -la src/lib/cache/
# Should show: db.ts, messages.ts, init.ts, index.ts
```
</verification>

<success_criteria>
- Dexie and dexie-react-hooks installed in package.json
- src/lib/cache/db.ts exports db and CachedMessage with proper schema
- src/lib/cache/messages.ts exports all cache operations
- src/lib/cache/init.ts exports initializeCache
- src/lib/cache/index.ts provides clean barrel exports
- TypeScript compiles without errors
- npm run build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/16-message-caching/16-01-SUMMARY.md`
</output>
