---
phase: 26-collections-presence
plan: 06
type: execute
wave: 4
depends_on: ["26-04", "26-05"]
files_modified:
  - src/components/message/file-attachment.tsx
  - src/components/bookmark/bookmark-list.tsx
autonomous: false

must_haves:
  truths:
    - "User can save files to personal saved list"
    - "Saved files appear in bookmarks list"
    - "User can click saved file to access original context"
  artifacts:
    - path: "src/components/message/file-attachment.tsx"
      provides: "Bookmark button on file attachments"
  key_links:
    - from: "src/components/message/file-attachment.tsx"
      to: "src/lib/actions/bookmark.ts"
      via: "server action call"
      pattern: "toggleBookmark.*file"
---

<objective>
Add file bookmark support and verification checkpoint.

Purpose: Users need to save files (BOOK-02), not just messages. Also verify the complete bookmarks and status features work end-to-end.

Output: Files can be bookmarked, visual verification of all Phase 26 features.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/26-collections-presence/26-RESEARCH.md
@.planning/phases/26-collections-presence/26-04-SUMMARY.md
@.planning/phases/26-collections-presence/26-05-SUMMARY.md
@src/components/message/file-attachment.tsx (add bookmark button)
@src/components/bookmark/bookmark-list.tsx (handle file bookmarks)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bookmark button to file attachments</name>
  <files>src/components/message/file-attachment.tsx</files>
  <action>
Update src/components/message/file-attachment.tsx:

1. Import useState, useTransition from react
2. Import Bookmark icon from lucide-react
3. Import toggleBookmark from actions/bookmark
4. Import Button and cn

5. Add file ID to FileAttachment props (if not already present):
   - The attachment object should have an `id` field

6. Add bookmark state and handler:
   ```typescript
   const [isBookmarked, setIsBookmarked] = useState(false);
   const [isPending, startTransition] = useTransition();

   const handleToggleBookmark = () => {
     setIsBookmarked(!isBookmarked);
     startTransition(async () => {
       try {
         const result = await toggleBookmark({
           type: "file",
           fileId: attachment.id,
         });
         setIsBookmarked(result.bookmarked);
       } catch (error) {
         setIsBookmarked(isBookmarked); // Revert
         console.error("Failed to toggle file bookmark:", error);
       }
     });
   };
   ```

7. Add bookmark button to file attachment UI:
   - Position: In the hover action area (similar to download button)
   - Style: Same as message BookmarkButton (yellow when active)
   - Icon: Bookmark with fill-current when bookmarked

Placement should be consistent with how download/preview actions are shown on file attachments.
  </action>
  <verify>
npx tsc --noEmit src/components/message/file-attachment.tsx
grep -q "toggleBookmark" src/components/message/file-attachment.tsx
  </verify>
  <done>File attachments have bookmark button. Users can save files to their saved list.</done>
</task>

<task type="auto">
  <name>Task 2: Update bookmark list to handle file bookmarks</name>
  <files>src/components/bookmark/bookmark-list.tsx, src/components/bookmark/bookmark-item.tsx</files>
  <action>
Update src/components/bookmark/bookmark-item.tsx:

1. Handle both bookmark.type === "message" and bookmark.type === "file"

2. For file bookmarks:
   - Show file name and type icon
   - Show file size if available
   - Show uploader name instead of author
   - Navigation: go to the message that contains the file

3. Display logic:
   ```typescript
   if (bookmark.type === "file" && bookmark.file) {
     // Show file info: name, type, size
     // Show uploader: bookmark.file.uploader?.name
     // Navigate to: bookmark.file.message?.channel or conversation
   } else if (bookmark.type === "message" && bookmark.message) {
     // Existing message bookmark display
   }
   ```

4. Handle case where file's parent message was deleted:
   - Show "File no longer available" message
   - Still allow removal from saved list

Update src/components/bookmark/bookmark-list.tsx if needed:
- Ensure it handles both message and file bookmarks from getBookmarks response
- No filtering needed - display all bookmark types
  </action>
  <verify>
npx tsc --noEmit src/components/bookmark/bookmark-item.tsx
  </verify>
  <done>Bookmark list displays both message and file bookmarks with appropriate formatting.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 26: Collections & Presence features:
1. Bookmarks: Save messages and files, view in Saved Items page, remove, navigate to original
2. User Status: Set emoji + text, presets, expiration, DND mode, display next to username
3. DND Integration: Notifications blocked when DND enabled
  </what-built>
  <how-to-verify>
**Bookmarks Testing:**
1. Navigate to any channel with messages
2. Hover over a message - see bookmark icon in action bar
3. Click bookmark icon - icon turns yellow (filled)
4. If message has file attachment, verify file also has bookmark button
5. Click "Saved" in sidebar - navigate to saved items page
6. Verify bookmarked message appears in list
7. Click the saved item - navigate back to original message in channel
8. Click X to remove - item disappears from list

**User Status Testing:**
1. In sidebar footer, click "Set status" (or similar trigger)
2. Select preset "In a meeting" - emoji and text populate
3. Select "1 hour" expiration
4. Toggle DND on
5. Click Save
6. Verify status emoji appears in sidebar
7. Send a message - status should appear next to your name
8. Clear status - emoji disappears

**DND Testing:**
1. With DND enabled, have another user mention you
2. Verify NO push notification received
3. Verify NO in-app notification received
4. Disable DND, get mentioned again
5. Verify notification works normally

**Status Expiration Testing:**
1. Set status with "30 minutes" expiration
2. (Optional: wait or manually trigger worker)
3. Status should auto-clear when expiration time passes
  </how-to-verify>
  <resume-signal>Type "verified" if all features work, or describe specific issues found</resume-signal>
</task>

</tasks>

<verification>
All verification happens in the checkpoint task.
</verification>

<success_criteria>
- BOOK-01: Save messages - working
- BOOK-02: Save files - working
- BOOK-03: View saved items - working
- BOOK-04: Remove from saved - working
- BOOK-05: Jump to original - working
- STAT-01: Custom status emoji + text - working
- STAT-02: Status visible next to name - working
- STAT-03: Status expiration - working
- STAT-04: Preset status options - working
- STAT-05: Clear status manually - working
- STAT-06: DND pauses notifications - working
</success_criteria>

<output>
After completion, create `.planning/phases/26-collections-presence/26-06-SUMMARY.md`
</output>
