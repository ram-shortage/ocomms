---
phase: 26-collections-presence
plan: 05
type: execute
wave: 3
depends_on: ["26-02"]
files_modified:
  - src/components/status/status-editor.tsx
  - src/components/status/status-display.tsx
  - src/components/status/status-indicator.tsx
  - src/components/workspace/workspace-sidebar.tsx
  - src/components/message/message-item.tsx
autonomous: true

must_haves:
  truths:
    - "User can set custom status with emoji and text"
    - "User can select from preset status options"
    - "User can set status expiration time"
    - "User can enable DND mode when setting status"
    - "Status displays next to username in message headers"
  artifacts:
    - path: "src/components/status/status-editor.tsx"
      provides: "Status input form with emoji, text, presets, expiration, DND"
      exports: ["StatusEditor"]
    - path: "src/components/status/status-display.tsx"
      provides: "Compact status display for message headers"
      exports: ["StatusDisplay"]
    - path: "src/components/status/status-indicator.tsx"
      provides: "Status badge/indicator with emoji"
      exports: ["StatusIndicator"]
  key_links:
    - from: "src/components/status/status-editor.tsx"
      to: "src/lib/actions/user-status.ts"
      via: "server action call"
      pattern: "setUserStatus|clearUserStatus"
    - from: "src/components/message/message-item.tsx"
      to: "src/components/status/status-display.tsx"
      via: "component import"
      pattern: "StatusDisplay"
---

<objective>
Build user status UI components - editor and display.

Purpose: Users need to set custom status (STAT-01), choose presets (STAT-04), set expiration (STAT-03), enable DND (STAT-06), and see status next to names (STAT-02).

Output: Status editor in profile/sidebar, status badge next to usernames.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/26-collections-presence/26-RESEARCH.md
@.planning/phases/26-collections-presence/26-02-SUMMARY.md
@src/components/message/message-item.tsx (add status display here)
@src/components/workspace/workspace-sidebar.tsx (add status editor trigger here)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create status editor component</name>
  <files>src/components/status/status-editor.tsx</files>
  <action>
Create src/components/status/status-editor.tsx:

1. "use client" directive
2. Imports:
   - useState from react
   - Button, Input, Label, Switch from ui components
   - Popover, PopoverContent, PopoverTrigger from radix
   - setUserStatus, clearUserStatus, STATUS_PRESETS from actions/user-status
   - addHours, addDays from date-fns

3. Define EXPIRATION_OPTIONS:
   ```typescript
   const EXPIRATION_OPTIONS = [
     { label: "30 minutes", value: () => addHours(new Date(), 0.5) },
     { label: "1 hour", value: () => addHours(new Date(), 1) },
     { label: "4 hours", value: () => addHours(new Date(), 4) },
     { label: "Today", value: () => new Date(new Date().setHours(23, 59, 59, 999)) },
     { label: "This week", value: () => addDays(new Date(), 7) },
     { label: "Don't clear", value: () => null },
   ] as const;
   ```

4. StatusEditor component:
   - Props: currentStatus (optional), onClose callback
   - State: emoji, text, expiresAt (Date|null), dndEnabled, isSaving
   - Preset buttons section (STATUS_PRESETS map)
   - Custom status inputs: emoji input (single char), text input (max 100)
   - Character count display
   - Expiration option buttons
   - DND toggle with Switch component
   - Clear button (calls clearUserStatus)
   - Save button (calls setUserStatus with all fields)

5. Layout: ~320px width popover-style panel

Follow research code example closely for UI structure.
  </action>
  <verify>
npx tsc --noEmit src/components/status/status-editor.tsx
  </verify>
  <done>StatusEditor component created with emoji, text, presets, expiration options, and DND toggle.</done>
</task>

<task type="auto">
  <name>Task 2: Create status display components</name>
  <files>src/components/status/status-display.tsx, src/components/status/status-indicator.tsx</files>
  <action>
Create src/components/status/status-display.tsx:

1. Simple component showing emoji + optional text
2. Props: emoji (string|null), text (string|null), showText (boolean, default false)
3. Render:
   - If no emoji and no text, return null
   - Emoji span with title={text} for hover tooltip
   - Optional text span (truncated, muted color)

Create src/components/status/status-indicator.tsx:

1. "use client" component
2. Props: userId (string), showText (boolean, default false)
3. Use useQuery or useEffect to fetch user's status
4. Import getUserStatus from actions
5. Render StatusDisplay with fetched data
6. Cache status briefly (status changes are rare)

For simpler initial implementation:
- StatusDisplay can be a pure display component
- StatusIndicator fetches and renders StatusDisplay
- Consider SWR or React Query for caching (if already in project, use it; otherwise useState + useEffect)
  </action>
  <verify>
npx tsc --noEmit src/components/status/status-display.tsx src/components/status/status-indicator.tsx
  </verify>
  <done>StatusDisplay and StatusIndicator components created for showing status next to usernames.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate status display into message headers and add editor to sidebar</name>
  <files>src/components/message/message-item.tsx, src/components/workspace/workspace-sidebar.tsx</files>
  <action>
Update src/components/message/message-item.tsx:

1. Import StatusDisplay (NOT StatusIndicator - we'll pass status directly for efficiency)
2. Add optional authorStatus prop to MessageItemProps:
   ```typescript
   authorStatus?: { emoji: string | null; text: string | null } | null;
   ```
3. In the header section, after author name, add:
   ```tsx
   {authorStatus?.emoji && (
     <StatusDisplay emoji={authorStatus.emoji} text={authorStatus.text} />
   )}
   ```

Note: Status will be passed down from message-list.tsx after fetching. For now, the display is ready but won't show until parent passes the prop. This avoids N+1 fetching in message list.

Update src/components/workspace/workspace-sidebar.tsx:

1. Import StatusEditor and Popover components
2. Import getMyStatus from actions/user-status (for initial state)
3. Add status editor in footer section, before "Edit Profile":
   ```tsx
   <Popover>
     <PopoverTrigger asChild>
       <button className="flex items-center gap-2 px-3 py-1.5 rounded-md hover:bg-accent w-full text-left">
         <StatusDisplay emoji={myStatus?.emoji} text={myStatus?.text} />
         <span className="text-sm">Set status</span>
       </button>
     </PopoverTrigger>
     <PopoverContent align="start" className="p-0">
       <StatusEditor currentStatus={myStatus} onClose={() => {}} />
     </PopoverContent>
   </Popover>
   ```

For the sidebar, we need to fetch initial status. Add a client wrapper or pass from server component.
  </action>
  <verify>
grep -q "StatusDisplay" src/components/message/message-item.tsx
grep -q "StatusEditor" src/components/workspace/workspace-sidebar.tsx
  </verify>
  <done>Status display integrated into message headers. Status editor accessible from sidebar.</done>
</task>

</tasks>

<verification>
Build and run:
```bash
npm run build
npm run dev
```

Manual verification:
1. Click "Set status" in sidebar footer
2. Select a preset (e.g., "In a meeting")
3. See emoji and text populate
4. Set expiration to "1 hour"
5. Enable DND toggle
6. Save status
7. Status emoji appears in sidebar
8. Send a message - status appears next to name
9. Clear status - emoji disappears
</verification>

<success_criteria>
- StatusEditor component with presets, custom input, expiration, DND
- StatusDisplay component shows emoji and optional text
- Status editor accessible from sidebar footer
- Status visible next to author name in messages (when passed)
- STAT-01, STAT-02, STAT-03, STAT-04, STAT-05, STAT-06 covered
</success_criteria>

<output>
After completion, create `.planning/phases/26-collections-presence/26-05-SUMMARY.md`
</output>
