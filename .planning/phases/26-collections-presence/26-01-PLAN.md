---
phase: 26-collections-presence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/bookmark.ts
  - src/db/schema/user-status.ts
  - src/db/schema/index.ts
  - src/server/queue/status-expiration.queue.ts
  - src/server/queue/index.ts
autonomous: true

must_haves:
  truths:
    - "Bookmark and user status tables exist in database"
    - "Status expiration queue is registered with BullMQ"
  artifacts:
    - path: "src/db/schema/bookmark.ts"
      provides: "Bookmarks table with polymorphic message/file references"
      exports: ["bookmarks", "bookmarksRelations", "bookmarkTypeEnum"]
    - path: "src/db/schema/user-status.ts"
      provides: "User status table with expiration and DND support"
      exports: ["userStatuses", "userStatusesRelations"]
    - path: "src/server/queue/status-expiration.queue.ts"
      provides: "BullMQ queue for status auto-expiration"
      exports: ["statusExpirationQueue", "StatusExpirationJobData"]
  key_links:
    - from: "src/db/schema/bookmark.ts"
      to: "src/db/schema/message.ts"
      via: "foreign key reference"
      pattern: "references.*messages"
    - from: "src/db/schema/bookmark.ts"
      to: "src/db/schema/file-attachment.ts"
      via: "foreign key reference"
      pattern: "references.*fileAttachments"
    - from: "src/db/schema/user-status.ts"
      to: "src/db/schema/auth.ts"
      via: "foreign key reference"
      pattern: "references.*users"
---

<objective>
Create database schema for bookmarks and user status features.

Purpose: Establish the data foundation for Phase 26 - bookmarks need polymorphic references to messages/files, status needs expiration tracking and DND flag.

Output: Database tables and BullMQ queue definition ready for server actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-collections-presence/26-RESEARCH.md
@src/db/schema/reminder.ts (pattern reference for BullMQ integration)
@src/server/queue/reminder.queue.ts (pattern reference for queue definition)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bookmarks table schema</name>
  <files>src/db/schema/bookmark.ts, src/db/schema/index.ts</files>
  <action>
Create src/db/schema/bookmark.ts with polymorphic bookmark table:

1. Create bookmarkTypeEnum with values: "message", "file"
2. Create bookmarks table with:
   - id: uuid primary key with defaultRandom()
   - userId: text, not null, references users.id with cascade delete
   - type: bookmarkTypeEnum, not null
   - messageId: uuid, nullable, references messages.id with cascade delete
   - fileId: uuid, nullable, references fileAttachments.id with cascade delete
   - note: text, nullable (optional user note for BOOK-01)
   - createdAt: timestamp with timezone, not null, defaultNow()

3. Add indexes:
   - uniqueIndex on (userId, messageId) - prevent duplicate message bookmarks
   - uniqueIndex on (userId, fileId) - prevent duplicate file bookmarks
   - index on userId for efficient user lookup
   - index on (userId, createdAt) for sorted list queries

4. Create bookmarksRelations with:
   - user: one-to-one with users
   - message: one-to-one with messages
   - file: one-to-one with fileAttachments

5. Export from src/db/schema/index.ts

Follow existing schema patterns from reminder.ts (similar structure with message reference).
  </action>
  <verify>
npx tsc --noEmit src/db/schema/bookmark.ts
grep -q "bookmarks" src/db/schema/index.ts
  </verify>
  <done>Bookmarks schema file exists with correct table structure, relations, and indexes. Exported from schema index.</done>
</task>

<task type="auto">
  <name>Task 2: Create user status table schema</name>
  <files>src/db/schema/user-status.ts, src/db/schema/index.ts</files>
  <action>
Create src/db/schema/user-status.ts for custom status feature:

1. Create userStatuses table with:
   - id: uuid primary key with defaultRandom()
   - userId: text, not null, references users.id with cascade delete, unique (one status per user)
   - emoji: text, nullable (single emoji character for STAT-01)
   - text: text, nullable (up to 100 chars for STAT-01)
   - expiresAt: timestamp with timezone, nullable (for STAT-03 auto-clear)
   - dndEnabled: boolean, not null, default false (for STAT-06)
   - jobId: text, nullable (BullMQ job ID for expiration tracking)
   - createdAt: timestamp with timezone, not null, defaultNow()
   - updatedAt: timestamp with timezone, not null, defaultNow()

2. Add indexes:
   - uniqueIndex on userId (enforced by unique constraint)
   - index on expiresAt for expiration queries

3. Create userStatusesRelations with:
   - user: one-to-one with users

4. Export from src/db/schema/index.ts

Use withTimezone on all timestamps (consistent with Phase 25 decision).
  </action>
  <verify>
npx tsc --noEmit src/db/schema/user-status.ts
grep -q "userStatuses" src/db/schema/index.ts
  </verify>
  <done>User status schema file exists with correct table structure for emoji, text, expiration, DND. Exported from schema index.</done>
</task>

<task type="auto">
  <name>Task 3: Create status expiration queue definition</name>
  <files>src/server/queue/status-expiration.queue.ts, src/server/queue/index.ts</files>
  <action>
Create src/server/queue/status-expiration.queue.ts following reminder.queue.ts pattern:

1. Import Queue from "bullmq" and getQueueConnection from "./connection"

2. Define StatusExpirationJobData interface:
   ```typescript
   export interface StatusExpirationJobData {
     userId: string;
   }
   ```

3. Create and export statusExpirationQueue:
   ```typescript
   export const statusExpirationQueue = new Queue<StatusExpirationJobData>(
     "status-expiration",
     {
       connection: getQueueConnection(),
       defaultJobOptions: {
         attempts: 3,
         backoff: {
           type: "exponential",
           delay: 1000,
         },
         removeOnComplete: 100,
         removeOnFail: 500,
       },
     }
   );
   ```

4. Add export to src/server/queue/index.ts

Follow exact pattern from reminder.queue.ts - same retry config (3 attempts, exponential backoff, 1s base).
  </action>
  <verify>
npx tsc --noEmit src/server/queue/status-expiration.queue.ts
grep -q "status-expiration" src/server/queue/index.ts
  </verify>
  <done>Status expiration queue defined with correct job data type and default options. Exported from queue index.</done>
</task>

</tasks>

<verification>
Run database migration to create new tables:
```bash
npx drizzle-kit push
```

Verify tables created:
```bash
npx drizzle-kit studio
# Check that bookmarks and user_statuses tables exist with correct columns
```

Type check entire project:
```bash
npx tsc --noEmit
```
</verification>

<success_criteria>
- bookmarks table schema with polymorphic message/file references
- user_statuses table schema with emoji, text, expiresAt, dndEnabled, jobId
- status-expiration queue registered with BullMQ
- All schemas exported from index.ts
- Database migration succeeds
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-collections-presence/26-01-SUMMARY.md`
</output>
