---
phase: 05-mentions-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/mentions.ts
  - src/components/message/mention-autocomplete.tsx
  - src/components/message/message-input.tsx
  - src/components/message/message-content.tsx
  - src/components/message/message-item.tsx
autonomous: true

must_haves:
  truths:
    - "User can type @ and see member suggestions"
    - "User can select a member from autocomplete to insert @mention"
    - "@mentions appear highlighted in message display"
    - "@channel and @here are recognized as special mentions"
  artifacts:
    - path: "src/lib/mentions.ts"
      provides: "Mention parsing and extraction utilities"
      exports: ["parseMentions", "extractMentions", "MENTION_REGEX"]
    - path: "src/components/message/mention-autocomplete.tsx"
      provides: "Autocomplete dropdown for @mentions"
      min_lines: 60
    - path: "src/components/message/message-content.tsx"
      provides: "Message content with highlighted mentions"
      min_lines: 30
  key_links:
    - from: "src/components/message/message-input.tsx"
      to: "src/components/message/mention-autocomplete.tsx"
      via: "Autocomplete triggers on @ keystroke"
      pattern: "MentionAutocomplete"
    - from: "src/components/message/message-item.tsx"
      to: "src/components/message/message-content.tsx"
      via: "MessageContent renders parsed content"
      pattern: "MessageContent"
---

<objective>
Implement @mention parsing, autocomplete, and highlighting for messages.

Purpose: Enable users to @mention other members in messages, triggering the notification system (built in 05-02).

Output: Mention utilities, autocomplete component, and highlighted message rendering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/message/message-input.tsx
@src/components/message/message-item.tsx
@src/db/schema/channel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mention parsing utilities</name>
  <files>src/lib/mentions.ts</files>
  <action>
Create mention parsing utilities:

1. Define MENTION_REGEX pattern to match:
   - @username (member mentions)
   - @channel (all members)
   - @here (active members only)

2. Create `parseMentions(content: string)` function that returns array of:
   ```ts
   interface ParsedMention {
     type: "user" | "channel" | "here";
     value: string;  // username for user, "channel" or "here" for special
     start: number;  // position in string
     end: number;    // position in string
   }
   ```

3. Create `extractMentionedUsernames(content: string): string[]` helper that returns just the usernames.

4. Create `highlightMentions(content: string, currentUserId?: string)` that returns React nodes with mentions wrapped in styled spans:
   - User mentions: blue text, slightly darker background
   - @channel/@here: orange text, yellow background
   - Current user's mention: extra emphasis (bold)

Pattern: Use regex with named groups for clean parsing. Support display names with spaces by using quotes: @"John Doe".
  </action>
  <verify>
Create test file and verify:
- `parseMentions("Hello @john")` returns correct ParsedMention
- `parseMentions("@channel check this")` identifies @channel
- `parseMentions("@here anyone?")` identifies @here
- `extractMentionedUsernames("Hey @john and @jane")` returns ["john", "jane"]
  </verify>
  <done>
Mention regex correctly parses @user, @channel, @here from message content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mention autocomplete component</name>
  <files>src/components/message/mention-autocomplete.tsx, src/components/message/message-input.tsx</files>
  <action>
Create MentionAutocomplete component:

1. **MentionAutocomplete.tsx:**
   - Props: `members: Member[]`, `filter: string`, `onSelect: (member) => void`, `position: { top, left }`
   - Render positioned dropdown (absolute) showing filtered members
   - Filter by name or email starting with filter string (case insensitive)
   - Show avatar initial, name, and email for each member
   - Keyboard navigation: arrow up/down to select, Enter to confirm, Escape to close
   - Max 5 results shown
   - Include special options at top when filter is empty or matches:
     - @channel - Notify all members
     - @here - Notify active members

2. **Update MessageInput.tsx:**
   - Add state: `mentionQuery: string | null`, `mentionPosition: {top, left} | null`
   - Detect @ trigger: When user types @, capture cursor position and start tracking query
   - Update query as user types after @
   - Close autocomplete on: space (no match), escape, backspace past @, blur
   - On select: Replace @query with @username (or @"Display Name" if has spaces)
   - Pass members prop from parent (channel members or workspace members for DM)

3. **Member data:** MessageInput needs to receive `members` prop from parent page.

Pattern: Use contenteditable or track cursor position in textarea. Textarea is simpler - track text before cursor to find @query.
  </action>
  <verify>
Manual verification steps:
- Type @ in message input, autocomplete appears
- Type @jo, shows filtered results starting with "jo"
- Arrow down selects next item, Enter inserts
- Escape closes autocomplete
- @channel and @here appear as options
  </verify>
  <done>
Typing @ triggers member autocomplete, selection inserts @mention.
  </done>
</task>

<task type="auto">
  <name>Task 3: Message content with mention highlighting</name>
  <files>src/components/message/message-content.tsx, src/components/message/message-item.tsx</files>
  <action>
Create MessageContent component:

1. **MessageContent.tsx:**
   - Props: `content: string`, `currentUserId?: string`
   - Import highlightMentions from lib/mentions
   - Render content with mentions highlighted
   - Style mentions with Tailwind:
     - User: `text-blue-600 bg-blue-50 rounded px-0.5`
     - Current user: `font-semibold` additional
     - @channel/@here: `text-amber-600 bg-amber-50 rounded px-0.5`
   - Maintain whitespace-pre-wrap for message formatting

2. **Update MessageItem.tsx:**
   - Replace raw content display with MessageContent component
   - Pass currentUserId for self-mention highlighting
   - Keep deleted message handling as-is

Pattern: Split content by mentions, map to alternating text/highlight spans.
  </action>
  <verify>
Visual verification:
- Message with @john displays "john" in blue highlight
- Message with @channel displays in orange highlight
- Own mention (@currentUser) is bold blue
  </verify>
  <done>
Messages display with @mentions visually highlighted.
  </done>
</task>

</tasks>

<verification>
Full feature verification:
1. Type @ in channel message input - autocomplete shows channel members
2. Select member - @username inserted in input
3. Send message - message appears with highlighted mention
4. @channel and @here render with orange highlighting
5. Own username mention renders with bold emphasis
</verification>

<success_criteria>
- Mention autocomplete triggers on @ keystroke
- Member selection inserts formatted mention
- Sent messages display with highlighted mentions
- @channel and @here recognized as special mentions
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/5-mentions-notifications/05-01-SUMMARY.md`
</output>
