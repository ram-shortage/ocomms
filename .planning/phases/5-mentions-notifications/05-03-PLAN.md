---
phase: 05-mentions-notifications
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/db/schema/channel-notification-settings.ts
  - src/db/schema/index.ts
  - src/app/api/channels/[channelId]/notifications/route.ts
  - src/components/channel/notification-settings-dialog.tsx
  - src/components/channel/channel-header.tsx
  - src/server/socket/handlers/notification.ts
autonomous: true

must_haves:
  truths:
    - "User can mute a channel (no notifications)"
    - "User can set channel to mention-only mode"
    - "Muted channel does not trigger any notifications"
    - "Mention-only channel only triggers notifications for direct @mentions"
  artifacts:
    - path: "src/db/schema/channel-notification-settings.ts"
      provides: "Per-user-per-channel notification preferences"
      contains: "channelNotificationSettings"
    - path: "src/app/api/channels/[channelId]/notifications/route.ts"
      provides: "REST API for notification settings"
      exports: ["GET", "PUT"]
    - path: "src/components/channel/notification-settings-dialog.tsx"
      provides: "Dialog for configuring channel notifications"
      min_lines: 50
  key_links:
    - from: "src/server/socket/handlers/notification.ts"
      to: "src/db/schema/channel-notification-settings.ts"
      via: "Check settings before creating notification"
      pattern: "channelNotificationSettings"
    - from: "src/components/channel/channel-header.tsx"
      to: "src/components/channel/notification-settings-dialog.tsx"
      via: "Settings button opens dialog"
      pattern: "NotificationSettingsDialog"
---

<objective>
Implement channel notification settings for muting and mention-only mode.

Purpose: Give users control over notification volume per channel.

Output: Settings schema, REST API, UI dialog, and notification filtering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/5-mentions-notifications/05-01-SUMMARY.md
@.planning/phases/5-mentions-notifications/05-02-SUMMARY.md
@src/db/schema/channel.ts
@src/app/api/channels/[channelId]/pins/route.ts
@src/components/channel/channel-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Channel notification settings schema</name>
  <files>src/db/schema/channel-notification-settings.ts, src/db/schema/index.ts</files>
  <action>
Create channel notification settings table:

1. **channel-notification-settings.ts:**
```ts
channelNotificationSettings table:
- id: uuid, primary key, default random
- channelId: uuid, FK to channels, cascade delete
- userId: uuid, FK to users, cascade delete
- mode: text ("all" | "mentions" | "muted"), default "all"
- updatedAt: timestamp, default now

Unique constraint: (channelId, userId)
Index: userId for fetching all user's settings
```

Modes:
- "all": Receive all notifications (default behavior)
- "mentions": Only direct @mentions (not @channel/@here)
- "muted": No notifications at all

2. **Relations:**
- channelNotificationSettings belongs to channel
- channelNotificationSettings belongs to user

3. **Export from index.ts**

Pattern: No entry = "all" mode (default). Only store when user changes from default.
  </action>
  <verify>
TypeScript compiles. Schema exports correctly.
  </verify>
  <done>
Channel notification settings schema with mode column.
  </done>
</task>

<task type="auto">
  <name>Task 2: Notification settings REST API</name>
  <files>src/app/api/channels/[channelId]/notifications/route.ts, src/server/socket/handlers/notification.ts</files>
  <action>
Create REST API and integrate settings check:

1. **route.ts API endpoints:**

GET /api/channels/[channelId]/notifications
- Verify user is channel member
- Return current settings or default { mode: "all" }

PUT /api/channels/[channelId]/notifications
- Body: { mode: "all" | "mentions" | "muted" }
- Verify user is channel member
- Upsert settings (onConflictDoUpdate on channelId+userId)
- If mode === "all", delete the row (return to default)
- Return updated settings

2. **Update notification.ts handler:**

In createNotifications function, before creating notification for a user:
- Query channelNotificationSettings for that user/channel
- If mode === "muted": Skip notification entirely
- If mode === "mentions" and mention type is "channel" or "here": Skip notification
- If mode === "all" or mention type is "user": Create notification

Add helper function:
```ts
async function shouldNotify(
  userId: string,
  channelId: string,
  mentionType: "user" | "channel" | "here"
): Promise<boolean>
```

Pattern: REST for settings (low frequency), filter check during notification creation.
  </action>
  <verify>
- GET returns default mode for new users
- PUT updates mode correctly
- Muted user does not receive notifications
- Mention-only user receives only direct @mentions
  </verify>
  <done>
REST API for notification settings, filtering integrated into notification creation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Channel notification settings UI</name>
  <files>src/components/channel/notification-settings-dialog.tsx, src/components/channel/channel-header.tsx</files>
  <action>
Create settings dialog:

1. **notification-settings-dialog.tsx:**
- Dialog with radio group for mode selection
- Three options with descriptions:
  - All activity: "Get notified for all messages in this channel"
  - Mentions only: "Only get notified when you're directly @mentioned"
  - Muted: "Don't receive any notifications from this channel"
- Current selection highlighted
- Save button calls PUT API
- Show loading state during save
- Close on successful save with toast

2. **Update channel-header.tsx:**
- Add Bell icon button in header toolbar (near pins button)
- Bell shows different state based on current mode:
  - All: Normal bell icon
  - Mentions: Bell with "@" badge
  - Muted: Bell with slash (BellOff icon)
- Click opens NotificationSettingsDialog
- Pass channelId and current mode to dialog
- Refetch mode after dialog closes

3. **Fetch current settings:**
- In channel page or ChannelContent, fetch notification settings on mount
- Pass settings to ChannelHeader

Pattern: Use shadcn Dialog and RadioGroup. Optimistic UI update on save.
  </action>
  <verify>
Manual verification:
- Bell button visible in channel header
- Click opens notification settings dialog
- Selecting "Muted" and saving changes bell to BellOff
- Muted channel does not show new notifications
  </verify>
  <done>
Users can mute channels or set mention-only mode via UI.
  </done>
</task>

</tasks>

<verification>
Full feature verification:
1. Open channel, click bell icon in header
2. Change to "Muted" mode, save
3. Header bell changes to BellOff icon
4. Another user sends message to channel - no notification received
5. Change to "Mentions only" mode
6. Another user sends @channel message - no notification
7. Another user sends @yourname message - notification received
8. Change to "All activity" mode - back to normal notifications
</verification>

<success_criteria>
- Notification settings persist in database
- REST API for get/update settings
- UI dialog with three mode options
- Header bell reflects current mode
- Muted channels receive no notifications
- Mention-only channels receive only direct @mentions
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/5-mentions-notifications/05-03-SUMMARY.md`
</output>
