---
phase: 34-sidebar-reorganization
plan: 04
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - src/components/workspace/workspace-sidebar.tsx
  - src/components/workspace/sidebar-sections.tsx
  - src/app/(workspace)/[workspaceSlug]/settings/sidebar/page.tsx
  - src/components/channel/category-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar sections (Threads, Search, Notes, Scheduled, Reminders, Saved) can be reordered"
    - "Sidebar sections can be hidden entirely via Settings"
    - "'New Category' button is in Settings, not sidebar"
    - "Hidden sections badge appears on Settings when unread content exists"
  artifacts:
    - path: "src/components/workspace/sidebar-sections.tsx"
      provides: "Reorderable sidebar sections component"
      contains: "SortableSection"
    - path: "src/app/(workspace)/[workspaceSlug]/settings/sidebar/page.tsx"
      provides: "Sidebar settings page with category and section management"
      contains: "CreateCategoryDialog"
  key_links:
    - from: "src/components/workspace/sidebar-sections.tsx"
      to: "src/lib/actions/sidebar-preferences.ts"
      via: "updateSectionOrder call"
      pattern: "updateSectionOrder"
    - from: "src/app/(workspace)/[workspaceSlug]/settings/sidebar/page.tsx"
      to: "src/components/channel/create-category-dialog.tsx"
      via: "CreateCategoryDialog import"
      pattern: "CreateCategoryDialog"
---

<objective>
Add sidebar section reordering and create Sidebar settings page with category management.

Purpose: Users can customize which sections appear and in what order (SIDE-06), and manage categories from Settings rather than cluttering the sidebar (SIDE-01).
Output: Reorderable sections in sidebar, Settings page for sidebar customization, "New Category" moved to Settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/34-sidebar-reorganization/34-01-SUMMARY.md
@.planning/phases/34-sidebar-reorganization/34-RESEARCH.md

# Components to modify
@src/components/workspace/workspace-sidebar.tsx
@src/app/(workspace)/[workspaceSlug]/settings/page.tsx
@src/components/channel/category-sidebar.tsx
@src/components/channel/create-category-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SidebarSections component with drag-and-drop</name>
  <files>src/components/workspace/sidebar-sections.tsx</files>
  <action>
Create a new component that renders the quick links section with drag-and-drop support:

1. Create `src/components/workspace/sidebar-sections.tsx`:
   ```typescript
   "use client";

   import { useState, useEffect } from "react";
   import Link from "next/link";
   import { usePathname } from "next/navigation";
   import {
     DndContext,
     DragEndEvent,
     DragOverlay,
     closestCenter,
     KeyboardSensor,
     PointerSensor,
     useSensor,
     useSensors,
   } from "@dnd-kit/core";
   import {
     SortableContext,
     sortableKeyboardCoordinates,
     verticalListSortingStrategy,
     useSortable,
     arrayMove,
   } from "@dnd-kit/sortable";
   import { CSS } from "@dnd-kit/utilities";
   import { GripVertical, MessageSquare, Search, StickyNote, Clock, Bell, Bookmark } from "lucide-react";
   import { cn } from "@/lib/utils";
   import { updateSectionOrder } from "@/lib/actions/sidebar-preferences";
   import { DEFAULT_SECTION_ORDER } from "@/lib/types/sidebar";
   ```

2. Define section config:
   ```typescript
   const SECTION_CONFIG: Record<string, { icon: React.ElementType; label: string; path: (slug: string) => string }> = {
     threads: { icon: MessageSquare, label: "Threads", path: (s) => `/${s}/threads` },
     search: { icon: Search, label: "Search", path: (s) => `/${s}/search` },
     notes: { icon: StickyNote, label: "My Notes", path: (s) => `/${s}/notes` },
     scheduled: { icon: Clock, label: "Scheduled", path: (s) => `/${s}/scheduled` },
     reminders: { icon: Bell, label: "Reminders", path: (s) => `/${s}/reminders` },
     saved: { icon: Bookmark, label: "Saved", path: (s) => `/${s}/saved` },
   };
   ```

3. Create SortableSection component:
   ```typescript
   function SortableSection({
     sectionId,
     workspaceSlug,
     extraContent,
   }: {
     sectionId: string;
     workspaceSlug: string;
     extraContent?: React.ReactNode;  // For ReminderBadge
   }) {
     const pathname = usePathname();
     const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: sectionId });
     const config = SECTION_CONFIG[sectionId];
     if (!config) return null;

     const Icon = config.icon;
     const href = config.path(workspaceSlug);

     const style = {
       transform: CSS.Transform.toString(transform),
       transition,
     };

     return (
       <div ref={setNodeRef} style={style} className={cn("group flex items-center", isDragging && "opacity-50")}>
         <button
           className="opacity-0 group-hover:opacity-100 p-1 cursor-grab active:cursor-grabbing"
           {...attributes}
           {...listeners}
         >
           <GripVertical className="h-3 w-3 text-muted-foreground" />
         </button>
         <Link
           href={href}
           className={cn(
             "flex-1 flex items-center gap-2 px-2 py-1.5 rounded-md text-sm hover:bg-accent transition-colors",
             pathname === href && "bg-accent"
           )}
         >
           <Icon className="h-4 w-4" />
           {config.label}
           {extraContent}
         </Link>
       </div>
     );
   }
   ```

4. Create main SidebarSections component:
   ```typescript
   interface SidebarSectionsProps {
     workspaceSlug: string;
     organizationId: string;
     savedSectionOrder?: string[];
     hiddenSections?: string[];
     reminderBadge?: React.ReactNode;  // ReminderBadge component
   }

   export function SidebarSections({
     workspaceSlug,
     organizationId,
     savedSectionOrder,
     hiddenSections = [],
     reminderBadge,
   }: SidebarSectionsProps) {
     // Initialize with saved order or default, filtering out hidden
     const [localOrder, setLocalOrder] = useState(() => {
       const order = savedSectionOrder?.length ? savedSectionOrder : DEFAULT_SECTION_ORDER;
       return order.filter(id => !hiddenSections.includes(id));
     });
     const [activeId, setActiveId] = useState<string | null>(null);

     // Sensors, handlers similar to other components...
     // handleDragEnd calls updateSectionOrder(organizationId, newOrder)

     return (
       <DndContext ...>
         <SortableContext items={localOrder} strategy={verticalListSortingStrategy}>
           <div className="px-3 py-1">
             {localOrder.map((sectionId) => (
               <SortableSection
                 key={sectionId}
                 sectionId={sectionId}
                 workspaceSlug={workspaceSlug}
                 extraContent={sectionId === 'reminders' ? reminderBadge : undefined}
               />
             ))}
           </div>
         </SortableContext>
         <DragOverlay>...</DragOverlay>
       </DndContext>
     );
   }
   ```

5. Handle hidden sections filter and sync with props.
  </action>
  <verify>
    - `ls src/components/workspace/sidebar-sections.tsx` confirms file exists
    - `grep "SortableSection" src/components/workspace/sidebar-sections.tsx` shows component
    - `grep "updateSectionOrder" src/components/workspace/sidebar-sections.tsx` shows persistence
  </verify>
  <done>
    - SidebarSections component created with drag-and-drop
    - Sections can be reordered
    - Hidden sections are filtered out
    - Order persists via updateSectionOrder
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Sidebar settings page</name>
  <files>src/app/(workspace)/[workspaceSlug]/settings/sidebar/page.tsx</files>
  <action>
Create a new settings page for sidebar customization:

1. Create directory and page: `src/app/(workspace)/[workspaceSlug]/settings/sidebar/page.tsx`

2. Page structure:
   ```typescript
   import { auth } from "@/lib/auth";
   import { headers } from "next/headers";
   import { redirect } from "next/navigation";
   import { db } from "@/db";
   import { eq, and } from "drizzle-orm";
   import { organizations, members, channelCategories } from "@/db/schema";
   import { getCategories } from "@/lib/actions/channel-category";
   import { getSidebarPreferences } from "@/lib/actions/sidebar-preferences";
   import { SidebarSettingsClient } from "./sidebar-settings-client";

   export default async function SidebarSettingsPage({ params }: { params: Promise<{ workspaceSlug: string }> }) {
     // Auth check, get org, check admin status
     // Fetch categories for this org
     // Fetch user's sidebar preferences

     return (
       <div className="h-full overflow-auto">
         <div className="p-8 max-w-2xl mx-auto space-y-8">
           <h1 className="text-2xl font-bold">Sidebar Settings</h1>

           {/* Sections visibility */}
           <SidebarSettingsClient
             organizationId={organization.id}
             categories={categories}
             preferences={preferences}
             isAdmin={isAdmin}
           />

           <Link href={`/${workspaceSlug}/settings`}>
             Back to settings
           </Link>
         </div>
       </div>
     );
   }
   ```

3. Create `sidebar-settings-client.tsx` in same directory:
   ```typescript
   "use client";

   import { useState } from "react";
   import { Checkbox } from "@/components/ui/checkbox";
   import { Button } from "@/components/ui/button";
   import { CreateCategoryDialog } from "@/components/channel/create-category-dialog";
   import { FolderPlus, Eye, EyeOff } from "lucide-react";
   import { updateSectionVisibility } from "@/lib/actions/sidebar-preferences";
   import { DEFAULT_SECTION_ORDER } from "@/lib/types/sidebar";

   // Section visibility toggles
   // Category list (admin only) with "New Category" button
   // Future: Category rename/delete UI
   ```

4. In the client component:
   - Show all 6 sections with checkboxes to show/hide
   - "New Category" button for admins (moved from sidebar)
   - List existing categories (for future rename/delete)

5. Add link to sidebar settings in main settings page:
   ```typescript
   <Link href={`/${workspaceSlug}/settings/sidebar`} className="block p-4 bg-card border rounded hover:bg-muted">
     <h3 className="font-medium">Sidebar</h3>
     <p className="text-sm text-muted-foreground">
       Customize sections and categories
     </p>
   </Link>
   ```
  </action>
  <verify>
    - `ls src/app/\\(workspace\\)/\\[workspaceSlug\\]/settings/sidebar/page.tsx` confirms file
    - `grep "CreateCategoryDialog" src/app/\\(workspace\\)/\\[workspaceSlug\\]/settings/sidebar/` shows button moved
    - Navigation to /settings/sidebar works (manual check after build)
  </verify>
  <done>
    - Sidebar settings page exists at /settings/sidebar
    - Section visibility can be toggled
    - "New Category" button available for admins
    - Link added to main settings page
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove "New Category" button from sidebar</name>
  <files>
    src/components/channel/category-sidebar.tsx
    src/components/workspace/workspace-sidebar.tsx
  </files>
  <action>
Remove the "New Category" button from the sidebar components:

1. In `src/components/channel/category-sidebar.tsx`:
   - Remove the CreateCategoryDialog import (or keep if used elsewhere)
   - Remove the "New Category" button at the bottom of the component (lines ~478-494)
   - Keep the FolderPlus import removal if no longer used

2. In `src/components/workspace/workspace-sidebar.tsx`:
   - Remove the "New Category" button from the non-category view section (lines ~258-275)
   - Keep CreateCategoryDialog import removal if no longer used anywhere
   - FolderPlus import may still be needed elsewhere, check before removing

3. The "New Category" functionality now lives ONLY in Settings > Sidebar.

4. Leave channel creation (+) button in sidebar as-is.
  </action>
  <verify>
    - `grep "New Category" src/components/channel/category-sidebar.tsx` returns nothing
    - `grep "New Category" src/components/workspace/workspace-sidebar.tsx` returns nothing
    - `npm run build` completes without errors
  </verify>
  <done>
    - "New Category" button removed from sidebar
    - Category creation only available in Settings
    - No unused imports left behind
  </done>
</task>

</tasks>

<verification>
1. Sidebar sections show drag handle on hover
2. Sections can be reordered via drag-and-drop
3. Sections can be hidden via Settings > Sidebar
4. "New Category" button is in Settings, not sidebar
5. Hidden sections are not rendered
</verification>

<success_criteria>
- Sidebar sections (6) can be reordered by any user
- Sections can be hidden entirely via Settings
- "New Category" moved to Settings (SIDE-01)
- Section order persists to database
</success_criteria>

<output>
After completion, create `.planning/phases/34-sidebar-reorganization/34-04-SUMMARY.md`
</output>
