---
phase: 34-sidebar-reorganization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/sidebar-preferences.ts
  - src/db/schema/index.ts
  - src/lib/actions/sidebar-preferences.ts
  - src/lib/types/sidebar.ts
autonomous: true

must_haves:
  truths:
    - "User sidebar preferences can be saved to database"
    - "User sidebar preferences can be loaded from database"
    - "Preferences include categoryOrder, dmOrder, sectionOrder, hiddenSections"
  artifacts:
    - path: "src/db/schema/sidebar-preferences.ts"
      provides: "userSidebarPreferences table definition"
      contains: "userSidebarPreferences"
    - path: "src/lib/actions/sidebar-preferences.ts"
      provides: "Server actions for save/load preferences"
      exports: ["getSidebarPreferences", "saveSidebarPreferences"]
    - path: "src/lib/types/sidebar.ts"
      provides: "TypeScript types for sidebar preferences"
      exports: ["SidebarPreferencesData"]
  key_links:
    - from: "src/lib/actions/sidebar-preferences.ts"
      to: "src/db/schema/sidebar-preferences.ts"
      via: "drizzle ORM queries"
      pattern: "userSidebarPreferences"
---

<objective>
Create database schema and server actions for storing user sidebar preferences.

Purpose: Foundation for all sidebar customization features - enables per-user ordering and visibility settings that sync across devices.
Output: Database table, TypeScript types, and server actions for sidebar preferences CRUD.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-sidebar-reorganization/34-RESEARCH.md

# Reference existing patterns
@src/db/schema/channel-category.ts
@src/lib/actions/channel-category.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sidebar preferences schema and types</name>
  <files>
    src/db/schema/sidebar-preferences.ts
    src/db/schema/index.ts
    src/lib/types/sidebar.ts
  </files>
  <action>
Create the database schema for user sidebar preferences:

1. Create `src/db/schema/sidebar-preferences.ts`:
   - Table: `user_sidebar_preferences`
   - Fields:
     - id: uuid, primary key, defaultRandom
     - userId: text, not null, references users.id with cascade delete
     - organizationId: text, not null, references organizations.id with cascade delete
     - preferences: jsonb, not null, typed as SidebarPreferencesData
     - createdAt: timestamp, not null, defaultNow
     - updatedAt: timestamp, not null, defaultNow
   - Add unique index on (userId, organizationId)
   - Add relations to users and organizations

2. Create `src/lib/types/sidebar.ts`:
   ```typescript
   export interface SidebarPreferencesData {
     categoryOrder: string[];      // Category IDs in user's preferred order
     dmOrder: string[];            // DM conversation IDs in order
     sectionOrder: string[];       // Section IDs: 'threads', 'search', 'notes', 'scheduled', 'reminders', 'saved'
     hiddenSections: string[];     // Section IDs user has hidden
     collapsedSections: string[];  // Section IDs user has collapsed (different from hidden)
     updatedAt: string;            // ISO timestamp for conflict resolution
   }

   export const DEFAULT_SECTION_ORDER = ['threads', 'search', 'notes', 'scheduled', 'reminders', 'saved'];
   ```

3. Export from `src/db/schema/index.ts` - add the new schema file export.

Follow the pattern from channel-category.ts for the table structure and relations.
  </action>
  <verify>
    - `grep -r "userSidebarPreferences" src/db/schema/` shows the table definition
    - `grep -r "SidebarPreferencesData" src/lib/types/` shows the type export
    - No TypeScript errors: `npx tsc --noEmit --skipLibCheck 2>&1 | head -20`
  </verify>
  <done>
    - userSidebarPreferences table defined with all fields
    - SidebarPreferencesData interface exported
    - Schema exported from index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server actions for preferences</name>
  <files>src/lib/actions/sidebar-preferences.ts</files>
  <action>
Create server actions for sidebar preferences CRUD:

1. Create `src/lib/actions/sidebar-preferences.ts` with "use server" directive:

```typescript
"use server";

// Required imports: db, auth, headers, eq, and, userSidebarPreferences, members
```

2. Implement `getSidebarPreferences(organizationId: string)`:
   - Get session, verify org membership (like channel-category.ts)
   - Query userSidebarPreferences for (userId, organizationId)
   - Return preferences data or null if not set
   - Return type: `SidebarPreferencesData | null`

3. Implement `saveSidebarPreferences(organizationId: string, preferences: Partial<SidebarPreferencesData>)`:
   - Get session, verify org membership
   - Upsert: insert or update on conflict (userId + organizationId)
   - Merge provided preferences with existing (don't overwrite fields not provided)
   - Set updatedAt to current ISO timestamp
   - Return { success: true }

4. Implement `updateCategoryOrder(organizationId: string, categoryOrder: string[])`:
   - Convenience wrapper that calls saveSidebarPreferences with just categoryOrder
   - Return { success: true }

5. Implement `updateDmOrder(organizationId: string, dmOrder: string[])`:
   - Convenience wrapper for DM order updates
   - Return { success: true }

6. Implement `updateSectionOrder(organizationId: string, sectionOrder: string[])`:
   - Convenience wrapper for section order updates
   - Return { success: true }

7. Implement `updateSectionVisibility(organizationId: string, hiddenSections: string[])`:
   - Convenience wrapper for hidden sections updates
   - Return { success: true }

Follow patterns from channel-category.ts for auth checks and error handling. Use the same verifyOrgMembership pattern.
  </action>
  <verify>
    - `grep -c "export async function" src/lib/actions/sidebar-preferences.ts` shows 6 functions
    - `grep "use server" src/lib/actions/sidebar-preferences.ts` confirms server action
    - No TypeScript errors: `npx tsc --noEmit --skipLibCheck 2>&1 | head -20`
  </verify>
  <done>
    - getSidebarPreferences returns user's preferences or null
    - saveSidebarPreferences upserts preferences with merge behavior
    - Convenience wrappers exist for categoryOrder, dmOrder, sectionOrder, hiddenSections
    - All actions verify org membership before operating
  </done>
</task>

<task type="auto">
  <name>Task 3: Run database migration</name>
  <files>drizzle migration files</files>
  <action>
Generate and apply the database migration for the new table:

1. Run `npx drizzle-kit generate` to create migration file

2. Run `npx drizzle-kit push` to apply migration to database

3. Verify table exists:
   ```bash
   npx drizzle-kit studio --port 4983 &
   # Or check via psql if available
   ```

The migration should create:
- `user_sidebar_preferences` table with all columns
- Unique index on (user_id, organization_id)
- Foreign key constraints to users and organizations
  </action>
  <verify>
    - Migration file exists in drizzle/ directory
    - `npx drizzle-kit push` completes without errors
    - Table is queryable (no runtime errors when importing schema)
  </verify>
  <done>
    - user_sidebar_preferences table exists in database
    - Indexes and constraints applied
    - Schema can be imported without errors
  </done>
</task>

</tasks>

<verification>
1. Schema file exports table and relations
2. Types file exports SidebarPreferencesData interface
3. Actions file exports all 6 functions
4. Database migration applied successfully
5. No TypeScript compilation errors
</verification>

<success_criteria>
- userSidebarPreferences table exists with correct schema
- SidebarPreferencesData type is importable from types/sidebar
- Server actions can save and retrieve preferences
- Org membership is verified before any operation
</success_criteria>

<output>
After completion, create `.planning/phases/34-sidebar-reorganization/34-01-SUMMARY.md`
</output>
