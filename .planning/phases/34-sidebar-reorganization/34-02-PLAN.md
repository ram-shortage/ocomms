---
phase: 34-sidebar-reorganization
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - src/components/channel/category-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Categories can be reordered by dragging the category header"
    - "Drag handle appears on hover over category header"
    - "Category order persists after page refresh"
  artifacts:
    - path: "src/components/channel/category-sidebar.tsx"
      provides: "Category drag-and-drop reordering"
      contains: "SortableCategorySection"
  key_links:
    - from: "src/components/channel/category-sidebar.tsx"
      to: "src/lib/actions/sidebar-preferences.ts"
      via: "updateCategoryOrder call on drag end"
      pattern: "updateCategoryOrder"
---

<objective>
Add drag-and-drop reordering for channel categories in the sidebar.

Purpose: Users can personalize their sidebar by reordering categories to match their workflow (SIDE-02).
Output: Category headers become draggable with visual feedback and persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/34-sidebar-reorganization/34-01-SUMMARY.md
@.planning/phases/34-sidebar-reorganization/34-RESEARCH.md

# Current implementation to extend
@src/components/channel/category-sidebar.tsx
@src/lib/actions/sidebar-preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add category drag-and-drop to CategorySidebar</name>
  <files>src/components/channel/category-sidebar.tsx</files>
  <action>
Extend the existing CategorySidebar component to support category reordering:

1. Import additional dnd-kit utilities:
   - Already have: DndContext, DragEndEvent, useSortable, SortableContext
   - Add: arrayMove from @dnd-kit/sortable (for reordering arrays)

2. Import the new action:
   ```typescript
   import { updateCategoryOrder } from "@/lib/actions/sidebar-preferences";
   ```

3. Add local state for category order:
   ```typescript
   const [localCategories, setLocalCategories] = useState(categories);
   ```
   - Sync with categories prop via useEffect (like localChannels)

4. Create `SortableCategorySection` component:
   - Wrap CategorySection to make it sortable
   - Use useSortable hook with category.id
   - Add drag handle (GripVertical icon) that appears on hover
   - Handle only appears for users who can reorder (any user can reorder their view)
   - Apply transform and transition styles from useSortable

5. Update the DndContext to handle two types of drags:
   - Channel drags (existing behavior - admin only)
   - Category drags (new - any user for their personal view)

   Modify handleDragEnd to detect if dragging a category vs channel:
   ```typescript
   const handleDragEnd = async (event: DragEndEvent) => {
     const { active, over } = event;
     if (!over || active.id === over.id) return;

     // Check if dragging a category (IDs start with "cat-")
     const activeId = active.id as string;
     if (activeId.startsWith("cat-")) {
       // Category reorder logic
       const oldIndex = localCategories.findIndex(c => `cat-${c.id}` === activeId);
       const newIndex = localCategories.findIndex(c => `cat-${c.id}` === over.id);
       if (oldIndex !== -1 && newIndex !== -1) {
         const newOrder = arrayMove(localCategories, oldIndex, newIndex);
         setLocalCategories(newOrder);
         // Persist to server
         await updateCategoryOrder(organizationId, newOrder.map(c => c.id));
       }
       return;
     }

     // Existing channel drag logic...
   };
   ```

6. Add SortableContext for categories:
   - Wrap the categories map with SortableContext
   - Use `localCategories.map(c => `cat-${c.id}`)` for items
   - Use verticalListSortingStrategy

7. Update CategorySection to receive sortable props:
   - Add props for drag handle visibility and listeners
   - Show drag handle on hover (similar to channel drag handle)
   - Handle appears to left of category name

8. Add DragOverlay for categories:
   - Create CategoryOverlay component (similar to ChannelItemOverlay)
   - Shows category name with appropriate styling when dragging

Note: Category order is per-user preference (anyone can customize their view).
Channel order within categories remains admin-only (shared across workspace).
  </action>
  <verify>
    - `grep "SortableCategorySection\\|cat-" src/components/channel/category-sidebar.tsx` shows new components
    - `grep "updateCategoryOrder" src/components/channel/category-sidebar.tsx` shows persistence
    - `npm run build` completes without errors
  </verify>
  <done>
    - Categories show drag handle on hover
    - Dragging category shows ghost preview
    - Dropping reorders categories
    - Order persists via updateCategoryOrder action
  </done>
</task>

<task type="auto">
  <name>Task 2: Load and apply saved category order</name>
  <files>src/components/channel/category-sidebar.tsx</files>
  <action>
Add loading of saved category order from preferences:

1. Add prop to CategorySidebar:
   ```typescript
   interface CategorySidebarProps {
     // ... existing props
     savedCategoryOrder?: string[];  // From getSidebarPreferences
   }
   ```

2. Apply saved order on mount:
   ```typescript
   const [localCategories, setLocalCategories] = useState(() => {
     if (savedCategoryOrder && savedCategoryOrder.length > 0) {
       // Sort categories by saved order, put any new categories at end
       const orderMap = new Map(savedCategoryOrder.map((id, idx) => [id, idx]));
       return [...categories].sort((a, b) => {
         const aOrder = orderMap.get(a.id) ?? Number.MAX_SAFE_INTEGER;
         const bOrder = orderMap.get(b.id) ?? Number.MAX_SAFE_INTEGER;
         return aOrder - bOrder;
       });
     }
     return categories;
   });
   ```

3. Handle prop changes:
   - When categories prop changes (new category added), merge with saved order
   - New categories appear at end
   - Removed categories are filtered out

4. The parent component (WorkspaceSidebar) will need to pass savedCategoryOrder.
   For now, just add the prop - Plan 05 will wire up the loading.
  </action>
  <verify>
    - `grep "savedCategoryOrder" src/components/channel/category-sidebar.tsx` shows prop usage
    - Component still renders when prop is undefined
    - No TypeScript errors
  </verify>
  <done>
    - savedCategoryOrder prop accepted by CategorySidebar
    - Categories sorted by saved order when provided
    - New categories appear at end of list
    - Component works with or without saved order
  </done>
</task>

</tasks>

<verification>
1. Category headers show grip handle on hover
2. Dragging category reorders the list
3. Drop indicator shows where category will land
4. Order persists via server action
5. Component accepts savedCategoryOrder prop
</verification>

<success_criteria>
- Categories can be reordered via drag-and-drop by any user
- Category order is personal (per-user preference)
- Order persists to database
- Visual feedback during drag (handle, overlay, indicator)
</success_criteria>

<output>
After completion, create `.planning/phases/34-sidebar-reorganization/34-02-SUMMARY.md`
</output>
