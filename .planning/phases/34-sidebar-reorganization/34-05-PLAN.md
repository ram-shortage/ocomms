---
phase: 34-sidebar-reorganization
plan: 05
type: execute
wave: 3
depends_on: ["34-02", "34-03", "34-04"]
files_modified:
  - src/components/workspace/workspace-sidebar.tsx
  - src/lib/hooks/use-sidebar-preferences.ts
  - src/app/(workspace)/[workspaceSlug]/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Sidebar order loads from server on page load"
    - "Sidebar order syncs across devices for same user"
    - "Changes are reflected immediately (optimistic updates)"
    - "localStorage provides instant response, server provides persistence"
  artifacts:
    - path: "src/lib/hooks/use-sidebar-preferences.ts"
      provides: "Hook for sidebar preferences with localStorage + server sync"
      exports: ["useSidebarPreferences"]
  key_links:
    - from: "src/lib/hooks/use-sidebar-preferences.ts"
      to: "src/lib/actions/sidebar-preferences.ts"
      via: "getSidebarPreferences call"
      pattern: "getSidebarPreferences"
    - from: "src/components/workspace/workspace-sidebar.tsx"
      to: "src/lib/hooks/use-sidebar-preferences.ts"
      via: "useSidebarPreferences hook"
      pattern: "useSidebarPreferences"
---

<objective>
Wire up sidebar preferences loading and implement cross-device sync.

Purpose: Ensure sidebar customizations persist and sync across all devices for the same user (SIDE-07, SIDE-08).
Output: Complete integration of preferences with all sidebar components, localStorage caching, and server sync.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/34-sidebar-reorganization/34-01-SUMMARY.md
@.planning/phases/34-sidebar-reorganization/34-02-SUMMARY.md
@.planning/phases/34-sidebar-reorganization/34-03-SUMMARY.md
@.planning/phases/34-sidebar-reorganization/34-04-SUMMARY.md
@.planning/phases/34-sidebar-reorganization/34-RESEARCH.md

# Components to integrate
@src/components/workspace/workspace-sidebar.tsx
@src/lib/actions/sidebar-preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSidebarPreferences hook</name>
  <files>src/lib/hooks/use-sidebar-preferences.ts</files>
  <action>
Create a hook that manages sidebar preferences with localStorage caching and server sync:

```typescript
"use client";

import { useState, useEffect, useCallback } from "react";
import { SidebarPreferencesData, DEFAULT_SECTION_ORDER } from "@/lib/types/sidebar";
import { getSidebarPreferences, saveSidebarPreferences } from "@/lib/actions/sidebar-preferences";

const STORAGE_KEY_PREFIX = "sidebar-prefs-";

function getStorageKey(orgId: string): string {
  return `${STORAGE_KEY_PREFIX}${orgId}`;
}

function getLocalPreferences(orgId: string): SidebarPreferencesData | null {
  if (typeof window === "undefined") return null;
  try {
    const stored = localStorage.getItem(getStorageKey(orgId));
    return stored ? JSON.parse(stored) : null;
  } catch {
    return null;
  }
}

function setLocalPreferences(orgId: string, prefs: SidebarPreferencesData): void {
  if (typeof window === "undefined") return;
  try {
    localStorage.setItem(getStorageKey(orgId), JSON.stringify(prefs));
  } catch {
    // Ignore storage errors
  }
}

export function useSidebarPreferences(organizationId: string) {
  // Initialize from localStorage for instant load
  const [preferences, setPreferences] = useState<SidebarPreferencesData | null>(() =>
    getLocalPreferences(organizationId)
  );
  const [isLoading, setIsLoading] = useState(true);

  // Load from server and sync
  useEffect(() => {
    let cancelled = false;

    async function loadFromServer() {
      try {
        const serverPrefs = await getSidebarPreferences(organizationId);
        if (cancelled) return;

        if (serverPrefs) {
          const local = getLocalPreferences(organizationId);

          // Last write wins: use whichever is newer
          if (!local || new Date(serverPrefs.updatedAt) >= new Date(local.updatedAt)) {
            setPreferences(serverPrefs);
            setLocalPreferences(organizationId, serverPrefs);
          } else {
            // Local is newer, push to server
            await saveSidebarPreferences(organizationId, local);
          }
        }
      } catch (error) {
        console.error("Failed to load sidebar preferences:", error);
      } finally {
        if (!cancelled) setIsLoading(false);
      }
    }

    loadFromServer();
    return () => { cancelled = true; };
  }, [organizationId]);

  // Update helper that saves to both localStorage and server
  const updatePreferences = useCallback(async (updates: Partial<SidebarPreferencesData>) => {
    const newPrefs: SidebarPreferencesData = {
      categoryOrder: preferences?.categoryOrder ?? [],
      dmOrder: preferences?.dmOrder ?? [],
      sectionOrder: preferences?.sectionOrder ?? DEFAULT_SECTION_ORDER,
      hiddenSections: preferences?.hiddenSections ?? [],
      collapsedSections: preferences?.collapsedSections ?? [],
      ...updates,
      updatedAt: new Date().toISOString(),
    };

    // Optimistic update
    setPreferences(newPrefs);
    setLocalPreferences(organizationId, newPrefs);

    // Persist to server (fire and forget for responsiveness)
    saveSidebarPreferences(organizationId, newPrefs).catch(console.error);
  }, [organizationId, preferences]);

  return {
    preferences,
    isLoading,
    updatePreferences,
    // Convenience getters
    categoryOrder: preferences?.categoryOrder ?? [],
    dmOrder: preferences?.dmOrder ?? [],
    sectionOrder: preferences?.sectionOrder ?? DEFAULT_SECTION_ORDER,
    hiddenSections: preferences?.hiddenSections ?? [],
  };
}
```

Key behaviors:
- Initialize from localStorage for instant UI (no flash)
- Fetch from server and use "last write wins" for conflict resolution
- Updates go to localStorage first (instant), then server (async)
- Provide typed accessors for each preference type
  </action>
  <verify>
    - `ls src/lib/hooks/use-sidebar-preferences.ts` confirms file exists
    - `grep "useSidebarPreferences" src/lib/hooks/use-sidebar-preferences.ts` shows export
    - `grep "localStorage" src/lib/hooks/use-sidebar-preferences.ts` shows caching
  </verify>
  <done>
    - useSidebarPreferences hook created
    - localStorage caching implemented
    - Server sync with last-write-wins
    - Typed preference accessors available
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate preferences into WorkspaceSidebar</name>
  <files>
    src/components/workspace/workspace-sidebar.tsx
    src/app/(workspace)/[workspaceSlug]/layout.tsx
  </files>
  <action>
Wire up sidebar preferences to all customizable components:

**In workspace-sidebar.tsx:**

1. Import the hook:
   ```typescript
   import { useSidebarPreferences } from "@/lib/hooks/use-sidebar-preferences";
   ```

2. Use the hook in the component:
   ```typescript
   const { categoryOrder, dmOrder, sectionOrder, hiddenSections, isLoading } = useSidebarPreferences(workspace.id);
   ```

3. Pass preferences to child components:
   ```typescript
   // SidebarSections (from 34-04)
   <SidebarSections
     workspaceSlug={workspace.slug}
     organizationId={workspace.id}
     savedSectionOrder={sectionOrder}
     hiddenSections={hiddenSections}
     reminderBadge={<ReminderBadge />}
   />

   // CategorySidebar
   <CategorySidebar
     categories={categories}
     channels={...}
     collapseStates={collapseStates ?? {}}
     workspaceSlug={workspace.slug}
     organizationId={workspace.id}
     isAdmin={isAdmin}
     savedCategoryOrder={categoryOrder}
   />

   // DMListClient
   <DMListClient
     conversations={conversations}
     workspaceSlug={workspace.slug}
     organizationId={workspace.id}
     savedDmOrder={dmOrder}
   />
   ```

4. Replace the hardcoded quick links section with SidebarSections component.

5. Handle loading state (optional - localStorage should make this instant):
   ```typescript
   // Could show skeleton if isLoading, but localStorage should provide instant data
   ```

**In layout.tsx:**

The layout already passes props to WorkspaceSidebar. Ensure workspace.id is available (it should be from the organization query). No changes needed if workspace object already has id.
  </action>
  <verify>
    - `grep "useSidebarPreferences" src/components/workspace/workspace-sidebar.tsx` shows hook usage
    - `grep "savedCategoryOrder" src/components/workspace/workspace-sidebar.tsx` shows prop passing
    - `grep "SidebarSections" src/components/workspace/workspace-sidebar.tsx` shows component usage
    - `npm run build` completes without errors
  </verify>
  <done>
    - WorkspaceSidebar uses useSidebarPreferences hook
    - Preferences passed to CategorySidebar, DMListClient, SidebarSections
    - Quick links replaced with SidebarSections component
    - All customizations load from saved preferences
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify drag-and-drop and sync</name>
  <what-built>
    Complete sidebar reorganization with:
    - Category reordering
    - Channel reordering within/between categories (existing)
    - DM conversation reordering
    - Sidebar section reordering
    - Section visibility controls in Settings
    - "New Category" moved to Settings
    - Cross-device sync via server
    - Instant updates via localStorage
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Navigate to a workspace with channels and DMs

    **Test category reordering (SIDE-02):**
    - Hover over category header - drag handle should appear
    - Drag a category to reorder
    - Refresh page - order should persist

    **Test DM reordering (SIDE-05):**
    - Hover over DM item - drag handle should appear
    - Drag a DM to reorder
    - Refresh page - order should persist

    **Test section reordering (SIDE-06):**
    - Hover over sidebar section (Threads, Search, etc.) - drag handle should appear
    - Drag a section to reorder
    - Refresh page - order should persist

    **Test Settings (SIDE-01):**
    - Go to Settings > Sidebar
    - "New Category" button should be visible (if admin)
    - Section visibility toggles should work
    - Hide a section, verify it disappears from sidebar

    **Test cross-device sync (SIDE-08):**
    - Open workspace in another browser/incognito
    - Login as same user
    - Make a reorder in first browser
    - Refresh second browser - order should match
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Preferences load from localStorage instantly (no flash)
2. Preferences sync from server on page load
3. Changes persist to both localStorage and server
4. Different devices show same preferences after refresh
5. All drag-and-drop features work smoothly
</verification>

<success_criteria>
- Sidebar order loads from server on initial page load
- Sidebar order syncs across devices for same user
- Changes are reflected immediately (localStorage)
- Changes persist across sessions (server)
- All 8 requirements (SIDE-01 through SIDE-08) are met
</success_criteria>

<output>
After completion, create `.planning/phases/34-sidebar-reorganization/34-05-SUMMARY.md`
</output>
