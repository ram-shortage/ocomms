---
phase: 34-sidebar-reorganization
plan: 03
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - src/components/dm/dm-list-client.tsx
  - src/components/dm/dm-list-item.tsx
autonomous: true

must_haves:
  truths:
    - "DM conversations can be reordered by dragging"
    - "Drag handle appears on hover over DM item"
    - "DM order persists after page refresh"
  artifacts:
    - path: "src/components/dm/dm-list-client.tsx"
      provides: "DM drag-and-drop reordering"
      contains: "DndContext"
    - path: "src/components/dm/dm-list-item.tsx"
      provides: "Sortable DM item with drag handle"
      contains: "useSortable"
  key_links:
    - from: "src/components/dm/dm-list-client.tsx"
      to: "src/lib/actions/sidebar-preferences.ts"
      via: "updateDmOrder call on drag end"
      pattern: "updateDmOrder"
---

<objective>
Add drag-and-drop reordering for DM conversations in the sidebar.

Purpose: Users can prioritize important conversations by reordering them (SIDE-05).
Output: DM list items become draggable with visual feedback and persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/34-sidebar-reorganization/34-01-SUMMARY.md
@.planning/phases/34-sidebar-reorganization/34-RESEARCH.md

# Current implementation to extend
@src/components/dm/dm-list-client.tsx
@src/components/dm/dm-list-item.tsx
@src/components/channel/category-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add drag-and-drop to DM list</name>
  <files>
    src/components/dm/dm-list-client.tsx
    src/components/dm/dm-list-item.tsx
  </files>
  <action>
Add drag-and-drop reordering to the DM list. Follow patterns from category-sidebar.tsx.

**In dm-list-client.tsx:**

1. Add dnd-kit imports:
   ```typescript
   import {
     DndContext,
     DragEndEvent,
     DragOverlay,
     closestCenter,
     KeyboardSensor,
     PointerSensor,
     useSensor,
     useSensors,
   } from "@dnd-kit/core";
   import {
     SortableContext,
     sortableKeyboardCoordinates,
     verticalListSortingStrategy,
     arrayMove,
   } from "@dnd-kit/sortable";
   ```

2. Import action:
   ```typescript
   import { updateDmOrder } from "@/lib/actions/sidebar-preferences";
   ```

3. Add props for preferences:
   ```typescript
   interface DMListClientProps {
     conversations: Conversation[];
     workspaceSlug: string;
     organizationId: string;  // Add this - needed for action
     savedDmOrder?: string[];  // From preferences
   }
   ```

4. Add local state with ordering:
   ```typescript
   const [localConversations, setLocalConversations] = useState(() => {
     if (savedDmOrder && savedDmOrder.length > 0) {
       const orderMap = new Map(savedDmOrder.map((id, idx) => [id, idx]));
       return [...conversations].sort((a, b) => {
         const aOrder = orderMap.get(a.id) ?? Number.MAX_SAFE_INTEGER;
         const bOrder = orderMap.get(b.id) ?? Number.MAX_SAFE_INTEGER;
         return aOrder - bOrder;
       });
     }
     return conversations;
   });
   const [activeId, setActiveId] = useState<string | null>(null);
   ```

5. Add sensors (same as category-sidebar):
   ```typescript
   const sensors = useSensors(
     useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),
     useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
   );
   ```

6. Add drag handlers:
   ```typescript
   const handleDragStart = (event: DragStartEvent) => {
     setActiveId(event.active.id as string);
   };

   const handleDragEnd = async (event: DragEndEvent) => {
     const { active, over } = event;
     setActiveId(null);
     if (!over || active.id === over.id) return;

     const oldIndex = localConversations.findIndex(c => c.id === active.id);
     const newIndex = localConversations.findIndex(c => c.id === over.id);

     if (oldIndex !== -1 && newIndex !== -1) {
       const newOrder = arrayMove(localConversations, oldIndex, newIndex);
       setLocalConversations(newOrder);
       // Persist
       await updateDmOrder(organizationId, newOrder.map(c => c.id));
     }
   };
   ```

7. Wrap list with DndContext and SortableContext:
   ```tsx
   return (
     <DndContext
       id="dm-list-dnd"
       sensors={sensors}
       collisionDetection={closestCenter}
       onDragStart={handleDragStart}
       onDragEnd={handleDragEnd}
     >
       <SortableContext
         items={localConversations.map(c => c.id)}
         strategy={verticalListSortingStrategy}
       >
         <div className="space-y-1">
           {localConversations.map((conversation) => (
             <SortableDMListItem key={conversation.id} ... />
           ))}
         </div>
       </SortableContext>
       <DragOverlay>
         {activeId && /* render overlay item */}
       </DragOverlay>
     </DndContext>
   );
   ```

8. Sync localConversations with conversations prop in useEffect.

**In dm-list-item.tsx:**

1. Create SortableDMListItem wrapper or modify existing component:
   ```typescript
   import { useSortable } from "@dnd-kit/sortable";
   import { CSS } from "@dnd-kit/utilities";
   import { GripVertical } from "lucide-react";
   ```

2. Add useSortable hook:
   ```typescript
   const {
     attributes,
     listeners,
     setNodeRef,
     transform,
     transition,
     isDragging,
   } = useSortable({ id: conversationId });

   const style = {
     transform: CSS.Transform.toString(transform),
     transition,
   };
   ```

3. Add drag handle that appears on hover:
   - GripVertical icon to the left
   - `opacity-0 group-hover:opacity-100` classes
   - `cursor-grab active:cursor-grabbing` on handle

4. Apply ref and style to wrapper div.

5. Create DMListItemOverlay component for drag preview (similar to ChannelItemOverlay).
  </action>
  <verify>
    - `grep "DndContext" src/components/dm/dm-list-client.tsx` shows DnD setup
    - `grep "useSortable" src/components/dm/dm-list-item.tsx` shows sortable hook
    - `grep "updateDmOrder" src/components/dm/dm-list-client.tsx` shows persistence
    - `npm run build` completes without errors
  </verify>
  <done>
    - DM items show drag handle on hover
    - Dragging DM shows ghost preview
    - Dropping reorders DMs
    - Order persists via updateDmOrder action
    - Component accepts savedDmOrder prop
  </done>
</task>

<task type="auto">
  <name>Task 2: Update WorkspaceSidebar to pass organizationId to DMListClient</name>
  <files>src/components/workspace/workspace-sidebar.tsx</files>
  <action>
Update WorkspaceSidebar to pass the required organizationId prop to DMListClient:

1. Update the DMListClient usage:
   ```tsx
   <DMListClient
     conversations={conversations}
     workspaceSlug={workspace.slug}
     organizationId={workspace.id}  // Add this
   />
   ```

2. This is needed for the updateDmOrder action to work.

3. savedDmOrder prop will be wired up in Plan 05.
  </action>
  <verify>
    - `grep "organizationId={workspace.id}" src/components/workspace/workspace-sidebar.tsx` or similar
    - No TypeScript errors
  </verify>
  <done>
    - DMListClient receives organizationId from WorkspaceSidebar
    - DM reordering can persist to database
  </done>
</task>

</tasks>

<verification>
1. DM items show grip handle on hover
2. Dragging DM item reorders the list
3. Order persists via server action
4. New DMs appear at end of custom order
5. Component works with or without saved order
</verification>

<success_criteria>
- DM conversations can be reordered via drag-and-drop
- DM order is per-user preference
- Order persists to database
- Visual feedback during drag (handle, overlay)
</success_criteria>

<output>
After completion, create `.planning/phases/34-sidebar-reorganization/34-03-SUMMARY.md`
</output>
