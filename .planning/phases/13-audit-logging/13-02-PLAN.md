---
phase: 13-audit-logging
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/lib/actions/admin.ts
  - src/app/api/admin/export/route.ts
  - src/server/socket/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin unlock actions logged with admin userId, target userId, organizationId"
    - "Data export actions logged with userId, organizationId"
    - "Socket.IO authorization failures logged with userId, target resource, action"
  artifacts:
    - path: "src/lib/actions/admin.ts"
      provides: "Admin unlock with audit logging"
      contains: "auditLog"
    - path: "src/app/api/admin/export/route.ts"
      provides: "Data export with audit logging"
      contains: "auditLog"
    - path: "src/server/socket/index.ts"
      provides: "Socket handlers with authz failure logging"
      contains: "auditLog"
  key_links:
    - from: "src/lib/actions/admin.ts"
      to: "src/lib/audit-logger.ts"
      via: "auditLog call"
      pattern: "auditLog\\(.*ADMIN_UNLOCK"
    - from: "src/app/api/admin/export/route.ts"
      to: "src/lib/audit-logger.ts"
      via: "auditLog call"
      pattern: "auditLog\\(.*ADMIN_EXPORT"
    - from: "src/server/socket/index.ts"
      to: "src/lib/audit-logger.ts"
      via: "auditLog call"
      pattern: "auditLog\\(.*AUTHZ_FAILURE"
---

<objective>
Add audit logging to admin actions and authorization failures

Purpose: Log all admin actions and security-relevant authorization failures for investigation
Output: Admin unlock, data export, and Socket.IO authz failures all logged
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-audit-logging/13-CONTEXT.md
@.planning/phases/13-audit-logging/13-01-SUMMARY.md

# Files to modify
@src/lib/actions/admin.ts
@src/app/api/admin/export/route.ts
@src/server/socket/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logging to admin actions</name>
  <files>src/lib/actions/admin.ts, src/app/api/admin/export/route.ts</files>
  <action>
1. In `src/lib/actions/admin.ts` (adminUnlockUser function):
   - Import auditLog, AuditEventType from audit-logger
   - After successful unlock (line ~46), call:
     ```typescript
     auditLog(AuditEventType.ADMIN_UNLOCK_USER, {
       userId: session.user.id,  // Admin performing action
       targetId: userId,         // User being unlocked
       organizationId,
     });
     ```
   - Do NOT log failed unlock attempts (auth errors already handled by auth hooks)

2. In `src/app/api/admin/export/route.ts`:
   - Import auditLog, AuditEventType, getClientIP from audit-logger
   - Before returning the export data (around line 309), call:
     ```typescript
     auditLog(AuditEventType.ADMIN_EXPORT_DATA, {
       userId: session.user.id,
       organizationId,
       ip: getClientIP(await headers()),
       details: {
         memberCount: manifest.counts.members,
         messageCount: manifest.counts.messages,
       },
     });
     ```
  </action>
  <verify>
Run `grep -n "auditLog" src/lib/actions/admin.ts src/app/api/admin/export/route.ts`
Confirm both files contain auditLog calls with appropriate event types.
  </verify>
  <done>
Admin unlock and data export actions log audit events.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add logging to Socket.IO authorization failures</name>
  <files>src/server/socket/index.ts</files>
  <action>
In `src/server/socket/index.ts`:

1. Import auditLog, AuditEventType from audit-logger

2. In the `room:join` handler (around lines 101-124):
   - After the unauthorized channel join attempt log (line 107), add:
     ```typescript
     auditLog(AuditEventType.AUTHZ_FAILURE, {
       userId,
       details: {
         action: "room:join",
         resourceType: "channel",
         resourceId: data.roomId,
       },
     });
     ```
   - After the unauthorized conversation join attempt log (line 114), add:
     ```typescript
     auditLog(AuditEventType.AUTHZ_FAILURE, {
       userId,
       details: {
         action: "room:join",
         resourceType: "conversation",
         resourceId: data.roomId,
       },
     });
     ```

3. In the `workspace:join` handler (around lines 127-149):
   - After the unauthorized workspace join attempt log (line 134), add:
     ```typescript
     auditLog(AuditEventType.AUTHZ_FAILURE, {
       userId,
       details: {
         action: "workspace:join",
         resourceType: "organization",
         resourceId: workspaceId,
       },
     });
     ```

Note: Keep existing console.log statements. Audit log is in addition to console output.
  </action>
  <verify>
Run `grep -n "AUTHZ_FAILURE" src/server/socket/index.ts`
Confirm three AUTHZ_FAILURE audit log calls exist (channel, conversation, workspace).
  </verify>
  <done>
Socket.IO authorization failures logged with user, resource type, and resource ID.
  </done>
</task>

</tasks>

<verification>
1. Admin action logging: `grep "auditLog" src/lib/actions/admin.ts src/app/api/admin/export/route.ts` returns matches
2. Socket authz logging: `grep "AUTHZ_FAILURE" src/server/socket/index.ts` returns 3 matches
3. Build passes: `npm run build` completes without errors
</verification>

<success_criteria>
- Admin unlock action logs ADMIN_UNLOCK_USER event
- Data export action logs ADMIN_EXPORT_DATA event
- Socket.IO authorization failures log AUTHZ_FAILURE events with context
- All events include userId and relevant resource information
</success_criteria>

<output>
After completion, create `.planning/phases/13-audit-logging/13-02-SUMMARY.md`
</output>
