---
phase: 23-notes
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/app/api/notes/channel/route.ts
  - src/app/api/notes/personal/route.ts
  - src/components/notes/note-editor.tsx
  - src/components/notes/note-viewer.tsx
  - src/components/notes/conflict-dialog.tsx
  - src/lib/utils/debounce.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/notes/channel returns note content and version for channelId"
    - "PUT /api/notes/channel saves with version check, returns conflict on mismatch"
    - "GET /api/notes/personal returns user's note for current workspace"
    - "PUT /api/notes/personal saves personal note with version check"
    - "User can toggle between edit mode (textarea) and preview mode (rendered markdown)"
    - "Conflict dialog shows when version mismatch detected on save"
  artifacts:
    - path: "src/app/api/notes/channel/route.ts"
      provides: "GET and PUT handlers for channel notes"
      exports: ["GET", "PUT"]
    - path: "src/app/api/notes/personal/route.ts"
      provides: "GET and PUT handlers for personal notes"
      exports: ["GET", "PUT"]
    - path: "src/components/notes/note-editor.tsx"
      provides: "Edit/preview toggle component with auto-save"
      exports: ["NoteEditor"]
    - path: "src/components/notes/note-viewer.tsx"
      provides: "Read-only markdown renderer"
      exports: ["NoteViewer"]
    - path: "src/components/notes/conflict-dialog.tsx"
      provides: "Conflict resolution dialog"
      exports: ["ConflictDialog"]
  key_links:
    - from: "src/app/api/notes/channel/route.ts"
      to: "src/db/schema/note.ts"
      via: "database query"
      pattern: "channelNotes"
    - from: "src/components/notes/note-editor.tsx"
      to: "/api/notes"
      via: "fetch calls"
      pattern: "fetch.*api/notes"
---

<objective>
Create API routes for channel and personal notes with optimistic locking, plus reusable note editor components with edit/preview toggle and conflict detection.

Purpose: Core notes functionality that channel and personal notes UI will consume.
Output: API routes for CRUD, NoteEditor component with markdown preview, ConflictDialog for version conflicts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-notes/23-RESEARCH.md

@src/db/schema/note.ts (from 23-01, note schemas)
@src/app/api/channels/[channelId]/pins/route.ts (API route pattern)
@src/app/api/upload/avatar/route.ts (auth pattern)
@src/lib/socket-events.ts (socket event types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-markdown and plugins</name>
  <files>package.json</files>
  <action>
Install markdown rendering dependencies:

```bash
npm install react-markdown remark-gfm rehype-highlight
```

These are needed for secure markdown rendering (no dangerouslySetInnerHTML).
  </action>
  <verify>`npm ls react-markdown` shows installed version</verify>
  <done>react-markdown, remark-gfm, and rehype-highlight are installed</done>
</task>

<task type="auto">
  <name>Task 2: Create API routes for notes</name>
  <files>src/app/api/notes/channel/route.ts, src/app/api/notes/personal/route.ts</files>
  <action>
**Create `src/app/api/notes/channel/route.ts`:**

GET handler:
- Get session via better-auth (same pattern as other routes)
- Parse channelId from searchParams
- Verify user is member of channel (query channelMembers)
- Query channelNotes by channelId
- If no note exists, return { content: "", version: 0 } (will be created on first save)
- Return { content, version, updatedBy, updatedByName, updatedAt }

PUT handler:
- Get session, parse { channelId, content, baseVersion } from body
- Verify channel membership
- If baseVersion is 0 (new note), INSERT with version 1
- Otherwise UPDATE with WHERE version = baseVersion
- If update affects 0 rows, version mismatch (conflict):
  - Fetch current note
  - Return 409 with { success: false, conflict: { serverContent, serverVersion, editedBy, editedByName } }
- On success, emit socket event "note:updated" to channel room
- Return { success: true, newVersion }

**Create `src/app/api/notes/personal/route.ts`:**

GET handler:
- Get session
- Parse workspaceId from searchParams
- Query personalNotes by userId + organizationId (workspaceId)
- Return { content, version, updatedAt }

PUT handler:
- Get session, parse { workspaceId, content, baseVersion } from body
- If baseVersion is 0, INSERT with version 1
- Otherwise UPDATE with WHERE version = baseVersion
- Handle conflict same as channel notes (but no socket emit for personal)
- Return { success: true, newVersion }

Use sql`${table.version} + 1` for atomic version increment (same as RESEARCH.md pattern).
  </action>
  <verify>`curl -X GET 'http://localhost:3000/api/notes/channel?channelId=test' -H 'Cookie: ...'` returns JSON (may be 403 for invalid channel)</verify>
  <done>Both API routes handle GET/PUT with optimistic locking and conflict detection</done>
</task>

<task type="auto">
  <name>Task 3: Create note UI components</name>
  <files>src/components/notes/note-editor.tsx, src/components/notes/note-viewer.tsx, src/components/notes/conflict-dialog.tsx, src/lib/utils/debounce.ts</files>
  <action>
**Create `src/lib/utils/debounce.ts`:**
```typescript
export function debounce<T extends (...args: any[]) => any>(
  fn: T,
  delay: number
): (...args: Parameters<T>) => void {
  let timeoutId: NodeJS.Timeout | null = null;
  return (...args: Parameters<T>) => {
    if (timeoutId) clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      fn(...args);
      timeoutId = null;
    }, delay);
  };
}
```

**Create `src/components/notes/note-viewer.tsx`:**
- Read-only markdown renderer using react-markdown
- Props: content: string
- Use remarkGfm and rehypeHighlight plugins
- Add urlTransform to block javascript: URLs
- Use prose dark:prose-invert classes for styling
- Open external links in new tab

**Create `src/components/notes/conflict-dialog.tsx`:**
- Props: open, onClose, editedBy, editedByName, onKeepYours, onKeepTheirs
- Use Dialog from shadcn/ui
- Title: "Edit Conflict Detected"
- Description: "This note was edited by {editedByName} while you were editing."
- Two buttons: "Keep their version" (outline), "Keep your version" (primary)

**Create `src/components/notes/note-editor.tsx`:**
- "use client" directive
- Props:
  - noteType: "channel" | "personal"
  - channelId?: string
  - workspaceId?: string
  - readOnly?: boolean
- State: mode (edit/preview), content, baseVersion, saving, hasChanges, conflict
- On mount: fetch note content from appropriate API endpoint
- Edit mode: Textarea with font-mono
- Preview mode: NoteViewer component
- Debounced auto-save (2 second delay) - only when hasChanges
- On save conflict: show ConflictDialog
- "Keep yours" handler: retry PUT with new baseVersion + your content
- "Keep theirs" handler: refetch and reset local content
- Show "Saving..." and "Unsaved changes" indicators
- Use Edit, Eye icons from lucide-react for mode toggle

Theme-aware styling:
- bg-card for containers
- text-foreground for primary text
- text-muted-foreground for secondary text
- Use existing Button, Textarea from shadcn/ui
  </action>
  <verify>`npx tsc --noEmit` passes, components render without errors</verify>
  <done>NoteEditor supports edit/preview toggle with debounced auto-save and conflict detection UI</done>
</task>

</tasks>

<verification>
1. `npm ls react-markdown` shows package installed
2. `npx tsc --noEmit` passes
3. API routes exist and return appropriate responses
4. NoteEditor component can be imported without errors
</verification>

<success_criteria>
- API routes handle GET/PUT for both note types
- Optimistic locking returns 409 on version conflict
- NoteEditor toggles between edit and preview
- Markdown renders safely (no dangerouslySetInnerHTML)
- ConflictDialog allows choosing between versions
</success_criteria>

<output>
After completion, create `.planning/phases/23-notes/23-02-SUMMARY.md`
</output>
