---
phase: 23-notes
plan: 03
type: execute
wave: 3
depends_on: ["23-02"]
files_modified:
  - src/components/channel/channel-header.tsx
  - src/components/channel/channel-notes-sheet.tsx
  - src/server/socket/handlers/notes.ts
  - src/server/socket/index.ts
autonomous: true

must_haves:
  truths:
    - "User can click Notes button in channel header to open notes panel"
    - "Channel notes display in a slide-out sheet from the right"
    - "Any channel member can view and edit the channel's notes"
    - "Other users viewing the note receive real-time update notification via socket"
  artifacts:
    - path: "src/components/channel/channel-header.tsx"
      provides: "Notes button in channel header actions"
      contains: "FileText"
    - path: "src/components/channel/channel-notes-sheet.tsx"
      provides: "Sheet wrapper for channel notes editor"
      exports: ["ChannelNotesSheet"]
    - path: "src/server/socket/handlers/notes.ts"
      provides: "Socket handlers for note subscribe/unsubscribe"
      exports: ["registerNoteHandlers"]
  key_links:
    - from: "src/components/channel/channel-notes-sheet.tsx"
      to: "src/components/notes/note-editor.tsx"
      via: "component import"
      pattern: "NoteEditor"
    - from: "src/components/channel/channel-header.tsx"
      to: "src/components/channel/channel-notes-sheet.tsx"
      via: "component import"
      pattern: "ChannelNotesSheet"
    - from: "src/server/socket/handlers/notes.ts"
      to: "src/lib/socket-events.ts"
      via: "type definitions"
      pattern: "note:subscribe"
---

<objective>
Integrate channel notes into the channel header with a slide-out sheet UI and real-time socket updates when notes are edited.

Purpose: Deliver NOTE-01, NOTE-05, NOTE-06, NOTE-07 - channel shared documents with conflict detection.
Output: Notes button in channel header, sheet-based editor, socket handlers for real-time sync.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-notes/23-RESEARCH.md

@src/components/channel/channel-header.tsx (integration target)
@src/components/notes/note-editor.tsx (from 23-02)
@src/server/socket/index.ts (socket handler registration)
@src/server/socket/handlers/message.ts (handler pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create socket handlers for note subscriptions</name>
  <files>src/server/socket/handlers/notes.ts, src/server/socket/index.ts</files>
  <action>
**Create `src/server/socket/handlers/notes.ts`:**

Export function `registerNoteHandlers(io: Server, socket: Socket)`:

Handle "note:subscribe":
- Extract data: { channelId?, workspaceId? }
- If channelId: join room `note:channel:${channelId}`
- If workspaceId: join room `note:personal:${socket.data.userId}:${workspaceId}`
- Log subscription for debugging

Handle "note:unsubscribe":
- Extract data: { channelId?, workspaceId? }
- If channelId: leave room `note:channel:${channelId}`
- If workspaceId: leave room `note:personal:${socket.data.userId}:${workspaceId}`

**Update `src/server/socket/index.ts`:**
- Import registerNoteHandlers
- Call registerNoteHandlers(io, socket) in the socket connection handler
- Follow same pattern as other handler registrations

**Update channel notes API (src/app/api/notes/channel/route.ts):**
In the PUT handler, after successful save, emit to note room:
```typescript
const io = getIO();
io.to(`note:channel:${channelId}`).emit("note:updated", {
  channelId,
  version: newVersion,
  updatedBy: session.user.id,
  updatedByName: session.user.name || "Someone",
});
```
  </action>
  <verify>Server starts without errors, socket handlers registered</verify>
  <done>Socket handlers for note:subscribe and note:unsubscribe registered, note:updated emitted on save</done>
</task>

<task type="auto">
  <name>Task 2: Create channel notes sheet component</name>
  <files>src/components/channel/channel-notes-sheet.tsx</files>
  <action>
**Create `src/components/channel/channel-notes-sheet.tsx`:**

"use client" directive

Props:
- channelId: string
- channelName: string
- trigger?: React.ReactNode (optional custom trigger)

Use Sheet from shadcn/ui (SheetTrigger, SheetContent, SheetHeader, SheetTitle).

Default trigger: Button with FileText icon and "Notes" text.

Sheet opens from right side, width 600px (w-[600px] sm:max-w-[600px]).

SheetHeader shows: "#{channelName} Notes"

Content area contains NoteEditor with:
- noteType="channel"
- channelId={channelId}
- Height: h-[calc(100vh-8rem)] to fill sheet

On sheet open, emit "note:subscribe" via socket client.
On sheet close (onOpenChange false), emit "note:unsubscribe".

Listen for "note:updated" socket event:
- If channelId matches, show toast: "{updatedByName} updated the notes"
- If NoteEditor is not focused (not actively editing), trigger refetch

Use useSocket hook or socket client import pattern from existing components.
  </action>
  <verify>Component imports and renders without TypeScript errors</verify>
  <done>ChannelNotesSheet opens slide-out panel with NoteEditor, handles socket subscription</done>
</task>

<task type="auto">
  <name>Task 3: Add notes button to channel header</name>
  <files>src/components/channel/channel-header.tsx</files>
  <action>
Update `src/components/channel/channel-header.tsx`:

1. Import FileText from lucide-react (already importing other icons)
2. Import ChannelNotesSheet from "./channel-notes-sheet"

3. Add ChannelNotesSheet between NotificationSettingsDialog and NotificationBell (or after PinnedMessagesDialog):
```tsx
{/* Channel notes */}
<ChannelNotesSheet
  channelId={channel.id}
  channelName={channel.name}
/>
```

The ChannelNotesSheet includes its own trigger button, so just render the component.
  </action>
  <verify>Channel header shows Notes button, clicking opens sheet</verify>
  <done>Notes button visible in channel header, opens slide-out notes panel</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Channel header shows FileText icon button
3. Clicking button opens right-side sheet with notes editor
4. Notes can be edited and saved
5. Opening notes in another browser tab shows real-time update notification
</verification>

<success_criteria>
- NOTE-07: User can access channel notes from channel header button
- NOTE-01: Each channel has one shared markdown document (accessed via sheet)
- NOTE-05: Any member of a channel can edit that channel's notes
- NOTE-06: Concurrent edits trigger conflict detection (socket notification + version check)
</success_criteria>

<output>
After completion, create `.planning/phases/23-notes/23-03-SUMMARY.md`
</output>
