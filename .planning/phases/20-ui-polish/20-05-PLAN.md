# Plan 20-05: Extended Socket Handler Tests

## Frontmatter

```yaml
phase: 20
plan: 05
title: Extended Socket Handler Tests
objective: Test remaining socket handlers - reactions, notifications, unread counts, presence
wave: 2
depends_on: ["20-04"]
autonomous: true
estimated_tasks: 4
files_modified:
  - src/server/socket/__tests__/reaction-handlers.test.ts
  - src/server/socket/__tests__/notification-handlers.test.ts
  - src/server/socket/__tests__/unread-handlers.test.ts
  - src/server/socket/__tests__/presence-handlers.test.ts
```

## Context

Extends 20-04 to cover remaining socket handlers not yet tested:
- Reactions (toggle, get)
- Notifications (fetch, mark read, mention parsing)
- Unread counts (fetch, mark read/unread, cache invalidation)
- Presence (set active/away, fetch, org membership checks)

## Tasks

### Task 1: Reaction Handler Tests

<task id="1">
<title>Socket reaction handler unit tests</title>
<files>
- src/server/socket/__tests__/reaction-handlers.test.ts
</files>
<action>
Create unit tests for reaction socket handlers:

1. **reaction:toggle handler**
   - Success: add reaction to message
   - Success: remove existing reaction (toggle off)
   - Auth failure: non-member cannot react to channel message
   - Auth failure: non-participant cannot react to DM
   - Idempotent: double-toggle returns to original state

2. **reaction:get handler**
   - Success: fetch reactions for message
   - Auth failure: non-member cannot fetch channel reactions
   - Returns correct structure: `{ emoji, users[] }`

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";

vi.mock("@/db", () => ({
  db: {
    select: vi.fn().mockReturnThis(),
    from: vi.fn().mockReturnThis(),
    where: vi.fn().mockReturnThis(),
    limit: vi.fn(),
    insert: vi.fn().mockReturnThis(),
    values: vi.fn(),
    delete: vi.fn().mockReturnThis(),
  },
}));

describe("Reaction Handlers", () => {
  describe("reaction:toggle", () => {
    it("adds reaction when not present", async () => {
      // Setup: no existing reaction for user+message+emoji
      // Action: call toggle
      // Assert: insert called, returns { added: true }
    });

    it("removes reaction when already present", async () => {
      // Setup: existing reaction for user+message+emoji
      // Action: call toggle
      // Assert: delete called, returns { added: false }
    });

    it("rejects non-channel-members", async () => {
      // Setup: message in channel, user not member
      // Action: call toggle
      // Assert: error "Not authorized"
    });

    it("is idempotent across rapid toggles", async () => {
      // Setup: simulate race condition with two rapid toggles
      // Assert: final state is consistent
    });
  });

  describe("reaction:get", () => {
    it("returns grouped reactions by emoji", async () => {
      // Setup: message with reactions from multiple users
      // Action: call get
      // Assert: returns [{ emoji: "üëç", users: ["user1", "user2"] }]
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/server/socket/__tests__/reaction-handlers.test.ts
```
</verify>
<done>
- [ ] reaction:toggle add tested
- [ ] reaction:toggle remove tested
- [ ] reaction:toggle auth tested
- [ ] reaction:toggle idempotency tested
- [ ] reaction:get tested
- [ ] All tests pass
</done>
</task>

### Task 2: Notification Handler Tests

<task id="2">
<title>Socket notification handler unit tests</title>
<files>
- src/server/socket/__tests__/notification-handlers.test.ts
</files>
<action>
Create unit tests for notification socket handlers:

1. **notification:fetch handler**
   - Success: returns user's notifications with pagination
   - Returns unread count
   - Respects limit parameter
   - Only returns notifications for authenticated user

2. **notification:markRead handler**
   - Success: marks single notification as read
   - Success: marks all notifications as read
   - Auth: cannot mark another user's notifications

3. **Mention notification creation** (integration)
   - @username creates notification for mentioned user
   - @channel creates notifications for all channel members
   - @here creates notifications for active channel members
   - Does not notify message author for self-mention

```typescript
describe("Notification Handlers", () => {
  describe("notification:fetch", () => {
    it("returns paginated notifications for user", async () => {
      // Setup: user has 15 notifications
      // Action: fetch with limit: 10
      // Assert: returns 10 notifications, hasMore: true
    });

    it("returns unread count", async () => {
      // Setup: user has 5 unread, 10 read
      // Action: fetch
      // Assert: unreadCount === 5
    });

    it("only returns own notifications", async () => {
      // Setup: notifications for multiple users
      // Action: fetch as userA
      // Assert: only userA's notifications returned
    });
  });

  describe("notification:markRead", () => {
    it("marks single notification as read", async () => {
      // Setup: unread notification
      // Action: markRead with notificationId
      // Assert: notification.readAt is set
    });

    it("marks all as read when no id provided", async () => {
      // Setup: 5 unread notifications
      // Action: markRead without id
      // Assert: all notifications have readAt set
    });
  });

  describe("Mention notification creation", () => {
    it("creates notification for @username mention", async () => {
      // Setup: message with @alice
      // Action: process message
      // Assert: notification created for alice
    });

    it("creates notifications for @channel", async () => {
      // Setup: channel with 5 members, message with @channel
      // Action: process message
      // Assert: 4 notifications created (excludes author)
    });

    it("does not notify author for self-mention", async () => {
      // Setup: alice sends message with @alice
      // Action: process message
      // Assert: no notification for alice
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/server/socket/__tests__/notification-handlers.test.ts
```
</verify>
<done>
- [ ] notification:fetch pagination tested
- [ ] notification:fetch unread count tested
- [ ] notification:markRead single tested
- [ ] notification:markRead all tested
- [ ] @username mention notification tested
- [ ] @channel mention notification tested
- [ ] Self-mention exclusion tested
- [ ] All tests pass
</done>
</task>

### Task 3: Unread Handler Tests

<task id="3">
<title>Socket unread handler unit tests</title>
<files>
- src/server/socket/__tests__/unread-handlers.test.ts
</files>
<action>
Create unit tests for unread count socket handlers:

1. **unread:fetch handler**
   - Success: returns unread counts per channel
   - Success: returns unread counts per conversation
   - Returns 0 for channels with no unread
   - Auth: only returns counts for member channels

2. **unread:markRead handler**
   - Success: marks channel as read up to sequence
   - Success: marks conversation as read
   - Updates lastReadSequence correctly
   - Auth: cannot mark non-member channel

3. **unread:markUnread handler**
   - Success: marks channel as unread from sequence
   - Auth: cannot mark non-member channel

4. **Cache invalidation**
   - New message increments unread for other members
   - Mark read clears unread count

```typescript
describe("Unread Handlers", () => {
  describe("unread:fetch", () => {
    it("returns unread counts per channel", async () => {
      // Setup: user is member of 3 channels with varying unread
      // Action: fetch
      // Assert: returns { channels: { ch1: 5, ch2: 0, ch3: 12 } }
    });

    it("only includes member channels", async () => {
      // Setup: user member of ch1, not ch2
      // Action: fetch for [ch1, ch2]
      // Assert: only ch1 in response
    });
  });

  describe("unread:markRead", () => {
    it("updates lastReadSequence for channel", async () => {
      // Setup: channel with messages up to sequence 50
      // Action: markRead with sequence: 50
      // Assert: channelReadState.lastReadSequence = 50
    });

    it("rejects non-member", async () => {
      // Setup: user not member of channel
      // Action: markRead
      // Assert: error
    });
  });

  describe("Cache invalidation", () => {
    it("new message increments unread for other members", async () => {
      // Setup: channel with alice and bob, both at sequence 10
      // Action: alice sends message (sequence 11)
      // Assert: bob's unread count = 1, alice's = 0
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/server/socket/__tests__/unread-handlers.test.ts
```
</verify>
<done>
- [ ] unread:fetch channels tested
- [ ] unread:fetch conversations tested
- [ ] unread:fetch auth tested
- [ ] unread:markRead tested
- [ ] unread:markUnread tested
- [ ] Cache invalidation tested
- [ ] All tests pass
</done>
</task>

### Task 4: Presence Handler Tests

<task id="4">
<title>Socket presence handler unit tests</title>
<files>
- src/server/socket/__tests__/presence-handlers.test.ts
</files>
<action>
Create unit tests for presence socket handlers:

1. **presence:setActive handler**
   - Sets user status to "active"
   - Broadcasts to workspace members
   - Updates Redis presence store

2. **presence:setAway handler**
   - Sets user status to "away"
   - Broadcasts to workspace members

3. **presence:fetch handler**
   - Returns presence for requested users
   - Auth: only returns presence for same-org users
   - Returns "offline" for users not in Redis

4. **Organization membership check**
   - Cannot fetch presence for users in different org
   - Cannot broadcast presence to different org

```typescript
describe("Presence Handlers", () => {
  describe("presence:setActive", () => {
    it("sets user status to active", async () => {
      // Setup: user in workspace
      // Action: setActive
      // Assert: Redis key set, broadcast emitted
    });

    it("broadcasts to workspace members", async () => {
      // Setup: workspace with multiple users
      // Action: setActive
      // Assert: workspace room receives presence:update event
    });
  });

  describe("presence:setAway", () => {
    it("sets user status to away", async () => {
      // Action: setAway
      // Assert: Redis key updated to "away"
    });
  });

  describe("presence:fetch", () => {
    it("returns presence for requested users", async () => {
      // Setup: alice=active, bob=away, charlie=not in Redis
      // Action: fetch [alice, bob, charlie]
      // Assert: { alice: "active", bob: "away", charlie: "offline" }
    });

    it("only returns same-org users", async () => {
      // Setup: alice in orgA, bob in orgB
      // Action: fetch [alice, bob] as orgA member
      // Assert: only alice's presence returned
    });
  });

  describe("Disconnect handling", () => {
    it("sets user to offline on socket disconnect", async () => {
      // Setup: user connected and active
      // Action: socket disconnects
      // Assert: presence set to offline after grace period
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/server/socket/__tests__/presence-handlers.test.ts
```
</verify>
<done>
- [ ] presence:setActive tested
- [ ] presence:setAway tested
- [ ] presence:fetch tested
- [ ] Org membership check tested
- [ ] Disconnect handling tested
- [ ] All tests pass
</done>
</task>

## Verification

### must_haves

```yaml
truths:
  - "Reaction toggle is idempotent"
  - "Reactions require channel/conversation membership"
  - "Notifications respect user ownership"
  - "@channel notifies all members except author"
  - "Unread counts only include member channels"
  - "Presence fetch respects org boundaries"

artifacts:
  - path: src/server/socket/__tests__/reaction-handlers.test.ts
    validates: ["Reaction toggle is idempotent", "Reactions require membership"]
  - path: src/server/socket/__tests__/notification-handlers.test.ts
    validates: ["Notifications respect user ownership", "@channel notifies all members"]
  - path: src/server/socket/__tests__/unread-handlers.test.ts
    validates: ["Unread counts only include member channels"]
  - path: src/server/socket/__tests__/presence-handlers.test.ts
    validates: ["Presence fetch respects org boundaries"]
```

### Verification Commands

```bash
npm run test -- src/server/socket/__tests__/reaction-handlers.test.ts
npm run test -- src/server/socket/__tests__/notification-handlers.test.ts
npm run test -- src/server/socket/__tests__/unread-handlers.test.ts
npm run test -- src/server/socket/__tests__/presence-handlers.test.ts
```
