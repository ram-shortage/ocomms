# Plan 20-07: Server Actions & Business Logic Tests

## Frontmatter

```yaml
phase: 20
plan: 07
title: Server Actions & Business Logic Tests
objective: Test server actions, data access layer, and business logic utilities
wave: 2
depends_on: []
autonomous: true
estimated_tasks: 4
files_modified:
  - src/lib/actions/__tests__/channels.test.ts
  - src/lib/actions/__tests__/conversations.test.ts
  - src/lib/actions/__tests__/search.test.ts
  - src/lib/actions/__tests__/admin.test.ts
  - src/lib/__tests__/audit.test.ts
```

## Context

Tests for server-side business logic:
- Server actions in `src/lib/actions/*`
- Audit logging functionality
- Data access patterns and scoping

## Tasks

### Task 1: Channel Actions Tests

<task id="1">
<title>Channel server action tests</title>
<files>
- src/lib/actions/__tests__/channels.test.ts
</files>
<action>
Create tests for channel server actions:

1. **createChannel**
   - Creates channel in organization
   - Sets creator as member with owner role
   - Validates name uniqueness within org
   - Supports public/private visibility

2. **getChannel**
   - Returns channel for member
   - Rejects non-member access
   - Rejects cross-org access

3. **updateChannel**
   - Updates name/description
   - Requires owner/admin role
   - Validates name uniqueness

4. **deleteChannel**
   - Soft deletes channel
   - Requires owner role
   - Cascades to memberships

5. **joinChannel / leaveChannel**
   - Join adds membership
   - Leave removes membership
   - Cannot leave if only owner

```typescript
import { describe, it, expect, vi } from "vitest";
import {
  createChannel,
  getChannel,
  updateChannel,
  joinChannel,
  leaveChannel,
} from "../channels";

vi.mock("@/db");
vi.mock("@/lib/auth");

describe("Channel Actions", () => {
  describe("createChannel", () => {
    it("creates channel with creator as owner", async () => {
      // Setup: authenticated user, valid org
      // Action: createChannel({ name: "general", orgId })
      // Assert: channel created, membership created with role: "owner"
    });

    it("rejects duplicate name in same org", async () => {
      // Setup: channel "general" exists in org
      // Action: createChannel({ name: "general", orgId })
      // Assert: throws "Channel name already exists"
    });

    it("allows same name in different orgs", async () => {
      // Setup: "general" exists in orgA
      // Action: createChannel({ name: "general", orgId: orgB })
      // Assert: succeeds
    });
  });

  describe("getChannel", () => {
    it("returns channel for member", async () => {
      // Setup: user is member of channel
      // Action: getChannel(channelId)
      // Assert: returns channel with messages
    });

    it("rejects non-member", async () => {
      // Setup: user not member
      // Action: getChannel(channelId)
      // Assert: returns null or throws
    });

    it("rejects cross-org access", async () => {
      // Setup: channel in orgA, user in orgB
      // Action: getChannel(channelId)
      // Assert: returns null
    });
  });

  describe("joinChannel", () => {
    it("adds user as member", async () => {
      // Setup: public channel, user in same org
      // Action: joinChannel(channelId)
      // Assert: membership created
    });

    it("rejects join for private channel without invite", async () => {
      // Setup: private channel
      // Action: joinChannel(channelId)
      // Assert: throws "Invite required"
    });
  });

  describe("leaveChannel", () => {
    it("removes membership", async () => {
      // Setup: user is member
      // Action: leaveChannel(channelId)
      // Assert: membership deleted
    });

    it("prevents last owner from leaving", async () => {
      // Setup: user is only owner
      // Action: leaveChannel(channelId)
      // Assert: throws "Cannot leave as only owner"
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/lib/actions/__tests__/channels.test.ts
```
</verify>
<done>
- [ ] createChannel tested
- [ ] createChannel name uniqueness tested
- [ ] getChannel member access tested
- [ ] getChannel cross-org blocked tested
- [ ] joinChannel tested
- [ ] leaveChannel tested
- [ ] All tests pass
</done>
</task>

### Task 2: Conversation Actions Tests

<task id="2">
<title>Conversation (DM) server action tests</title>
<files>
- src/lib/actions/__tests__/conversations.test.ts
</files>
<action>
Create tests for conversation server actions:

1. **createConversation**
   - Creates 1:1 conversation
   - Creates group conversation
   - Returns existing conversation if same participants
   - Validates all participants in same org

2. **getConversation**
   - Returns conversation for participant
   - Rejects non-participant
   - Includes messages and participants

3. **getOrCreateConversation**
   - Returns existing if found
   - Creates new if not found
   - Idempotent for same participant set

```typescript
describe("Conversation Actions", () => {
  describe("createConversation", () => {
    it("creates 1:1 conversation", async () => {
      // Setup: two users in same org
      // Action: createConversation([userA, userB])
      // Assert: conversation created with both as participants
    });

    it("returns existing conversation for same participants", async () => {
      // Setup: conversation exists between userA and userB
      // Action: createConversation([userA, userB])
      // Assert: returns existing conversation, no new one created
    });

    it("validates participants in same org", async () => {
      // Setup: userA in orgA, userB in orgB
      // Action: createConversation([userA, userB])
      // Assert: throws "Participants must be in same organization"
    });
  });

  describe("getConversation", () => {
    it("returns conversation for participant", async () => {
      // Setup: user is participant
      // Action: getConversation(convId)
      // Assert: returns conversation with messages
    });

    it("rejects non-participant", async () => {
      // Setup: user not in conversation
      // Action: getConversation(convId)
      // Assert: returns null
    });
  });

  describe("getOrCreateConversation", () => {
    it("is idempotent", async () => {
      // Action: call twice with same participants
      // Assert: same conversation returned both times
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/lib/actions/__tests__/conversations.test.ts
```
</verify>
<done>
- [ ] createConversation 1:1 tested
- [ ] createConversation existing return tested
- [ ] createConversation org validation tested
- [ ] getConversation access tested
- [ ] getOrCreateConversation idempotency tested
- [ ] All tests pass
</done>
</task>

### Task 3: Search Actions Tests

<task id="3">
<title>Search server action tests</title>
<files>
- src/lib/actions/__tests__/search.test.ts
</files>
<action>
Create tests for search server actions:

1. **searchMessages**
   - Returns matching messages
   - Only searches user's accessible channels/DMs
   - Respects org boundaries
   - Supports pagination

2. **Search result scoping**
   - Does not return messages from non-member channels
   - Does not return messages from other orgs
   - Does not return deleted messages

```typescript
describe("Search Actions", () => {
  describe("searchMessages", () => {
    it("returns matching messages from member channels", async () => {
      // Setup: user member of channel with matching messages
      // Action: searchMessages("hello")
      // Assert: returns matches from accessible channels
    });

    it("excludes non-member channel messages", async () => {
      // Setup: "hello" exists in channel user is NOT member of
      // Action: searchMessages("hello")
      // Assert: does not include that message
    });

    it("respects org boundaries", async () => {
      // Setup: "hello" in channel in different org
      // Action: searchMessages("hello")
      // Assert: does not include cross-org results
    });

    it("excludes deleted messages", async () => {
      // Setup: deleted message matching query
      // Action: searchMessages("hello")
      // Assert: deleted message not in results
    });

    it("supports pagination", async () => {
      // Setup: 25 matching messages
      // Action: searchMessages("hello", { limit: 10, offset: 10 })
      // Assert: returns messages 11-20
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/lib/actions/__tests__/search.test.ts
```
</verify>
<done>
- [ ] Search basic functionality tested
- [ ] Search scoping to member channels tested
- [ ] Search org boundary tested
- [ ] Search excludes deleted tested
- [ ] Search pagination tested
- [ ] All tests pass
</done>
</task>

### Task 4: Audit Logging Tests

<task id="4">
<title>Audit logging tests</title>
<files>
- src/lib/__tests__/audit.test.ts
</files>
<action>
Create tests for audit logging:

1. **logAuditEvent**
   - Writes event to audit log
   - Includes all required fields (timestamp, eventType, userId, etc.)
   - Non-blocking (fire-and-forget)

2. **queryAuditLogs**
   - Filters by date range
   - Filters by event type
   - Paginates correctly
   - Scoped to organization

3. **Retention cleanup**
   - Deletes events older than retention period
   - Runs without blocking

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";
import { logAuditEvent, queryAuditLogs, cleanupOldEvents } from "../audit";

describe("Audit Logging", () => {
  describe("logAuditEvent", () => {
    it("writes event with required fields", async () => {
      // Action: logAuditEvent({ eventType: "AUTH_LOGIN_SUCCESS", userId })
      // Assert: event written with timestamp, eventType, userId
    });

    it("includes optional fields when provided", async () => {
      // Action: logAuditEvent({ ..., ip: "1.2.3.4", userAgent: "..." })
      // Assert: event includes ip and userAgent
    });

    it("is non-blocking", async () => {
      // Action: call logAuditEvent, measure time
      // Assert: returns immediately (< 10ms)
    });
  });

  describe("queryAuditLogs", () => {
    it("filters by date range", async () => {
      // Setup: events from Jan 1-31
      // Action: query from Jan 10-20
      // Assert: only events in range returned
    });

    it("filters by event type", async () => {
      // Setup: mix of AUTH_LOGIN_SUCCESS and AUTH_LOGIN_FAILURE
      // Action: query with eventType: "AUTH_LOGIN_FAILURE"
      // Assert: only failure events returned
    });

    it("scopes to organization", async () => {
      // Setup: events from multiple orgs
      // Action: query for orgA
      // Assert: only orgA events returned
    });
  });

  describe("cleanupOldEvents", () => {
    it("deletes events older than retention period", async () => {
      // Setup: events from 100 days ago, retention = 90 days
      // Action: cleanupOldEvents()
      // Assert: old events deleted
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/lib/__tests__/audit.test.ts
```
</verify>
<done>
- [ ] logAuditEvent basic tested
- [ ] logAuditEvent non-blocking tested
- [ ] queryAuditLogs date filter tested
- [ ] queryAuditLogs event type filter tested
- [ ] queryAuditLogs org scoping tested
- [ ] cleanupOldEvents tested
- [ ] All tests pass
</done>
</task>

## Verification

### must_haves

```yaml
truths:
  - "Channel actions enforce org membership"
  - "Conversation creation validates same-org participants"
  - "Search results respect access control"
  - "Audit logging is non-blocking"

artifacts:
  - path: src/lib/actions/__tests__/channels.test.ts
    validates: ["Channel actions enforce org membership"]
  - path: src/lib/actions/__tests__/conversations.test.ts
    validates: ["Conversation creation validates same-org participants"]
  - path: src/lib/actions/__tests__/search.test.ts
    validates: ["Search results respect access control"]
  - path: src/lib/__tests__/audit.test.ts
    validates: ["Audit logging is non-blocking"]
```

### Verification Commands

```bash
npm run test -- src/lib/actions/__tests__/
npm run test -- src/lib/__tests__/audit.test.ts
```
