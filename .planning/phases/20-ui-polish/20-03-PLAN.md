---
phase: 20-ui-polish
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/app/(workspace)/[workspaceSlug]/settings/admin/page.tsx
  - src/components/admin/audit-log-viewer.tsx
  - src/components/admin/export-data-button.tsx
  - src/app/(workspace)/[workspaceSlug]/settings/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin can navigate to admin settings page"
    - "Admin can view audit logs with date filtering"
    - "Admin can filter audit logs by event type"
    - "Admin can export audit logs to CSV"
    - "Admin can trigger organization data export"
    - "Non-admins cannot access admin page"
  artifacts:
    - path: "src/app/(workspace)/[workspaceSlug]/settings/admin/page.tsx"
      provides: "Admin settings page"
      min_lines: 50
    - path: "src/components/admin/audit-log-viewer.tsx"
      provides: "Audit log table with filtering"
      exports: ["AuditLogViewer"]
    - path: "src/components/admin/export-data-button.tsx"
      provides: "Data export trigger"
      exports: ["ExportDataButton"]
  key_links:
    - from: "src/app/(workspace)/[workspaceSlug]/settings/admin/page.tsx"
      to: "/api/admin/audit-logs"
      via: "AuditLogViewer fetch"
      pattern: "api/admin/audit-logs"
    - from: "src/components/admin/export-data-button.tsx"
      to: "/api/admin/export"
      via: "fetch POST"
      pattern: "api/admin/export"
    - from: "src/app/(workspace)/[workspaceSlug]/settings/page.tsx"
      to: "settings/admin"
      via: "Link component"
      pattern: "settings/admin"
---

<objective>
Create admin settings page with audit log viewer and data export functionality.

Purpose: Enable organization admins to monitor security events and export organization data through the UI.
Output: Admin page accessible from settings, audit log table with filtering/export, data export button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-ui-polish/20-RESEARCH.md

API references:
@src/app/api/admin/audit-logs/route.ts
@src/app/api/admin/export/route.ts

Page pattern reference:
@src/app/(workspace)/[workspaceSlug]/settings/page.tsx
@src/app/(workspace)/[workspaceSlug]/settings/members/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit log viewer component</name>
  <files>src/components/admin/audit-log-viewer.tsx</files>
  <action>
  Create client component at `src/components/admin/audit-log-viewer.tsx`:

  Props:
  ```typescript
  interface AuditLogViewerProps {
    organizationId: string;
  }
  ```

  Features:
  1. **Date range filter** using native `<input type="date">` for from/to dates
     - Default: last 7 days
     - Maximum range: 90 days (matches log retention)

  2. **Event type filter** using a select dropdown
     - Options: All events + each AuditEventType value
     - Values from: AUTH_LOGIN_SUCCESS, AUTH_LOGIN_FAILURE, AUTH_LOGOUT, AUTH_PASSWORD_RESET, ADMIN_UNLOCK_USER, ADMIN_EXPORT_DATA, AUTHZ_FAILURE

  3. **Table display** with columns:
     - Timestamp (formatted with date-fns: "MMM d, yyyy HH:mm:ss")
     - Event Type (with monospace/badge styling)
     - User ID (truncated if long, or "-" if null)
     - IP Address (or "-" if null)

  4. **Pagination** controls:
     - Show total count
     - Previous/Next buttons
     - 50 events per page

  5. **Export to CSV** button:
     - Client-side CSV generation from current filtered results
     - Filename: `audit-logs-YYYY-MM-DD.csv`
     - Include all columns

  State management:
  - useState for filters (from, to, eventType)
  - useState for events array, pagination, loading
  - useEffect to fetch when filters change

  Fetch pattern:
  ```typescript
  const params = new URLSearchParams({
    from: fromDate.toISOString(),
    to: toDate.toISOString(),
    limit: "50",
    offset: String(offset),
  });
  if (eventType) params.set("eventType", eventType);

  const res = await fetch(`/api/admin/audit-logs?${params}`);
  const data = await res.json();
  ```

  CSV export function:
  ```typescript
  function exportToCSV(events: AuditEvent[]) {
    const headers = ["Timestamp", "Event Type", "User ID", "IP", "Details"];
    const rows = events.map(e => [
      e.timestamp,
      e.eventType,
      e.userId || "",
      e.ip || "",
      JSON.stringify(e.details || {})
    ]);
    const csv = [headers, ...rows]
      .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(","))
      .join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `audit-logs-${new Date().toISOString().split("T")[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }
  ```

  Styling:
  - Use existing Tailwind patterns from settings pages
  - Table: border, rounded corners, hover states on rows
  - Filters: flex row with gap, inputs and select with consistent sizing
  - Loading state: show "Loading..." text or spinner
  - Empty state: "No audit events found for the selected filters"
  </action>
  <verify>
  ```bash
  test -f src/components/admin/audit-log-viewer.tsx && grep "AuditLogViewer" src/components/admin/audit-log-viewer.tsx
  ```
  Should show file exists and exports component.
  </verify>
  <done>AuditLogViewer component created with date filtering, event type filtering, pagination, and CSV export.</done>
</task>

<task type="auto">
  <name>Task 2: Create export data button component</name>
  <files>src/components/admin/export-data-button.tsx</files>
  <action>
  Create client component at `src/components/admin/export-data-button.tsx`:

  Props:
  ```typescript
  interface ExportDataButtonProps {
    organizationId: string;
  }
  ```

  Features:
  1. Button with "Export Data (JSON)" label
  2. Loading state while export is in progress
  3. Triggers download of JSON file

  Implementation:
  ```typescript
  "use client";

  import { useState } from "react";
  import { Button } from "@/components/ui/button";

  export function ExportDataButton({ organizationId }: ExportDataButtonProps) {
    const [loading, setLoading] = useState(false);

    const handleExport = async () => {
      setLoading(true);
      try {
        const res = await fetch("/api/admin/export", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ organizationId }),
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || "Export failed");
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `ocomms-export-${new Date().toISOString().replace(/[:.]/g, "-")}.json`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error("Export failed:", error);
        alert(error instanceof Error ? error.message : "Export failed");
      } finally {
        setLoading(false);
      }
    };

    return (
      <Button onClick={handleExport} disabled={loading}>
        {loading ? "Exporting..." : "Export Data (JSON)"}
      </Button>
    );
  }
  ```

  Note: Export is owner-only (API enforces this), but UI should be accessible to admins too - the API will return 403 if non-owner tries.
  </action>
  <verify>
  ```bash
  test -f src/components/admin/export-data-button.tsx && grep "ExportDataButton" src/components/admin/export-data-button.tsx
  ```
  Should show file exists and exports component.
  </verify>
  <done>ExportDataButton component created with loading state and download trigger.</done>
</task>

<task type="auto">
  <name>Task 3: Create admin settings page and add navigation</name>
  <files>src/app/(workspace)/[workspaceSlug]/settings/admin/page.tsx, src/app/(workspace)/[workspaceSlug]/settings/page.tsx</files>
  <action>
  **Part A: Create admin page**

  Create `src/app/(workspace)/[workspaceSlug]/settings/admin/page.tsx`:

  Pattern from existing settings pages:
  1. Server component that checks session
  2. Load organization and verify membership
  3. Check role is owner or admin
  4. If not admin, call notFound() or redirect to settings
  5. Render page with client components

  Structure:
  ```typescript
  import { auth } from "@/lib/auth";
  import { headers } from "next/headers";
  import { redirect, notFound } from "next/navigation";
  import Link from "next/link";
  import { db } from "@/db";
  import { eq, and } from "drizzle-orm";
  import { organizations, members } from "@/db/schema";
  import { AuditLogViewer } from "@/components/admin/audit-log-viewer";
  import { ExportDataButton } from "@/components/admin/export-data-button";

  export default async function AdminSettingsPage({
    params,
  }: {
    params: Promise<{ workspaceSlug: string }>;
  }) {
    const { workspaceSlug } = await params;

    const session = await auth.api.getSession({
      headers: await headers(),
    });

    if (!session) {
      redirect("/login");
    }

    // Get organization
    const organization = await db.query.organizations.findFirst({
      where: eq(organizations.slug, workspaceSlug),
    });

    if (!organization) {
      notFound();
    }

    // Check user is admin or owner
    const membership = await db.query.members.findFirst({
      where: and(
        eq(members.userId, session.user.id),
        eq(members.organizationId, organization.id)
      ),
    });

    const isAdmin = membership?.role === "owner" || membership?.role === "admin";
    if (!isAdmin) {
      notFound(); // Or redirect to settings
    }

    const isOwner = membership?.role === "owner";

    return (
      <div className="p-8 max-w-4xl mx-auto space-y-8">
        <h1 className="text-2xl font-bold">Administration</h1>

        {/* Audit Logs Section */}
        <section className="space-y-4">
          <h2 className="text-xl font-semibold">Audit Logs</h2>
          <p className="text-sm text-gray-600">
            View security events for your organization. Logs are retained for 90 days.
          </p>
          <AuditLogViewer organizationId={organization.id} />
        </section>

        {/* Data Export Section - only show to owners */}
        {isOwner && (
          <section className="space-y-4">
            <h2 className="text-xl font-semibold">Data Export</h2>
            <p className="text-sm text-gray-600">
              Export all organization data including members, channels, messages, and settings.
              This export can be used for backup or data portability (GDPR compliance).
            </p>
            <ExportDataButton organizationId={organization.id} />
          </section>
        )}

        <div className="pt-4">
          <Link
            href={`/${workspaceSlug}/settings`}
            className="text-sm text-blue-600 hover:underline"
          >
            Back to settings
          </Link>
        </div>
      </div>
    );
  }
  ```

  **Part B: Add admin link to settings index page**

  Update `src/app/(workspace)/[workspaceSlug]/settings/page.tsx`:

  1. Add membership/role check (similar pattern to admin page)
  2. Add admin section after the Workspace section, before NotificationsSection
  3. Only show to admin/owner roles

  Add this section conditionally:
  ```tsx
  {/* Admin section - only for admins/owners */}
  {isAdmin && (
    <section className="space-y-4">
      <h2 className="text-xl font-semibold">Administration</h2>
      <nav className="space-y-2">
        <Link
          href={`/${workspaceSlug}/settings/admin`}
          className="block p-4 bg-white border rounded hover:bg-gray-50"
        >
          <h3 className="font-medium">Audit Logs & Export</h3>
          <p className="text-sm text-gray-500">
            View security logs and export organization data
          </p>
        </Link>
      </nav>
    </section>
  )}
  ```

  This requires adding:
  - Import and query for organization and membership
  - isAdmin check variable
  </action>
  <verify>
  ```bash
  test -f src/app/(workspace)/[workspaceSlug]/settings/admin/page.tsx && \
  grep "AuditLogViewer" src/app/(workspace)/[workspaceSlug]/settings/admin/page.tsx && \
  grep "settings/admin" src/app/(workspace)/[workspaceSlug]/settings/page.tsx
  ```
  Should confirm both files exist and are properly connected.
  </verify>
  <done>Admin page created with audit viewer and export, settings page has admin link for admin/owner users.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build` completes without errors
2. Admin page accessible at `/{workspace}/settings/admin`
3. Non-admin users get 404 on admin page
4. Audit log viewer loads events from API
5. Date and event type filters work
6. CSV export downloads file
7. Data export button triggers JSON download (owner only)
8. Settings page shows admin link for admin/owner users
</verification>

<success_criteria>
- Admin can navigate to admin settings page (UIPOL-03 partial)
- Admin can view audit logs with filtering (UIPOL-03 complete)
- Admin can export audit logs to CSV (UIPOL-03 complete)
- Admin can trigger data export (UIPOL-04 complete)
- Non-admins cannot access admin page
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-ui-polish/20-03-SUMMARY.md`
</output>
