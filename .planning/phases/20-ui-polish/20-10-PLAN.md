# Plan 20-10: Accessibility Tests

## Frontmatter

```yaml
phase: 20
plan: 10
title: Accessibility Tests
objective: Test ARIA compliance, keyboard navigation, and focus management
wave: 3
depends_on: ["20-09"]
autonomous: true
estimated_tasks: 3
files_modified:
  - src/components/__tests__/a11y/aria-compliance.test.tsx
  - src/components/__tests__/a11y/keyboard-navigation.test.tsx
  - src/components/__tests__/a11y/focus-management.test.tsx
```

## Context

Accessibility tests to ensure the application is usable with:
- Screen readers (ARIA attributes)
- Keyboard-only navigation
- Proper focus management

Uses @axe-core/react for automated accessibility checks.

## Tasks

### Task 1: ARIA Compliance Tests

<task id="1">
<title>ARIA compliance tests</title>
<files>
- src/components/__tests__/a11y/aria-compliance.test.tsx
</files>
<action>
Install axe-core and create ARIA compliance tests:

1. Install: `npm install -D @axe-core/react axe-core`

2. Test ARIA attributes on key components:

```typescript
import { render } from '@testing-library/react';
import { axe, toHaveNoViolations } from 'jest-axe';
import { describe, it, expect } from 'vitest';

expect.extend(toHaveNoViolations);

// Or use @axe-core/react directly
import { configureAxe } from '@axe-core/react';

describe('ARIA Compliance', () => {
  describe('MessageList', () => {
    it('has no accessibility violations', async () => {
      const { container } = render(<MessageList messages={mockMessages} />);
      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });

    it('messages have appropriate roles', () => {
      render(<MessageList messages={mockMessages} />);

      const messages = screen.getAllByRole('article');
      expect(messages.length).toBe(mockMessages.length);
    });

    it('message actions are labeled', () => {
      render(<MessageList messages={mockMessages} />);

      // Hover to show actions
      const message = screen.getByText('Hello').closest('[data-message]');
      fireEvent.mouseEnter(message!);

      expect(screen.getByRole('button', { name: /reply to thread/i })).toBeInTheDocument();
      expect(screen.getByRole('button', { name: /add reaction/i })).toBeInTheDocument();
    });
  });

  describe('MessageInput', () => {
    it('has no accessibility violations', async () => {
      const { container } = render(<MessageInput onSend={vi.fn()} />);
      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });

    it('input has accessible label', () => {
      render(<MessageInput onSend={vi.fn()} />);

      expect(screen.getByRole('textbox', { name: /message/i })).toBeInTheDocument();
    });

    it('send button has accessible name', () => {
      render(<MessageInput onSend={vi.fn()} />);

      expect(screen.getByRole('button', { name: /send message/i })).toBeInTheDocument();
    });
  });

  describe('Sidebar', () => {
    it('has no accessibility violations', async () => {
      const { container } = render(<Sidebar workspace={mockWorkspace} />);
      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });

    it('navigation has appropriate landmark', () => {
      render(<Sidebar workspace={mockWorkspace} />);

      expect(screen.getByRole('navigation')).toBeInTheDocument();
    });

    it('channel list uses proper list semantics', () => {
      render(<Sidebar workspace={mockWorkspace} />);

      expect(screen.getByRole('list', { name: /channels/i })).toBeInTheDocument();
    });
  });

  describe('Dialog/Modal', () => {
    it('has no accessibility violations', async () => {
      const { container } = render(<CreateChannelDialog open={true} />);
      const results = await axe(container);
      expect(results).toHaveNoViolations();
    });

    it('dialog has appropriate role and label', () => {
      render(<CreateChannelDialog open={true} />);

      expect(screen.getByRole('dialog', { name: /create channel/i })).toBeInTheDocument();
    });

    it('dialog traps focus', () => {
      render(<CreateChannelDialog open={true} />);

      const dialog = screen.getByRole('dialog');
      expect(dialog).toHaveAttribute('aria-modal', 'true');
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/components/__tests__/a11y/aria-compliance.test.tsx
```
</verify>
<done>
- [ ] axe-core installed
- [ ] MessageList ARIA tested
- [ ] MessageInput ARIA tested
- [ ] Sidebar ARIA tested
- [ ] Dialog ARIA tested
- [ ] All tests pass with no violations
</done>
</task>

### Task 2: Keyboard Navigation Tests

<task id="2">
<title>Keyboard navigation tests</title>
<files>
- src/components/__tests__/a11y/keyboard-navigation.test.tsx
</files>
<action>
Test keyboard-only navigation through the application:

```typescript
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { describe, it, expect } from 'vitest';

describe('Keyboard Navigation', () => {
  describe('Tab order', () => {
    it('sidebar tabs in logical order', async () => {
      const user = userEvent.setup();
      render(<Sidebar workspace={mockWorkspace} />);

      // Start from beginning
      await user.tab();
      expect(screen.getByRole('link', { name: /home/i })).toHaveFocus();

      await user.tab();
      expect(screen.getByRole('link', { name: /threads/i })).toHaveFocus();

      await user.tab();
      expect(screen.getByRole('link', { name: /search/i })).toHaveFocus();
    });

    it('message list items are focusable', async () => {
      const user = userEvent.setup();
      render(<MessageList messages={mockMessages} />);

      // Tab to first message
      await user.tab();
      expect(screen.getAllByRole('article')[0]).toHaveFocus();

      // Tab to next message
      await user.tab();
      expect(screen.getAllByRole('article')[1]).toHaveFocus();
    });
  });

  describe('Arrow key navigation', () => {
    it('up/down arrows navigate channel list', async () => {
      const user = userEvent.setup();
      render(<ChannelList channels={mockChannels} />);

      const list = screen.getByRole('list');
      list.focus();

      await user.keyboard('{ArrowDown}');
      expect(screen.getByText('general').closest('li')).toHaveAttribute('aria-selected', 'true');

      await user.keyboard('{ArrowDown}');
      expect(screen.getByText('random').closest('li')).toHaveAttribute('aria-selected', 'true');
    });

    it('Enter activates selected channel', async () => {
      const user = userEvent.setup();
      const onSelect = vi.fn();
      render(<ChannelList channels={mockChannels} onSelect={onSelect} />);

      const list = screen.getByRole('list');
      list.focus();

      await user.keyboard('{ArrowDown}{Enter}');
      expect(onSelect).toHaveBeenCalledWith(mockChannels[0]);
    });
  });

  describe('Escape key behavior', () => {
    it('Escape closes modal', async () => {
      const user = userEvent.setup();
      const onClose = vi.fn();
      render(<CreateChannelDialog open={true} onClose={onClose} />);

      await user.keyboard('{Escape}');
      expect(onClose).toHaveBeenCalled();
    });

    it('Escape closes emoji picker', async () => {
      const user = userEvent.setup();
      render(<EmojiPicker open={true} onSelect={vi.fn()} />);

      await user.keyboard('{Escape}');
      expect(screen.queryByRole('dialog')).not.toBeInTheDocument();
    });
  });

  describe('Shortcuts', () => {
    it('Cmd+K opens search', async () => {
      const user = userEvent.setup();
      render(<App />);

      await user.keyboard('{Meta>}k{/Meta}');
      expect(screen.getByRole('dialog', { name: /search/i })).toBeInTheDocument();
    });

    it('Cmd+/ opens keyboard shortcuts help', async () => {
      const user = userEvent.setup();
      render(<App />);

      await user.keyboard('{Meta>}/{/Meta}');
      expect(screen.getByRole('dialog', { name: /keyboard shortcuts/i })).toBeInTheDocument();
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/components/__tests__/a11y/keyboard-navigation.test.tsx
```
</verify>
<done>
- [ ] Tab order tested
- [ ] Arrow key navigation tested
- [ ] Escape key behavior tested
- [ ] Keyboard shortcuts tested
- [ ] All tests pass
</done>
</task>

### Task 3: Focus Management Tests

<task id="3">
<title>Focus management tests</title>
<files>
- src/components/__tests__/a11y/focus-management.test.tsx
</files>
<action>
Test proper focus management for dialogs, routing, and dynamic content:

```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { describe, it, expect } from 'vitest';

describe('Focus Management', () => {
  describe('Modal focus trap', () => {
    it('focus moves to modal when opened', async () => {
      const user = userEvent.setup();
      render(<ModalTrigger />);

      await user.click(screen.getByRole('button', { name: /open modal/i }));

      await waitFor(() => {
        const dialog = screen.getByRole('dialog');
        expect(dialog).toContainFocus();
      });
    });

    it('focus returns to trigger when modal closes', async () => {
      const user = userEvent.setup();
      render(<ModalTrigger />);

      const trigger = screen.getByRole('button', { name: /open modal/i });
      await user.click(trigger);

      await user.keyboard('{Escape}');

      await waitFor(() => {
        expect(trigger).toHaveFocus();
      });
    });

    it('Tab cycles within modal', async () => {
      const user = userEvent.setup();
      render(<CreateChannelDialog open={true} />);

      const dialog = screen.getByRole('dialog');
      const focusableElements = dialog.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );

      // Tab through all elements
      for (let i = 0; i < focusableElements.length; i++) {
        await user.tab();
      }

      // Should cycle back to first element
      await user.tab();
      expect(focusableElements[0]).toHaveFocus();
    });
  });

  describe('Route change focus', () => {
    it('focus moves to main content on route change', async () => {
      const user = userEvent.setup();
      render(<App />);

      // Navigate to a channel
      await user.click(screen.getByText('general'));

      await waitFor(() => {
        const main = screen.getByRole('main');
        expect(main).toContainFocus();
      });
    });
  });

  describe('Dynamic content focus', () => {
    it('focus moves to new message input when channel loads', async () => {
      render(<ChannelView channelId="123" />);

      await waitFor(() => {
        expect(screen.getByRole('textbox', { name: /message/i })).toHaveFocus();
      });
    });

    it('loading state announces to screen reader', async () => {
      render(<MessageList isLoading={true} />);

      expect(screen.getByRole('status')).toHaveTextContent(/loading/i);
    });

    it('new messages announced to screen reader', async () => {
      const { rerender } = render(<MessageList messages={[]} />);

      rerender(<MessageList messages={[newMessage]} />);

      await waitFor(() => {
        expect(screen.getByRole('log')).toHaveAttribute('aria-live', 'polite');
      });
    });
  });

  describe('Skip links', () => {
    it('skip to main content link exists', () => {
      render(<App />);

      expect(screen.getByRole('link', { name: /skip to main content/i })).toBeInTheDocument();
    });

    it('skip link moves focus to main', async () => {
      const user = userEvent.setup();
      render(<App />);

      const skipLink = screen.getByRole('link', { name: /skip to main content/i });
      await user.click(skipLink);

      expect(screen.getByRole('main')).toHaveFocus();
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/components/__tests__/a11y/focus-management.test.tsx
```
</verify>
<done>
- [ ] Modal focus trap tested
- [ ] Focus return on close tested
- [ ] Tab cycling in modal tested
- [ ] Route change focus tested
- [ ] Skip link tested
- [ ] All tests pass
</done>
</task>

## Verification

### must_haves

```yaml
truths:
  - "Key components pass axe-core automated checks"
  - "All interactive elements are keyboard accessible"
  - "Modals trap and restore focus correctly"
  - "Skip link allows bypassing navigation"

artifacts:
  - path: src/components/__tests__/a11y/aria-compliance.test.tsx
    validates: ["Components pass axe-core checks"]
  - path: src/components/__tests__/a11y/keyboard-navigation.test.tsx
    validates: ["Interactive elements are keyboard accessible"]
  - path: src/components/__tests__/a11y/focus-management.test.tsx
    validates: ["Modals trap focus", "Skip link exists"]
```

### Verification Commands

```bash
npm run test -- src/components/__tests__/a11y/
```
