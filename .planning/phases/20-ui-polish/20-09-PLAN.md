# Plan 20-09: UI Component Tests

## Frontmatter

```yaml
phase: 20
plan: 09
title: UI Component Tests
objective: Add React component tests with React Testing Library for core UI workflows
wave: 3
depends_on: []
autonomous: true
estimated_tasks: 4
files_modified:
  - package.json (add @testing-library/react, @testing-library/user-event)
  - vitest.config.ts (add jsdom environment)
  - src/components/__tests__/message-list.test.tsx
  - src/components/__tests__/message-input.test.tsx
  - src/components/__tests__/thread-panel.test.tsx
  - src/components/__tests__/mention-autocomplete.test.tsx
```

## Context

React component tests for core UI workflows:
- Message list rendering and interactions
- Message input with send functionality
- Thread panel for replies
- Mention autocomplete behavior

Uses React Testing Library for user-centric testing.

## Tasks

### Task 1: Setup React Testing Library

<task id="1">
<title>Configure React Testing Library with Vitest</title>
<files>
- package.json
- vitest.config.ts
- src/test/setup.ts
</files>
<action>
Set up React Testing Library for component tests:

1. Install dependencies:
```bash
npm install -D @testing-library/react @testing-library/user-event @testing-library/jest-dom jsdom
```

2. Update vitest.config.ts:
```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    globals: true,
    css: true,
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

3. Create src/test/setup.ts:
```typescript
import '@testing-library/jest-dom';
import { vi } from 'vitest';

// Mock next/navigation
vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: vi.fn(),
    replace: vi.fn(),
    back: vi.fn(),
  }),
  usePathname: () => '/test',
  useParams: () => ({}),
}));

// Mock next/image
vi.mock('next/image', () => ({
  default: ({ src, alt, ...props }: any) => <img src={src} alt={alt} {...props} />,
}));

// Mock socket.io-client
vi.mock('socket.io-client', () => ({
  io: vi.fn(() => ({
    on: vi.fn(),
    off: vi.fn(),
    emit: vi.fn(),
    connect: vi.fn(),
    disconnect: vi.fn(),
  })),
}));
```
</action>
<verify>
```bash
npm run test -- --run src/test/setup.ts
```
</verify>
<done>
- [ ] Dependencies installed
- [ ] vitest.config.ts updated
- [ ] Setup file created with mocks
- [ ] Test environment works
</done>
</task>

### Task 2: Message List Component Tests

<task id="2">
<title>MessageList component tests</title>
<files>
- src/components/__tests__/message-list.test.tsx
</files>
<action>
Create tests for MessageList component:

1. **Rendering**
   - Renders list of messages
   - Shows author name and avatar
   - Formats timestamps correctly
   - Displays message content

2. **Interactions**
   - Click on message shows thread option
   - Click on reaction adds/removes reaction
   - Scroll loads more messages

3. **States**
   - Shows loading skeleton
   - Shows empty state
   - Shows pending messages with indicator

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { describe, it, expect, vi } from 'vitest';
import { MessageList } from '../message-list';

const mockMessages = [
  {
    id: '1',
    content: 'Hello world',
    author: { id: 'u1', name: 'Alice', image: '/alice.jpg' },
    createdAt: new Date().toISOString(),
    sequence: 1,
  },
  {
    id: '2',
    content: 'Hi Alice!',
    author: { id: 'u2', name: 'Bob', image: '/bob.jpg' },
    createdAt: new Date().toISOString(),
    sequence: 2,
  },
];

describe('MessageList', () => {
  describe('Rendering', () => {
    it('renders list of messages', () => {
      render(<MessageList messages={mockMessages} />);

      expect(screen.getByText('Hello world')).toBeInTheDocument();
      expect(screen.getByText('Hi Alice!')).toBeInTheDocument();
    });

    it('shows author names', () => {
      render(<MessageList messages={mockMessages} />);

      expect(screen.getByText('Alice')).toBeInTheDocument();
      expect(screen.getByText('Bob')).toBeInTheDocument();
    });

    it('shows loading skeleton when loading', () => {
      render(<MessageList messages={[]} isLoading={true} />);

      expect(screen.getByTestId('message-skeleton')).toBeInTheDocument();
    });

    it('shows empty state when no messages', () => {
      render(<MessageList messages={[]} isLoading={false} />);

      expect(screen.getByText(/no messages/i)).toBeInTheDocument();
    });
  });

  describe('Interactions', () => {
    it('shows thread option on message hover', async () => {
      const user = userEvent.setup();
      render(<MessageList messages={mockMessages} />);

      const message = screen.getByText('Hello world').closest('[data-message]');
      await user.hover(message!);

      expect(screen.getByRole('button', { name: /reply/i })).toBeInTheDocument();
    });

    it('calls onReaction when reaction clicked', async () => {
      const onReaction = vi.fn();
      const user = userEvent.setup();
      render(<MessageList messages={mockMessages} onReaction={onReaction} />);

      const message = screen.getByText('Hello world').closest('[data-message]');
      await user.hover(message!);

      const reactionButton = screen.getByRole('button', { name: /add reaction/i });
      await user.click(reactionButton);

      // Select emoji from picker
      const emoji = screen.getByText('ğŸ‘');
      await user.click(emoji);

      expect(onReaction).toHaveBeenCalledWith('1', 'ğŸ‘');
    });
  });

  describe('Pending messages', () => {
    it('shows pending indicator for optimistic messages', () => {
      const pendingMessages = [
        { ...mockMessages[0], _isPending: true },
      ];

      render(<MessageList messages={pendingMessages} />);

      expect(screen.getByText(/sending/i)).toBeInTheDocument();
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/components/__tests__/message-list.test.tsx
```
</verify>
<done>
- [ ] Message rendering tested
- [ ] Author display tested
- [ ] Loading state tested
- [ ] Empty state tested
- [ ] Hover interactions tested
- [ ] Pending indicator tested
- [ ] All tests pass
</done>
</task>

### Task 3: Message Input Component Tests

<task id="3">
<title>MessageInput component tests</title>
<files>
- src/components/__tests__/message-input.test.tsx
</files>
<action>
Create tests for MessageInput component:

1. **Input behavior**
   - Types text into input
   - Clears input after send
   - Shows character count
   - Disables send for empty input

2. **Send functionality**
   - Calls onSend with message content
   - Supports Enter to send
   - Supports Shift+Enter for newline

3. **Validation**
   - Shows warning at character limit
   - Prevents send over limit

```typescript
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { describe, it, expect, vi } from 'vitest';
import { MessageInput } from '../message-input';

describe('MessageInput', () => {
  describe('Input behavior', () => {
    it('types text into input', async () => {
      const user = userEvent.setup();
      render(<MessageInput onSend={vi.fn()} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'Hello world');

      expect(input).toHaveValue('Hello world');
    });

    it('clears input after send', async () => {
      const user = userEvent.setup();
      const onSend = vi.fn();
      render(<MessageInput onSend={onSend} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'Hello');
      await user.click(screen.getByRole('button', { name: /send/i }));

      expect(input).toHaveValue('');
    });

    it('shows character count', async () => {
      const user = userEvent.setup();
      render(<MessageInput onSend={vi.fn()} maxLength={100} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'Hello');

      expect(screen.getByText('5/100')).toBeInTheDocument();
    });

    it('disables send button for empty input', () => {
      render(<MessageInput onSend={vi.fn()} />);

      const sendButton = screen.getByRole('button', { name: /send/i });
      expect(sendButton).toBeDisabled();
    });
  });

  describe('Send functionality', () => {
    it('calls onSend with message content', async () => {
      const user = userEvent.setup();
      const onSend = vi.fn();
      render(<MessageInput onSend={onSend} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'Hello world');
      await user.click(screen.getByRole('button', { name: /send/i }));

      expect(onSend).toHaveBeenCalledWith('Hello world');
    });

    it('sends on Enter key', async () => {
      const user = userEvent.setup();
      const onSend = vi.fn();
      render(<MessageInput onSend={onSend} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'Hello{Enter}');

      expect(onSend).toHaveBeenCalledWith('Hello');
    });

    it('adds newline on Shift+Enter', async () => {
      const user = userEvent.setup();
      const onSend = vi.fn();
      render(<MessageInput onSend={onSend} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'Line 1{Shift>}{Enter}{/Shift}Line 2');

      expect(input).toHaveValue('Line 1\nLine 2');
      expect(onSend).not.toHaveBeenCalled();
    });
  });

  describe('Validation', () => {
    it('shows warning near character limit', async () => {
      const user = userEvent.setup();
      render(<MessageInput onSend={vi.fn()} maxLength={20} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'This is 18 chars!!');

      expect(screen.getByText('18/20')).toHaveClass('text-orange-500');
    });

    it('prevents send over limit', async () => {
      const user = userEvent.setup();
      const onSend = vi.fn();
      render(<MessageInput onSend={onSend} maxLength={10} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'This message is too long');

      const sendButton = screen.getByRole('button', { name: /send/i });
      expect(sendButton).toBeDisabled();
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/components/__tests__/message-input.test.tsx
```
</verify>
<done>
- [ ] Text input tested
- [ ] Clear after send tested
- [ ] Character count tested
- [ ] Empty input disabled tested
- [ ] Enter to send tested
- [ ] Shift+Enter newline tested
- [ ] Character limit warning tested
- [ ] All tests pass
</done>
</task>

### Task 4: Mention Autocomplete Component Tests

<task id="4">
<title>MentionAutocomplete component tests</title>
<files>
- src/components/__tests__/mention-autocomplete.test.tsx
</files>
<action>
Create tests for mention autocomplete:

1. **Trigger behavior**
   - Shows autocomplete on @ character
   - Hides when @ deleted
   - Filters as user types

2. **Selection**
   - Keyboard navigation (up/down arrows)
   - Enter selects highlighted user
   - Click selects user
   - Escape closes autocomplete

3. **Display**
   - Shows user name and avatar
   - Highlights matching text
   - Shows "No results" for no matches

```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { describe, it, expect, vi } from 'vitest';
import { MentionAutocomplete } from '../mention-autocomplete';

const mockUsers = [
  { id: 'u1', name: 'Alice Anderson', image: '/alice.jpg' },
  { id: 'u2', name: 'Bob Brown', image: '/bob.jpg' },
  { id: 'u3', name: 'Charlie Chen', image: '/charlie.jpg' },
];

describe('MentionAutocomplete', () => {
  describe('Trigger behavior', () => {
    it('shows autocomplete on @ character', async () => {
      const user = userEvent.setup();
      render(<MentionAutocomplete users={mockUsers} onSelect={vi.fn()} />);

      const input = screen.getByRole('textbox');
      await user.type(input, 'Hello @');

      await waitFor(() => {
        expect(screen.getByRole('listbox')).toBeInTheDocument();
      });
    });

    it('hides when @ deleted', async () => {
      const user = userEvent.setup();
      render(<MentionAutocomplete users={mockUsers} onSelect={vi.fn()} />);

      const input = screen.getByRole('textbox');
      await user.type(input, '@');
      await waitFor(() => expect(screen.getByRole('listbox')).toBeInTheDocument());

      await user.type(input, '{Backspace}');
      await waitFor(() => expect(screen.queryByRole('listbox')).not.toBeInTheDocument());
    });

    it('filters users as typing', async () => {
      const user = userEvent.setup();
      render(<MentionAutocomplete users={mockUsers} onSelect={vi.fn()} />);

      const input = screen.getByRole('textbox');
      await user.type(input, '@ali');

      await waitFor(() => {
        expect(screen.getByText('Alice Anderson')).toBeInTheDocument();
        expect(screen.queryByText('Bob Brown')).not.toBeInTheDocument();
      });
    });
  });

  describe('Selection', () => {
    it('navigates with arrow keys', async () => {
      const user = userEvent.setup();
      render(<MentionAutocomplete users={mockUsers} onSelect={vi.fn()} />);

      const input = screen.getByRole('textbox');
      await user.type(input, '@');
      await waitFor(() => expect(screen.getByRole('listbox')).toBeInTheDocument());

      await user.keyboard('{ArrowDown}');
      expect(screen.getByText('Bob Brown').closest('li')).toHaveAttribute('aria-selected', 'true');
    });

    it('selects on Enter', async () => {
      const user = userEvent.setup();
      const onSelect = vi.fn();
      render(<MentionAutocomplete users={mockUsers} onSelect={onSelect} />);

      const input = screen.getByRole('textbox');
      await user.type(input, '@ali{Enter}');

      expect(onSelect).toHaveBeenCalledWith(mockUsers[0]);
    });

    it('selects on click', async () => {
      const user = userEvent.setup();
      const onSelect = vi.fn();
      render(<MentionAutocomplete users={mockUsers} onSelect={onSelect} />);

      const input = screen.getByRole('textbox');
      await user.type(input, '@');
      await waitFor(() => expect(screen.getByRole('listbox')).toBeInTheDocument());

      await user.click(screen.getByText('Bob Brown'));
      expect(onSelect).toHaveBeenCalledWith(mockUsers[1]);
    });

    it('closes on Escape', async () => {
      const user = userEvent.setup();
      render(<MentionAutocomplete users={mockUsers} onSelect={vi.fn()} />);

      const input = screen.getByRole('textbox');
      await user.type(input, '@');
      await waitFor(() => expect(screen.getByRole('listbox')).toBeInTheDocument());

      await user.keyboard('{Escape}');
      expect(screen.queryByRole('listbox')).not.toBeInTheDocument();
    });
  });

  describe('Display', () => {
    it('shows no results message', async () => {
      const user = userEvent.setup();
      render(<MentionAutocomplete users={mockUsers} onSelect={vi.fn()} />);

      const input = screen.getByRole('textbox');
      await user.type(input, '@xyz');

      await waitFor(() => {
        expect(screen.getByText(/no users found/i)).toBeInTheDocument();
      });
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/components/__tests__/mention-autocomplete.test.tsx
```
</verify>
<done>
- [ ] @ trigger tested
- [ ] Filter behavior tested
- [ ] Keyboard navigation tested
- [ ] Enter selection tested
- [ ] Click selection tested
- [ ] Escape close tested
- [ ] No results display tested
- [ ] All tests pass
</done>
</task>

## Verification

### must_haves

```yaml
truths:
  - "MessageList renders messages with author info"
  - "MessageInput clears after send"
  - "Enter sends message, Shift+Enter adds newline"
  - "@ triggers mention autocomplete"
  - "Arrow keys navigate autocomplete options"

artifacts:
  - path: src/components/__tests__/message-list.test.tsx
    validates: ["MessageList renders messages with author info"]
  - path: src/components/__tests__/message-input.test.tsx
    validates: ["MessageInput clears after send", "Enter sends, Shift+Enter newline"]
  - path: src/components/__tests__/mention-autocomplete.test.tsx
    validates: ["@ triggers autocomplete", "Arrow keys navigate"]
```

### Verification Commands

```bash
npm run test -- src/components/__tests__/
```
