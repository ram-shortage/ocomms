# Plan 20-06: Extended API Route Tests

## Frontmatter

```yaml
phase: 20
plan: 06
title: Extended API Route Tests
objective: Test remaining API routes - auth flows, channels endpoints, upload
wave: 2
depends_on: ["20-04"]
autonomous: true
estimated_tasks: 4
files_modified:
  - src/app/api/auth/__tests__/password-reset.test.ts
  - src/app/api/auth/__tests__/lockout.test.ts
  - src/app/api/channels/__tests__/pins.test.ts
  - src/app/api/channels/__tests__/notifications.test.ts
  - src/app/api/upload/__tests__/avatar.test.ts
  - tests/functional/auth-flows.test.ts
```

## Context

Extends 20-04 to cover remaining API routes:
- Auth flow endpoints (password reset, email verification, lockout)
- Channels endpoints (pins, notification settings)
- Upload/avatar route (full e2e, not just signature helper)

## Tasks

### Task 1: Auth Flow Tests

<task id="1">
<title>Authentication flow API tests</title>
<files>
- src/app/api/auth/__tests__/password-reset.test.ts
- src/app/api/auth/__tests__/lockout.test.ts
- tests/functional/auth-flows.test.ts
</files>
<action>
Create tests for authentication flows:

**password-reset.test.ts (unit):**
1. Request password reset - sends email for valid user
2. Request password reset - no error for invalid email (prevents enumeration)
3. Reset password with valid token - succeeds
4. Reset password with expired token - fails
5. Reset password with invalid token - fails

**lockout.test.ts (unit):**
1. Account locks after 5 failed attempts
2. Lockout duration increases progressively
3. Successful login resets failure count
4. Admin can unlock account

**auth-flows.test.ts (functional):**
1. Full signup → signin → signout flow
2. Password change flow
3. Session validation and refresh
4. Rate limiting on auth endpoints (10 requests/minute)

```typescript
// src/app/api/auth/__tests__/password-reset.test.ts
import { describe, it, expect, vi } from "vitest";

vi.mock("@/lib/email", () => ({
  sendPasswordResetEmail: vi.fn(),
}));

describe("Password Reset Flow", () => {
  describe("POST /api/auth/forgot-password", () => {
    it("sends reset email for valid user", async () => {
      // Setup: user exists
      // Action: POST with email
      // Assert: sendPasswordResetEmail called
    });

    it("returns success for non-existent email (no enumeration)", async () => {
      // Setup: email not in database
      // Action: POST with email
      // Assert: 200 OK (same as valid email)
    });
  });

  describe("POST /api/auth/reset-password", () => {
    it("resets password with valid token", async () => {
      // Setup: valid reset token
      // Action: POST with token and new password
      // Assert: password updated, can login with new password
    });

    it("rejects expired token", async () => {
      // Setup: token created 25 hours ago
      // Action: POST
      // Assert: 400 "Token expired"
    });
  });
});

// src/app/api/auth/__tests__/lockout.test.ts
describe("Account Lockout", () => {
  it("locks account after 5 failed attempts", async () => {
    // Action: 5 failed login attempts
    // Assert: 6th attempt returns "Account locked"
  });

  it("progressive lockout duration", async () => {
    // First lockout: 1 minute
    // Second lockout: 5 minutes
    // Third lockout: 15 minutes
  });

  it("successful login resets failure count", async () => {
    // Setup: 4 failed attempts
    // Action: successful login
    // Assert: failure count reset to 0
  });
});
```
</action>
<verify>
```bash
npm run test -- src/app/api/auth/__tests__/
npm run test:functional -- --grep "Auth"
```
</verify>
<done>
- [ ] Password reset request tested
- [ ] Password reset with token tested
- [ ] Token expiration tested
- [ ] Account lockout tested
- [ ] Progressive lockout tested
- [ ] Admin unlock tested
- [ ] Rate limiting tested
- [ ] All tests pass
</done>
</task>

### Task 2: Channel Pins API Tests

<task id="2">
<title>Channel pins API tests</title>
<files>
- src/app/api/channels/__tests__/pins.test.ts
</files>
<action>
Create tests for pins API:

1. **GET /api/channels/[channelId]/pins**
   - Returns pinned messages for channel
   - Auth: requires channel membership
   - Cross-tenant: cannot fetch other org's pins

2. **POST /api/channels/[channelId]/pins**
   - Pins message to channel
   - Auth: requires channel membership
   - Validation: message must belong to channel
   - Limit: cannot exceed max pins per channel

3. **DELETE /api/channels/[channelId]/pins/[messageId]**
   - Unpins message
   - Auth: requires channel membership

```typescript
describe("Channel Pins API", () => {
  describe("GET /api/channels/[channelId]/pins", () => {
    it("returns pinned messages for member", async () => {
      // Setup: channel with 3 pinned messages
      // Action: GET as member
      // Assert: returns 3 pins with message content
    });

    it("rejects non-member", async () => {
      // Setup: user not in channel
      // Action: GET
      // Assert: 403 Forbidden
    });

    it("rejects cross-tenant access", async () => {
      // Setup: channel in orgA, user in orgB
      // Action: GET
      // Assert: 403 or 404
    });
  });

  describe("POST /api/channels/[channelId]/pins", () => {
    it("pins message to channel", async () => {
      // Setup: message in channel, user is member
      // Action: POST with messageId
      // Assert: message pinned, returns pin
    });

    it("rejects message from different channel", async () => {
      // Setup: message in channelA, try to pin to channelB
      // Action: POST
      // Assert: 400 "Message not in channel"
    });
  });

  describe("DELETE /api/channels/[channelId]/pins/[messageId]", () => {
    it("unpins message", async () => {
      // Setup: pinned message
      // Action: DELETE
      // Assert: message unpinned
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/app/api/channels/__tests__/pins.test.ts
```
</verify>
<done>
- [ ] GET pins tested
- [ ] GET pins auth tested
- [ ] GET pins cross-tenant tested
- [ ] POST pin tested
- [ ] POST pin validation tested
- [ ] DELETE unpin tested
- [ ] All tests pass
</done>
</task>

### Task 3: Channel Notification Settings API Tests

<task id="3">
<title>Channel notification settings API tests</title>
<files>
- src/app/api/channels/__tests__/notifications.test.ts
</files>
<action>
Create tests for channel notification settings:

1. **GET /api/channels/[channelId]/notifications**
   - Returns user's notification settings for channel
   - Default: "all" if no settings exist
   - Auth: requires channel membership

2. **PUT /api/channels/[channelId]/notifications**
   - Updates notification preference (all/mentions/none)
   - Validation: only valid values accepted
   - Idempotent: same value returns success

```typescript
describe("Channel Notification Settings API", () => {
  describe("GET /api/channels/[channelId]/notifications", () => {
    it("returns notification settings for member", async () => {
      // Setup: user has setting = "mentions" for channel
      // Action: GET
      // Assert: { preference: "mentions" }
    });

    it("returns default 'all' when no setting exists", async () => {
      // Setup: no explicit setting
      // Action: GET
      // Assert: { preference: "all" }
    });

    it("rejects non-member", async () => {
      // Action: GET as non-member
      // Assert: 403
    });
  });

  describe("PUT /api/channels/[channelId]/notifications", () => {
    it("updates preference to mentions", async () => {
      // Action: PUT { preference: "mentions" }
      // Assert: 200, setting updated
    });

    it("updates preference to none", async () => {
      // Action: PUT { preference: "none" }
      // Assert: 200, no notifications for this channel
    });

    it("rejects invalid preference value", async () => {
      // Action: PUT { preference: "invalid" }
      // Assert: 400 "Invalid preference"
    });

    it("is idempotent", async () => {
      // Setup: preference = "mentions"
      // Action: PUT { preference: "mentions" }
      // Assert: 200 OK (no error)
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/app/api/channels/__tests__/notifications.test.ts
```
</verify>
<done>
- [ ] GET notification settings tested
- [ ] GET default value tested
- [ ] GET auth tested
- [ ] PUT update tested
- [ ] PUT validation tested
- [ ] PUT idempotency tested
- [ ] All tests pass
</done>
</task>

### Task 4: Avatar Upload API Tests

<task id="4">
<title>Avatar upload API e2e tests</title>
<files>
- src/app/api/upload/__tests__/avatar.test.ts
</files>
<action>
Create end-to-end tests for avatar upload:

1. **POST /api/upload/avatar**
   - Success: uploads valid image, updates user profile
   - Auth: requires authentication
   - Validation: rejects non-image files
   - Validation: rejects files > size limit
   - Validation: file signature matches extension
   - Storage: file saved to correct path
   - Database: user.image updated

```typescript
describe("Avatar Upload API", () => {
  describe("POST /api/upload/avatar", () => {
    it("uploads valid image and updates profile", async () => {
      // Setup: authenticated user, valid PNG file
      // Action: POST multipart form with file
      // Assert: 200, file exists, user.image updated
    });

    it("requires authentication", async () => {
      // Setup: no session
      // Action: POST
      // Assert: 401 Unauthorized
    });

    it("rejects non-image files", async () => {
      // Setup: text file with .txt extension
      // Action: POST
      // Assert: 400 "Invalid file type"
    });

    it("rejects files exceeding size limit", async () => {
      // Setup: 10MB image (limit is 5MB)
      // Action: POST
      // Assert: 400 "File too large"
    });

    it("validates file signature matches extension", async () => {
      // Setup: text file renamed to .png
      // Action: POST
      // Assert: 400 "Invalid file signature"
    });

    it("saves file to correct storage path", async () => {
      // Setup: valid image
      // Action: POST
      // Assert: file exists at /uploads/avatars/{userId}.{ext}
    });

    it("deletes old avatar when uploading new one", async () => {
      // Setup: user has existing avatar
      // Action: POST new avatar
      // Assert: old file deleted, new file exists
    });
  });
});
```
</action>
<verify>
```bash
npm run test -- src/app/api/upload/__tests__/avatar.test.ts
```
</verify>
<done>
- [ ] Upload success tested
- [ ] Auth required tested
- [ ] File type validation tested
- [ ] File size validation tested
- [ ] File signature validation tested
- [ ] Storage path tested
- [ ] Old avatar cleanup tested
- [ ] All tests pass
</done>
</task>

## Verification

### must_haves

```yaml
truths:
  - "Password reset does not reveal email existence"
  - "Account locks after 5 failed attempts"
  - "Pins API respects channel membership"
  - "Notification settings accept only valid values"
  - "Avatar upload validates file signatures"

artifacts:
  - path: src/app/api/auth/__tests__/password-reset.test.ts
    validates: ["Password reset does not reveal email existence"]
  - path: src/app/api/auth/__tests__/lockout.test.ts
    validates: ["Account locks after 5 failed attempts"]
  - path: src/app/api/channels/__tests__/pins.test.ts
    validates: ["Pins API respects channel membership"]
  - path: src/app/api/channels/__tests__/notifications.test.ts
    validates: ["Notification settings accept only valid values"]
  - path: src/app/api/upload/__tests__/avatar.test.ts
    validates: ["Avatar upload validates file signatures"]
```

### Verification Commands

```bash
npm run test -- src/app/api/auth/__tests__/
npm run test -- src/app/api/channels/__tests__/
npm run test -- src/app/api/upload/__tests__/
```
