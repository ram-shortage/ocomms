# Plan 20-04: Test Coverage (Priority)

## Frontmatter

```yaml
phase: 20
plan: 04
title: Test Coverage (Priority)
objective: Add tests for critical gaps - socket handlers, admin APIs, push APIs, mentions, security
wave: 2
depends_on: []
autonomous: true
estimated_tasks: 6
files_modified:
  - src/server/socket/__tests__/message-handlers.test.ts
  - src/server/socket/__tests__/thread-handlers.test.ts
  - src/app/api/admin/__tests__/audit-logs.test.ts
  - src/app/api/admin/__tests__/export.test.ts
  - src/app/api/push/__tests__/subscribe.test.ts
  - src/lib/__tests__/mentions.test.ts
  - tests/security/cross-tenant.test.ts
  - tests/security/rate-limits.test.ts
```

## Context

**Priority areas from TEST_COVERAGE.MD:**
1. Auth/authz tests for key API + socket routes (cross-tenant isolation)
2. Message + thread handlers: limits, sequencing, and concurrency
3. Admin export/audit logs: streaming/pagination + authorization
4. Push subscribe/unsubscribe
5. Mention parsing

## Tasks

### Task 1: Socket Message Handler Tests

<task id="1">
<title>Socket message handler unit tests</title>
<files>
- src/server/socket/__tests__/message-handlers.test.ts
</files>
<action>
Create unit tests covering:
- message:send success, auth rejection, rate limit (10/60s), size limit (10k chars)
- message:delete auth (author only)
- Atomic sequence generation

Follow existing authz.test.ts pattern with vi.mock for database.
</action>
<verify>
```bash
npm run test -- src/server/socket/__tests__/message-handlers.test.ts
```
</verify>
<done>
- [ ] message:send tests pass
- [ ] message:delete tests pass
- [ ] Rate limit tested
- [ ] Size limit tested
</done>
</task>

### Task 2: Socket Thread Handler Tests

<task id="2">
<title>Socket thread handler unit tests</title>
<files>
- src/server/socket/__tests__/thread-handlers.test.ts
</files>
<action>
Create unit tests covering:
- thread:reply success, auth rejection
- No nested replies (cannot reply to a reply)
- Parent replyCount increment
- thread:fetch with pagination
</action>
<verify>
```bash
npm run test -- src/server/socket/__tests__/thread-handlers.test.ts
```
</verify>
<done>
- [ ] thread:reply tests pass
- [ ] Nested prevention tested
- [ ] replyCount tested
- [ ] thread:fetch tested
</done>
</task>

### Task 3: Admin API Tests

<task id="3">
<title>Admin API route tests</title>
<files>
- src/app/api/admin/__tests__/audit-logs.test.ts
- src/app/api/admin/__tests__/export.test.ts
</files>
<action>
Create unit tests covering:
- audit-logs: auth (admin/owner only), date filtering, event type filtering, pagination, cross-tenant block
- export: auth (owner only), returns JSON, cross-tenant block
</action>
<verify>
```bash
npm run test -- src/app/api/admin/__tests__/
```
</verify>
<done>
- [ ] audit-logs auth tested
- [ ] audit-logs filtering tested
- [ ] export auth tested
- [ ] Cross-tenant tested
</done>
</task>

### Task 4: Push API Tests

<task id="4">
<title>Push notification API tests</title>
<files>
- src/app/api/push/__tests__/subscribe.test.ts
</files>
<action>
Create unit tests covering:
- subscribe: auth required, creates subscription, idempotent (same endpoint updates)
- unsubscribe: auth required, idempotent
- vapid-public: no auth, returns key, 503 if unconfigured
</action>
<verify>
```bash
npm run test -- src/app/api/push/__tests__/
```
</verify>
<done>
- [ ] subscribe tested
- [ ] unsubscribe tested
- [ ] vapid-public tested
- [ ] Idempotency tested
</done>
</task>

### Task 5: Mention Parsing Tests

<task id="5">
<title>Mention parsing tests</title>
<files>
- src/lib/__tests__/mentions.test.ts
</files>
<action>
Create unit tests covering:
- parseMentions: extracts @username, handles multiple, ignores emails, trailing punctuation
- formatMentions: replaces with display names
- resolveMentions: org-scoped resolution
</action>
<verify>
```bash
npm run test -- src/lib/__tests__/mentions.test.ts
```
</verify>
<done>
- [ ] parseMentions tested
- [ ] formatMentions tested
- [ ] Org scoping tested
</done>
</task>

### Task 6: Cross-Tenant Security Tests

<task id="6">
<title>Cross-tenant security tests</title>
<files>
- tests/security/cross-tenant.test.ts
- tests/security/rate-limits.test.ts
</files>
<action>
Create functional tests (against running instance) covering:
- API: cannot fetch channels/export/audit-logs from other org
- Socket: cannot join/send to other org's channels
- Search: only returns own org data
- Rate limits: per-user enforcement
</action>
<verify>
```bash
npm run test:functional -- --grep "Cross-Tenant"
```
</verify>
<done>
- [ ] API cross-tenant tested
- [ ] Socket cross-tenant tested
- [ ] Search scoping tested
- [ ] Rate limits tested
</done>
</task>

## Verification

### must_haves

```yaml
truths:
  - "Message handlers enforce rate limit and size limit"
  - "Thread replies cannot be nested"
  - "Admin APIs require admin/owner role"
  - "Push subscribe is idempotent"
  - "Mention parsing ignores emails"
  - "Cross-tenant access is blocked"

artifacts:
  - path: src/server/socket/__tests__/message-handlers.test.ts
    validates: ["rate limit", "size limit"]
  - path: src/server/socket/__tests__/thread-handlers.test.ts
    validates: ["no nested replies"]
  - path: src/app/api/admin/__tests__/audit-logs.test.ts
    validates: ["admin role required"]
  - path: src/app/api/push/__tests__/subscribe.test.ts
    validates: ["idempotent subscribe"]
  - path: src/lib/__tests__/mentions.test.ts
    validates: ["ignores emails"]
  - path: tests/security/cross-tenant.test.ts
    validates: ["cross-tenant blocked"]
```
