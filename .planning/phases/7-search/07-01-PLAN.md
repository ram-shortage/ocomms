---
phase: 07-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/message.ts
  - src/lib/actions/search.ts
autonomous: true

must_haves:
  truths:
    - "Messages have searchable content indexed for full-text search"
    - "Search query returns messages matching keywords"
    - "Search respects channel membership permissions"
    - "Search respects conversation participation permissions"
    - "Deleted messages are excluded from search results"
  artifacts:
    - path: "src/db/schema/message.ts"
      provides: "tsvector column with GIN index"
      contains: "searchContent"
    - path: "src/lib/actions/search.ts"
      provides: "Search server action"
      exports: ["searchMessages"]
  key_links:
    - from: "src/lib/actions/search.ts"
      to: "src/db/schema/message.ts"
      via: "searchContent tsvector column"
      pattern: "messages\\.searchContent"
    - from: "src/lib/actions/search.ts"
      to: "channelMembers"
      via: "permission filter"
      pattern: "channelMembers"
    - from: "src/lib/actions/search.ts"
      to: "conversationParticipants"
      via: "permission filter"
      pattern: "conversationParticipants"
---

<objective>
Add PostgreSQL full-text search capability to messages with permission-aware querying.

Purpose: Enable members to search across all messages they have access to (channels they're members of, DMs they participate in) using natural language keyword search.

Output:
- Updated message schema with tsvector column and GIN index
- Server action for permission-filtered message search
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/7-search/07-RESEARCH.md
@src/db/schema/message.ts
@src/db/schema/channel.ts
@src/db/schema/conversation.ts
@src/lib/actions/channel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tsvector search column to messages schema</name>
  <files>src/db/schema/message.ts</files>
  <action>
Update the messages schema to add a generated tsvector column for full-text search:

1. Add custom tsvector type (as shown in research):
```typescript
import { customType } from "drizzle-orm/pg-core";
import { SQL, sql } from "drizzle-orm";

export const tsvector = customType<{ data: string }>({
  dataType() {
    return `tsvector`;
  },
});
```

2. Add `searchContent` column to messages table as a generated column:
```typescript
searchContent: tsvector("search_content")
  .generatedAlwaysAs((): SQL => sql`to_tsvector('english', ${messages.content})`),
```

3. Add GIN index for the search column in the table's index array:
```typescript
index("messages_search_idx").using("gin", table.searchContent),
```

IMPORTANT: Use 'english' language config consistently for both indexing and querying. The generated column will auto-populate for existing and new messages.

After schema update, run `npm run db:push` to apply migration.
  </action>
  <verify>
1. Run `npm run db:push` - should complete without errors
2. Query database: `SELECT search_content FROM messages LIMIT 1;` should show tsvector data
3. Check index exists: `\d messages` should show messages_search_idx GIN index
  </verify>
  <done>Message schema has searchContent tsvector column with GIN index, migration applied successfully</done>
</task>

<task type="auto">
  <name>Task 2: Create search server action with permission filtering</name>
  <files>src/lib/actions/search.ts</files>
  <action>
Create a new server action file for message search following established patterns from channel.ts:

1. Create `src/lib/actions/search.ts` with "use server" directive

2. Define SearchResult type:
```typescript
export type SearchResult = {
  id: string;
  content: string;
  channelId: string | null;
  conversationId: string | null;
  authorId: string;
  createdAt: Date;
  rank: number;
  // Include author info for display
  author: {
    id: string;
    name: string;
    image: string | null;
  };
  // Include channel/conversation info for context
  channel?: {
    id: string;
    name: string;
    slug: string;
  } | null;
  conversation?: {
    id: string;
    isGroup: boolean;
  } | null;
};
```

3. Implement `searchMessages()` function:
- Accept params: `organizationId: string`, `query: string`, `limit?: number` (default 50)
- Validate session using `auth.api.getSession({ headers: await headers() })`
- Return empty array if query is empty or whitespace only

4. Get accessible channel IDs:
```typescript
const channelMemberships = await db.query.channelMembers.findMany({
  where: eq(channelMembers.userId, session.user.id),
  with: { channel: true },
});
const accessibleChannelIds = channelMemberships
  .filter(m => m.channel.organizationId === organizationId)
  .map(m => m.channelId);
```

5. Get accessible conversation IDs:
```typescript
const conversationMemberships = await db.query.conversationParticipants.findMany({
  where: eq(conversationParticipants.userId, session.user.id),
  with: { conversation: true },
});
const accessibleConversationIds = conversationMemberships
  .filter(p => p.conversation.organizationId === organizationId)
  .map(p => p.conversationId);
```

6. Build and execute search query with proper conditions:
- Use `websearch_to_tsquery('english', ${query})` for natural language parsing
- Filter by accessible channels OR accessible conversations
- Exclude deleted messages: `isNull(messages.deletedAt)`
- Order by `ts_rank()` descending
- Limit results
- Join with users table for author info
- Join with channels/conversations for context

7. Handle edge case: If user has no accessible channels AND no accessible conversations, return empty array (don't run query that would error with empty IN clause).

Use drizzle-orm imports: `sql, and, or, eq, isNull, inArray, desc`
  </action>
  <verify>
1. `npm run build` completes without TypeScript errors
2. Test in development: Search returns results only from channels user is member of
3. Test: Search does not return messages from channels user is not member of
4. Test: Deleted messages (deletedAt not null) are excluded from results
  </verify>
  <done>searchMessages server action exists, returns permission-filtered results with author and context info</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Schema migration applied: `npm run db:push` successful
2. TypeScript compiles: `npm run build` no errors
3. Permission filtering works: Messages from non-member channels not returned
4. Search relevance: Results ordered by ts_rank
</verification>

<success_criteria>
- Message schema has searchContent tsvector column
- GIN index exists for search performance
- searchMessages action returns typed results
- Results filtered by channel membership
- Results filtered by conversation participation
- Deleted messages excluded
- Results ranked by relevance
</success_criteria>

<output>
After completion, create `.planning/phases/7-search/07-01-SUMMARY.md`
</output>
