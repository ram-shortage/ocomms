---
phase: 06-attention-management
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/channel/channel-list-client.tsx
  - src/components/channel/channel-list.tsx
  - src/components/message/message-item.tsx
  - src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx
  - src/app/(workspace)/[workspaceSlug]/dm/[conversationId]/page.tsx
  - src/lib/hooks/use-unread.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Member sees unread count per channel in sidebar"
    - "Member can mark channel as read by viewing it"
    - "Member can mark message as unread via context menu"
    - "Unread badges update in real-time when new messages arrive"
  artifacts:
    - path: "src/components/channel/channel-list-client.tsx"
      provides: "Client-side channel list with unread badges"
      contains: "unread:update"
    - path: "src/lib/hooks/use-unread.ts"
      provides: "React hooks for unread state management"
      exports: ["useUnreadCounts", "useMarkAsRead"]
    - path: "src/components/message/message-item.tsx"
      provides: "Message item with mark as unread option"
      contains: "markMessageUnread"
  key_links:
    - from: "src/components/channel/channel-list-client.tsx"
      to: "src/lib/socket-events.ts"
      via: "socket.on unread:update"
      pattern: "socket\\.on.*unread:update"
    - from: "src/components/channel/channel-list.tsx"
      to: "src/components/channel/channel-list-client.tsx"
      via: "renders client component"
      pattern: "ChannelListClient"
    - from: "src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx"
      to: "src/lib/hooks/use-unread.ts"
      via: "useMarkAsRead hook"
      pattern: "useMarkAsRead"
---

<objective>
Unread UI components and auto mark-as-read integration

Purpose: Display unread counts in the sidebar, provide "mark as unread" context menu on messages, and automatically mark channels as read when the user views them.

Output: Client channel list with badges, mark-as-unread button on messages, auto mark-as-read on navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/6-attention-management/06-RESEARCH.md
@.planning/phases/6-attention-management/06-01-SUMMARY.md

@src/components/channel/channel-list.tsx
@src/components/message/message-item.tsx
@src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx
@src/app/(workspace)/[workspaceSlug]/dm/[conversationId]/page.tsx
@src/lib/socket-client.ts
@src/lib/socket-events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unread hooks and channel list client component</name>
  <files>src/lib/hooks/use-unread.ts, src/components/channel/channel-list-client.tsx, src/components/channel/channel-list.tsx</files>
  <action>
1. Create `src/lib/hooks/use-unread.ts`:
   - `useUnreadCounts(channelIds: string[], conversationIds?: string[])`:
     - Uses useSocket() to get socket connection
     - On mount, emits `unread:fetch` with channelIds/conversationIds
     - Stores counts in useState: `Record<string, number>`
     - Subscribes to `unread:update` events, updates local state
     - Returns { channelUnreads, conversationUnreads, isLoading }
   - `useMarkAsRead()`:
     - Returns a function `(channelId?: string, conversationId?: string) => void`
     - Emits `unread:markRead` with callback
     - Also accepts optional optimistic update callback
   - `useMarkMessageUnread()`:
     - Returns a function `(messageId: string) => void`
     - Emits `unread:markMessageUnread` with callback

2. Create `src/components/channel/channel-list-client.tsx`:
   - "use client" directive
   - Props: `channels: Array<{ id, name, slug, isPrivate }>`, `workspaceSlug: string`
   - Uses `useUnreadCounts(channels.map(c => c.id))`
   - Renders channel links with unread badges:
     - Badge shows count (99+ if > 99)
     - Channel name bold if has unreads
     - Badge styling: `bg-blue-600 text-white text-xs font-medium px-1.5 py-0.5 rounded-full min-w-[1.25rem] text-center`
   - Follows existing channel-list.tsx layout (Hash/Lock icons, hover states)

3. Update `src/components/channel/channel-list.tsx`:
   - Server component fetches channels (unchanged)
   - Passes channel data to new `ChannelListClient` component
   - ChannelListClient handles the client-side unread logic
  </action>
  <verify>TypeScript compilation succeeds: `npx tsc --noEmit`</verify>
  <done>Channel list shows unread badges that update in real-time</done>
</task>

<task type="auto">
  <name>Task 2: Mark as unread context menu on messages</name>
  <files>src/components/message/message-item.tsx</files>
  <action>
Update MessageItem component to add "Mark as unread" action:

1. Add new prop to MessageItemProps:
   - `onMarkUnread?: (messageId: string) => void`

2. Add "Mark as unread" button to the action buttons area:
   - Use `MessageSquareX` or `EyeOff` icon from lucide-react (whichever looks better - try EyeOff first)
   - Position after reaction picker, before pin button
   - Same styling as other action buttons: opacity-0 group-hover:opacity-100
   - Only show for non-deleted messages
   - Do NOT show for messages the user authored (can't mark own message as unread since you just sent it)
   - onClick calls `onMarkUnread?.(message.id)`

3. Tooltip or sr-only text: "Mark as unread"

The actual socket emission will be handled by the parent component (message-list or channel page) which will pass the onMarkUnread callback.
  </action>
  <verify>TypeScript compilation succeeds: `npx tsc --noEmit`</verify>
  <done>MessageItem has mark-as-unread button visible on hover for other users' messages</done>
</task>

<task type="auto">
  <name>Task 3: Auto mark-as-read on channel/DM navigation</name>
  <files>src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx, src/app/(workspace)/[workspaceSlug]/dm/[conversationId]/page.tsx</files>
  <action>
1. Update channel page `src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx`:
   - Import `useMarkAsRead` from `@/lib/hooks/use-unread`
   - In the client component wrapper (or create one if needed):
     - Call `useMarkAsRead()` to get markAsRead function
     - Use useEffect with channelId dependency:
       - On mount (and when channelId changes), call `markAsRead(channelId)`
       - This marks the channel as read when user views it
   - Also pass `onMarkUnread` callback to MessageList/MessageItem:
     - Use `useMarkMessageUnread()` hook
     - Pass the function down to MessageItem components

2. Update DM page `src/app/(workspace)/[workspaceSlug]/dm/[conversationId]/page.tsx`:
   - Same pattern but with conversationId instead of channelId
   - Call `markAsRead(undefined, conversationId)` for DMs

3. Ensure the pages can properly pass the hooks down:
   - If the page is server component with client children, you may need a wrapper client component
   - The MessageList component should accept optional `onMarkUnread` callback and pass to MessageItem

Note: The channel and DM pages already have client-side message handling. Integrate the mark-as-read into the existing client component structure.
  </action>
  <verify>TypeScript compilation succeeds: `npx tsc --noEmit`</verify>
  <done>Channels/DMs automatically marked as read on navigation, messages can be marked as unread</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Channel list client exists: grep for `ChannelListClient` in channel-list.tsx
3. Unread hooks exist: grep for `useUnreadCounts` in use-unread.ts
4. Mark as unread button: grep for `onMarkUnread` in message-item.tsx
5. Auto mark-as-read: grep for `markAsRead` in channel page and DM page
</verification>

<success_criteria>
- Channel sidebar shows unread count badges
- Badges update in real-time when new messages arrive
- Viewing a channel/DM marks it as read
- Users can mark messages as unread via hover action
- Unread counts persist across page refresh (backed by database)
</success_criteria>

<output>
After completion, create `.planning/phases/6-attention-management/06-02-SUMMARY.md`
</output>
