---
phase: 03-real-time-messaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/server/index.ts
  - src/server/socket/index.ts
  - src/server/socket/adapter.ts
  - src/server/socket/middleware/auth.ts
  - src/server/socket/rooms.ts
  - src/server/redis.ts
  - src/lib/socket-client.ts
  - src/lib/socket-events.ts
  - tsconfig.json
autonomous: true
user_setup:
  - service: valkey
    why: "Real-time pub/sub for WebSocket scaling"
    env_vars:
      - name: REDIS_URL
        source: "Local Valkey: redis://localhost:6379"
    dashboard_config: []

must_haves:
  truths:
    - "WebSocket server starts alongside Next.js"
    - "Authenticated users can connect via WebSocket"
    - "Users join correct rooms based on channel/DM memberships"
    - "Redis adapter enables multi-instance scaling"
  artifacts:
    - path: "src/server/index.ts"
      provides: "Custom server entry point"
      exports: ["httpServer"]
    - path: "src/server/socket/index.ts"
      provides: "Socket.IO initialization and handlers"
      exports: ["setupSocketHandlers"]
    - path: "src/server/socket/middleware/auth.ts"
      provides: "Session validation for WebSocket"
      exports: ["authMiddleware"]
    - path: "src/server/socket/rooms.ts"
      provides: "Room naming and management"
      exports: ["getRoomName", "joinUserRooms"]
    - path: "src/lib/socket-client.ts"
      provides: "Client-side socket instance"
      exports: ["getSocket", "useSocket"]
  key_links:
    - from: "src/server/socket/middleware/auth.ts"
      to: "src/lib/auth.ts"
      via: "auth.api.getSession()"
      pattern: "auth\\.api\\.getSession"
    - from: "src/server/socket/adapter.ts"
      to: "ioredis"
      via: "Redis pub/sub clients"
      pattern: "createAdapter"
---

<objective>
Set up WebSocket infrastructure with Socket.IO custom server, Redis pub/sub adapter, and authentication middleware.

Purpose: Foundation for real-time messaging - WebSocket connections enable instant message delivery and presence updates.
Output: Custom server running Socket.IO alongside Next.js, with Redis scaling and session-based auth.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-messaging/03-RESEARCH.md

@src/lib/auth.ts
@src/db/schema/channel.ts
@src/db/schema/conversation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create custom server</name>
  <files>
    package.json
    src/server/index.ts
    src/server/redis.ts
    src/server/socket/adapter.ts
    tsconfig.json
  </files>
  <action>
    Install real-time dependencies:
    ```bash
    npm install socket.io socket.io-client ioredis @socket.io/redis-adapter
    ```

    Create Redis client setup at src/server/redis.ts:
    - Export function to create Redis client from REDIS_URL env var
    - Default to redis://localhost:6379 if not set
    - Use ioredis library

    Create Redis adapter at src/server/socket/adapter.ts:
    - Export async function createRedisAdapter()
    - Create pubClient and subClient (duplicate)
    - Wait for both connections
    - Return createAdapter(pubClient, subClient) from @socket.io/redis-adapter

    Create custom server at src/server/index.ts:
    - Import next, create http server, create Socket.IO server
    - Configure Socket.IO with CORS from NEXT_PUBLIC_APP_URL
    - Enable connectionStateRecovery (2 min duration)
    - Attach Redis adapter
    - Call setupSocketHandlers(io) - will be created in Task 2
    - Listen on PORT env var (default 3000)

    Update package.json scripts:
    - Change "dev" to "tsx --watch src/server/index.ts"
    - Change "start" to "node dist/server/index.js"
    - Add "build:server" script: "tsc -p tsconfig.server.json"

    Create tsconfig.server.json for server-side TypeScript compilation:
    - Extend base tsconfig.json
    - Set outDir to dist
    - Include only src/server/**/*
    - Module: NodeNext, moduleResolution: NodeNext
  </action>
  <verify>
    npm run build succeeds (Next.js still compiles)
    TypeScript compilation shows no errors for server files
  </verify>
  <done>
    Dependencies installed, custom server entry point created, Redis adapter configured, package.json scripts updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Socket.IO auth, rooms, and client setup</name>
  <files>
    src/server/socket/index.ts
    src/server/socket/middleware/auth.ts
    src/server/socket/rooms.ts
    src/lib/socket-client.ts
    src/lib/socket-events.ts
  </files>
  <action>
    Create auth middleware at src/server/socket/middleware/auth.ts:
    - Export authMiddleware(socket, next) async function
    - Extract cookies from socket.handshake.headers.cookie
    - Call auth.api.getSession({ headers: new Headers({ cookie: cookies }) })
    - If no session, return next(new Error("Invalid session"))
    - Attach session.user.id to socket.data.userId
    - Attach session.user to socket.data.user
    - Call next() on success

    Create room utilities at src/server/socket/rooms.ts:
    - Export getRoomName object with functions:
      - channel(channelId: string) => `channel:${channelId}`
      - conversation(conversationId: string) => `dm:${conversationId}`
      - workspace(workspaceId: string) => `workspace:${workspaceId}`
      - user(userId: string) => `user:${userId}`
    - Export async joinUserRooms(socket: Socket):
      - Join user's personal room
      - Query channelMembers for user's channel memberships, join those rooms
      - Query conversationParticipants for user's DMs, join those rooms
      - Use db from @/db for queries

    Create main socket setup at src/server/socket/index.ts:
    - Export setupSocketHandlers(io: Server)
    - Apply authMiddleware using io.use()
    - On connection: call joinUserRooms(socket)
    - On disconnect: log (presence will handle cleanup in plan 03)
    - Placeholder for message and presence handlers (added in plans 02, 03)

    Create shared event types at src/lib/socket-events.ts:
    - Export ServerToClientEvents interface (message:new, message:deleted, typing:update, presence:update, error)
    - Export ClientToServerEvents interface (message:send, message:delete, typing:start, typing:stop, presence:setAway, presence:setActive, room:join, room:leave)
    - Export SocketData interface (userId, user, workspaceId)

    Create client socket at src/lib/socket-client.ts:
    - "use client" directive
    - Export getSocket() singleton function
    - Configure with withCredentials: true, autoConnect: false
    - Export useSocket() hook that connects on mount, disconnects on unmount
  </action>
  <verify>
    TypeScript compilation succeeds with no errors
    All imports resolve correctly (check with tsc --noEmit)
  </verify>
  <done>
    Auth middleware validates better-auth sessions, rooms organized by channel/DM/workspace, client hook ready for use in components
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify WebSocket server starts</name>
  <files></files>
  <action>
    Start the development server to verify everything works:
    ```bash
    npm run dev
    ```

    The server should:
    - Start without errors
    - Log "Ready on http://localhost:3000" (or similar)
    - Accept WebSocket connections (Socket.IO path /socket.io/)

    If REDIS_URL is not set, verify graceful handling:
    - Server should log warning about Redis not available
    - Fall back to in-memory adapter for local dev (modify adapter.ts to handle connection failure gracefully)

    Add error handling to adapter.ts:
    - Wrap Redis connection in try/catch
    - If connection fails, log warning and return null
    - In index.ts, only attach adapter if createRedisAdapter() returns non-null
  </action>
  <verify>
    npm run dev starts successfully
    Browser can load Next.js pages
    Console shows Socket.IO ready message
  </verify>
  <done>
    WebSocket server running alongside Next.js, ready to accept authenticated connections
  </done>
</task>

</tasks>

<verification>
- Custom server starts with `npm run dev`
- Socket.IO endpoint responds at /socket.io/
- TypeScript compiles without errors
- Redis adapter connects when REDIS_URL is set
- Graceful fallback when Redis unavailable
</verification>

<success_criteria>
- WebSocket infrastructure operational
- Auth middleware validates sessions
- Room management ready for messages/presence
- Client hook available for React components
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-messaging/03-01-SUMMARY.md`
</output>
