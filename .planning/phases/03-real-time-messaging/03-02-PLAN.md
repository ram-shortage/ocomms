---
phase: 03-real-time-messaging
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/db/schema/message.ts
  - src/db/schema/index.ts
  - src/server/socket/handlers/message.ts
  - src/server/socket/index.ts
  - src/components/message/message-list.tsx
  - src/components/message/message-input.tsx
  - src/components/message/message-item.tsx
  - src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx
  - src/app/(workspace)/[workspaceSlug]/dm/[conversationId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can send message to channel and see it instantly"
    - "User can send message in DM and see it instantly"
    - "Messages appear for all connected users in real-time"
    - "User can delete own messages"
    - "Deleted messages show as deleted to all users"
  artifacts:
    - path: "src/db/schema/message.ts"
      provides: "Message table with soft delete"
      contains: "messages"
    - path: "src/server/socket/handlers/message.ts"
      provides: "Message send/delete handlers"
      exports: ["handleMessageEvents"]
    - path: "src/components/message/message-list.tsx"
      provides: "Real-time message rendering"
      exports: ["MessageList"]
    - path: "src/components/message/message-input.tsx"
      provides: "Message composition with send"
      exports: ["MessageInput"]
  key_links:
    - from: "src/components/message/message-input.tsx"
      to: "socket"
      via: "emit message:send"
      pattern: "emit.*message:send"
    - from: "src/server/socket/handlers/message.ts"
      to: "src/db/schema/message.ts"
      via: "db.insert(messages)"
      pattern: "db\\.insert\\(messages\\)"
    - from: "src/components/message/message-list.tsx"
      to: "socket"
      via: "on message:new"
      pattern: "on.*message:new"
---

<objective>
Implement message persistence and real-time delivery for channels and DMs.

Purpose: Core messaging functionality - users can send messages that appear instantly for all participants.
Output: Message schema, socket handlers, and React components for composing and viewing messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-messaging/03-RESEARCH.md
@.planning/phases/03-real-time-messaging/03-01-SUMMARY.md

@src/db/schema/channel.ts
@src/db/schema/conversation.ts
@src/server/socket/index.ts
@src/server/socket/rooms.ts
@src/lib/socket-events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Message schema and database</name>
  <files>
    src/db/schema/message.ts
    src/db/schema/index.ts
  </files>
  <action>
    Create message schema at src/db/schema/message.ts:
    - id: uuid primary key with defaultRandom()
    - content: text, notNull
    - authorId: uuid, notNull, references users.id with onDelete cascade
    - channelId: uuid nullable, references channels.id with onDelete cascade
    - conversationId: uuid nullable, references conversations.id with onDelete cascade
    - sequence: integer, notNull (for ordering within channel/conversation)
    - deletedAt: timestamp nullable (soft delete)
    - createdAt: timestamp with defaultNow()
    - updatedAt: timestamp with defaultNow()

    Add indexes:
    - messages_channel_seq_idx on (channelId, sequence) for channel message fetching
    - messages_conversation_seq_idx on (conversationId, sequence) for DM message fetching
    - messages_author_idx on (authorId) for user's messages

    Add relations:
    - author: one(users)
    - channel: one(channels)
    - conversation: one(conversations)

    Export from src/db/schema/index.ts

    Run db:push to apply schema:
    ```bash
    npm run db:push
    ```
    Note: If database not running, verify schema correctness via TypeScript compilation.
  </action>
  <verify>
    TypeScript compiles without errors
    Schema exports correctly from src/db/schema/index.ts
    npm run db:push succeeds (or TypeScript validates if no DB)
  </verify>
  <done>
    Message table with soft delete, proper indexes for ordered fetching, relations to users/channels/conversations
  </done>
</task>

<task type="auto">
  <name>Task 2: Message socket handlers</name>
  <files>
    src/server/socket/handlers/message.ts
    src/server/socket/index.ts
  </files>
  <action>
    Create message handlers at src/server/socket/handlers/message.ts:

    handleSendMessage(socket, io, data):
    - Validate user is member of target channel/conversation
    - Get next sequence number: SELECT MAX(sequence) + 1 FROM messages WHERE channelId/conversationId = target
    - Handle null case (first message = sequence 1)
    - Insert message with db.insert(messages)
    - Broadcast to room using getRoomName.channel/conversation
    - Emit "message:new" with full message object including author info
    - Return message via callback acknowledgement

    handleDeleteMessage(socket, io, data):
    - Verify ownership: message.authorId === socket.data.userId
    - Soft delete: UPDATE messages SET deletedAt = now() WHERE id = messageId AND authorId = userId AND deletedAt IS NULL
    - If no rows updated, emit error
    - Broadcast "message:deleted" to room with messageId and deletedAt

    Export handleMessageEvents(socket, io) that registers:
    - socket.on("message:send", ...)
    - socket.on("message:delete", ...)

    Update src/server/socket/index.ts:
    - Import handleMessageEvents
    - Call handleMessageEvents(socket, io) in connection handler
  </action>
  <verify>
    TypeScript compiles without errors
    Handler functions properly typed with Socket.IO types
  </verify>
  <done>
    Message send/delete handlers with membership validation, soft delete, and room broadcast
  </done>
</task>

<task type="auto">
  <name>Task 3: Message UI components and page integration</name>
  <files>
    src/components/message/message-item.tsx
    src/components/message/message-list.tsx
    src/components/message/message-input.tsx
    src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx
    src/app/(workspace)/[workspaceSlug]/dm/[conversationId]/page.tsx
  </files>
  <action>
    Create MessageItem at src/components/message/message-item.tsx:
    - Display author name, avatar (if available), timestamp
    - Show message content
    - If deletedAt is set, show "[Message deleted]" in italics
    - Show delete button (trash icon) only for own messages (compare with currentUserId prop)
    - On delete click, call onDelete(messageId) prop

    Create MessageList at src/components/message/message-list.tsx:
    - "use client" directive
    - Props: initialMessages, targetId, targetType ("channel" | "dm"), currentUserId
    - State: messages array initialized from initialMessages
    - useSocket hook to get socket connection
    - useEffect to subscribe to "message:new" and "message:deleted"
    - On "message:new": if matches targetId, append to messages
    - On "message:deleted": update message with deletedAt
    - Render MessageItem for each message
    - Auto-scroll to bottom on new messages using useRef

    Create MessageInput at src/components/message/message-input.tsx:
    - "use client" directive
    - Props: targetId, targetType ("channel" | "dm")
    - State: message text, sending boolean
    - useSocket hook
    - On submit: emit "message:send" with targetId, targetType, content
    - Use callback acknowledgement to handle success/error
    - Clear input on success
    - Disable input while sending

    Update channel page at src/app/(workspace)/[workspaceSlug]/channels/[channelSlug]/page.tsx:
    - Fetch initial messages: SELECT * FROM messages WHERE channelId = channel.id AND deletedAt IS NULL ORDER BY sequence ASC LIMIT 50
    - Pass to MessageList with targetType="channel"
    - Add MessageInput below MessageList
    - Style: flex column, message-list grows, input at bottom

    Update DM page at src/app/(workspace)/[workspaceSlug]/dm/[conversationId]/page.tsx:
    - Fetch initial messages: SELECT * FROM messages WHERE conversationId = conversation.id AND deletedAt IS NULL ORDER BY sequence ASC LIMIT 50
    - Pass to MessageList with targetType="dm"
    - Add MessageInput below MessageList
    - Style: flex column, message-list grows, input at bottom
  </action>
  <verify>
    TypeScript compiles without errors
    Components render without errors (verify via npm run build)
  </verify>
  <done>
    Message components display messages, handle real-time updates, support sending and deleting messages
  </done>
</task>

</tasks>

<verification>
- Message schema created and applied to database
- Messages persist to PostgreSQL on send
- Messages broadcast to all room members in real-time
- Delete soft-deletes and broadcasts deletion
- UI updates instantly on send/receive/delete
</verification>

<success_criteria>
- User sends message in channel -> appears for all channel members
- User sends message in DM -> appears for all DM participants
- User deletes own message -> shows as deleted for everyone
- Messages persist across page refresh
- Sub-second latency for message delivery
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-messaging/03-02-SUMMARY.md`
</output>
