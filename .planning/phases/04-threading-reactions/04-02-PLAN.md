---
phase: 04-threading-reactions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/reaction.ts
  - src/db/schema/index.ts
  - src/lib/socket-events.ts
  - src/server/socket/handlers/reaction.ts
  - src/server/socket/index.ts
  - src/components/ui/popover.tsx
  - src/components/reaction/reaction-picker.tsx
  - src/components/reaction/reaction-display.tsx
  - src/components/reaction/index.ts
  - src/components/message/message-item.tsx
autonomous: true

must_haves:
  truths:
    - "User can add emoji reaction to any message"
    - "User can remove their own emoji reaction"
    - "User can see who reacted with each emoji via tooltip"
    - "Reactions update in real-time for all users"
  artifacts:
    - path: "src/db/schema/reaction.ts"
      provides: "Reactions table with composite uniqueness"
      exports: ["reactions"]
      contains: "uniqueIndex.*messageId.*userId.*emoji"
    - path: "src/server/socket/handlers/reaction.ts"
      provides: "Reaction toggle socket handler"
      exports: ["handleReactionEvents"]
    - path: "src/components/reaction/reaction-picker.tsx"
      provides: "Emoji picker popover using frimousse"
      min_lines: 40
    - path: "src/components/reaction/reaction-display.tsx"
      provides: "Reaction badges with tooltip showing reactors"
      min_lines: 30
  key_links:
    - from: "src/components/message/message-item.tsx"
      to: "reaction-picker.tsx"
      via: "add reaction button opens picker"
      pattern: "ReactionPicker"
    - from: "src/server/socket/handlers/reaction.ts"
      to: "reactions table"
      via: "toggle insert/delete"
      pattern: "reactions.*insert|delete"
---

<objective>
Implement emoji reactions with a lightweight picker, toggle functionality, and real-time updates across all clients.

Purpose: Enable quick emotional responses and feedback on messages without adding to conversation noise.

Output: Reaction picker UI, reaction badges on messages, real-time reaction sync.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-threading-reactions/04-RESEARCH.md

# Existing code to extend
@src/db/schema/index.ts
@src/lib/socket-events.ts
@src/server/socket/handlers/message.ts
@src/server/socket/index.ts
@src/components/message/message-item.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reactions schema</name>
  <files>
    src/db/schema/reaction.ts
    src/db/schema/index.ts
  </files>
  <action>
    Create reactions table:

    1. Create `src/db/schema/reaction.ts`:
       ```typescript
       import { pgTable, text, timestamp, uuid, uniqueIndex, index } from "drizzle-orm/pg-core";
       import { relations } from "drizzle-orm";
       import { users } from "./auth";
       import { messages } from "./message";

       export const reactions = pgTable("reactions", {
         id: uuid("id").primaryKey().defaultRandom(),
         messageId: uuid("message_id")
           .notNull()
           .references(() => messages.id, { onDelete: "cascade" }),
         userId: uuid("user_id")
           .notNull()
           .references(() => users.id, { onDelete: "cascade" }),
         emoji: text("emoji").notNull(), // Unicode emoji: "thumbs_up", "heart", etc.
         createdAt: timestamp("created_at").notNull().defaultNow(),
       }, (table) => [
         uniqueIndex("reactions_unique_idx").on(table.messageId, table.userId, table.emoji),
         index("reactions_message_idx").on(table.messageId),
       ]);

       export const reactionsRelations = relations(reactions, ({ one }) => ({
         message: one(messages, {
           fields: [reactions.messageId],
           references: [messages.id],
         }),
         user: one(users, {
           fields: [reactions.userId],
           references: [users.id],
         }),
       }));
       ```

    2. Export from `src/db/schema/index.ts`

    Key: Using unicode emoji strings directly (not codes) for simplicity.
    The unique constraint prevents duplicate reactions of same emoji from same user.
  </action>
  <verify>
    `npx tsc --noEmit` passes
  </verify>
  <done>
    Reactions table exists with composite unique index on (messageId, userId, emoji)
  </done>
</task>

<task type="auto">
  <name>Task 2: Reaction socket handlers</name>
  <files>
    src/lib/socket-events.ts
    src/server/socket/handlers/reaction.ts
    src/server/socket/index.ts
  </files>
  <action>
    Implement real-time reaction toggle:

    1. Update `src/lib/socket-events.ts`:
       - Add Reaction interface:
         ```typescript
         export interface Reaction {
           emoji: string;
           count: number;
           users: { id: string; name: string | null }[];
           hasReacted: boolean; // current user reacted with this emoji
         }
         ```
       - Add to ServerToClientEvents:
         ```typescript
         "reaction:update": (data: {
           messageId: string;
           emoji: string;
           userId: string;
           userName: string | null;
           action: "added" | "removed";
         }) => void;
         ```
       - Add to ClientToServerEvents:
         ```typescript
         "reaction:toggle": (data: { messageId: string; emoji: string }) => void;
         "reaction:get": (
           data: { messageId: string },
           callback: (response: { success: boolean; reactions?: Reaction[] }) => void
         ) => void;
         ```

    2. Create `src/server/socket/handlers/reaction.ts`:
       - handleReactionToggle:
         - Check if reaction exists for this user+message+emoji
         - If exists: delete it, action = "removed"
         - If not: insert with ON CONFLICT DO NOTHING for race safety, action = "added"
         - Get message to determine room (channel or DM)
         - Broadcast reaction:update to room
         - Also broadcast to thread room if message.parentId exists
       - handleGetReactions:
         - Fetch reactions grouped by emoji with user info
         - Return array of Reaction objects

       Use ON CONFLICT DO NOTHING for insert to handle race conditions where two clients toggle simultaneously.

    3. Register handlers in `src/server/socket/index.ts`

    Avoid: Checking existence then inserting without constraint handling.
    Why: Race conditions can cause duplicate reactions.
  </action>
  <verify>
    `npx tsc --noEmit` passes, handlers registered
  </verify>
  <done>
    Reaction toggle uses database constraints for safety, broadcasts to appropriate rooms
  </done>
</task>

<task type="auto">
  <name>Task 3: Reaction UI components</name>
  <files>
    src/components/ui/popover.tsx
    src/components/reaction/reaction-picker.tsx
    src/components/reaction/reaction-display.tsx
    src/components/reaction/index.ts
    src/components/message/message-item.tsx
  </files>
  <action>
    Build reaction UI:

    1. Install dependencies:
       Run `npm install frimousse`
       Run `npx shadcn@latest add popover tooltip`

    2. Create `src/components/reaction/reaction-picker.tsx`:
       - Use Popover from shadcn wrapping frimousse EmojiPicker
       - Trigger button: SmilePlus icon (from lucide-react), appears on message hover
       - On emoji select: call onSelectEmoji callback, close popover
       - Style picker to match shadcn aesthetic (see research example)
       - Include search functionality

    3. Create `src/components/reaction/reaction-display.tsx`:
       - Accept reactions array (Reaction[]) and onToggle callback
       - Display as horizontal row of reaction badges
       - Each badge: emoji + count, highlighted if current user reacted
       - Wrap each badge in Tooltip showing reactor names ("Alice, Bob, and 3 others")
       - Clicking badge calls onToggle with that emoji (add if not reacted, remove if reacted)

    4. Update `src/components/message/message-item.tsx`:
       - Add props: reactions (Reaction[]), onReaction (emoji: string) => void
       - On mount/update, fetch reactions via reaction:get if not provided
       - Show ReactionPicker button in hover actions
       - Show ReactionDisplay below message content if reactions exist
       - Subscribe to reaction:update for real-time updates

    5. Export components from `src/components/reaction/index.ts`

    Avoid: Building custom emoji grid/search.
    Why: frimousse handles Unicode edge cases, skin tones, search, and accessibility.
  </action>
  <verify>
    `npx tsc --noEmit` passes, frimousse installed, popover/tooltip components available
  </verify>
  <done>
    Emoji picker opens on button click, reactions display below messages with counts and tooltips, clicking toggles reaction
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Reactions table has unique constraint on (messageId, userId, emoji)
3. frimousse package installed: `grep frimousse package.json`
4. Popover and Tooltip components in ui folder
5. ReactionPicker renders emoji grid with search
6. ReactionDisplay shows badges with tooltips
7. MessageItem integrates both reaction components
</verification>

<success_criteria>
- Reactions persisted to database with uniqueness constraint
- Toggle add/remove works via single socket event
- Real-time updates broadcast to all room members
- Emoji picker is lightweight (<5KB from frimousse)
- Reaction badges show count and reactors on hover
- Clicking existing reaction toggles it off
- Requirements covered: REAC-01, REAC-02, REAC-03
</success_criteria>

<output>
After completion, create `.planning/phases/04-threading-reactions/04-02-SUMMARY.md`
</output>
