---
phase: 04-threading-reactions
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/db/schema/pinned-message.ts
  - src/db/schema/index.ts
  - src/app/api/channels/[channelId]/pins/route.ts
  - src/components/channel/pinned-messages-dialog.tsx
  - src/components/channel/channel-header.tsx
  - src/components/message/message-item.tsx
autonomous: true

must_haves:
  truths:
    - "User can pin a message in a channel"
    - "User can unpin a message"
    - "User can view all pinned messages in a channel"
    - "Pinned messages list shows who pinned and when"
  artifacts:
    - path: "src/db/schema/pinned-message.ts"
      provides: "Pinned messages junction table"
      exports: ["pinnedMessages"]
      contains: "pinnedBy"
    - path: "src/app/api/channels/[channelId]/pins/route.ts"
      provides: "Pin/unpin REST API endpoints"
      exports: ["GET", "POST", "DELETE"]
    - path: "src/components/channel/pinned-messages-dialog.tsx"
      provides: "Dialog showing all pinned messages"
      min_lines: 40
  key_links:
    - from: "src/components/message/message-item.tsx"
      to: "pins API"
      via: "pin action in message menu"
      pattern: "fetch.*pins"
    - from: "src/components/channel/channel-header.tsx"
      to: "pinned-messages-dialog.tsx"
      via: "pin icon button opens dialog"
      pattern: "PinnedMessagesDialog"
---

<objective>
Implement message pinning with a dedicated table, REST API for pin operations, and UI for viewing pinned messages.

Purpose: Allow important messages to be bookmarked for easy reference by all channel members.

Output: Pin/unpin functionality, pinned messages dialog accessible from channel header.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-threading-reactions/04-RESEARCH.md

# Prior phase context
@.planning/phases/04-threading-reactions/04-01-SUMMARY.md

# Existing code to extend
@src/db/schema/message.ts
@src/db/schema/index.ts
@src/components/message/message-item.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pinned messages schema and API</name>
  <files>
    src/db/schema/pinned-message.ts
    src/db/schema/index.ts
    src/app/api/channels/[channelId]/pins/route.ts
  </files>
  <action>
    Create pinned messages table and REST endpoints:

    1. Create `src/db/schema/pinned-message.ts`:
       ```typescript
       import { pgTable, timestamp, uuid, uniqueIndex, index } from "drizzle-orm/pg-core";
       import { relations } from "drizzle-orm";
       import { users } from "./auth";
       import { messages } from "./message";
       import { channels } from "./channel";

       export const pinnedMessages = pgTable("pinned_messages", {
         id: uuid("id").primaryKey().defaultRandom(),
         messageId: uuid("message_id")
           .notNull()
           .references(() => messages.id, { onDelete: "cascade" }),
         channelId: uuid("channel_id")
           .notNull()
           .references(() => channels.id, { onDelete: "cascade" }),
         pinnedBy: uuid("pinned_by")
           .notNull()
           .references(() => users.id, { onDelete: "cascade" }),
         pinnedAt: timestamp("pinned_at").notNull().defaultNow(),
       }, (table) => [
         uniqueIndex("pinned_messages_unique_idx").on(table.messageId, table.channelId),
         index("pinned_messages_channel_idx").on(table.channelId),
       ]);

       export const pinnedMessagesRelations = relations(pinnedMessages, ({ one }) => ({
         message: one(messages, {
           fields: [pinnedMessages.messageId],
           references: [messages.id],
         }),
         channel: one(channels, {
           fields: [pinnedMessages.channelId],
           references: [channels.id],
         }),
         pinnedByUser: one(users, {
           fields: [pinnedMessages.pinnedBy],
           references: [users.id],
         }),
       }));
       ```

    2. Export from `src/db/schema/index.ts`

    3. Create `src/app/api/channels/[channelId]/pins/route.ts`:
       - GET: Fetch all pinned messages for channel with message content and pinner info
         - Join pinnedMessages -> messages -> users (author) and users (pinnedBy)
         - Filter out soft-deleted messages (deletedAt IS NULL)
         - Order by pinnedAt DESC (most recent first)
       - POST: Pin a message (body: { messageId })
         - Validate user is channel member
         - Validate message belongs to this channel
         - Insert with ON CONFLICT DO NOTHING (already pinned is idempotent)
         - Return 201 on success
       - DELETE: Unpin a message (body: { messageId })
         - Validate user is channel member (any member can unpin)
         - Delete from pinnedMessages
         - Return 204 on success

    Use auth() from better-auth to get current user, validate channel membership.
  </action>
  <verify>
    `npx tsc --noEmit` passes, API routes have proper handlers
  </verify>
  <done>
    Pinned messages table with cascade delete, REST API for CRUD operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Pinned messages UI</name>
  <files>
    src/components/channel/pinned-messages-dialog.tsx
    src/components/channel/channel-header.tsx
    src/components/message/message-item.tsx
  </files>
  <action>
    Build pinned messages UI:

    1. Create `src/components/channel/pinned-messages-dialog.tsx`:
       - Accept channelId prop
       - Use shadcn Dialog component
       - Fetch pinned messages from GET /api/channels/[channelId]/pins on open
       - Display list of pinned messages with:
         - Message content (snippet if long)
         - Author name and avatar
         - "Pinned by [name] on [date]" subtitle
         - Unpin button (X icon) on each message
       - Show empty state if no pins
       - Handle loading and error states

    2. Create or update `src/components/channel/channel-header.tsx`:
       - If channel header doesn't exist, create it with:
         - Channel name and topic display
         - Members count
       - Add Pin icon button (lucide Pin icon)
       - Clicking opens PinnedMessagesDialog
       - Show badge with pin count if > 0

    3. Update `src/components/message/message-item.tsx`:
       - Add dropdown menu (DropdownMenu from shadcn) for message actions
       - Trigger: MoreHorizontal icon (vertical ellipsis) on hover
       - Menu items:
         - "Reply in thread" (if onReply provided)
         - "Pin to channel" (if message in channel, not already pinned)
         - "Unpin from channel" (if already pinned)
         - "Delete message" (if own message)
       - Pin/unpin calls fetch to pins API
       - Pass isPinned prop from parent (check in pinned messages list)

       Note: Need to install shadcn dropdown-menu if not present:
       `npx shadcn@latest add dropdown-menu`

    Avoid: Adding real-time socket events for pins.
    Why: Pins are infrequent operations; polling on dialog open is sufficient. Real-time would add complexity for minimal benefit.
  </action>
  <verify>
    `npx tsc --noEmit` passes, Dialog and DropdownMenu components available
  </verify>
  <done>
    Pin icon in channel header opens dialog with pinned messages, message menu has pin/unpin actions
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Pinned messages table has unique constraint on (messageId, channelId)
3. API routes exist at /api/channels/[channelId]/pins
4. PinnedMessagesDialog component renders pinned messages list
5. ChannelHeader has pin icon button
6. MessageItem has dropdown menu with pin action
</verification>

<success_criteria>
- Pins persist to database with proper foreign keys
- Pinning already-pinned message is idempotent (no error)
- Pinned messages list shows pinner and timestamp
- Soft-deleted messages don't appear in pinned list
- Any channel member can pin/unpin (not restricted to admins)
- Requirements covered: CHAN-08, CHAN-09
</success_criteria>

<output>
After completion, create `.planning/phases/04-threading-reactions/04-03-SUMMARY.md`
</output>
