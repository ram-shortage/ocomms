---
phase: 04-threading-reactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/message.ts
  - src/db/schema/thread-participant.ts
  - src/db/schema/index.ts
  - src/lib/socket-events.ts
  - src/server/socket/handlers/thread.ts
  - src/server/socket/rooms.ts
  - src/server/socket/index.ts
  - src/components/ui/sheet.tsx
  - src/components/thread/thread-panel.tsx
  - src/components/thread/thread-list.tsx
  - src/components/thread/index.ts
  - src/components/message/message-item.tsx
  - src/app/(workspace)/[workspaceSlug]/threads/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can reply to a message to create a thread"
    - "User can view thread replies in a slide-out panel"
    - "User can view All Threads page showing threads they participate in"
    - "Thread reply count displays on parent message"
  artifacts:
    - path: "src/db/schema/message.ts"
      provides: "parentId self-reference and replyCount column"
      contains: "parentId.*references.*messages.id"
    - path: "src/db/schema/thread-participant.ts"
      provides: "Thread participant tracking for notifications"
      exports: ["threadParticipants"]
    - path: "src/server/socket/handlers/thread.ts"
      provides: "Thread reply and join socket handlers"
      exports: ["handleThreadEvents"]
    - path: "src/components/thread/thread-panel.tsx"
      provides: "Slide-out thread panel with replies"
      min_lines: 50
    - path: "src/app/(workspace)/[workspaceSlug]/threads/page.tsx"
      provides: "All Threads view"
      min_lines: 30
  key_links:
    - from: "src/components/message/message-item.tsx"
      to: "thread-panel.tsx"
      via: "onReply callback opens thread panel"
      pattern: "onReply"
    - from: "src/server/socket/handlers/thread.ts"
      to: "thread_participants"
      via: "participant creation on reply"
      pattern: "threadParticipants"
---

<objective>
Implement threaded conversations with self-referencing message schema, socket handlers for real-time thread replies, and UI components for viewing threads.

Purpose: Enable focused discussions on specific messages without cluttering the main channel feed, matching core Slack functionality.

Output: Thread panel UI, All Threads page, and real-time thread reply delivery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-threading-reactions/04-RESEARCH.md

# Existing code to extend
@src/db/schema/message.ts
@src/db/schema/index.ts
@src/lib/socket-events.ts
@src/server/socket/handlers/message.ts
@src/server/socket/rooms.ts
@src/server/socket/index.ts
@src/components/message/message-item.tsx
@src/components/message/message-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread schema extensions</name>
  <files>
    src/db/schema/message.ts
    src/db/schema/thread-participant.ts
    src/db/schema/index.ts
  </files>
  <action>
    Extend messages table with threading support:

    1. In `src/db/schema/message.ts`:
       - Add `parentId` column: `uuid("parent_id").references((): AnyPgColumn => messages.id, { onDelete: "cascade" })`
       - Add `replyCount` column: `integer("reply_count").notNull().default(0)`
       - Add index: `index("messages_parent_idx").on(table.parentId)`
       - Update messagesRelations to include self-reference for parent/replies
       - Import `AnyPgColumn` from drizzle-orm/pg-core

    2. Create `src/db/schema/thread-participant.ts`:
       ```typescript
       export const threadParticipants = pgTable("thread_participants", {
         id: uuid("id").primaryKey().defaultRandom(),
         threadId: uuid("thread_id")
           .notNull()
           .references(() => messages.id, { onDelete: "cascade" }),
         userId: uuid("user_id")
           .notNull()
           .references(() => users.id, { onDelete: "cascade" }),
         lastReadAt: timestamp("last_read_at").notNull().defaultNow(),
         joinedAt: timestamp("joined_at").notNull().defaultNow(),
       }, (table) => [
         uniqueIndex("thread_participants_unique_idx").on(table.threadId, table.userId),
         index("thread_participants_user_idx").on(table.userId),
       ]);
       ```
       Include relations to users and messages.

    3. Export from `src/db/schema/index.ts`

    Avoid: Creating a separate threads table. Self-referencing is simpler per research.
    Why: Separate tables create unnecessary join complexity.
  </action>
  <verify>
    `npx tsc --noEmit` passes with no errors
  </verify>
  <done>
    Messages table has parentId and replyCount columns, thread_participants table exists with proper indexes
  </done>
</task>

<task type="auto">
  <name>Task 2: Thread socket handlers and events</name>
  <files>
    src/lib/socket-events.ts
    src/server/socket/rooms.ts
    src/server/socket/handlers/thread.ts
    src/server/socket/index.ts
  </files>
  <action>
    Implement real-time thread functionality:

    1. Update `src/lib/socket-events.ts`:
       - Add to Message interface: `parentId?: string | null; replyCount?: number;`
       - Add to ServerToClientEvents:
         ```typescript
         "thread:reply": (message: Message) => void;
         "message:replyCount": (data: { messageId: string; replyCount: number }) => void;
         ```
       - Add to ClientToServerEvents:
         ```typescript
         "thread:sendReply": (
           data: { parentId: string; content: string },
           callback?: (response: { success: boolean; messageId?: string }) => void
         ) => void;
         "thread:join": (data: { threadId: string }) => void;
         "thread:leave": (data: { threadId: string }) => void;
         "thread:getReplies": (
           data: { threadId: string },
           callback: (response: { success: boolean; replies?: Message[] }) => void
         ) => void;
         ```

    2. Update `src/server/socket/rooms.ts`:
       - Add `thread: (parentMessageId: string) => \`thread:${parentMessageId}\`` to getRoomName

    3. Create `src/server/socket/handlers/thread.ts`:
       - handleThreadReply: Validate parent exists and is not a reply itself (prevent nested threads), create reply with atomic increment of parent replyCount, add sender to thread_participants with ON CONFLICT UPDATE, broadcast to thread room AND parent channel/DM room
       - handleThreadJoin: Join socket to thread room
       - handleThreadLeave: Leave thread room
       - handleGetReplies: Fetch thread replies with author info

       Use transaction pattern from research for atomic operations.

    4. Register handlers in `src/server/socket/index.ts`

    Avoid: Allowing replies to replies (nested threads).
    Why: Slack proved single-level is better UX and simpler to implement.
  </action>
  <verify>
    `npx tsc --noEmit` passes, handlers registered in socket index
  </verify>
  <done>
    Thread events defined, room naming includes threads, handlers create replies with atomic replyCount increment
  </done>
</task>

<task type="auto">
  <name>Task 3: Thread UI components and All Threads page</name>
  <files>
    src/components/ui/sheet.tsx
    src/components/thread/thread-panel.tsx
    src/components/thread/thread-list.tsx
    src/components/thread/index.ts
    src/components/message/message-item.tsx
    src/app/(workspace)/[workspaceSlug]/threads/page.tsx
  </files>
  <action>
    Build thread UI:

    1. Add shadcn Sheet component:
       Run `npx shadcn@latest add sheet` to get the component

    2. Create `src/components/thread/thread-panel.tsx`:
       - Accept props: isOpen, onClose, parentMessage, currentUserId
       - Use shadcn Sheet sliding from right (w-[400px] sm:w-[500px])
       - Show parent message at top with border separator
       - Fetch and display replies using thread:getReplies on mount
       - Subscribe to thread:reply events for real-time updates
       - Join thread room on open, leave on close
       - Include MessageInput at bottom for sending replies
       - Key component with threadId for proper state reset

    3. Create `src/components/thread/thread-list.tsx`:
       - Displays replies with scroll, auto-scroll to bottom on new message
       - Reuse MessageItem for individual replies (pass isThreadReply prop for compact styling)

    4. Update `src/components/message/message-item.tsx`:
       - Add reply button (MessageSquare icon) that appears on hover
       - Add onReply prop callback
       - Display reply count badge if replyCount > 0 (e.g., "3 replies" link)
       - Add optional isThreadReply prop for compact thread styling (no reply button)

    5. Create `src/app/(workspace)/[workspaceSlug]/threads/page.tsx`:
       - Server component fetching threads user participates in from thread_participants
       - Join with messages to get parent message content and replyCount
       - Order by most recent activity (latest reply timestamp)
       - Show list of thread previews: parent message snippet, reply count, last activity
       - Each thread links to open thread panel in channel context (or could open modal)

    6. Export components from `src/components/thread/index.ts`

    Avoid: Polling for thread updates.
    Why: Socket rooms handle real-time updates efficiently.
  </action>
  <verify>
    `npx tsc --noEmit` passes, Sheet component installed, thread components exist
  </verify>
  <done>
    Thread panel slides in from right, shows parent and replies, reply input works, All Threads page shows user's threads
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Schema includes parentId, replyCount columns on messages
3. thread_participants table created with proper indexes
4. Thread socket handlers registered and export correctly
5. Sheet component available in ui folder
6. Thread panel component renders with proper structure
7. MessageItem has reply button and count display
8. All Threads page exists at correct route
</verification>

<success_criteria>
- Messages can have parentId pointing to parent message (self-reference)
- Reply count is tracked and updated atomically
- Thread participants are recorded for notification tracking
- Thread panel shows parent message and replies
- Real-time reply delivery to thread rooms
- All Threads page lists threads user participates in
- Requirements covered: THRD-01, THRD-02, THRD-04 (THRD-03 tracking ready, notifications in Phase 5)
</success_criteria>

<output>
After completion, create `.planning/phases/04-threading-reactions/04-01-SUMMARY.md`
</output>
