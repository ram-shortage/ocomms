---
phase: 25-job-queue-foundation
plan: 04
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - src/lib/actions/reminder.ts
  - src/components/reminder/reminder-menu-item.tsx
  - src/components/reminder/reminders-list.tsx
  - src/components/reminder/reminder-detail-panel.tsx
  - src/components/reminder/snooze-options.tsx
  - src/components/message/message-item.tsx
  - src/components/workspace/workspace-sidebar.tsx
  - src/workers/reminder.worker.ts
  - src/workers/index.ts
  - src/lib/socket-events.ts
  - src/app/(workspace)/[workspaceSlug]/reminders/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can set a reminder on any message via action menu"
    - "User can view list of pending reminders in sidebar"
    - "Reminder fires at scheduled time with in-app toast and push notification"
    - "User can snooze a fired reminder"
    - "User can mark reminder as complete"
    - "Clicking reminder links to original message"
    - "User can set recurring reminders (daily, weekly)"
  artifacts:
    - path: "src/lib/actions/reminder.ts"
      provides: "Server actions for reminder CRUD"
      exports: ["createReminder", "getReminders", "snoozeReminder", "completeReminder", "cancelReminder"]
    - path: "src/components/reminder/reminder-menu-item.tsx"
      provides: "Menu item for setting reminder in message actions"
      min_lines: 40
    - path: "src/components/reminder/reminder-detail-panel.tsx"
      provides: "Slide-in panel for fired reminders"
      min_lines: 80
    - path: "src/workers/reminder.worker.ts"
      provides: "Worker processor for firing reminders"
      min_lines: 80
  key_links:
    - from: "src/components/reminder/reminder-menu-item.tsx"
      to: "src/lib/actions/reminder.ts"
      via: "createReminder action call"
      pattern: "createReminder"
    - from: "src/workers/reminder.worker.ts"
      to: "src/lib/socket-events.ts"
      via: "reminder:fired event emission"
      pattern: "reminder:fired"
    - from: "src/components/message/message-item.tsx"
      to: "src/components/reminder/reminder-menu-item.tsx"
      via: "menu item composition"
      pattern: "ReminderMenuItem"
---

<objective>
Implement reminders feature: users can set reminders on messages to be notified at a chosen time, with snooze and complete actions.

Purpose: Enables users to flag messages for follow-up without relying on memory. Reminders ensure important messages don't get lost in busy channels.

Output: Complete reminders feature with UI, server actions, worker processing, and notification delivery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-job-queue-foundation/25-RESEARCH.md
@.planning/phases/25-job-queue-foundation/25-CONTEXT.md
@.planning/phases/25-job-queue-foundation/25-01-SUMMARY.md
@.planning/phases/25-job-queue-foundation/25-02-SUMMARY.md

# Existing patterns
@src/lib/actions/channel.ts
@src/components/message/message-item.tsx
@src/lib/socket-events.ts
@src/server/socket/handlers/notification.ts
@src/components/thread/thread-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reminder server actions</name>
  <files>
    - src/lib/actions/reminder.ts
  </files>
  <action>
    Create src/lib/actions/reminder.ts with "use server" directive:

    1. **createReminder(data: { messageId, remindAt, note?, recurringPattern? })**:
       - Verify auth session
       - Verify message exists and user has access to it
       - Validate remindAt is in future
       - Insert into reminders with status "pending"
       - For recurring (RMND-07):
         - If recurringPattern is "daily" or "weekly":
           ```typescript
           await reminderQueue.upsertJobScheduler(
             `reminder-${reminder.id}`,
             {
               every: recurringPattern === "daily" ? 24*60*60*1000 : 7*24*60*60*1000,
               startDate: remindAt,
             },
             { name: "recurring-reminder", data: { reminderId: reminder.id } }
           );
           ```
       - For one-time:
         ```typescript
         const delay = remindAt.getTime() - Date.now();
         await reminderQueue.add(
           "one-time-reminder",
           { reminderId: reminder.id },
           { delay, jobId: `reminder-${reminder.id}` }
         );
         ```
       - Update record with jobId
       - Return reminder

    2. **getReminders()**:
       - Get auth session
       - Query reminders where userId = user.id AND status in ("pending", "fired", "snoozed")
       - Order by remindAt ascending
       - Include message relation with author for display
       - Return list

    3. **snoozeReminder(id, snoozeDuration: "20min" | "1hour" | "3hours" | "tomorrow")**:
       - Verify auth and ownership
       - Calculate snoozedUntil based on duration:
         - "20min": addMinutes(now, 20)
         - "1hour": addHours(now, 1)
         - "3hours": addHours(now, 3)
         - "tomorrow": setHours(addDays(now, 1), 9) - tomorrow 9am
       - Update status to "snoozed", set snoozedUntil
       - Remove old job if exists
       - Add new delayed job for snoozedUntil time
       - Return updated reminder

    4. **completeReminder(id)**:
       - Verify auth and ownership
       - Update status to "completed", set completedAt
       - Remove job if exists (for recurring, remove scheduler)
       - Return success

    5. **cancelReminder(id)**:
       - Verify auth and ownership
       - Update status to "cancelled"
       - Remove job/scheduler
       - Return success

    6. **getReminder(id)** (helper for detail view):
       - Verify auth and ownership
       - Return reminder with message and message.author
  </action>
  <verify>
    - File exists at src/lib/actions/reminder.ts
    - `npx tsc --noEmit` passes
    - All actions exported
  </verify>
  <done>Server actions for creating, listing, snoozing, completing, canceling reminders</done>
</task>

<task type="auto">
  <name>Task 2: Create reminder UI components</name>
  <files>
    - src/components/reminder/reminder-menu-item.tsx
    - src/components/reminder/reminders-list.tsx
    - src/components/reminder/reminder-detail-panel.tsx
    - src/components/reminder/snooze-options.tsx
    - src/components/message/message-item.tsx
    - src/components/workspace/workspace-sidebar.tsx
    - src/app/(workspace)/[workspaceSlug]/reminders/page.tsx
  </files>
  <action>
    1. **Create src/components/reminder/reminder-menu-item.tsx**:
       - Popover component for message action menu
       - Shows "Remind me..." with Bell icon
       - Popover content same as schedule dropdown:
         - "Tomorrow at 9:00 AM"
         - "Monday at 9:00 AM"
         - "Custom time..."
       - Optional note input (per 25-CONTEXT.md)
       - Checkbox for recurring: "Repeat daily" / "Repeat weekly"
       - Creates reminder on selection
       - Shows toast on success: "Reminder set for {time}"

    2. **Create src/components/reminder/reminders-list.tsx**:
       - "use client" component
       - Fetch reminders via server action
       - Group by status: "Pending", "Fired" (needs attention)
       - Each item shows:
         - Message content preview
         - Note if set
         - Reminder time
         - Recurring badge if applicable
         - Click to open detail panel or jump to message
       - Empty state: "No reminders"

    3. **Create src/components/reminder/reminder-detail-panel.tsx**:
       - Sheet component (slide-in from right, like thread panel per 25-CONTEXT.md)
       - Shows full reminder info:
         - Original message content with author
         - Reminder note
         - Scheduled time
         - Recurring info
       - Actions:
         - "Snooze" - opens SnoozeOptions
         - "Complete" - marks done
         - "Go to message" - navigates to message in channel/DM
         - "Delete" - cancels reminder

    4. **Create src/components/reminder/snooze-options.tsx**:
       - Simple component with snooze duration buttons
       - "20 minutes", "1 hour", "3 hours", "Tomorrow"
       - Calls snoozeReminder action
       - Per 25-CONTEXT.md: fixed intervals as quick taps

    5. **Update src/components/message/message-item.tsx**:
       - Add ReminderMenuItem to message action menu (the â‹® dropdown)
       - Position alongside existing actions (reply, react, etc.)

    6. **Update src/components/workspace/workspace-sidebar.tsx**:
       - Add "Reminders" link (below or near "Scheduled")
       - Icon: Bell from lucide-react
       - Show badge count for fired + pending reminders

    7. **Create src/app/(workspace)/[workspaceSlug]/reminders/page.tsx**:
       - Page component for /workspace/reminders
       - Renders RemindersList component
       - Title: "Reminders"

    Per 25-CONTEXT.md:
    - Reminder via message action menu ("Remind me..." option)
    - Same presets as scheduling for consistency
    - Snooze as fixed intervals (quick taps)
    - Detail panel slides in like thread view
  </action>
  <verify>
    - All component files exist
    - `npx tsc --noEmit` passes
    - Message item shows "Remind me..." in action menu
    - Reminders page accessible at /[workspace]/reminders
  </verify>
  <done>Reminder UI with menu item, list view, detail panel, snooze options</done>
</task>

<task type="auto">
  <name>Task 3: Implement worker processor and notifications</name>
  <files>
    - src/workers/reminder.worker.ts
    - src/workers/index.ts
    - src/lib/socket-events.ts
  </files>
  <action>
    1. **Update src/lib/socket-events.ts**:
       - Add Reminder interface:
         ```typescript
         export interface Reminder {
           id: string;
           messageId: string;
           note: string | null;
           remindAt: Date;
           status: "pending" | "fired" | "snoozed" | "completed" | "cancelled";
           recurringPattern: "daily" | "weekly" | null;
           message?: Message;
         }
         ```
       - Add to ServerToClientEvents:
         ```typescript
         "reminder:fired": (data: {
           reminder: Reminder;
           message: Message;
         }) => void;

         "reminder:updated": (data: {
           reminderId: string;
           status: Reminder["status"];
           snoozedUntil?: Date;
         }) => void;
         ```

    2. **Create src/workers/reminder.worker.ts**:
       - Export createReminderWorker function
       - Processor for both "one-time-reminder" and "recurring-reminder" jobs
       - Logic:
         ```typescript
         async (job) => {
           const { reminderId } = job.data;

           const reminder = await db.query.reminders.findFirst({
             where: eq(reminders.id, reminderId),
             with: {
               message: {
                 with: { author: true },
               },
             },
           });

           if (!reminder || reminder.status === "completed" || reminder.status === "cancelled") {
             return { skipped: true };
           }

           // Update to fired
           await db.update(reminders)
             .set({ status: "fired", lastFiredAt: new Date() })
             .where(eq(reminders.id, reminderId));

           // Format message for display
           const messageData = {
             id: reminder.message.id,
             content: reminder.message.content,
             authorId: reminder.message.authorId,
             author: reminder.message.author,
             channelId: reminder.message.channelId,
             conversationId: reminder.message.conversationId,
             createdAt: reminder.message.createdAt,
           };

           // Emit to user's personal room via Socket.IO
           const emitter = getEmitter();
           emitter.to(`user:${reminder.userId}`).emit("reminder:fired", {
             reminder: {
               id: reminder.id,
               messageId: reminder.messageId,
               note: reminder.note,
               remindAt: reminder.remindAt,
               status: "fired",
               recurringPattern: reminder.recurringPattern,
             },
             message: messageData,
           });

           // Send push notification (use existing push notification infrastructure)
           await sendPushNotification(reminder.userId, {
             title: "Reminder",
             body: reminder.note || `Reminder: ${reminder.message.content.slice(0, 50)}...`,
             data: {
               type: "reminder",
               reminderId: reminder.id,
               messageId: reminder.messageId,
             },
           });

           return { success: true };
         }
         ```

       - Use @socket.io/redis-emitter for Socket.IO emission (same as scheduled-message.worker)
       - Import and use existing push notification function from notifications handler

    3. **Update src/workers/index.ts**:
       - Import createReminderWorker
       - Replace placeholder with real worker
       - Add to shutdown handler

    4. **Add client-side listener for reminder:fired**:
       - In a provider or layout, listen for "reminder:fired"
       - Show toast with reminder info
       - Click toast opens reminder detail panel or navigates to message

    Per 25-CONTEXT.md:
    - Delivery: both in-app toast AND push notification
    - Click action: opens reminder detail view first, then option to jump to message
  </action>
  <verify>
    - Worker file exists at src/workers/reminder.worker.ts
    - Socket events updated with reminder types
    - `npx tsc --noEmit` passes
    - Worker starts without errors
  </verify>
  <done>Worker fires reminders, emits Socket.IO event, sends push notification</done>
</task>

</tasks>

<verification>
1. Manual test: Set reminder for 1 minute in future
2. Wait for reminder time
3. Toast appears with reminder content
4. Push notification received (if enabled)
5. Can snooze reminder
6. Can mark complete
7. Can click to view original message
8. Recurring reminders fire repeatedly
</verification>

<success_criteria>
- RMND-01: Can set reminder on any message via action menu
- RMND-02: Can set reminder for specific date and time
- RMND-03: Can view list of pending reminders in sidebar
- RMND-04: Can mark reminder as complete
- RMND-05: Can snooze reminder when it fires (20min, 1hr, 3hr, tomorrow)
- RMND-06: Reminder notification links to original message
- RMND-07: Can create recurring reminders (daily, weekly)
- In-app toast + push notification on fire
- Detail panel slides in like thread view
</success_criteria>

<output>
After completion, create `.planning/phases/25-job-queue-foundation/25-04-SUMMARY.md`
</output>
