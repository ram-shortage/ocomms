---
phase: 25-job-queue-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/scheduled-message.ts
  - src/db/schema/reminder.ts
  - src/db/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "Scheduled messages can be stored with author, content, target, and scheduled time"
    - "Reminders can be stored with user, message reference, and reminder time"
    - "Both tables have status tracking for job lifecycle management"
    - "Recurring reminders have pattern stored (daily, weekly)"
  artifacts:
    - path: "src/db/schema/scheduled-message.ts"
      provides: "Scheduled messages table with status enum"
      exports: ["scheduledMessages", "scheduledMessagesRelations", "scheduledMessageStatusEnum"]
      contains: "pgTable"
    - path: "src/db/schema/reminder.ts"
      provides: "Reminders table with status and pattern enums"
      exports: ["reminders", "remindersRelations", "reminderStatusEnum", "reminderPatternEnum"]
      contains: "pgTable"
  key_links:
    - from: "src/db/schema/scheduled-message.ts"
      to: "src/db/schema/auth.ts"
      via: "author foreign key"
      pattern: "references.*users"
    - from: "src/db/schema/reminder.ts"
      to: "src/db/schema/message.ts"
      via: "message foreign key"
      pattern: "references.*messages"
---

<objective>
Create database schema for scheduled messages and reminders with proper status tracking and relations.

Purpose: Database tables store the persistent state of scheduled messages and reminders. BullMQ handles timing, but the database tracks metadata, status, and enables UI management (view, edit, cancel).

Output: Drizzle schema files for scheduled_messages and reminders tables, migration ready.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-job-queue-foundation/25-RESEARCH.md

# Existing schema patterns
@src/db/schema/message.ts
@src/db/schema/notification.ts
@src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scheduled_messages schema</name>
  <files>
    - src/db/schema/scheduled-message.ts
  </files>
  <action>
    Create src/db/schema/scheduled-message.ts following existing schema patterns:

    1. Import dependencies:
       - pgTable, text, timestamp, uuid, pgEnum from drizzle-orm/pg-core
       - relations from drizzle-orm
       - users from ./auth
       - channels from ./channel
       - conversations from ./conversation
       - messages from ./message

    2. Create status enum:
       ```typescript
       export const scheduledMessageStatusEnum = pgEnum("scheduled_message_status", [
         "pending",     // Waiting to send
         "processing",  // Currently being processed by worker
         "sent",        // Successfully sent
         "cancelled",   // User cancelled before send time
         "failed",      // Send failed after retries
       ]);
       ```

    3. Create scheduled_messages table:
       - id: uuid primary key with defaultRandom()
       - authorId: text references users.id with onDelete cascade
       - content: text not null (message content to send)
       - channelId: uuid references channels.id with onDelete cascade (nullable)
       - conversationId: uuid references conversations.id with onDelete cascade (nullable)
       - scheduledFor: timestamp with timezone not null (UTC time to send)
       - status: scheduledMessageStatusEnum default "pending"
       - jobId: text (BullMQ job ID for management)
       - messageId: uuid references messages.id with onDelete set null (populated after sending)
       - error: text (error message if failed)
       - sentAt: timestamp with timezone (when actually sent)
       - createdAt: timestamp with timezone default now
       - updatedAt: timestamp with timezone default now

    4. Add indexes:
       - index on authorId + status (for "my scheduled messages" queries)
       - index on scheduledFor (for time-based queries)

    5. Create relations:
       - author: one to users
       - channel: one to channels
       - conversation: one to conversations
       - message: one to messages (the sent message)

    Follow existing pattern from message.ts for timestamp and foreign key conventions.
  </action>
  <verify>
    - File exists at src/db/schema/scheduled-message.ts
    - `npx tsc --noEmit` passes
    - All required columns present
  </verify>
  <done>scheduled_messages table with status tracking, relations to users/channels/conversations/messages</done>
</task>

<task type="auto">
  <name>Task 2: Create reminders schema</name>
  <files>
    - src/db/schema/reminder.ts
  </files>
  <action>
    Create src/db/schema/reminder.ts:

    1. Import dependencies (same as scheduled-message.ts)

    2. Create status enum:
       ```typescript
       export const reminderStatusEnum = pgEnum("reminder_status", [
         "pending",    // Waiting to fire
         "fired",      // Reminder triggered, awaiting user action
         "snoozed",    // User snoozed, waiting for next fire
         "completed",  // User marked as complete
         "cancelled",  // User cancelled
       ]);
       ```

    3. Create pattern enum (RMND-07: recurring reminders):
       ```typescript
       export const reminderPatternEnum = pgEnum("reminder_pattern", [
         "daily",
         "weekly",
       ]);
       ```

    4. Create reminders table:
       - id: uuid primary key with defaultRandom()
       - userId: text references users.id with onDelete cascade (who set the reminder)
       - messageId: uuid references messages.id with onDelete cascade (the message being reminded about)
       - note: text nullable (optional user note, per 25-CONTEXT)
       - remindAt: timestamp with timezone not null (when to remind, UTC)
       - status: reminderStatusEnum default "pending"
       - recurringPattern: reminderPatternEnum nullable (null = one-time)
       - jobId: text (BullMQ job ID)
       - lastFiredAt: timestamp with timezone (for recurring)
       - snoozedUntil: timestamp with timezone (if snoozed)
       - completedAt: timestamp with timezone (when marked complete)
       - createdAt: timestamp with timezone default now
       - updatedAt: timestamp with timezone default now

    5. Add indexes (from research):
       - index on userId + status (for "my reminders" queries)
       - index on remindAt (for time-based queries)

    6. Create relations:
       - user: one to users
       - message: one to messages
  </action>
  <verify>
    - File exists at src/db/schema/reminder.ts
    - `npx tsc --noEmit` passes
    - Has recurringPattern for RMND-07 requirement
  </verify>
  <done>reminders table with status, recurring pattern support, relations to users/messages</done>
</task>

<task type="auto">
  <name>Task 3: Export schemas and run migration</name>
  <files>
    - src/db/schema/index.ts
  </files>
  <action>
    1. Update src/db/schema/index.ts to export new schemas:
       - Add: export * from "./scheduled-message";
       - Add: export * from "./reminder";

    2. Run drizzle-kit push to apply schema changes:
       ```bash
       npm run db:push
       ```

    3. Verify tables created in database:
       - scheduled_messages table exists with all columns
       - reminders table exists with all columns
       - Enums created: scheduled_message_status, reminder_status, reminder_pattern
  </action>
  <verify>
    - `npm run db:push` succeeds
    - No TypeScript errors: `npx tsc --noEmit`
    - Can query tables (drizzle studio or manual check)
  </verify>
  <done>Schemas exported, database migrated with new tables</done>
</task>

</tasks>

<verification>
1. Schema files exist: `ls src/db/schema/scheduled-message.ts src/db/schema/reminder.ts`
2. TypeScript valid: `npx tsc --noEmit` passes
3. Database has tables: `npm run db:push` applies without errors
4. Exports work: importing from "@/db/schema" includes new tables
</verification>

<success_criteria>
- scheduled_messages table created with: authorId, content, channelId, conversationId, scheduledFor, status, jobId, messageId, error, sentAt, createdAt, updatedAt
- reminders table created with: userId, messageId, note, remindAt, status, recurringPattern, jobId, lastFiredAt, snoozedUntil, completedAt, createdAt, updatedAt
- Both tables have proper foreign keys and indexes
- Status enums defined for job lifecycle
- Recurring pattern enum for RMND-07
- Schema exports updated in index.ts
- Database migration applied successfully
</success_criteria>

<output>
After completion, create `.planning/phases/25-job-queue-foundation/25-02-SUMMARY.md`
</output>
