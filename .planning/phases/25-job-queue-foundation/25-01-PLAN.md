---
phase: 25-job-queue-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/queue/connection.ts
  - src/server/queue/scheduled-message.queue.ts
  - src/server/queue/reminder.queue.ts
  - src/server/queue/index.ts
  - src/workers/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "BullMQ worker process can start and connect to Redis"
    - "Queues are defined and accessible for adding jobs"
    - "Worker gracefully shuts down on SIGTERM"
  artifacts:
    - path: "src/server/queue/connection.ts"
      provides: "Redis connection factory for BullMQ"
      exports: ["getQueueConnection"]
    - path: "src/server/queue/scheduled-message.queue.ts"
      provides: "Scheduled messages queue definition"
      exports: ["scheduledMessageQueue", "ScheduledMessageJobData"]
    - path: "src/server/queue/reminder.queue.ts"
      provides: "Reminders queue definition"
      exports: ["reminderQueue", "ReminderJobData"]
    - path: "src/workers/index.ts"
      provides: "Worker entry point"
      min_lines: 20
  key_links:
    - from: "src/server/queue/*.queue.ts"
      to: "src/server/queue/connection.ts"
      via: "getQueueConnection import"
      pattern: "getQueueConnection"
    - from: "src/workers/index.ts"
      to: "src/server/queue/*.queue.ts"
      via: "queue imports for worker processing"
---

<objective>
Set up BullMQ infrastructure for persistent job processing enabling scheduled messages and reminders.

Purpose: BullMQ provides the foundation for time-delayed operations that must survive server restarts. Without this infrastructure, scheduled messages and reminders would require polling or be lost on restart.

Output: Queue definitions, Redis connection factory, worker entry point, npm scripts for running worker.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-job-queue-foundation/25-RESEARCH.md
@.planning/phases/25-job-queue-foundation/25-CONTEXT.md

# Existing patterns
@src/server/redis.ts
@src/server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install BullMQ and create Redis connection factory</name>
  <files>
    - package.json
    - src/server/queue/connection.ts
  </files>
  <action>
    1. Install bullmq: `npm install bullmq`

    2. Create src/server/queue/connection.ts:
       - Import Redis from ioredis (already installed)
       - Create getQueueConnection() function that returns a singleton Redis instance
       - Use REDIS_URL env var with localhost fallback
       - Set maxRetriesPerRequest: null (required for BullMQ workers)
       - Add error handling for connection failures

    Pattern from research:
    ```typescript
    import { Redis } from "ioredis";

    let queueConnection: Redis | null = null;

    export function getQueueConnection(): Redis {
      if (!queueConnection) {
        const redisUrl = process.env.REDIS_URL || "redis://localhost:6379";
        queueConnection = new Redis(redisUrl, {
          maxRetriesPerRequest: null, // Required for BullMQ workers
        });
      }
      return queueConnection;
    }
    ```
  </action>
  <verify>
    - `npm ls bullmq` shows installed
    - File exists at src/server/queue/connection.ts
    - No TypeScript errors: `npx tsc --noEmit`
  </verify>
  <done>BullMQ installed, Redis connection factory exports getQueueConnection()</done>
</task>

<task type="auto">
  <name>Task 2: Create queue definitions</name>
  <files>
    - src/server/queue/scheduled-message.queue.ts
    - src/server/queue/reminder.queue.ts
    - src/server/queue/index.ts
  </files>
  <action>
    1. Create src/server/queue/scheduled-message.queue.ts:
       - Import Queue from bullmq
       - Import getQueueConnection from ./connection
       - Define ScheduledMessageJobData interface with scheduledMessageId: string
       - Create scheduledMessageQueue with name "scheduled-messages"
       - Configure defaultJobOptions:
         - attempts: 3
         - backoff: { type: "exponential", delay: 1000 }
         - removeOnComplete: { count: 100 }
         - removeOnFail: { count: 500 }
       - Export queue and job data type

    2. Create src/server/queue/reminder.queue.ts:
       - Same pattern as scheduled-message.queue.ts
       - Define ReminderJobData interface with reminderId: string
       - Queue name: "reminders"
       - Same defaultJobOptions

    3. Create src/server/queue/index.ts:
       - Re-export from both queue files
       - Re-export getQueueConnection from ./connection

    Research pattern for queue:
    ```typescript
    import { Queue } from "bullmq";
    import { getQueueConnection } from "./connection";

    export interface ScheduledMessageJobData {
      scheduledMessageId: string;
    }

    export const scheduledMessageQueue = new Queue<ScheduledMessageJobData>(
      "scheduled-messages",
      {
        connection: getQueueConnection(),
        defaultJobOptions: {
          attempts: 3,
          backoff: { type: "exponential", delay: 1000 },
          removeOnComplete: { count: 100 },
          removeOnFail: { count: 500 },
        },
      }
    );
    ```
  </action>
  <verify>
    - Files exist at src/server/queue/*.ts
    - `npx tsc --noEmit` passes
    - Exports visible: both queues and job data types
  </verify>
  <done>Queue definitions for scheduled-messages and reminders created with proper configuration</done>
</task>

<task type="auto">
  <name>Task 3: Create worker entry point and npm scripts</name>
  <files>
    - src/workers/index.ts
    - package.json
  </files>
  <action>
    1. Create src/workers/index.ts:
       - Load environment variables (dotenv with .env.local priority, same pattern as src/server/index.ts)
       - Import Worker from bullmq
       - Import getQueueConnection from @/server/queue/connection
       - Create placeholder worker processors (will be filled in Plan 03 and 04):
         - scheduledMessageWorker for "scheduled-messages" queue
         - reminderWorker for "reminders" queue
       - Placeholder processor: just log job data and return success
       - Add graceful shutdown handler on SIGTERM
       - Log "[Worker] BullMQ workers started" on startup

    Worker structure:
    ```typescript
    import { config } from "dotenv";
    import { existsSync } from "node:fs";

    if (existsSync(".env.local")) {
      config({ path: ".env.local" });
    }
    config();

    import { Worker } from "bullmq";
    import { getQueueConnection } from "@/server/queue/connection";

    // Placeholder workers - real processors added in later plans
    const scheduledMessageWorker = new Worker(
      "scheduled-messages",
      async (job) => {
        console.log("[Worker] Processing scheduled message:", job.data);
        // TODO: Implement in Plan 03
        return { processed: true };
      },
      { connection: getQueueConnection(), concurrency: 5 }
    );

    const reminderWorker = new Worker(
      "reminders",
      async (job) => {
        console.log("[Worker] Processing reminder:", job.data);
        // TODO: Implement in Plan 04
        return { processed: true };
      },
      { connection: getQueueConnection(), concurrency: 5 }
    );

    console.log("[Worker] BullMQ workers started");

    // Graceful shutdown
    const shutdown = async () => {
      console.log("[Worker] Shutting down...");
      await scheduledMessageWorker.close();
      await reminderWorker.close();
      process.exit(0);
    };

    process.on("SIGTERM", shutdown);
    process.on("SIGINT", shutdown);
    ```

    2. Update package.json scripts:
       - Add "worker": "dotenv -e .env.local -- npx tsx --watch src/workers/index.ts"
       - Add "worker:prod": "node dist/workers/index.js"

    Note: tsx is already installed as devDependency
  </action>
  <verify>
    - File exists at src/workers/index.ts
    - `npm run worker` starts without crashing (ctrl+c to stop)
    - Console shows "[Worker] BullMQ workers started"
    - SIGTERM/SIGINT triggers graceful shutdown message
  </verify>
  <done>Worker entry point with placeholder processors, npm scripts for dev and prod</done>
</task>

</tasks>

<verification>
1. BullMQ installed: `npm ls bullmq` shows version
2. Queue files exist: `ls src/server/queue/*.ts` shows connection.ts, scheduled-message.queue.ts, reminder.queue.ts, index.ts
3. Worker starts: `npm run worker` logs startup message
4. TypeScript valid: `npx tsc --noEmit` passes
</verification>

<success_criteria>
- BullMQ package installed
- Redis connection factory created with maxRetriesPerRequest: null
- Two queues defined (scheduled-messages, reminders) with retry/backoff config
- Worker entry point starts and connects to Redis
- npm scripts available: worker, worker:prod
- Worker gracefully shuts down on SIGTERM
</success_criteria>

<output>
After completion, create `.planning/phases/25-job-queue-foundation/25-01-SUMMARY.md`
</output>
