---
phase: 31-high-security-bug-fixes
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(workspace)/[workspaceSlug]/dm/page.tsx
  - src/app/(workspace)/[workspaceSlug]/profile/page.tsx
  - src/components/channel/channel-header.tsx
  - src/components/workspace/workspace-sidebar.tsx
  - src/components/layout/mobile-tab-bar.tsx
autonomous: true

must_haves:
  truths:
    - "DMs page loads correctly on mobile (not 404)"
    - "Profile page title and back link have proper spacing"
    - "Mobile channel header uses overflow menu for actions"
    - "Truncated workspace names show full name on hover"
    - "Mobile navigation highlights correct route after navigation"
  artifacts:
    - path: "src/app/(workspace)/[workspaceSlug]/dm/page.tsx"
      provides: "DM list page for mobile navigation"
      min_lines: 20
    - path: "src/components/channel/channel-header.tsx"
      provides: "Channel header with mobile overflow menu"
      contains: "md:flex"
  key_links:
    - from: "src/components/layout/mobile-tab-bar.tsx"
      to: "/[workspaceSlug]/dm"
      via: "navigation link"
      pattern: "href.*dm"
---

<objective>
Fix mobile UI bugs: DM route, profile spacing, channel header overflow, workspace name tooltip, and nav highlighting.

Purpose: FIX-01 through FIX-05 address user-facing mobile bugs that degrade the experience. The DM route 404 is critical for mobile users.

Output: All mobile navigation routes work, proper spacing and tooltips, responsive channel header.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/31-high-security-bug-fixes/31-CONTEXT.md
@src/app/(workspace)/[workspaceSlug]/dm/[conversationId]/page.tsx
@src/app/(workspace)/[workspaceSlug]/profile/page.tsx
@src/components/channel/channel-header.tsx
@src/components/workspace/workspace-sidebar.tsx
@src/components/layout/mobile-tab-bar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DM list page for mobile navigation (FIX-01)</name>
  <files>
    src/app/(workspace)/[workspaceSlug]/dm/page.tsx
  </files>
  <action>
Create the missing /dm route page. Currently only /dm/[conversationId] exists, causing 404 when mobile tab bar navigates to /dm.

Create `src/app/(workspace)/[workspaceSlug]/dm/page.tsx`:
```typescript
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { redirect, notFound } from "next/navigation";
import { db } from "@/db";
import { conversations, conversationParticipants, users, members } from "@/db/schema";
import { eq, and, desc, ne, inArray } from "drizzle-orm";
import Link from "next/link";
import { MessageSquare } from "lucide-react";
import { StartDMDialog } from "@/components/dm/start-dm-dialog";

export default async function DMListPage({
  params,
}: {
  params: Promise<{ workspaceSlug: string }>;
}) {
  const { workspaceSlug } = await params;

  const session = await auth.api.getSession({
    headers: await headers(),
  });

  if (!session) {
    redirect("/login");
  }

  // Get organization by slug
  const orgs = await auth.api.listOrganizations({
    headers: await headers(),
  });
  const workspace = orgs?.find((org) => org.slug === workspaceSlug);

  if (!workspace) {
    notFound();
  }

  // Fetch user's DM conversations
  const userConversations = await db
    .select({
      id: conversations.id,
      lastMessageAt: conversations.lastMessageAt,
    })
    .from(conversations)
    .innerJoin(
      conversationParticipants,
      eq(conversations.id, conversationParticipants.conversationId)
    )
    .where(
      and(
        eq(conversationParticipants.userId, session.user.id),
        eq(conversations.organizationId, workspace.id)
      )
    )
    .orderBy(desc(conversations.lastMessageAt));

  // Get other participants for each conversation
  const conversationsWithUsers = await Promise.all(
    userConversations.map(async (conv) => {
      const participants = await db
        .select({
          userId: conversationParticipants.userId,
          userName: users.name,
          userEmail: users.email,
          userImage: users.image,
        })
        .from(conversationParticipants)
        .innerJoin(users, eq(conversationParticipants.userId, users.id))
        .where(
          and(
            eq(conversationParticipants.conversationId, conv.id),
            ne(conversationParticipants.userId, session.user.id)
          )
        );

      return {
        ...conv,
        otherUser: participants[0] || null,
      };
    })
  );

  // Get workspace members for StartDMDialog
  const workspaceMembers = await db
    .select({
      id: members.userId,
      name: users.name,
      email: users.email,
      image: users.image,
    })
    .from(members)
    .innerJoin(users, eq(members.userId, users.id))
    .where(eq(members.organizationId, workspace.id));

  return (
    <div className="flex flex-col h-full">
      <header className="border-b px-4 py-3 flex items-center justify-between">
        <h1 className="font-semibold text-lg">Direct Messages</h1>
        <StartDMDialog
          currentUserId={session.user.id}
          organizationId={workspace.id}
          workspaceSlug={workspaceSlug}
          members={workspaceMembers.filter((m) => m.id !== session.user.id)}
        />
      </header>

      <div className="flex-1 overflow-y-auto">
        {conversationsWithUsers.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64 text-muted-foreground">
            <MessageSquare className="h-12 w-12 mb-4" />
            <p>No conversations yet</p>
            <p className="text-sm">Start a new conversation above</p>
          </div>
        ) : (
          <ul className="divide-y">
            {conversationsWithUsers.map((conv) => (
              <li key={conv.id}>
                <Link
                  href={`/${workspaceSlug}/dm/${conv.id}`}
                  className="flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors"
                >
                  <div className="h-10 w-10 rounded-full bg-muted flex items-center justify-center text-sm font-medium shrink-0">
                    {conv.otherUser?.userImage ? (
                      <img
                        src={conv.otherUser.userImage}
                        alt=""
                        className="h-10 w-10 rounded-full object-cover"
                      />
                    ) : (
                      conv.otherUser?.userName?.charAt(0).toUpperCase() || "?"
                    )}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-medium truncate">
                      {conv.otherUser?.userName || conv.otherUser?.userEmail || "Unknown"}
                    </p>
                    {conv.lastMessageAt && (
                      <p className="text-xs text-muted-foreground">
                        {new Date(conv.lastMessageAt).toLocaleDateString()}
                      </p>
                    )}
                  </div>
                </Link>
              </li>
            ))}
          </ul>
        )}
      </div>
    </div>
  );
}
```

This creates a proper landing page for the DM tab that:
- Shows list of existing conversations
- Allows starting new conversations
- Works on mobile with proper touch targets
  </action>
  <verify>
Run: `npm run build` - no TypeScript errors
Run: `npm run dev` - navigate to /[workspace]/dm on mobile viewport, page loads
  </verify>
  <done>
DM list page exists and loads correctly on mobile.
Shows conversation list with links to individual DMs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix profile page spacing and channel header overflow (FIX-02, FIX-03)</name>
  <files>
    src/app/(workspace)/[workspaceSlug]/profile/page.tsx
    src/components/channel/channel-header.tsx
  </files>
  <action>
Fix FIX-02: Profile page title and back link spacing.

In `src/app/(workspace)/[workspaceSlug]/profile/page.tsx`:
Current issue: Title and back link in same row with justify-between, may look cramped.

Update the header section (around line 39-48):
```typescript
<div className="p-4 sm:p-8 max-w-2xl mx-auto">
  {/* Mobile: stack vertically. Desktop: side by side */}
  <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-6">
    <h1 className="text-xl sm:text-2xl font-bold">Your Profile</h1>
    <Link
      href={`/${workspaceSlug}`}
      className="text-sm text-primary hover:underline"
    >
      Back to workspace
    </Link>
  </div>
  {/* ... rest of content */}
</div>
```

Key changes:
- Reduce padding on mobile (p-4) vs desktop (sm:p-8)
- Stack title/back link vertically on mobile, horizontal on desktop
- Add gap-2 for consistent spacing
- Slightly smaller title on mobile (text-xl vs text-2xl)

---

Fix FIX-03: Channel header overflow menu for mobile.

In `src/components/channel/channel-header.tsx`:
Current issue: All action buttons shown inline, may overflow on mobile.

Add responsive hiding and overflow menu. Around line 162 (the actions div):

1. Hide individual buttons on mobile, show on desktop:
```typescript
<div className="hidden md:flex items-center gap-2 ml-4">
  {/* Existing buttons: NotificationSettingsDialog, ChannelNotesSheet, etc. */}
</div>
```

2. Add mobile overflow menu:
```typescript
import { MoreVertical } from "lucide-react";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

// After the desktop buttons div, add mobile menu:
<div className="md:hidden">
  <DropdownMenu>
    <DropdownMenuTrigger asChild>
      <Button variant="ghost" size="icon">
        <MoreVertical className="h-5 w-5" />
        <span className="sr-only">Channel actions</span>
      </Button>
    </DropdownMenuTrigger>
    <DropdownMenuContent align="end">
      {/* Members */}
      <DropdownMenuItem onSelect={() => setShowMembersDialog(true)}>
        <Users className="h-4 w-4 mr-2" />
        Members ({channel.memberCount})
      </DropdownMenuItem>
      {/* Leave */}
      <DropdownMenuItem
        onSelect={() => setShowLeaveDialog(true)}
        className="text-destructive"
      >
        <LogOut className="h-4 w-4 mr-2" />
        Leave channel
      </DropdownMenuItem>
    </DropdownMenuContent>
  </DropdownMenu>
</div>
```

Note: Some actions (notification settings, notes, pins) may need dialog triggers in dropdown. Keep critical actions (members, leave) in dropdown, others can be accessed via settings page on mobile.
  </action>
  <verify>
Run: `npm run build` - no TypeScript errors
Run: `npm run dev` - check profile page at mobile viewport, spacing looks correct
Run: `npm run dev` - check channel header at mobile viewport, shows overflow menu
  </verify>
  <done>
Profile page has proper spacing at mobile breakpoint.
Channel header shows overflow menu on mobile instead of cramped buttons.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix workspace name tooltip and nav highlighting (FIX-04, FIX-05)</name>
  <files>
    src/components/workspace/workspace-sidebar.tsx
    src/components/layout/mobile-tab-bar.tsx
  </files>
  <action>
Fix FIX-04: Truncated workspace names show full name on hover.

In `src/components/workspace/workspace-sidebar.tsx`:
Around line 100, the workspace name link:
```typescript
<Link href={`/${workspace.slug}`} className="font-bold truncate hover:underline">
  {workspace.name}
</Link>
```

Add title attribute for hover tooltip:
```typescript
<Link
  href={`/${workspace.slug}`}
  className="font-bold truncate hover:underline"
  title={workspace.name}
>
  {workspace.name}
</Link>
```

The native `title` attribute provides hover tooltip on desktop. For better UX, could use Tooltip component, but title is simpler and meets the requirement.

---

Fix FIX-05: Mobile navigation highlights correct route.

In `src/components/layout/mobile-tab-bar.tsx`:
Review the current isActive logic (lines 35-40):
```typescript
const isActive = pathname === tabHref ||
  (label === "Home" && pathname === `/${workspaceSlug}`) ||
  (label === "DMs" && pathname.startsWith(`/${workspaceSlug}/dm`)) ||
  ...
```

Current logic looks mostly correct, but may have edge cases:
1. After navigating to a channel, "Home" tab should still be active (channels are under home)
2. Channels are at `/${workspaceSlug}/channels/[slug]` - should highlight Home

Update logic to handle all routes:
```typescript
const getIsActive = (label: string, tabHref: string, pathname: string, workspaceSlug: string) => {
  // Exact match
  if (pathname === tabHref) return true;

  switch (label) {
    case "Home":
      // Home is active for workspace root and channels
      return pathname === `/${workspaceSlug}` ||
             pathname.startsWith(`/${workspaceSlug}/channels`);
    case "DMs":
      return pathname.startsWith(`/${workspaceSlug}/dm`);
    case "Mentions":
      return pathname.startsWith(`/${workspaceSlug}/threads`);
    case "Search":
      return pathname.startsWith(`/${workspaceSlug}/search`);
    case "Profile":
      return pathname.startsWith(`/${workspaceSlug}/profile`) ||
             pathname.startsWith(`/${workspaceSlug}/settings`);
    default:
      return false;
  }
};

// In the map:
const isActive = getIsActive(label, tabHref, pathname, workspaceSlug);
```

Key improvements:
- Channels highlight Home tab
- Settings routes highlight Profile tab (logical grouping)
- Cleaner, more maintainable logic
  </action>
  <verify>
Run: `npm run build` - no TypeScript errors
Run: `npm run dev` - hover over truncated workspace name, see full name in tooltip
Run: `npm run dev` - navigate between routes on mobile, correct tab highlighted
  </verify>
  <done>
Truncated workspace names show full name on hover.
Mobile navigation correctly highlights active route after all navigations.
Channels correctly highlight Home tab.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Manual testing:
   - Navigate to /[workspace]/dm on mobile - page loads (not 404)
   - Check profile page on mobile viewport - proper spacing
   - Check channel header on mobile viewport - overflow menu visible
   - Hover over long workspace name - tooltip shows full name
   - Navigate to channel on mobile - Home tab highlighted
   - Navigate to settings on mobile - Profile tab highlighted
</verification>

<success_criteria>
- /dm route returns valid page on mobile (FIX-01)
- Profile page has proper spacing on mobile (FIX-02)
- Channel header has overflow menu on mobile (FIX-03)
- Workspace name tooltip appears on hover (FIX-04)
- Mobile nav highlights correct route for all navigations (FIX-05)
</success_criteria>

<output>
After completion, create `.planning/phases/31-high-security-bug-fixes/31-04-SUMMARY.md`
</output>
