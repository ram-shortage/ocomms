---
phase: 31-high-security-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/sanitize.ts
  - src/server/socket/handlers/message.ts
  - src/app/api/notes/channel/route.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Messages with Unicode control characters display safely (no visual spoofing)"
    - "Channel notes HTML is sanitized (only safe tags allowed)"
    - "Sanitized content shows placeholder (box) where dangerous chars were"
  artifacts:
    - path: "src/lib/sanitize.ts"
      provides: "Unicode and HTML sanitization functions"
      exports: ["sanitizeUnicode", "sanitizeHtml"]
    - path: "src/server/socket/handlers/message.ts"
      provides: "Message handler with Unicode sanitization"
      contains: "sanitizeUnicode"
  key_links:
    - from: "src/server/socket/handlers/message.ts"
      to: "src/lib/sanitize.ts"
      via: "import and call on message content"
      pattern: "sanitizeUnicode.*content"
    - from: "src/app/api/notes/channel/route.ts"
      to: "src/lib/sanitize.ts"
      via: "import and call on notes content"
      pattern: "sanitizeHtml.*content"
---

<objective>
Implement content sanitization for Unicode control characters and HTML in channel notes.

Purpose: SEC2-05 requires sanitizing message content for Unicode control chars (visual spoofing attacks) and channel notes HTML (XSS prevention). This prevents attackers from using invisible characters to spoof messages or inject malicious scripts.

Output: Sanitization library with Unicode and HTML functions, integrated into message creation and channel notes API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/31-high-security-bug-fixes/31-CONTEXT.md
@.planning/phases/31-high-security-bug-fixes/31-RESEARCH.md
@src/server/socket/handlers/message.ts
@src/app/api/notes/channel/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install isomorphic-dompurify and create sanitization library</name>
  <files>
    package.json
    src/lib/sanitize.ts
  </files>
  <action>
Install isomorphic-dompurify for HTML sanitization:
```bash
npm install isomorphic-dompurify
```

Create `src/lib/sanitize.ts` with two functions:

1. `sanitizeUnicode(text: string): string`
   - Replace dangerous Unicode control characters with visible placeholder (U+25A1 = ‚ñ°)
   - Target ranges (from RESEARCH.md):
     - C0 controls: U+0000-U+0008, U+000B, U+000C, U+000E-U+001F (preserve tab U+0009, newline U+000A, CR U+000D)
     - DEL: U+007F
     - C1 controls: U+0080-U+009F
     - Zero-width space: U+200B (ZWSP)
     - Zero-width non-joiner: U+200C (ZWNJ)
     - RTL override: U+202E
   - PRESERVE Zero-width joiner (U+200D) for emoji sequences per RESEARCH.md pitfall #3

   Pattern:
   ```typescript
   const CONTROL_CHARS = /[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F\u0080-\u009F]/g;
   const ZERO_WIDTH_DANGEROUS = /[\u200B\u200C]/g;  // ZWSP and ZWNJ only, NOT ZWJ
   const RTL_OVERRIDE = /[\u202E]/g;

   export function sanitizeUnicode(text: string): string {
     return text
       .replace(CONTROL_CHARS, '\u25A1')
       .replace(ZERO_WIDTH_DANGEROUS, '\u25A1')
       .replace(RTL_OVERRIDE, '\u25A1');
   }
   ```

2. `sanitizeHtml(html: string): string`
   - Use isomorphic-dompurify with safe tag allowlist
   - Allowed tags (per CONTEXT.md): b, i, strong, em, a, p, ul, ol, li, br
   - Allowed attributes: href, title
   - Disable data attributes and unknown protocols

   Pattern:
   ```typescript
   import DOMPurify from 'isomorphic-dompurify';

   const ALLOWED_TAGS = ['b', 'i', 'strong', 'em', 'a', 'p', 'ul', 'ol', 'li', 'br'];
   const ALLOWED_ATTR = ['href', 'title'];

   export function sanitizeHtml(html: string): string {
     return DOMPurify.sanitize(html, {
       ALLOWED_TAGS,
       ALLOWED_ATTR,
       ALLOW_DATA_ATTR: false,
       ALLOW_UNKNOWN_PROTOCOLS: false,
     });
   }
   ```
  </action>
  <verify>
Run: `npm run build` - no TypeScript errors
Run: `npm test` - existing tests still pass
  </verify>
  <done>
Sanitization library created with Unicode and HTML functions.
isomorphic-dompurify installed and integrated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate sanitization into message creation</name>
  <files>
    src/server/socket/handlers/message.ts
  </files>
  <action>
Add Unicode sanitization to message creation in socket handler.

In `src/server/socket/handlers/message.ts`:
- Import sanitizeUnicode from '@/lib/sanitize'
- In the message creation handler (likely 'message:send' or similar):
  - Sanitize content BEFORE storing in database
  - Apply sanitizeUnicode to message content
  - Do NOT retroactively sanitize existing messages (per CONTEXT.md)

Find the message creation code (look for db.insert or similar) and add:
```typescript
import { sanitizeUnicode } from '@/lib/sanitize';

// In message handler
const sanitizedContent = sanitizeUnicode(data.content);
// Use sanitizedContent for database insert
```

Key points:
- Sanitize server-side BEFORE storage (not client-side)
- Going forward only - don't modify existing messages
- Preserve legitimate content (emojis with ZWJ will work)
  </action>
  <verify>
Run: `npm run build` - no TypeScript errors
Run: `npm test -- --grep "message"` - message tests still pass
  </verify>
  <done>
New messages are sanitized for Unicode control characters before storage.
Existing messages are not modified.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate HTML sanitization into channel notes API</name>
  <files>
    src/app/api/notes/channel/route.ts
    src/lib/sanitize.test.ts
  </files>
  <action>
Add HTML sanitization to channel notes PUT endpoint.

In `src/app/api/notes/channel/route.ts`:
- Import sanitizeHtml from '@/lib/sanitize'
- In the PUT handler, sanitize content before storing:
  - After validating input
  - Before inserting/updating in database

Find the content handling and add:
```typescript
import { sanitizeHtml } from '@/lib/sanitize';

// In PUT handler, after input validation
const sanitizedContent = sanitizeHtml(content);
// Use sanitizedContent for database operations
```

Create test file `src/lib/sanitize.test.ts`:
1. Unicode sanitization tests:
   - "replaces control characters with placeholder"
   - "preserves valid text and emoji"
   - "preserves zero-width joiner for emoji sequences"
   - "removes RTL override characters"
   - "preserves tabs, newlines, and carriage returns"

2. HTML sanitization tests:
   - "allows safe tags (b, i, strong, em, a, p, ul, ol, li, br)"
   - "removes script tags"
   - "removes style tags"
   - "removes onclick and other event handlers"
   - "preserves href and title attributes on links"
   - "removes data attributes"
  </action>
  <verify>
Run: `npm run build` - no TypeScript errors
Run: `npm test src/lib/sanitize.test.ts` - all sanitization tests pass
Run: `npm test src/app/api/notes` - notes API tests still pass
  </verify>
  <done>
Channel notes content is HTML sanitized before storage.
Only safe HTML tags are preserved.
Scripts and dangerous content are stripped.
Comprehensive tests verify sanitization behavior.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. All tests pass: `npm test`
3. Sanitization tests pass: `npm test src/lib/sanitize.test.ts`
4. Manual verification:
   - Create message with RTL override character - should show ‚ñ° placeholder
   - Create channel note with script tag - should be stripped
   - Create message with emoji (üë®‚Äçüíª) - should display correctly
</verification>

<success_criteria>
- Unicode control characters replaced with visible placeholder (‚ñ°)
- ZWJ preserved for emoji sequences (family emoji work correctly)
- Channel notes allow only safe HTML subset
- Scripts, styles, and event handlers stripped from notes
- Sanitization happens server-side before storage
- Existing content not retroactively modified
</success_criteria>

<output>
After completion, create `.planning/phases/31-high-security-bug-fixes/31-02-SUMMARY.md`
</output>
