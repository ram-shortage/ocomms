---
phase: 36-stabilization
plan: 03
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - e2e/tests/workspace/switcher.spec.ts
  - e2e/tests/workspace/discovery.spec.ts
  - e2e/tests/sidebar/reorder.spec.ts
  - e2e/tests/sidebar/categories.spec.ts
autonomous: true

must_haves:
  truths:
    - "User can view and switch between workspaces"
    - "User can browse and join available workspaces"
    - "Sidebar categories can be reordered via drag-and-drop"
    - "Channels can be moved between categories"
  artifacts:
    - path: "e2e/tests/workspace/switcher.spec.ts"
      provides: "Workspace switching tests"
      contains: "switch"
    - path: "e2e/tests/workspace/discovery.spec.ts"
      provides: "Workspace discovery tests"
      contains: "join"
    - path: "e2e/tests/sidebar/reorder.spec.ts"
      provides: "Sidebar reorder tests"
      contains: "drag"
    - path: "e2e/tests/sidebar/categories.spec.ts"
      provides: "Category management tests"
      contains: "category"
  key_links:
    - from: "e2e/tests/workspace/switcher.spec.ts"
      to: "workspace-switcher.page.ts"
      via: "page object usage"
      pattern: "WorkspaceSwitcher"
    - from: "e2e/tests/sidebar/reorder.spec.ts"
      to: "sidebar.page.ts"
      via: "drag-drop methods"
      pattern: "drag.*drop"
---

<objective>
Verify workspace management (WKSP2-*) and sidebar reorganization (SIDE-*) features work correctly.

Purpose: Ensure v0.6.0 workspace and sidebar features from Phases 33-34 function as designed. These are key new features that need integration verification.

Output: E2E test suite covering workspace switching, discovery, and sidebar drag-and-drop reordering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/36-stabilization/36-01-SUMMARY.md

# Page objects created in Plan 01
@e2e/pages/workspace-switcher.page.ts
@e2e/pages/sidebar.page.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Workspace Switcher and Discovery Tests</name>
  <files>
    e2e/tests/workspace/switcher.spec.ts
    e2e/tests/workspace/discovery.spec.ts
    e2e/pages/browse-workspaces.page.ts
  </files>
  <action>
Create comprehensive workspace management tests:

1. Create `e2e/pages/browse-workspaces.page.ts`:
   - BrowseWorkspacesPage class
   - Locators: workspaceCards, joinButton, requestButton, searchInput
   - Methods: goto(), searchWorkspaces(query), joinWorkspace(name), requestJoin(name)

2. Create `e2e/tests/workspace/switcher.spec.ts`:
   - Test: "user can see list of workspaces" (WKSP2-01)
     - Open workspace switcher dropdown
     - Verify user's workspaces are listed
     - Verify workspace names display correctly

   - Test: "user can switch workspaces" (WKSP2-02)
     - Open workspace switcher
     - Click different workspace
     - Verify URL changes to new workspace
     - Verify page content updates

   - Test: "workspace switcher shows unread counts" (WKSP2-06)
     - Setup: Have unread messages in another workspace
     - Open switcher
     - Verify unread badge/count visible for workspace with unreads

   - Test: "last visited workspace is restored on login"
     - Navigate to specific workspace/channel
     - Logout and login again
     - Verify returned to same location (or workspace)

3. Create `e2e/tests/workspace/discovery.spec.ts`:
   - Test: "user can browse available workspaces" (WKSP2-03)
     - Navigate to browse workspaces page (/browse-workspaces)
     - Verify workspace cards display
     - Verify workspaces user isn't in are shown

   - Test: "user can join open workspace instantly"
     - Find workspace with open join policy
     - Click join button
     - Verify added to workspace (appears in switcher)

   - Test: "user can request to join restricted workspace" (WKSP2-04)
     - Find workspace with request policy
     - Click request button
     - Verify request sent confirmation
     - Verify button changes to "Pending"

   - Test: "multi-user: owner approves join request" (WKSP2-05)
     - Context A: User requests to join
     - Context B: Owner sees request notification
     - Context B: Owner approves request
     - Context A: User now has access to workspace

Use multi-browser context for approval flow test.
  </action>
  <verify>
`npm run test:e2e -- tests/workspace/` passes
  </verify>
  <done>
Workspace switching, browsing, joining, and approval flows all verified
  </done>
</task>

<task type="auto">
  <name>Task 2: Sidebar Drag-and-Drop Reorder Tests</name>
  <files>
    e2e/tests/sidebar/reorder.spec.ts
    e2e/tests/sidebar/categories.spec.ts
    e2e/pages/sidebar.page.ts
  </files>
  <action>
Create sidebar reordering tests using Playwright's drag-and-drop API:

1. Extend `e2e/pages/sidebar.page.ts` with drag-drop helpers:
   - Add dragAndDrop(source: Locator, target: Locator) method
   - Add getCategoryOrder() -> string[] method
   - Add getChannelOrder(category: string) -> string[] method
   - Add getDMOrder() -> string[] method

2. Create `e2e/tests/sidebar/reorder.spec.ts`:
   - Test: "categories can be reordered" (SIDE-02)
     - Get initial category order
     - Drag first category to second position
     - Verify order changed
     - Refresh page, verify order persists

   - Test: "channels can be reordered within category" (SIDE-03)
     - Get initial channel order in a category
     - Drag channel to new position
     - Verify order changed
     - Verify change persists after refresh

   - Test: "channels can be moved between categories" (SIDE-04)
     - Drag channel from Category A to Category B
     - Verify channel now in Category B
     - Verify change persists

   - Test: "DM conversations can be reordered" (SIDE-05)
     - Get initial DM order
     - Drag DM conversation to new position
     - Verify order changed

   - Test: "sidebar sections can be reordered" (SIDE-06)
     - Get initial section order (Notes, Scheduled, etc.)
     - Drag section to new position
     - Verify order changed

   - Test: "sidebar order syncs across devices" (SIDE-08)
     - Context A: Reorder sidebar item
     - Context B: Refresh page
     - Verify Context B sees same order

3. Create `e2e/tests/sidebar/categories.spec.ts`:
   - Test: "New Category button is in Settings" (SIDE-01)
     - Verify New Category button NOT in sidebar
     - Navigate to Settings > Workspace
     - Verify New Category option available there

   - Test: "category order stored per-user" (SIDE-07)
     - Context A (user Alice): Reorder categories
     - Context B (user Bob): View sidebar
     - Verify Bob's order unchanged (each user has own order)

Use Playwright drag-and-drop:
```typescript
await page.locator('[data-category="dev"]').dragTo(
  page.locator('[data-category="general"]')
);
```
  </action>
  <verify>
`npm run test:e2e -- tests/sidebar/` passes
  </verify>
  <done>
All SIDE-* requirements verified via drag-and-drop tests
  </done>
</task>

</tasks>

<verification>
Run workspace and sidebar tests:
```bash
npm run test:e2e -- tests/workspace/ tests/sidebar/
```

Requirements coverage:
- WKSP2-01: View workspace list (switcher.spec.ts)
- WKSP2-02: Switch workspaces (switcher.spec.ts)
- WKSP2-03: Browse workspaces (discovery.spec.ts)
- WKSP2-04: Request to join (discovery.spec.ts)
- WKSP2-05: Owner approval (discovery.spec.ts)
- WKSP2-06: Unread counts (switcher.spec.ts)
- SIDE-01: New Category in Settings (categories.spec.ts)
- SIDE-02: Category reorder (reorder.spec.ts)
- SIDE-03: Channel reorder (reorder.spec.ts)
- SIDE-04: Channel move (reorder.spec.ts)
- SIDE-05: DM reorder (reorder.spec.ts)
- SIDE-06: Section reorder (reorder.spec.ts)
- SIDE-07: Per-user storage (categories.spec.ts)
- SIDE-08: Cross-device sync (reorder.spec.ts)
</verification>

<success_criteria>
- All workspace switcher flows work (view, switch, unread counts)
- Workspace discovery and join flows work
- Join request approval flow works with two users
- All sidebar drag-and-drop operations work
- Sidebar order persists after refresh
- Sidebar order syncs between sessions/devices for same user
- Different users have independent sidebar orders
</success_criteria>

<output>
After completion, create `.planning/phases/36-stabilization/36-03-SUMMARY.md`
</output>
