---
phase: 36-stabilization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.test.yml
  - e2e/playwright.config.ts
  - e2e/tests/auth.setup.ts
  - e2e/fixtures/test-fixtures.ts
  - e2e/pages/login.page.ts
  - e2e/pages/channel.page.ts
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Docker Compose test stack starts with healthy services"
    - "Playwright can connect to test app and run a basic test"
    - "Authentication state is saved and reused across tests"
  artifacts:
    - path: "docker-compose.test.yml"
      provides: "Test environment configuration"
      contains: "service_healthy"
    - path: "e2e/playwright.config.ts"
      provides: "Playwright test configuration"
      contains: "defineConfig"
    - path: "e2e/tests/auth.setup.ts"
      provides: "Authentication setup project"
      contains: "storageState"
    - path: "e2e/fixtures/test-fixtures.ts"
      provides: "Shared test fixtures"
      exports: ["test", "expect"]
    - path: "e2e/pages/login.page.ts"
      provides: "Login page object"
      exports: ["LoginPage"]
    - path: "e2e/pages/channel.page.ts"
      provides: "Channel page object"
      exports: ["ChannelPage"]
  key_links:
    - from: "e2e/playwright.config.ts"
      to: "docker-compose.test.yml"
      via: "webServer command"
      pattern: "docker compose.*test"
    - from: "e2e/tests/auth.setup.ts"
      to: "e2e/.auth/user.json"
      via: "storageState save"
      pattern: "storageState.*path"
---

<objective>
Set up E2E test infrastructure with Docker Compose test environment and Playwright configuration.

Purpose: Establish the foundation for all integration and verification tests. This infrastructure enables running tests against a production-like environment with proper isolation.

Output: Working test infrastructure that can start services, authenticate test users, and run basic browser tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-stabilization/36-RESEARCH.md

# Existing docker setup
@docker-compose.yml

# Existing package.json for dependencies
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker Compose Test Environment</name>
  <files>
    docker-compose.test.yml
    .env.test.example
  </files>
  <action>
Create `docker-compose.test.yml` based on production compose but optimized for testing:

1. Create docker-compose.test.yml with:
   - PostgreSQL with tmpfs for speed (RAM disk)
   - Redis for sessions/cache
   - App service building from Dockerfile
   - All services with healthchecks
   - No nginx (not needed for testing)
   - Test-appropriate environment variables

2. Key differences from production:
   - Database uses tmpfs (`/var/lib/postgresql/data`)
   - No persistent volumes
   - Shorter healthcheck intervals (5s)
   - `start_period: 60s` for app to allow build time
   - Test secrets (AUTH_SECRET min 32 chars)

3. Create `.env.test.example` with documented test environment variables

4. Add entries to .gitignore:
   - `e2e/.auth/` (auth state files)
   - `.env.test` (local test env)

Reference docker-compose.yml for service structure but simplify for testing.
  </action>
  <verify>
`docker compose -f docker-compose.test.yml config` validates without errors
  </verify>
  <done>
docker-compose.test.yml exists and passes config validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Set Up Playwright Configuration and Auth Setup</name>
  <files>
    e2e/playwright.config.ts
    e2e/tests/auth.setup.ts
    e2e/fixtures/test-fixtures.ts
    package.json
  </files>
  <action>
1. Install Playwright:
   ```bash
   npm install -D @playwright/test
   npx playwright install chromium --with-deps
   ```

2. Create `e2e/playwright.config.ts`:
   - Test directory: `./tests`
   - Projects: setup, chromium, mobile-chrome (Pixel 5), mobile-safari (iPhone 13)
   - Setup project runs auth.setup.ts first
   - Other projects depend on setup and use storageState
   - Mobile projects only match `**/mobile/**/*.spec.ts`
   - webServer: `docker compose -f docker-compose.test.yml up`
   - baseURL: `http://localhost:3000`
   - Retries: 2 in CI, 0 locally
   - Workers: 1 in CI (resource constraints)
   - trace: 'on-first-retry'
   - screenshot: 'only-on-failure'

3. Create `e2e/tests/auth.setup.ts`:
   - Navigate to sign-in page
   - Sign in with test user (alice@demo.ocomms.local / password123)
   - Wait for redirect to workspace
   - Save storage state to `e2e/.auth/user.json`

4. Create `e2e/fixtures/test-fixtures.ts`:
   - Export extended test with custom fixtures
   - Add authenticatedPage fixture (uses storage state)
   - Add testWorkspace fixture (returns 'acme-corp' slug)
   - Re-export expect from @playwright/test

5. Add npm scripts to package.json:
   - `"test:e2e": "npx playwright test"`
   - `"test:e2e:ui": "npx playwright test --ui"`
   - `"test:e2e:headed": "npx playwright test --headed"`
  </action>
  <verify>
`npm run test:e2e -- --list` shows available test projects without errors
  </verify>
  <done>
Playwright installed, config created, auth setup ready to run
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Page Object Models</name>
  <files>
    e2e/pages/login.page.ts
    e2e/pages/channel.page.ts
    e2e/pages/sidebar.page.ts
    e2e/pages/workspace-switcher.page.ts
    e2e/tests/smoke.spec.ts
  </files>
  <action>
1. Create `e2e/pages/login.page.ts`:
   - LoginPage class with Page dependency injection
   - Locators: emailInput, passwordInput, signInButton, errorMessage
   - Methods: goto(), login(email, password), expectLoggedIn()
   - Use getByLabel/getByRole for accessibility

2. Create `e2e/pages/channel.page.ts`:
   - ChannelPage class
   - Locators: messageInput, messageList, sendButton
   - Methods: goto(workspace, channel), sendMessage(text), expectMessageVisible(text, timeout?)
   - Use semantic locators (getByRole, getByPlaceholder)

3. Create `e2e/pages/sidebar.page.ts`:
   - SidebarPage class
   - Locators: categoryList, channelList, dmList
   - Methods: getCategory(name), getChannel(name), dragChannel(from, to)
   - Will be extended in Plan 03 for drag-drop tests

4. Create `e2e/pages/workspace-switcher.page.ts`:
   - WorkspaceSwitcherPage class
   - Locators: switcherDropdown, workspaceList, unreadBadges
   - Methods: open(), selectWorkspace(name), getUnreadCount(workspace)

5. Create `e2e/tests/smoke.spec.ts`:
   - Basic smoke test that verifies the infrastructure works
   - Test: "can load homepage" - navigates to /, expects page to load
   - Test: "can navigate to workspace" - uses auth, goes to /acme-corp
   - Uses fixtures from test-fixtures.ts

6. Run the smoke test to verify infrastructure:
   ```bash
   # Start test stack first
   docker compose -f docker-compose.test.yml up -d
   # Wait for healthy, then run smoke test
   npm run test:e2e -- tests/smoke.spec.ts
   ```
  </action>
  <verify>
`npm run test:e2e -- tests/smoke.spec.ts` passes (may need stack running)
  </verify>
  <done>
Page objects created, smoke test verifies infrastructure works end-to-end
  </done>
</task>

</tasks>

<verification>
1. `docker compose -f docker-compose.test.yml config` - validates compose file
2. `npm run test:e2e -- --list` - lists test projects
3. `docker compose -f docker-compose.test.yml up -d` - starts test stack
4. `npm run test:e2e -- tests/smoke.spec.ts` - runs smoke test

Full verification requires Phase 33-35 to be complete (test users/workspaces exist).
</verification>

<success_criteria>
- docker-compose.test.yml exists and validates
- Playwright installed and configured with 4 projects (setup, chromium, mobile-chrome, mobile-safari)
- Auth setup project saves storage state
- Page objects exist for login, channel, sidebar, workspace-switcher
- Smoke test passes against running test stack
</success_criteria>

<output>
After completion, create `.planning/phases/36-stabilization/36-01-SUMMARY.md`
</output>
