---
phase: 36-stabilization
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - e2e/tests/security/csp.spec.ts
  - e2e/tests/security/session.spec.ts
  - e2e/tests/security/auth.spec.ts
  - e2e/tests/security/mfa.spec.ts
autonomous: true

must_haves:
  truths:
    - "CSP headers include nonce and exclude unsafe-inline"
    - "Session revocation takes immediate effect"
    - "Password breach check blocks known compromised passwords"
    - "MFA setup and verification work end-to-end"
    - "Secure cookie prefix used in production mode"
    - "Redirect validation prevents open redirects"
    - "SRI hashes present on static assets"
    - "Socket.IO rejects unauthorized connections and rate limits rapid events"
    - "Security headers present on API routes"
  artifacts:
    - path: "e2e/tests/security/csp.spec.ts"
      provides: "CSP header verification tests"
      contains: "Content-Security-Policy"
    - path: "e2e/tests/security/session.spec.ts"
      provides: "Session security tests"
      contains: "revoke"
    - path: "e2e/tests/security/auth.spec.ts"
      provides: "Authentication security tests"
      contains: "breach"
    - path: "e2e/tests/security/mfa.spec.ts"
      provides: "MFA flow tests"
      contains: "totp"
  key_links:
    - from: "e2e/tests/security/csp.spec.ts"
      to: "response headers"
      via: "page.route interception"
      pattern: "response\\.headers"
    - from: "e2e/tests/security/mfa.spec.ts"
      to: "/api/auth/mfa"
      via: "API calls"
      pattern: "mfa.*setup"
---

<objective>
Verify all security requirements (SEC2-01 through SEC2-22) pass automated tests.

Purpose: Ensure security hardening from Phases 30-32 works correctly in a production-like environment. Automated tests catch regressions and verify security controls are active.

Output: Comprehensive security test suite that verifies CSP, session handling, authentication controls, and MFA functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/36-stabilization/36-01-SUMMARY.md

# Security implementation references
@src/middleware.ts
@src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSP and Header Security Tests</name>
  <files>
    e2e/tests/security/csp.spec.ts
    e2e/tests/security/headers.spec.ts
  </files>
  <action>
Create automated tests verifying security headers:

1. Create `e2e/tests/security/csp.spec.ts`:
   - Test: "CSP header includes nonce directive" (SEC2-01)
     - Navigate to any page
     - Intercept response with page.route
     - Extract Content-Security-Policy header
     - Verify contains `'nonce-` in script-src
     - Verify does NOT contain `'unsafe-inline'` or `'unsafe-eval'`

   - Test: "scripts on page use nonce attribute" (SEC2-01)
     - Navigate to page
     - Query all script elements
     - Verify inline scripts have nonce attribute
     - Verify nonce matches CSP header nonce

   - Test: "no CSP violations in console" (SEC2-01)
     - Listen for console messages
     - Navigate through several pages
     - Verify no "Content Security Policy" errors

2. Create `e2e/tests/security/headers.spec.ts`:
   - Test: "security headers present on API routes" (SEC2-18)
     - Make request to /api/health
     - Verify X-Content-Type-Options: nosniff
     - Verify X-Frame-Options present
     - Verify Referrer-Policy present

   - Test: "SRI hashes present on static assets" (SEC2-17)
     - Navigate to page
     - Find script/link tags for static assets
     - Verify integrity attribute present on appropriate assets

Use Playwright's route interception: `page.route('**/*', route => {...})`
  </action>
  <verify>
`npm run test:e2e -- tests/security/csp.spec.ts tests/security/headers.spec.ts` passes
  </verify>
  <done>
CSP nonce verification, header checks, and SRI verification all pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Session and Authentication Security Tests</name>
  <files>
    e2e/tests/security/session.spec.ts
    e2e/tests/security/auth.spec.ts
  </files>
  <action>
Create tests for session handling and authentication security:

1. Create `e2e/tests/security/session.spec.ts`:
   - Test: "session cookie uses secure prefix in production mode" (SEC2-11)
     - Check cookies after login
     - In production mode (NODE_ENV=production), verify cookie name starts with `__Secure-`
     - Note: May need conditional based on test environment

   - Test: "session revocation takes immediate effect" (SEC2-02)
     - Login in browser A context
     - Get session token/id
     - Make API call to revoke session (simulate from admin or user action)
     - In browser A, attempt protected action
     - Verify redirected to login or receives 401

   - Test: "logout clears session"
     - Login, verify access to protected page
     - Click logout / call logout API
     - Attempt to access protected page
     - Verify redirected to login

2. Create `e2e/tests/security/auth.spec.ts`:
   - Test: "password breach check blocks common passwords" (SEC2-09)
     - Navigate to signup page
     - Enter common breached password (e.g., "password123456")
     - Submit form
     - Verify error message about breached password

   - Test: "password history check blocks recent passwords" (SEC2-20)
     - Login as existing user
     - Go to change password
     - Try to set same password or recent password
     - Verify rejection with appropriate message

   - Test: "redirect validation prevents open redirect" (SEC2-14)
     - Attempt login with malicious returnUrl (external domain)
     - Verify redirect goes to safe default, not external URL

Use multi-context pattern for session revocation test:
```typescript
const contextA = await browser.newContext();
const contextB = await browser.newContext();
```
  </action>
  <verify>
`npm run test:e2e -- tests/security/session.spec.ts tests/security/auth.spec.ts` passes
  </verify>
  <done>
Session revocation, logout, password breach check, and redirect validation all verified
  </done>
</task>

<task type="auto">
  <name>Task 3: MFA and Additional Security Tests</name>
  <files>
    e2e/tests/security/mfa.spec.ts
    e2e/tests/security/socketio.spec.ts
  </files>
  <action>
Create tests for MFA and remaining security features:

1. Create `e2e/tests/security/mfa.spec.ts`:
   - Test: "MFA setup shows QR code and backup codes" (SEC2-21)
     - Login as user without MFA
     - Navigate to security settings
     - Click "Enable MFA"
     - Verify QR code is displayed
     - Verify backup codes are shown
     - Note: Actual TOTP verification requires OTP library in tests

   - Test: "MFA verification required after setup"
     - Setup MFA for test user (may need API call)
     - Logout and login again
     - Verify MFA code entry screen appears
     - Note: Full TOTP verification may be out of scope for E2E

2. Create `e2e/tests/security/socketio.spec.ts`:
   - Test: "Socket.IO connection works from allowed origin" (SEC2-13)
     - Connect to Socket.IO from page
     - Verify connection established
     - Send test event, verify response

   - Test: "rapid events are rate limited" (SEC2-04)
     - Connect to Socket.IO
     - Send many events rapidly (> 30/sec)
     - Verify rate limit toast/error appears
     - Verify connection still works after cooldown

   - Test: "unauthorized user cannot access protected socket events"
     - Without authentication, try to join room
     - Verify rejection/disconnect

Note on MFA testing: Full TOTP flow requires generating valid codes. Options:
- Use otpauth library to generate test codes
- Or test just the UI flow (setup screens, input fields) without code verification
- CONTEXT decision: Test UI flow, skip actual TOTP code generation for simplicity
  </action>
  <verify>
`npm run test:e2e -- tests/security/mfa.spec.ts tests/security/socketio.spec.ts` passes
  </verify>
  <done>
MFA setup UI verified, Socket.IO CORS and rate limiting confirmed working
  </done>
</task>

</tasks>

<verification>
Run all security tests:
```bash
npm run test:e2e -- tests/security/
```

Expected coverage of security requirements:
- SEC2-01: CSP nonce (csp.spec.ts)
- SEC2-02: Session revocation (session.spec.ts)
- SEC2-04: Socket rate limiting (socketio.spec.ts)
- SEC2-09: Password breach (auth.spec.ts)
- SEC2-11: Secure cookie prefix (session.spec.ts)
- SEC2-13: Socket CORS (socketio.spec.ts)
- SEC2-14: Redirect validation (auth.spec.ts)
- SEC2-17: SRI hashes (headers.spec.ts)
- SEC2-18: API security headers (headers.spec.ts)
- SEC2-20: Password history (auth.spec.ts)
- SEC2-21: MFA (mfa.spec.ts)

Note: Some requirements (SEC2-03 SVG, SEC2-05 Unicode, SEC2-10 quotas, etc.) are better verified via unit tests or manual inspection and are already covered in their respective phase implementations.
</verification>

<success_criteria>
- All security spec files created and tests pass
- CSP nonce verified present, unsafe-inline absent
- Session revocation verified as immediate
- Password breach check blocks common passwords
- MFA setup UI flow works
- Socket.IO rate limiting triggers on rapid events
</success_criteria>

<output>
After completion, create `.planning/phases/36-stabilization/36-02-SUMMARY.md`
</output>
