---
phase: 30-critical-security
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/file-validation.ts
  - src/app/api/upload/attachment/route.ts
  - src/app/api/upload/emoji/route.ts
  - public/file.svg (deleted)
  - public/vercel.svg (deleted)
  - public/next.svg (deleted)
  - public/globe.svg (deleted)
  - public/window.svg (deleted)
autonomous: true

must_haves:
  truths:
    - "SVG uploads are rejected with clear error message"
    - "SVG content detection blocks spoofed MIME types"
    - "No SVG files exist in public directory"
    - "Emoji upload no longer accepts SVG input"
  artifacts:
    - path: "src/lib/file-validation.ts"
      provides: "File validation that blocks SVGs"
      exports: ["validateFileSignature"]
    - path: "src/app/api/upload/attachment/route.ts"
      provides: "Attachment upload rejecting SVGs"
      contains: "Invalid file type"
    - path: "src/app/api/upload/emoji/route.ts"
      provides: "Emoji upload rejecting SVGs"
      contains: "Invalid file type"
  key_links:
    - from: "src/app/api/upload/attachment/route.ts"
      to: "src/lib/file-validation.ts"
      via: "validateFileSignature import"
      pattern: "validateFileSignature"
    - from: "src/app/api/upload/emoji/route.ts"
      to: "src/lib/file-validation.ts"
      via: "validateFileSignature import"
      pattern: "validateFileSignature"
---

<objective>
Block all SVG uploads and convert existing system SVG assets to raster formats.

Purpose: SVGs can contain JavaScript and execute XSS attacks. Per CONTEXT.md decision, block ALL SVGs rather than attempt sanitization. Convert system assets to WebP/PNG for complete SVG elimination.

Output: Updated file validation that rejects SVGs, updated upload routes, and converted system assets.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-critical-security/30-RESEARCH.md
@.planning/phases/30-critical-security/30-CONTEXT.md
@src/lib/file-validation.ts
@src/app/api/upload/attachment/route.ts
@src/app/api/upload/emoji/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update file validation to reject SVGs</name>
  <files>src/lib/file-validation.ts</files>
  <action>
1. Update `src/lib/file-validation.ts`:
   - REMOVE the SVG detection block (lines 83-92 that return svg extension)
   - ADD explicit SVG rejection that returns null (existing behavior for unknown types)
   - ADD helper function to detect SVG content for security logging:

   ```typescript
   /**
    * Check if content appears to be SVG (for security logging).
    * Returns true if SVG content detected.
    */
   export function isSvgContent(bytes: Uint8Array): boolean {
     const textStart = new TextDecoder().decode(bytes.slice(0, 200));
     return (
       textStart.trim().startsWith('<?xml') ||
       textStart.trim().startsWith('<svg') ||
       textStart.includes('<svg')
     );
   }
   ```

2. Update the main `validateFileSignature` function comments to clarify SVG is NOT supported:
   ```typescript
   /**
    * Validate file signature (magic bytes) and return file type info.
    * Returns null if file signature doesn't match any allowed type.
    *
    * Supported types:
    * - Images: JPEG, PNG, GIF, WebP
    * - Documents: PDF
    *
    * NOT supported (security risk):
    * - SVG (can contain JavaScript, XSS vector)
    */
   ```

The function now returns null for SVGs, which is already handled as rejection by upload routes.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - validateFileSignature returns null for SVG content
    - isSvgContent helper correctly detects SVG
  </verify>
  <done>
    - SVG detection removed from allowed types
    - Helper function added for SVG content detection
    - Documentation updated to explain SVG exclusion
  </done>
</task>

<task type="auto">
  <name>Task 2: Update upload routes to explicitly reject SVGs</name>
  <files>
    src/app/api/upload/attachment/route.ts
    src/app/api/upload/emoji/route.ts
  </files>
  <action>
1. Update `src/app/api/upload/attachment/route.ts`:
   - Import { isSvgContent } from '@/lib/file-validation'
   - After reading file bytes (uint8), BEFORE validateFileSignature:
     ```typescript
     // Explicit SVG blocking with security logging
     if (isSvgContent(uint8)) {
       console.warn('[Security] SVG upload blocked:', {
         filename: file.name,
         userId: session.user.id,
         timestamp: new Date().toISOString(),
       });
       return NextResponse.json(
         { error: "SVG files are not allowed for security reasons" },
         { status: 400 }
       );
     }
     ```
   - This provides explicit error message rather than generic "Invalid file type"
   - Logs blocked attempts for security monitoring

2. Update `src/app/api/upload/emoji/route.ts`:
   - Import { isSvgContent } from '@/lib/file-validation'
   - REMOVE the SVG conversion logic (lines 99, 109-119)
   - Remove 'svg' from the allowed extensions check
   - Change line 99 from:
     `if (!validated || !["png", "jpg", "gif", "webp", "svg"].includes(validated.extension))`
     to:
     `if (!validated || !["png", "jpg", "gif", "webp"].includes(validated.extension))`
   - Add explicit SVG check before validation (same as attachment route)
   - Update error message: "Invalid file type. Allowed: PNG, JPG, GIF, WebP"

Note: The emoji route previously converted SVG to PNG. Now it simply rejects SVG entirely.
  </action>
  <verify>
    - Uploading SVG to /api/upload/attachment returns 400 with "SVG files are not allowed"
    - Uploading SVG to /api/upload/emoji returns 400 with "Invalid file type"
    - Uploading PNG/JPG/GIF/WebP still works
    - Security log appears when SVG blocked
  </verify>
  <done>
    - Attachment upload explicitly rejects SVGs with clear message
    - Emoji upload rejects SVGs (no conversion fallback)
    - Security logging for blocked SVG attempts
    - Other image types still work correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert system SVG assets to PNG</name>
  <files>
    public/file.svg -> public/file.png
    public/vercel.svg (delete - not needed)
    public/next.svg (delete - not needed)
    public/globe.svg (delete - not needed)
    public/window.svg (delete - not needed)
  </files>
  <action>
1. Analyze existing SVG files in public/:
   - file.svg - likely a file icon used in app
   - vercel.svg, next.svg, globe.svg, window.svg - Next.js template defaults, likely unused

2. Check if any SVGs are actually referenced in codebase:
   ```bash
   grep -r "file.svg\|vercel.svg\|next.svg\|globe.svg\|window.svg" src/
   ```

3. For file.svg (if used):
   - Use Sharp to convert to PNG: `npx sharp-cli -i public/file.svg -o public/file.png`
   - Or use online converter if sharp-cli not available
   - Alternative: Create simple file icon as PNG using any tool

4. For unused template SVGs (vercel, next, globe, window):
   - Simply delete them: `rm public/vercel.svg public/next.svg public/globe.svg public/window.svg`
   - These are boilerplate from create-next-app

5. Update any code references from .svg to .png:
   - Search codebase for references
   - Update import paths or src attributes

6. Verify no SVG files remain:
   ```bash
   find public -name "*.svg" -type f
   ```
   Should return empty.

Note: If file.svg is used somewhere and has complex content, may need to find/create a suitable PNG replacement. Simple icons can be recreated easily.
  </action>
  <verify>
    - `find public -name "*.svg"` returns nothing
    - Any references to converted files work correctly
    - App still renders correctly (no missing icons)
  </verify>
  <done>
    - All template SVGs deleted (vercel, next, globe, window)
    - file.svg converted to PNG if used, or deleted if unused
    - No SVG files in public directory
    - Codebase references updated if needed
  </done>
</task>

</tasks>

<verification>
1. Try uploading SVG via attachment endpoint - should return 400
2. Try uploading SVG via emoji endpoint - should return 400
3. Upload PNG/JPG - should succeed
4. Check server logs for "[Security] SVG upload blocked" entries
5. Run `find public -name "*.svg"` - should return empty
6. Build and run app - verify no broken images
7. Check no references to .svg files in rendered pages
</verification>

<success_criteria>
- SVG uploads blocked on all routes
- Clear error messages for SVG rejection
- Security logging for blocked attempts
- No SVG files in public directory
- App functions normally with converted/removed assets
</success_criteria>

<output>
After completion, create `.planning/phases/30-critical-security/30-03-SUMMARY.md`
</output>
