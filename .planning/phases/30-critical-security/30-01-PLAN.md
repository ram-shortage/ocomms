---
phase: 30-critical-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware.ts
  - src/app/layout.tsx
  - src/app/api/csp-report/route.ts
  - src/lib/security/csp.ts
autonomous: true

must_haves:
  truths:
    - "Application loads without inline script CSP violations"
    - "All script tags use nonces generated per-request"
    - "CSP violations are logged to server endpoint"
    - "Development mode allows unsafe-eval for hot reload"
  artifacts:
    - path: "src/lib/security/csp.ts"
      provides: "CSP header generation with nonces"
      exports: ["generateCSP", "generateNonce"]
    - path: "src/app/api/csp-report/route.ts"
      provides: "CSP violation reporting endpoint"
      exports: ["POST"]
    - path: "src/middleware.ts"
      provides: "CSP header injection with nonce"
      contains: "x-nonce"
    - path: "src/app/layout.tsx"
      provides: "Nonce propagation to scripts"
      contains: "headers().get"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/security/csp.ts"
      via: "import generateCSP, generateNonce"
      pattern: "generateCSP|generateNonce"
    - from: "src/app/layout.tsx"
      to: "x-nonce header"
      via: "headers().get('x-nonce')"
      pattern: "headers.*x-nonce"
---

<objective>
Implement Content Security Policy with nonce-based script loading to eliminate inline script XSS vectors.

Purpose: Removes unsafe-inline and unsafe-eval from production CSP, using cryptographic nonces for authorized scripts. This is a critical security control against XSS attacks.

Output: CSP middleware with per-request nonces, nonce propagation to layout, and violation reporting endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-critical-security/30-RESEARCH.md
@.planning/phases/30-critical-security/30-CONTEXT.md
@src/middleware.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSP utility and update middleware</name>
  <files>
    src/lib/security/csp.ts
    src/middleware.ts
  </files>
  <action>
1. Create `src/lib/security/csp.ts`:
   - `generateNonce()`: Returns base64-encoded crypto.randomUUID() for 128+ bits entropy
   - `generateCSP(nonce: string, isDev: boolean)`: Builds CSP header string

   CSP directives (production):
   ```
   default-src 'self';
   script-src 'self' 'nonce-{nonce}' 'strict-dynamic';
   style-src 'self' 'unsafe-inline';  // Per CONTEXT.md decision
   img-src 'self' blob: data:;
   font-src 'self';
   object-src 'none';
   base-uri 'self';
   form-action 'self';
   frame-ancestors 'none';
   upgrade-insecure-requests;
   report-uri /api/csp-report;
   ```

   Development mode additions to script-src:
   - Add `'unsafe-eval'` (required for Next.js hot reload)

2. Update `src/middleware.ts`:
   - Import generateNonce, generateCSP from '@/lib/security/csp'
   - Generate nonce at start of middleware
   - Set 'x-nonce' request header for downstream access
   - Set 'Content-Security-Policy' response header
   - Detect dev mode via process.env.NODE_ENV
   - Keep existing session validation logic unchanged
   - Add '/api/csp-report' to public routes (allow violation reports without auth)

Important: Use `.replace(/\s{2,}/g, ' ').trim()` to format CSP header (remove excess whitespace).
  </action>
  <verify>
    - `npm run build` completes without errors
    - `npm run dev` starts without CSP self-blocking
    - Check response headers include Content-Security-Policy with nonce
  </verify>
  <done>
    - Middleware generates unique nonce per request
    - CSP header present on all page responses
    - Development mode includes unsafe-eval, production does not
  </done>
</task>

<task type="auto">
  <name>Task 2: Propagate nonce to layout and scripts</name>
  <files>src/app/layout.tsx</files>
  <action>
1. Update `src/app/layout.tsx`:
   - Import `headers` from 'next/headers'
   - Make RootLayout async
   - Read nonce from headers: `const nonce = (await headers()).get('x-nonce') || ''`
   - Pass nonce to any Script components via nonce prop
   - If using next/script for analytics or third-party, add nonce={nonce}

2. For this app (no external scripts currently), the nonce is read but may not need immediate use. The key is that the infrastructure is in place for any future Script components.

Note: Next.js automatically handles nonces for its own framework scripts when CSP is configured via middleware. The layout change ensures any additional Script components also get nonces.
  </action>
  <verify>
    - Page loads without CSP violations in browser console
    - View page source shows no blocked scripts
    - `npm run build && npm start` works in production mode
  </verify>
  <done>
    - Layout reads nonce from request headers
    - No inline script CSP violations on page load
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSP violation reporting endpoint</name>
  <files>src/app/api/csp-report/route.ts</files>
  <action>
1. Create `src/app/api/csp-report/route.ts`:
   - Export POST handler
   - Parse JSON body (CSP reports use 'csp-report' wrapper for report-uri format)
   - Extract violation details: documentUri, violatedDirective, blockedUri
   - Log to console.error with structured format (timestamp, userAgent, details)
   - Return 204 No Content (standard for report endpoints)
   - Wrap in try/catch, return 400 on parse errors

Example log format:
```typescript
console.error('CSP Violation:', {
  documentUri: report['csp-report']?.documentUri,
  violatedDirective: report['csp-report']?.violatedDirective,
  blockedUri: report['csp-report']?.blockedUri,
  timestamp: new Date().toISOString(),
  userAgent: request.headers.get('user-agent'),
})
```

Note: No authentication required for this endpoint (violations reported by browser, not user-initiated).
  </action>
  <verify>
    - `curl -X POST http://localhost:3000/api/csp-report -H "Content-Type: application/json" -d '{"csp-report":{"document-uri":"test"}}' -v` returns 204
    - Violation appears in server logs
  </verify>
  <done>
    - POST /api/csp-report accepts violation reports
    - Returns 204 on success, 400 on parse error
    - Violations logged with structured format
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Open browser DevTools Network tab
3. Navigate to any page
4. Verify Response Headers include `Content-Security-Policy` with nonce
5. Check Console for any CSP violations (should be none)
6. Build production: `npm run build && npm start`
7. Verify production CSP does NOT include `unsafe-eval`
8. Test violation reporting: intentionally inject inline script, verify report logged
</verification>

<success_criteria>
- Content-Security-Policy header present on all page responses
- Nonce is unique per request (refresh page, nonce changes)
- Production build works without CSP violations
- Development build works with hot reload
- CSP violation endpoint receives and logs reports
</success_criteria>

<output>
After completion, create `.planning/phases/30-critical-security/30-01-SUMMARY.md`
</output>
