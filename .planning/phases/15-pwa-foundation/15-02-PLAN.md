---
phase: 15-pwa-foundation
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/sw.ts
  - src/app/offline/page.tsx
  - src/lib/pwa/register-sw.ts
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Service worker registers and caches app shell on first visit"
    - "Offline page displays when navigating without network"
    - "App loads instantly from cache on repeat visits"
  artifacts:
    - path: "src/app/sw.ts"
      provides: "Service worker with precaching and offline fallback"
      contains: "Serwist"
    - path: "src/app/offline/page.tsx"
      provides: "Custom offline page with retry button"
      exports: ["default"]
    - path: "src/lib/pwa/register-sw.ts"
      provides: "Service worker registration with update detection"
      exports: ["registerServiceWorker", "acceptUpdate"]
  key_links:
    - from: "src/app/sw.ts"
      to: "/offline"
      via: "fallback configuration"
      pattern: 'url:.*"/offline"'
    - from: "src/lib/pwa/register-sw.ts"
      to: "/sw.js"
      via: "Workbox registration"
      pattern: 'Workbox.*"/sw.js"'
    - from: "src/app/layout.tsx"
      to: "src/lib/pwa/register-sw.ts"
      via: "PWA provider registration"
      pattern: "registerServiceWorker"
---

<objective>
Create service worker, offline page, and SW registration hook.

Purpose: Implement core PWA functionality - service worker enables caching for instant repeat loads and offline fallback page provides graceful degradation.
Output: Working service worker with stale-while-revalidate caching, custom offline page, and registration hook.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-pwa-foundation/15-CONTEXT.md
@.planning/phases/15-pwa-foundation/15-RESEARCH.md
@.planning/phases/15-pwa-foundation/15-01-SUMMARY.md
@src/app/layout.tsx
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service worker and offline page</name>
  <files>src/app/sw.ts, src/app/offline/page.tsx</files>
  <action>
    1. Create src/app/sw.ts following Serwist pattern:
       ```typescript
       import { defaultCache } from "@serwist/next/worker";
       import type { PrecacheEntry, SerwistGlobalConfig } from "serwist";
       import { Serwist } from "serwist";

       declare global {
         interface WorkerGlobalScope extends SerwistGlobalConfig {
           __SW_MANIFEST: (PrecacheEntry | string)[] | undefined;
         }
       }

       declare const self: ServiceWorkerGlobalScope;

       const serwist = new Serwist({
         precacheEntries: self.__SW_MANIFEST,
         skipWaiting: false, // User controls updates (per CONTEXT.md)
         clientsClaim: true,
         navigationPreload: true,
         runtimeCaching: defaultCache,
         fallbacks: {
           entries: [{
             url: "/offline",
             matcher({ request }) {
               return request.destination === "document";
             },
           }],
         },
       });

       // Listen for skip waiting message from main thread
       self.addEventListener("message", (event) => {
         if (event.data && event.data.type === "SKIP_WAITING") {
           self.skipWaiting();
         }
       });

       serwist.addEventListeners();
       ```

    2. Create src/app/offline/page.tsx:
       - "use client" directive (needs useEffect for online detection)
       - Simple centered layout with "You're offline" heading
       - Muted description text
       - Retry button that calls window.location.reload()
       - useEffect that listens for "online" event and auto-reloads
       - Use Tailwind classes consistent with existing UI (see src/components/ui/)
       - Keep it minimal per CONTEXT.md: "more features come in Phase 16"
  </action>
  <verify>
    `npm run build` succeeds and generates public/sw.js
    `cat src/app/sw.ts` shows Serwist configuration with offline fallback
    `cat src/app/offline/page.tsx` shows offline page component
  </verify>
  <done>
    Service worker configured with precaching and offline fallback, offline page ready
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SW registration and update layout metadata</name>
  <files>src/lib/pwa/register-sw.ts, src/app/layout.tsx</files>
  <action>
    1. Create src/lib/pwa/register-sw.ts:
       ```typescript
       import { Workbox } from "workbox-window";

       let wb: Workbox | null = null;
       let updateCallback: (() => void) | null = null;

       export function registerServiceWorker(onUpdate?: () => void) {
         if (typeof window === "undefined" || !("serviceWorker" in navigator)) {
           return null;
         }

         // Don't register in development
         if (process.env.NODE_ENV === "development") {
           return null;
         }

         updateCallback = onUpdate || null;
         wb = new Workbox("/sw.js");

         // Fires when new SW installed but waiting
         wb.addEventListener("waiting", () => {
           if (updateCallback) {
             updateCallback();
           }
         });

         // Fires when new SW takes control
         wb.addEventListener("controlling", () => {
           window.location.reload();
         });

         wb.register();
         return wb;
       }

       export function acceptUpdate() {
         if (wb) {
           wb.messageSkipWaiting();
         }
       }
       ```

    2. Update src/app/layout.tsx:
       - Add PWA metadata to existing Metadata export:
         - applicationName: "OComms"
         - Update title to "OComms"
         - Update description to "Secure team communication"
         - Add appleWebApp object: { capable: true, statusBarStyle: "default", title: "OComms" }
         - Add formatDetection: { telephone: false }

       - Add Viewport export:
         - themeColor: "#000000"
         - width: "device-width"
         - initialScale: 1
         - maximumScale: 1
         - userScalable: false

       - Do NOT add SW registration to layout.tsx directly - that will be done via a client component in Plan 03

    Note: The actual SW registration will be wired through a PWAProvider component in Plan 03.
  </action>
  <verify>
    `cat src/lib/pwa/register-sw.ts` shows registerServiceWorker and acceptUpdate exports
    `grep -A5 "appleWebApp" src/app/layout.tsx` shows PWA metadata
    `npm run build` succeeds
  </verify>
  <done>
    SW registration hook ready with update detection, layout has PWA metadata and viewport
  </done>
</task>

</tasks>

<verification>
1. `npm run build` generates public/sw.js without errors
2. After build, `head -20 public/sw.js` shows Serwist-generated service worker
3. Production build serves /offline route as valid page
4. layout.tsx contains appleWebApp metadata
5. register-sw.ts exports both registerServiceWorker and acceptUpdate
</verification>

<success_criteria>
- Service worker source (sw.ts) uses Serwist with stale-while-revalidate caching
- Service worker has offline document fallback to /offline
- Offline page displays "You're offline" message with retry button
- Offline page auto-refreshes when connection returns
- SW registration hook uses workbox-window for lifecycle management
- Layout has complete PWA metadata (appleWebApp, viewport, theme color)
- Build generates public/sw.js
</success_criteria>

<output>
After completion, create `.planning/phases/15-pwa-foundation/15-02-SUMMARY.md`
</output>
