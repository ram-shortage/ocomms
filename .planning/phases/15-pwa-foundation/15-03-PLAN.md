---
phase: 15-pwa-foundation
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - src/components/pwa/InstallPrompt.tsx
  - src/components/pwa/IOSInstallGuide.tsx
  - src/components/pwa/UpdateNotification.tsx
  - src/components/pwa/OfflineBanner.tsx
  - src/components/pwa/PWAProvider.tsx
  - src/components/pwa/index.ts
  - src/lib/pwa/use-install-prompt.ts
  - src/lib/pwa/use-ios-install.ts
  - src/lib/pwa/use-online-status.ts
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Install prompt appears after user engagement (not immediately)"
    - "Clicking install button triggers native browser install flow"
    - "iOS users see Add to Home Screen instructions with Safari share icon"
    - "Update notification appears when new SW version waiting"
    - "Clicking refresh in update notification activates new SW"
    - "Offline banner shows when network unavailable"
  artifacts:
    - path: "src/components/pwa/InstallPrompt.tsx"
      provides: "Chromium install banner with engagement tracking"
      exports: ["InstallPrompt"]
    - path: "src/components/pwa/IOSInstallGuide.tsx"
      provides: "iOS Safari Add to Home Screen instructions"
      exports: ["IOSInstallGuide"]
    - path: "src/components/pwa/UpdateNotification.tsx"
      provides: "Service worker update toast"
      exports: ["UpdateNotification"]
    - path: "src/components/pwa/OfflineBanner.tsx"
      provides: "Persistent offline status indicator"
      exports: ["OfflineBanner"]
    - path: "src/components/pwa/PWAProvider.tsx"
      provides: "Client component that orchestrates all PWA features"
      exports: ["PWAProvider"]
  key_links:
    - from: "src/components/pwa/InstallPrompt.tsx"
      to: "beforeinstallprompt event"
      via: "useInstallPrompt hook"
      pattern: "beforeinstallprompt"
    - from: "src/components/pwa/UpdateNotification.tsx"
      to: "src/lib/pwa/register-sw.ts"
      via: "acceptUpdate callback"
      pattern: "acceptUpdate"
    - from: "src/app/layout.tsx"
      to: "src/components/pwa/PWAProvider.tsx"
      via: "component import and render"
      pattern: "PWAProvider"
---

<objective>
Create PWA UI components (install prompt, iOS guide, update notification, offline banner) and wire them to layout.

Purpose: Complete the user-facing PWA experience - install prompts drive adoption, update notifications ensure users get latest code, offline banner provides status awareness.
Output: Fully functional PWA with install flow, update mechanism, and offline indication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-pwa-foundation/15-CONTEXT.md
@.planning/phases/15-pwa-foundation/15-RESEARCH.md
@.planning/phases/15-pwa-foundation/15-02-SUMMARY.md
@src/app/layout.tsx
@src/lib/pwa/register-sw.ts
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PWA hooks</name>
  <files>src/lib/pwa/use-install-prompt.ts, src/lib/pwa/use-ios-install.ts, src/lib/pwa/use-online-status.ts</files>
  <action>
    1. Create src/lib/pwa/use-install-prompt.ts:
       - Define BeforeInstallPromptEvent interface (extends Event with prompt() and userChoice)
       - Track deferredPrompt, isInstallable, isInstalled states
       - Check if already in standalone mode on mount (display-mode: standalone)
       - Listen for beforeinstallprompt event, preventDefault, store prompt
       - Listen for appinstalled event to update isInstalled
       - Provide promptInstall function that calls deferredPrompt.prompt()
       - Track engagement: page views (increment on mount) and time spent
       - Only set isInstallable=true after engagement threshold (3 pages OR 30 seconds)
       - Use localStorage key "pwa-install-dismissed" to check if user dismissed
       - Export: { isInstallable, isInstalled, promptInstall, dismiss }

    2. Create src/lib/pwa/use-ios-install.ts:
       - Detect iOS via userAgent (/iphone|ipad|ipod/i)
       - Check navigator.standalone for already-installed state
       - Check localStorage "pwa-ios-dismissed" for dismiss state
       - Export: { shouldShowIOSPrompt, dismissIOSPrompt }

    3. Create src/lib/pwa/use-online-status.ts:
       - Initialize with navigator.onLine
       - Listen for online/offline events
       - Export: { isOnline }
  </action>
  <verify>
    `cat src/lib/pwa/use-install-prompt.ts` shows hook with engagement tracking
    `cat src/lib/pwa/use-ios-install.ts` shows iOS detection logic
    `cat src/lib/pwa/use-online-status.ts` shows online status hook
    TypeScript compiles without errors
  </verify>
  <done>
    All three PWA hooks created with proper engagement tracking and localStorage persistence
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PWA UI components</name>
  <files>src/components/pwa/InstallPrompt.tsx, src/components/pwa/IOSInstallGuide.tsx, src/components/pwa/UpdateNotification.tsx, src/components/pwa/OfflineBanner.tsx, src/components/pwa/index.ts</files>
  <action>
    1. Create src/components/pwa/InstallPrompt.tsx:
       - "use client" directive
       - Use useInstallPrompt hook
       - Render dismissible bottom banner (fixed bottom, full width, z-50)
       - Show app icon, "Install OComms" text, brief benefit ("Fast access from home screen")
       - Two buttons: "Install" (calls promptInstall) and "X" dismiss (calls dismiss)
       - Use Button component from @/components/ui/button
       - Only render if isInstallable && !isInstalled
       - Animate in with Tailwind (translate-y transition)

    2. Create src/components/pwa/IOSInstallGuide.tsx:
       - "use client" directive
       - Use useIOSInstall hook
       - Modal/dialog with step-by-step instructions
       - Step 1: "Tap the Share button" with Safari share icon (can use emoji or inline SVG)
       - Step 2: "Scroll down and tap 'Add to Home Screen'"
       - Step 3: "Tap 'Add' in the top right"
       - Include visual of Safari share icon (square with arrow)
       - Dismiss button that sets localStorage flag
       - Only render if shouldShowIOSPrompt

    3. Create src/components/pwa/UpdateNotification.tsx:
       - "use client" directive
       - Receive hasUpdate and onRefresh props
       - Use sonner toast or custom fixed-position notification
       - Text: "A new version is available"
       - "Refresh" button that calls onRefresh (which calls acceptUpdate)
       - "Later" button to dismiss (toast auto-dismisses, banner needs dismiss handler)
       - Per CONTEXT.md: "Toast persists until user clicks refresh or dismiss"
       - Position: top-right, below any header

    4. Create src/components/pwa/OfflineBanner.tsx:
       - "use client" directive
       - Use useOnlineStatus hook
       - Muted gray banner at top of viewport when offline
       - Text: "You're offline - some features may be unavailable"
       - Per CONTEXT.md: "muted/gray styling - informational, not alarming"
       - Only render when !isOnline
       - Fixed position, z-40 (below modals)

    5. Create src/components/pwa/index.ts:
       - Export all components: InstallPrompt, IOSInstallGuide, UpdateNotification, OfflineBanner
  </action>
  <verify>
    `ls src/components/pwa/` shows all 5 files
    `cat src/components/pwa/index.ts` shows all exports
    TypeScript compiles without errors
  </verify>
  <done>
    All PWA UI components created with proper styling and behavior
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PWAProvider and wire to layout</name>
  <files>src/components/pwa/PWAProvider.tsx, src/app/layout.tsx</files>
  <action>
    1. Create src/components/pwa/PWAProvider.tsx:
       - "use client" directive
       - Import registerServiceWorker, acceptUpdate from @/lib/pwa/register-sw
       - Import all PWA components
       - Manage hasUpdate state (boolean)
       - useEffect on mount: call registerServiceWorker with callback that sets hasUpdate=true
       - Render all PWA components:
         - OfflineBanner (always - shows/hides based on online status)
         - InstallPrompt (shows based on engagement + not dismissed)
         - IOSInstallGuide (shows based on iOS detection + not dismissed)
         - UpdateNotification (shows when hasUpdate=true)
       - Pass acceptUpdate to UpdateNotification's onRefresh prop

    2. Update src/app/layout.tsx:
       - Import PWAProvider from @/components/pwa
       - Add PWAProvider inside body, after {children} and before Toaster
       - PWAProvider should be a sibling to children, not wrapping it

    3. Update src/components/pwa/index.ts to also export PWAProvider
  </action>
  <verify>
    `grep -q "PWAProvider" src/app/layout.tsx` confirms integration
    `npm run build` succeeds
    In production build, PWA components render based on conditions
  </verify>
  <done>
    PWAProvider orchestrates all PWA features, wired to root layout
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Production server: Install prompt appears after engagement threshold
3. Production server on iOS Safari: iOS guide modal appears
4. Offline mode: Gray banner appears at top
5. After deploying new SW: Update notification appears
6. Clicking "Refresh" in update notification reloads with new SW
7. Dismissing install prompt persists to localStorage
</verification>

<success_criteria>
- useInstallPrompt tracks engagement (3 pages OR 30 seconds before showing)
- InstallPrompt shows dismissible bottom banner with Install button
- IOSInstallGuide shows step-by-step instructions with Safari share icon visual
- UpdateNotification persists until user clicks Refresh or dismisses
- OfflineBanner shows muted gray bar when offline
- All components use existing UI patterns (Button, Tailwind classes)
- PWAProvider wires everything together in layout.tsx
- Dismissed states persist in localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/15-pwa-foundation/15-03-SUMMARY.md`
</output>
