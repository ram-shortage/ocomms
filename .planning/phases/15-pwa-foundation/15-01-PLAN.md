---
phase: 15-pwa-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - tsconfig.json
  - .gitignore
  - src/app/manifest.ts
  - public/icons/icon-192x192.png
  - public/icons/icon-512x512.png
  - public/icons/icon-maskable-512x512.png
  - public/icons/apple-touch-icon.png
autonomous: true

must_haves:
  truths:
    - "Browser recognizes app as installable PWA (manifest valid)"
    - "Build succeeds with Serwist configuration"
  artifacts:
    - path: "src/app/manifest.ts"
      provides: "Web app manifest with icons, theme colors, display mode"
      exports: ["default"]
    - path: "next.config.ts"
      provides: "Serwist integration for service worker generation"
      contains: "withSerwist"
    - path: "public/icons/icon-192x192.png"
      provides: "Android/Chrome icon"
    - path: "public/icons/icon-512x512.png"
      provides: "Android/Chrome splash icon"
    - path: "public/icons/apple-touch-icon.png"
      provides: "iOS home screen icon"
  key_links:
    - from: "next.config.ts"
      to: "@serwist/next"
      via: "withSerwistInit import"
      pattern: "withSerwistInit.*@serwist/next"
    - from: "src/app/manifest.ts"
      to: "public/icons"
      via: "icon paths in manifest"
      pattern: "/icons/icon"
---

<objective>
Set up PWA infrastructure: manifest, Serwist configuration, tsconfig updates, and app icons.

Purpose: Establish the foundation for PWA functionality - without manifest and proper configuration, browsers cannot recognize the app as installable.
Output: Valid web app manifest, Serwist-configured build, placeholder icons ready for branding.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-pwa-foundation/15-CONTEXT.md
@.planning/phases/15-pwa-foundation/15-RESEARCH.md
@next.config.ts
@tsconfig.json
@package.json
@.gitignore
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PWA dependencies and configure build</name>
  <files>package.json, next.config.ts, tsconfig.json, .gitignore</files>
  <action>
    1. Install dependencies:
       `npm install @serwist/next workbox-window && npm install -D serwist`

    2. Update next.config.ts to use Serwist:
       - Import withSerwistInit from "@serwist/next"
       - Create revision constant using crypto.randomUUID() (or process.env.VERCEL_GIT_COMMIT_SHA if available)
       - Configure withSerwist wrapper:
         - swSrc: "src/app/sw.ts"
         - swDest: "public/sw.js"
         - additionalPrecacheEntries: [{ url: "/offline", revision }]
         - disable: process.env.NODE_ENV === "development"
       - Wrap existing config with withSerwist, preserve output: "standalone"

    3. Update tsconfig.json:
       - Add "@serwist/next/typings" to compilerOptions.types array (create if missing)
       - Add "webworker" to compilerOptions.lib array (existing: dom, dom.iterable, esnext)
       - Add "public/sw.js" to exclude array (existing: node_modules)

    4. Update .gitignore to ignore generated SW files:
       - Add section "# Service Worker (generated)"
       - Add: public/sw*
       - Add: public/swe-worker*
  </action>
  <verify>
    `npm run build` completes without errors (will warn about missing sw.ts, that's expected)
    tsconfig.json includes webworker in lib and @serwist/next/typings in types
  </verify>
  <done>
    Serwist configured in next.config.ts, tsconfig updated for SW types, .gitignore excludes generated files
  </done>
</task>

<task type="auto">
  <name>Task 2: Create web app manifest and placeholder icons</name>
  <files>src/app/manifest.ts, public/icons/icon-192x192.png, public/icons/icon-512x512.png, public/icons/icon-maskable-512x512.png, public/icons/apple-touch-icon.png</files>
  <action>
    1. Create src/app/manifest.ts using Next.js MetadataRoute.Manifest type:
       ```typescript
       import type { MetadataRoute } from "next";

       export default function manifest(): MetadataRoute.Manifest {
         return {
           name: "OComms",
           short_name: "OComms",
           description: "Secure team communication",
           start_url: "/",
           display: "standalone",
           background_color: "#ffffff",
           theme_color: "#000000",
           orientation: "portrait",
           icons: [
             {
               src: "/icons/icon-192x192.png",
               sizes: "192x192",
               type: "image/png",
             },
             {
               src: "/icons/icon-512x512.png",
               sizes: "512x512",
               type: "image/png",
             },
             {
               src: "/icons/icon-maskable-512x512.png",
               sizes: "512x512",
               type: "image/png",
               purpose: "maskable",
             },
           ],
         };
       }
       ```

    2. Create public/icons/ directory

    3. Generate placeholder PNG icons using a simple approach:
       - Create solid-color placeholder PNGs with centered "O" text
       - icon-192x192.png (192x192)
       - icon-512x512.png (512x512)
       - icon-maskable-512x512.png (512x512, same as regular for now)
       - apple-touch-icon.png (180x180)

       Use ImageMagick if available: `convert -size 192x192 xc:#000000 -fill white -gravity center -pointsize 100 -annotate 0 "O" public/icons/icon-192x192.png`
       Or use a simple Node script to create placeholder PNGs
       Or download placeholder icons from a service

       Note: These are placeholders. User can replace with branded icons later.

    4. Link apple-touch-icon in layout.tsx metadata (will be done in Plan 02, just create the file here)
  </action>
  <verify>
    `ls public/icons/` shows all 4 icon files
    `curl http://localhost:3000/manifest.webmanifest` returns valid JSON with icons array (after dev server start)
    All icon paths in manifest resolve to actual files
  </verify>
  <done>
    manifest.ts exports valid PWA manifest, placeholder icons exist in public/icons/
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with Serwist configuration
2. `cat src/app/manifest.ts` shows MetadataRoute.Manifest export
3. `ls public/icons/` shows 4 icon files
4. `grep -q "withSerwist" next.config.ts` confirms Serwist integration
5. `grep -q "webworker" tsconfig.json` confirms SW types configured
</verification>

<success_criteria>
- Serwist installed and configured in next.config.ts
- tsconfig.json updated with service worker type support
- .gitignore excludes generated SW files
- manifest.ts provides valid PWA manifest with all required fields
- All 4 icon sizes exist in public/icons/
- Build completes successfully (warns about missing sw.ts, expected)
</success_criteria>

<output>
After completion, create `.planning/phases/15-pwa-foundation/15-01-SUMMARY.md`
</output>
