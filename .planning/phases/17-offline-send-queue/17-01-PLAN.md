---
phase: 17-offline-send-queue
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/cache/db.ts
  - src/lib/cache/send-queue.ts
  - src/lib/retry/backoff.ts
  - src/lib/cache/index.ts
autonomous: true

must_haves:
  truths:
    - "Queued messages persist across page reloads"
    - "Messages can be added to queue with status tracking"
    - "Retry delay increases exponentially with jitter"
  artifacts:
    - path: "src/lib/cache/db.ts"
      provides: "SendQueue table schema (version 2)"
      contains: "sendQueue"
    - path: "src/lib/cache/send-queue.ts"
      provides: "Queue CRUD operations"
      exports: ["queueMessage", "updateQueueStatus", "getPendingMessages", "removeFromQueue"]
    - path: "src/lib/retry/backoff.ts"
      provides: "Exponential backoff calculation"
      exports: ["calculateBackoff", "shouldRetry", "sleep"]
  key_links:
    - from: "src/lib/cache/send-queue.ts"
      to: "src/lib/cache/db.ts"
      via: "imports db and QueuedMessage type"
      pattern: "from.*[\"']\\./db[\"']"
---

<objective>
Create the IndexedDB send queue infrastructure for offline message persistence.

Purpose: Enable messages composed offline to persist across page reloads and app restarts, with status tracking for pending/sending/sent/failed states.

Output: Dexie schema version 2 with sendQueue table, queue CRUD operations, and exponential backoff utility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-offline-send-queue/17-RESEARCH.md

# Prior phase context - cache infrastructure
@.planning/phases/16-message-caching/16-01-SUMMARY.md
@src/lib/cache/db.ts
@src/lib/cache/messages.ts
@src/lib/cache/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Dexie schema with sendQueue table</name>
  <files>src/lib/cache/db.ts</files>
  <action>
Update db.ts to version 2 schema with sendQueue table:

1. Add SendStatus type: "pending" | "sending" | "sent" | "failed"

2. Add QueuedMessage interface:
   - clientId: string (primary key - UUID generated on client)
   - serverId: string | null (set when server confirms)
   - content: string
   - targetId: string (channelId or conversationId)
   - targetType: "channel" | "dm"
   - parentId: string | null (for thread replies)
   - status: SendStatus
   - retryCount: number
   - lastError: string | null
   - createdAt: Date
   - lastAttemptAt: Date | null

3. Update database type to include sendQueue EntityTable

4. Add db.version(2).stores() with:
   - Existing messages indexes unchanged
   - sendQueue: "clientId, [targetId+status], status, createdAt"
   - Compound index [targetId+status] enables efficient queries for pending messages by target

5. Export SendStatus and QueuedMessage types

Note: Dexie handles version upgrades automatically - existing messages table data preserved.
  </action>
  <verify>
TypeScript compiles without errors:
```
npx tsc --noEmit src/lib/cache/db.ts
```
  </verify>
  <done>
db.ts exports SendStatus type, QueuedMessage interface, and db with version 2 schema including sendQueue table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create queue operations module</name>
  <files>src/lib/cache/send-queue.ts</files>
  <action>
Create send-queue.ts with queue CRUD operations following the pattern from messages.ts (graceful error handling):

1. queueMessage(message: Omit<QueuedMessage, "retryCount" | "lastError" | "lastAttemptAt">): Promise<void>
   - Sets retryCount: 0, lastError: null, lastAttemptAt: null
   - Uses db.sendQueue.add()
   - Logs errors but doesn't throw (graceful degradation)

2. updateQueueStatus(clientId: string, status: SendStatus, updates?: Partial<QueuedMessage>): Promise<void>
   - Updates status and lastAttemptAt: new Date()
   - Merges optional updates (retryCount, lastError, serverId)
   - Uses db.sendQueue.update()

3. getPendingMessages(targetId?: string): Promise<QueuedMessage[]>
   - Returns messages with status "pending" or "failed"
   - If targetId provided, filter by targetId
   - Sorted by createdAt (oldest first for FIFO processing)

4. removeFromQueue(clientId: string): Promise<void>
   - Deletes message from queue after successful send
   - Uses db.sendQueue.delete()

5. getQueuedMessagesByTarget(targetId: string): Promise<QueuedMessage[]>
   - Returns all non-sent messages for a specific target
   - Filter: status !== "sent"
   - Used by useSendQueue hook for UI display

Add console.log for errors following the [Cache] prefix pattern from messages.ts.
  </action>
  <verify>
TypeScript compiles:
```
npx tsc --noEmit src/lib/cache/send-queue.ts
```
  </verify>
  <done>
send-queue.ts exports queueMessage, updateQueueStatus, getPendingMessages, removeFromQueue, and getQueuedMessagesByTarget functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create exponential backoff utility and update exports</name>
  <files>src/lib/retry/backoff.ts, src/lib/cache/index.ts</files>
  <action>
Create src/lib/retry/backoff.ts:

1. BackoffConfig interface:
   - baseDelay: number (default 1000ms)
   - maxDelay: number (default 30000ms)
   - maxJitter: number (default 500ms)
   - maxRetries: number (default 5)

2. DEFAULT_CONFIG constant with above defaults

3. calculateBackoff(attempt: number, config?: Partial<BackoffConfig>): number
   - Formula: min(maxDelay, baseDelay * 2^attempt) + random(0, maxJitter)
   - Returns delay in milliseconds

4. shouldRetry(retryCount: number, config?: Partial<BackoffConfig>): boolean
   - Returns retryCount < maxRetries

5. sleep(ms: number): Promise<void>
   - Returns new Promise(resolve => setTimeout(resolve, ms))

Update src/lib/cache/index.ts:
- Add exports for SendStatus, QueuedMessage from "./db"
- Add exports for queueMessage, updateQueueStatus, getPendingMessages, removeFromQueue, getQueuedMessagesByTarget from "./send-queue"

Note: Create src/lib/retry/ directory if it doesn't exist.
  </action>
  <verify>
TypeScript compiles and exports available:
```
npx tsc --noEmit src/lib/retry/backoff.ts src/lib/cache/index.ts
```
  </verify>
  <done>
backoff.ts exports calculateBackoff, shouldRetry, sleep functions. index.ts exports all queue types and operations.
  </done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors
2. Dexie schema version is 2 with sendQueue table
3. Queue operations match the interface from research document
4. Backoff calculation produces increasing delays with jitter
</verification>

<success_criteria>
- SendStatus and QueuedMessage types exported from cache module
- queueMessage, updateQueueStatus, getPendingMessages, removeFromQueue functions work
- calculateBackoff returns increasing delays (1s, 2s, 4s, 8s, 16s, capped at 30s)
- shouldRetry returns false after 5 attempts
</success_criteria>

<output>
After completion, create `.planning/phases/17-offline-send-queue/17-01-SUMMARY.md`
</output>
