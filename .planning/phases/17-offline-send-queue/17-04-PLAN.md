---
phase: 17-offline-send-queue
plan: 04
type: execute
wave: 3
depends_on: ["17-02", "17-03"]
files_modified:
  - src/components/message/message-status.tsx
  - src/components/message/message-item.tsx
  - src/components/message/message-list.tsx
  - src/components/thread/thread-panel.tsx
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Pending messages show distinct visual indicator"
    - "Failed messages show error state with retry count"
    - "User can manually retry failed messages"
    - "Thread replies queue offline like regular messages"
    - "Sync listeners initialize on app load"
  artifacts:
    - path: "src/components/message/message-status.tsx"
      provides: "Visual status indicator component"
      exports: ["MessageStatus"]
    - path: "src/components/message/message-item.tsx"
      provides: "Updated to show status for pending messages"
      contains: "MessageStatus"
    - path: "src/components/message/message-list.tsx"
      provides: "Merges real and pending messages for display"
      contains: "useSendQueue"
    - path: "src/components/thread/thread-panel.tsx"
      provides: "Thread replies use useSendMessage hook"
      contains: "useSendMessage"
  key_links:
    - from: "src/components/message/message-item.tsx"
      to: "src/components/message/message-status.tsx"
      via: "renders status indicator"
      pattern: "<MessageStatus"
    - from: "src/components/message/message-list.tsx"
      to: "src/lib/cache/use-send-queue.ts"
      via: "queries pending messages"
      pattern: "useSendQueue"
    - from: "src/app/layout.tsx"
      to: "src/lib/cache/sync-on-reconnect.ts"
      via: "initializes sync listeners"
      pattern: "initSyncOnReconnect"
---

<objective>
Create visual status indicators for pending/failed messages and complete the offline send integration.

Purpose: Users need to see the state of their messages (pending, sending, failed) with the ability to retry failed sends. Thread replies must also work offline.

Output: MessageStatus component, updated MessageItem/MessageList with status display, ThreadPanel using useSendMessage, sync listener initialization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-offline-send-queue/17-RESEARCH.md

# Prior plans context (MUST BE COMPLETE)
@.planning/phases/17-offline-send-queue/17-02-SUMMARY.md
@.planning/phases/17-offline-send-queue/17-03-SUMMARY.md

@src/components/message/message-item.tsx
@src/components/message/message-list.tsx
@src/components/thread/thread-panel.tsx
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessageStatus component</name>
  <files>src/components/message/message-status.tsx</files>
  <action>
Create src/components/message/message-status.tsx:

"use client";

1. Import dependencies:
   - Loader2 from "lucide-react"
   - SendStatus from "@/lib/cache"

2. Interface MessageStatusProps:
   - status?: SendStatus
   - retryCount?: number
   - onRetry?: () => void

3. MessageStatus component:
   - If !status || status === "sent", return null (no indicator needed)

   - Return a flex container with items-center gap-1 text-xs

   - status === "pending":
     - <span className="text-gray-400">Sending...</span>

   - status === "sending":
     - <span className="text-blue-500 flex items-center gap-1">
         <Loader2 className="h-3 w-3 animate-spin" />
         Sending
       </span>

   - status === "failed":
     - <span className="text-red-500 flex items-center gap-1">
         Failed
         {retryCount && retryCount > 0 && (
           <span className="text-gray-400">({retryCount} retries)</span>
         )}
         {onRetry && (
           <button
             onClick={onRetry}
             className="underline ml-1 hover:text-red-600"
           >
             Retry
           </button>
         )}
       </span>

4. Export MessageStatus

Design: Status shows below message content, subtle but visible.
  </action>
  <verify>
TypeScript compiles:
```
npx tsc --noEmit src/components/message/message-status.tsx
```
  </verify>
  <done>
MessageStatus component displays pending/sending/failed states with retry button for failures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MessageItem and MessageList for status display</name>
  <files>src/components/message/message-item.tsx, src/components/message/message-list.tsx</files>
  <action>
Update MessageItem (message-item.tsx):

1. Add imports:
   - MessageStatus from "./message-status"
   - SendStatus from "@/lib/cache"

2. Add to MessageItemProps interface:
   - sendStatus?: SendStatus
   - retryCount?: number
   - onRetry?: () => void

3. Add below MessageContent (inside the !isDeleted block, after ReactionDisplay):
   - <MessageStatus
       status={sendStatus}
       retryCount={retryCount}
       onRetry={onRetry}
     />

4. Optional: Add slight opacity to pending messages:
   - className on outer div: add ${sendStatus === "pending" || sendStatus === "sending" ? "opacity-70" : ""}

Update MessageList (message-list.tsx):

1. Add imports:
   - useSendQueue, QueuedMessage, processQueue from "@/lib/cache"
   - useSocket from "@/lib/socket-client" (already imported)

2. Get pending messages for this target:
   - const pendingMessages = useSendQueue(targetId)

3. Create merged messages array:
   - Convert pending QueuedMessage to display format
   - Map pendingMessages to include: id (use clientId), content, authorId (from currentUserId prop),
     authorName/authorEmail (need to pass these in), sendStatus, retryCount
   - Append to displayMessages (pending goes at bottom since they're newest)

4. Add handleRetry callback:
   - const handleRetry = useCallback((clientId: string) => {
       // Trigger queue processing for retry
       processQueue(socket).catch(console.error)
     }, [socket])

5. Pass to MessageItem:
   - For pending messages: sendStatus, retryCount, onRetry={handleRetry}
   - For real messages: no sendStatus (or undefined)

Note: Need to add currentUserName and currentUserEmail props to MessageList to display author for pending messages. Add these to MessageListProps interface.
  </action>
  <verify>
TypeScript compiles:
```
npx tsc --noEmit src/components/message/message-item.tsx src/components/message/message-list.tsx
```
  </verify>
  <done>
MessageItem shows status indicator for pending messages. MessageList merges real and pending messages for display.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ThreadPanel and initialize sync listeners</name>
  <files>src/components/thread/thread-panel.tsx, src/app/layout.tsx</files>
  <action>
Update ThreadPanel (thread-panel.tsx):

1. Add import:
   - useSendMessage from "@/hooks/use-send-message"

2. Update ThreadReplyInput component:
   - Remove direct socket.emit for thread:reply
   - Use useSendMessage with targetId (parentMessage's channelId or conversationId),
     targetType (derive from parentMessage), and parentId

3. Change sendReply:
   - Call sendMessage(content.trim()) from useSendMessage hook
   - This queues the reply just like regular messages
   - Keep the optimistic clear pattern

Note: ThreadReplyInput already clears content on success. Just need to swap socket.emit for queueAndSend.

Update layout.tsx (src/app/layout.tsx):

1. Add import:
   - initSyncOnReconnect, cleanupSyncListeners from "@/lib/cache"
   - getSocket from "@/lib/socket-client"

2. Create a client component for sync initialization (or use existing provider):
   - Option A: Add to existing PWAProvider if appropriate
   - Option B: Create SyncProvider client component

3. In the sync initialization effect:
   - const socket = getSocket()
   - initSyncOnReconnect(socket)
   - Return cleanup: cleanupSyncListeners()

Preferred approach: Create src/components/providers/sync-provider.tsx that:
- Is a "use client" component
- Wraps children
- Calls initSyncOnReconnect in useEffect
- Cleans up on unmount
- Add to layout.tsx wrapping the app
  </action>
  <verify>
TypeScript compiles:
```
npx tsc --noEmit src/components/thread/thread-panel.tsx src/app/layout.tsx
```

Manual test: Go offline (DevTools), send message, see "Sending..." status, go online, see message send.
  </verify>
  <done>
Thread replies queue offline. Sync listeners initialize on app load. Full offline send queue working end-to-end.
  </done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors
2. Pending messages show "Sending..." indicator
3. Failed messages show retry count and retry button
4. Thread replies queue when offline
5. Messages send automatically when going online
6. Manual retry triggers queue processing
</verification>

<success_criteria>
- OFFL-03: User can compose messages offline (queued locally) - VERIFIED
- OFFL-04: Pending messages show status indicator (pending/sent/failed) - VERIFIED
- OFFL-05: Queued messages sync automatically on reconnect - VERIFIED
- OFFL-06: Messages display instantly with optimistic UI - VERIFIED
- OFFL-07: Failed sends retry with exponential backoff - VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/17-offline-send-queue/17-04-SUMMARY.md`
</output>
