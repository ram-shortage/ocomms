---
phase: 33-workspace-management
plan: 04
type: execute
wave: 3
depends_on: ["33-03"]
files_modified:
  - src/app/(workspace)/[workspaceSlug]/settings/join-requests/page.tsx
  - src/components/workspace/join-request-list.tsx
  - src/lib/actions/workspace-join.ts
  - src/lib/email.ts
  - src/server/socket/index.ts
autonomous: false

must_haves:
  truths:
    - "Workspace owner can see list of pending join requests"
    - "Owner can approve requests, adding user to workspace"
    - "Owner can reject requests with optional reason"
    - "Requester receives email and in-app notification on approval/rejection"
    - "Bulk actions allow approving/rejecting multiple requests at once"
  artifacts:
    - path: "src/app/(workspace)/[workspaceSlug]/settings/join-requests/page.tsx"
      provides: "Admin page for managing join requests"
      min_lines: 50
    - path: "src/components/workspace/join-request-list.tsx"
      provides: "List component with bulk action support"
      exports: ["JoinRequestList"]
    - path: "src/lib/actions/workspace-join.ts"
      provides: "Approval and rejection server actions"
      exports: ["approveJoinRequest", "rejectJoinRequest", "bulkApproveRequests", "bulkRejectRequests"]
  key_links:
    - from: "src/app/(workspace)/[workspaceSlug]/settings/join-requests/page.tsx"
      to: "src/lib/actions/workspace-join.ts"
      via: "server action calls"
      pattern: "approveJoinRequest|rejectJoinRequest"
    - from: "src/lib/actions/workspace-join.ts"
      to: "src/lib/email.ts"
      via: "notification email"
      pattern: "sendEmail"
---

<objective>
Create admin interface for workspace owners to approve or reject join requests with notification delivery.

Purpose: Workspace owners need control over who joins their workspace. The approval flow ensures owners can vet requesters and maintain workspace membership quality.

Output: Settings page for join request management, approval/rejection actions with notifications, bulk operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/33-workspace-management/33-CONTEXT.md
@.planning/phases/33-workspace-management/33-RESEARCH.md
@.planning/phases/33-workspace-management/33-01-SUMMARY.md
@.planning/phases/33-workspace-management/33-03-SUMMARY.md

@src/app/(workspace)/[workspaceSlug]/settings/page.tsx
@src/lib/email.ts
@src/server/socket/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create approval and rejection server actions</name>
  <files>
    src/lib/actions/workspace-join.ts
    src/lib/email.ts
  </files>
  <action>
1. Add to `workspace-join.ts`:

`getPendingRequests(workspaceId: string)`:
- Validate user is owner/admin of workspace
- Return all pending requests with requester info (name, email, message, createdAt)

`approveJoinRequest(requestId: string)`:
- Validate user is owner/admin of the request's workspace
- Validate request exists and is pending
- Update request status to "approved", set reviewedAt and reviewedBy
- Add user to workspace via better-auth API
- Send approval email (fire-and-forget)
- Emit Socket.IO notification to requester
- Return { success: true }

`rejectJoinRequest(requestId: string, reason?: string)`:
- Validate user is owner/admin
- Validate request exists and is pending
- Update request status to "rejected", set rejectionReason, reviewedAt, reviewedBy
- Send rejection email with reason if provided (fire-and-forget)
- Emit Socket.IO notification to requester
- Return { success: true }

`bulkApproveRequests(requestIds: string[])`:
- Loop through requestIds and approve each
- Return { success: true, approved: number, failed: string[] }
- Continue on individual failures, report at end

`bulkRejectRequests(requestIds: string[], reason?: string)`:
- Loop through requestIds and reject each with same reason
- Return { success: true, rejected: number, failed: string[] }

2. Add to `email.ts`:

`sendJoinRequestApprovedEmail({ to, workspaceName, workspaceSlug })`:
- Subject: "Your request to join {workspaceName} was approved"
- Body: Simple text with link to workspace

`sendJoinRequestRejectedEmail({ to, workspaceName, reason? })`:
- Subject: "Your request to join {workspaceName}"
- Body: Request was not approved, include reason if provided

Pattern: Follow existing sendEmail patterns from email.ts
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Server actions for approve/reject exist with email notification helpers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create join request list component and settings page</name>
  <files>
    src/components/workspace/join-request-list.tsx
    src/app/(workspace)/[workspaceSlug]/settings/join-requests/page.tsx
  </files>
  <action>
1. Create `join-request-list.tsx`:
   - Props: requests (array), onApprove, onReject, onBulkApprove, onBulkReject
   - State: selectedIds (Set of request IDs for bulk actions)
   - Render:
     - Header row with "Select All" checkbox if requests exist
     - Bulk action buttons (Approve Selected, Reject Selected) shown when selection > 0
     - Empty state: "No pending join requests"
   - For each request, render row with:
     - Checkbox for selection
     - Requester avatar + name + email
     - Optional message (expandable if long)
     - "Requested {timeAgo}" timestamp
     - Approve button (check icon, green)
     - Reject button (x icon, red) - opens dialog for optional reason
   - Use Dialog component for rejection reason input
   - Loading states during action execution
   - Toast notifications on success/failure

2. Create `settings/join-requests/page.tsx`:
   - Server component that fetches pending requests
   - Validate user is owner/admin, redirect if not
   - Render page header: "Join Requests" with count badge
   - Render JoinRequestList with server actions
   - Link back to settings page

3. Add navigation link in existing settings page:
   - Add "Join Requests" link with badge showing pending count
   - Only visible to owners/admins

Pattern: Follow existing settings pages (members/page.tsx, guests/page.tsx) for layout and patterns.
  </action>
  <verify>
1. `npm run dev` - Application starts
2. Navigate to /workspace-slug/settings/join-requests as owner
3. List shows pending requests
4. Approve button works and shows toast
5. Reject button opens dialog, submits with reason
6. Bulk selection works
7. Non-admin cannot access page
  </verify>
  <done>
- JoinRequestList component with selection and bulk actions
- Settings page at /[workspaceSlug]/settings/join-requests
- Approve/reject actions with toast feedback
- Only accessible to workspace owners/admins
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete workspace management flow: switcher, browse page, join requests, and approval flow.
  </what-built>
  <how-to-verify>
1. **Test workspace switcher:**
   - Log into app with a user who has multiple workspaces
   - Click workspace name in sidebar header
   - Verify dropdown shows all workspaces with unread counts
   - Verify "Browse workspaces" link at bottom

2. **Test browse and join flow:**
   - Navigate to /browse-workspaces
   - Verify workspaces appear (need at least one with open or request policy)
   - For open workspace: Click "Join" and verify instant membership
   - For request workspace: Click "Request to Join", optionally add message, submit
   - Verify success toast and pending state

3. **Test admin approval:**
   - Log in as workspace owner
   - Navigate to Settings > Join Requests
   - Verify pending requests visible
   - Approve one request - verify user added to workspace
   - Reject one request with reason
   - Test bulk actions if multiple requests exist

4. **Test notifications:**
   - Check requester receives email on approval/rejection
   - Check requester receives in-app notification

5. **Test edge cases:**
   - Verify invite-only workspaces hidden from browse
   - Verify existing members don't see their workspaces in browse
   - Verify non-admin cannot access join requests page
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Approval adds user to workspace membership
3. Rejection updates request status and sends notification
4. Emails sent for both approval and rejection
5. Bulk actions work correctly
6. Settings page only accessible to owner/admin
7. Navigation link with badge in settings page
</verification>

<success_criteria>
- [ ] getPendingRequests returns requests for workspace
- [ ] approveJoinRequest adds user to workspace and sends email
- [ ] rejectJoinRequest updates status and optionally sends reason
- [ ] bulkApproveRequests handles multiple requests
- [ ] bulkRejectRequests handles multiple requests
- [ ] JoinRequestList renders with selection and actions
- [ ] Settings page protected by owner/admin role
- [ ] Join request link with badge in settings navigation
- [ ] Human verification passed for full flow
</success_criteria>

<output>
After completion, create `.planning/phases/33-workspace-management/33-04-SUMMARY.md`
</output>
