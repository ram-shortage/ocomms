---
phase: 33-workspace-management
plan: 03
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - src/app/browse-workspaces/page.tsx
  - src/components/workspace/workspace-browse-card.tsx
  - src/lib/actions/workspace-join.ts
  - src/db/schema/auth.ts
autonomous: true

must_haves:
  truths:
    - "User can see list of available workspaces they can join"
    - "Invite-only workspaces are hidden from browse list"
    - "User can request to join workspaces with approval-required policy"
    - "User can instantly join workspaces with open policy"
    - "User cannot see or join workspaces they already belong to"
  artifacts:
    - path: "src/app/browse-workspaces/page.tsx"
      provides: "Browse workspaces discovery page"
      min_lines: 50
    - path: "src/lib/actions/workspace-join.ts"
      provides: "Server actions for join flow"
      exports: ["submitJoinRequest", "joinOpenWorkspace"]
  key_links:
    - from: "src/app/browse-workspaces/page.tsx"
      to: "src/lib/actions/workspace-join.ts"
      via: "server action import"
      pattern: "submitJoinRequest|joinOpenWorkspace"
    - from: "src/lib/actions/workspace-join.ts"
      to: "src/db/schema/workspace-join-request.ts"
      via: "database insert"
      pattern: "workspaceJoinRequests"
---

<objective>
Create workspace discovery page where users can browse and request to join available workspaces.

Purpose: Users need to find and join workspaces beyond their current membership. This supports the multi-workspace experience by providing a discovery mechanism.

Output: Browse workspaces page with workspace cards, join request submission, and instant join for open workspaces.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/33-workspace-management/33-CONTEXT.md
@.planning/phases/33-workspace-management/33-RESEARCH.md
@.planning/phases/33-workspace-management/33-01-SUMMARY.md

@src/db/schema/auth.ts
@src/db/schema/workspace-join-request.ts
@src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add join policy field to organization schema</name>
  <files>
    src/db/schema/auth.ts
    src/db/migrations/*.sql
  </files>
  <action>
1. Update `organization` table in auth.ts to add join policy:
   - Add `joinPolicy` field: text, not null, default "invite_only"
   - Valid values: "open" (instant join), "request" (requires approval), "invite_only" (hidden, invite only)
   - Add `description` field: text (optional, shown in browse page)

2. Generate and run migration:
   ```bash
   npx drizzle-kit generate
   npx drizzle-kit migrate
   ```

Note: This extends the existing better-auth organization table. Ensure column names use snake_case to match better-auth conventions.
  </action>
  <verify>
`npx drizzle-kit migrate` succeeds.
Database shows new columns: `psql -c "\\d organizations"` includes join_policy and description columns.
  </verify>
  <done>
Organization table has joinPolicy and description fields with proper defaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workspace join server actions</name>
  <files>
    src/lib/actions/workspace-join.ts
  </files>
  <action>
Create server actions for the join flow:

1. `getAvailableWorkspaces()`:
   - Fetch all organizations where joinPolicy != "invite_only"
   - Exclude organizations where user is already a member
   - Exclude organizations where user has pending join request
   - Return: id, name, slug, logo, description, memberCount, joinPolicy

2. `submitJoinRequest(workspaceId: string, message?: string)`:
   - Validate user is authenticated
   - Validate workspace exists and has joinPolicy = "request"
   - Validate user is not already a member
   - Validate no existing pending request
   - Insert into workspaceJoinRequests with status "pending"
   - Return { success: true } or throw error

3. `joinOpenWorkspace(workspaceId: string)`:
   - Validate user is authenticated
   - Validate workspace exists and has joinPolicy = "open"
   - Validate user is not already a member
   - Add user to organization using better-auth API:
     ```typescript
     await auth.api.addMember({
       headers: await headers(),
       body: {
         organizationId: workspaceId,
         userId: session.user.id,
         role: "member",
       },
     });
     ```
   - Return { success: true, slug: workspace.slug }

4. `getMyJoinRequests()`:
   - Return all pending join requests for current user
   - Include workspace name for display

Authorization: All actions must verify session exists. Never expose invite-only workspaces.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Server actions exist for browsing workspaces, submitting join requests, and instant joining open workspaces.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create browse workspaces page</name>
  <files>
    src/app/browse-workspaces/page.tsx
    src/components/workspace/workspace-browse-card.tsx
  </files>
  <action>
1. Create `workspace-browse-card.tsx`:
   - Props: workspace (id, name, slug, logo, description, memberCount, joinPolicy), onJoin callback, isPending
   - Display workspace logo (40x40) or placeholder
   - Show workspace name and description (truncated if long)
   - Show member count with Users icon
   - Action button based on joinPolicy:
     - "open": "Join" button, calls onJoin directly
     - "request": "Request to Join" button, opens modal for optional message
   - If isPending: Show "Request Pending" disabled state instead of button

2. Create `browse-workspaces/page.tsx`:
   - Fetch available workspaces using getAvailableWorkspaces()
   - Fetch user's pending requests using getMyJoinRequests()
   - Page layout:
     - Header: "Browse Workspaces" title
     - Back link to current workspace (or home if none)
     - Grid of WorkspaceBrowseCard components (3 cols on lg, 2 on md, 1 on sm)
     - Empty state if no workspaces available: "No workspaces available to join"
   - Handle join actions:
     - Open: Call joinOpenWorkspace, redirect to workspace on success
     - Request: Show dialog for optional message, call submitJoinRequest, show success toast
   - Use sonner for toast notifications on success/error

3. Add loading and error states:
   - Loading: Skeleton cards while fetching
   - Error: Error message with retry button

Pattern: Follow existing page patterns from channels/page.tsx and settings pages.
  </action>
  <verify>
1. `npm run dev` - Application starts
2. Navigate to /browse-workspaces - Page renders without errors
3. Workspaces with open/request policy visible
4. Workspaces user is already member of NOT visible
5. Invite-only workspaces NOT visible
6. Join button works for open workspaces
7. Request button opens message dialog and submits request
  </verify>
  <done>
- Browse workspaces page at /browse-workspaces
- WorkspaceBrowseCard shows workspace info and join options
- Open workspaces allow instant join
- Request workspaces show message dialog and create pending request
- Pending requests show disabled "Request Pending" state
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Organization schema has joinPolicy field
3. Browse page only shows joinable workspaces (not invite-only)
4. User's existing workspaces excluded from browse list
5. Join button adds user to open workspace
6. Request button creates pending join request
7. Pending requests reflected in UI state
</verification>

<success_criteria>
- [ ] joinPolicy field added to organization schema
- [ ] getAvailableWorkspaces excludes invite-only and already-member workspaces
- [ ] submitJoinRequest creates pending request with optional message
- [ ] joinOpenWorkspace adds user to workspace immediately
- [ ] Browse page displays available workspaces in grid
- [ ] Join/Request buttons work correctly based on policy
- [ ] Pending request state shown for already-requested workspaces
</success_criteria>

<output>
After completion, create `.planning/phases/33-workspace-management/33-03-SUMMARY.md`
</output>
