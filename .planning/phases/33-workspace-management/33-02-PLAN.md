---
phase: 33-workspace-management
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - src/components/workspace/workspace-switcher.tsx
  - src/components/workspace/workspace-card.tsx
  - src/components/workspace/workspace-sidebar.tsx
  - src/app/(workspace)/[workspaceSlug]/layout.tsx
  - src/lib/redis.ts
  - src/server/socket/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees dropdown with all their workspaces when clicking workspace name in header"
    - "Each workspace card shows name, unread count, member count, and last activity"
    - "Clicking a workspace navigates to that workspace and restores last-visited position"
    - "Switcher includes 'Browse workspaces' link at bottom"
  artifacts:
    - path: "src/components/workspace/workspace-switcher.tsx"
      provides: "Dropdown trigger and menu for workspace switching"
      exports: ["WorkspaceSwitcher"]
    - path: "src/components/workspace/workspace-card.tsx"
      provides: "Preview card for each workspace in switcher"
      exports: ["WorkspaceCard"]
  key_links:
    - from: "src/components/workspace/workspace-switcher.tsx"
      to: "src/lib/hooks/use-workspace-unread.ts"
      via: "useWorkspaceUnreadCounts hook"
      pattern: "useWorkspaceUnreadCounts"
    - from: "src/components/workspace/workspace-sidebar.tsx"
      to: "src/components/workspace/workspace-switcher.tsx"
      via: "component import"
      pattern: "WorkspaceSwitcher"
    - from: "src/app/(workspace)/[workspaceSlug]/layout.tsx"
      to: "workspace-sidebar.tsx"
      via: "passes workspaces prop"
      pattern: "workspaces.*WorkspaceSidebar"
---

<objective>
Build workspace switcher UI with preview cards showing workspace state and integrate into sidebar header.

Purpose: Users need to quickly switch between workspaces and see at-a-glance which workspaces have activity. The switcher provides the primary navigation point for multi-workspace users.

Output: Workspace switcher dropdown with preview cards, integrated into sidebar header, with last-visited position restoration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/33-workspace-management/33-CONTEXT.md
@.planning/phases/33-workspace-management/33-RESEARCH.md
@.planning/phases/33-workspace-management/33-01-SUMMARY.md

@src/components/workspace/workspace-sidebar.tsx
@src/components/ui/dropdown-menu.tsx
@src/app/(workspace)/[workspaceSlug]/layout.tsx
@src/lib/redis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace card and switcher components</name>
  <files>
    src/components/workspace/workspace-card.tsx
    src/components/workspace/workspace-switcher.tsx
  </files>
  <action>
1. Create `workspace-card.tsx`:
   - Props: workspace (id, name, slug, logo), unreadCount, memberCount, lastActivityAt, isActive
   - Display workspace logo (or placeholder if none) as 40x40 rounded image
   - Show workspace name (truncated if long)
   - Show unread badge (red, "99+" if > 99) aligned right if unreadCount > 0
   - Show member count with Users icon, last activity with date-fns formatDistanceToNow
   - Use Tailwind for styling matching project conventions
   - Active workspace should have subtle highlight

2. Create `workspace-switcher.tsx`:
   - Props: currentWorkspace, workspaces (array of workspace objects)
   - Use Radix DropdownMenu from @/components/ui/dropdown-menu
   - Trigger: Button showing current workspace icon + name + ChevronDown
   - Content (w-80, aligned start):
     - Label "Your Workspaces"
     - Map workspaces to WorkspaceCard items
     - Use useWorkspaceUnreadCounts hook to get unread counts
     - DropdownMenuSeparator
     - DropdownMenuItem with Link to "/browse-workspaces"
   - On workspace selection:
     - POST to `/api/workspace/last-visited` to store current location before switching
     - Navigate to `/${workspace.slug}` (middleware will handle redirect to last-visited)

Pattern: Follow existing Radix dropdown usage in channel-header.tsx and status-editor.tsx.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
WorkspaceCard and WorkspaceSwitcher components exist with proper props and Radix dropdown integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add last-visited position storage and restoration</name>
  <files>
    src/app/api/workspace/last-visited/route.ts
    src/app/(workspace)/[workspaceSlug]/layout.tsx
    src/lib/redis.ts
  </files>
  <action>
1. Add helper functions to `redis.ts` (or create separate file if preferred):
   ```typescript
   export async function storeLastVisited(userId: string, workspaceId: string, path: string): Promise<void> {
     const key = `user:${userId}:workspace:${workspaceId}:last-visited`;
     await redis.set(key, path, "EX", 60 * 60 * 24 * 30); // 30 day TTL
   }

   export async function getLastVisited(userId: string, workspaceId: string): Promise<string | null> {
     const key = `user:${userId}:workspace:${workspaceId}:last-visited`;
     return await redis.get(key);
   }
   ```

2. Create `/api/workspace/last-visited` route:
   - POST: Store last-visited path for current workspace
     - Body: { workspaceId: string, path: string }
     - Validate user is member of workspace
     - Call storeLastVisited
     - Return { success: true }
   - GET: Get last-visited path for a workspace
     - Query: workspaceId
     - Validate user is member
     - Return { path: string | null }

3. Update workspace layout to restore position:
   - In the layout, after validating workspace membership, check Redis for last-visited
   - If user is navigating to workspace root (no channel/dm in path), redirect to last-visited if exists
   - Store current path as last-visited when rendering (fire-and-forget)

Note: Be careful not to create redirect loops. Only redirect from workspace root, not from specific pages.
  </action>
  <verify>
1. `curl -X POST /api/workspace/last-visited -d '{"workspaceId":"...", "path":"/acme/general"}' -H "Cookie: ..."` returns 200
2. `curl /api/workspace/last-visited?workspaceId=...` returns stored path
  </verify>
  <done>
- Last-visited storage functions in redis.ts
- API route for storing/retrieving last-visited path
- Layout restores position when navigating to workspace root
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate switcher into sidebar and register socket handlers</name>
  <files>
    src/components/workspace/workspace-sidebar.tsx
    src/app/(workspace)/[workspaceSlug]/layout.tsx
    src/server/socket/index.ts
  </files>
  <action>
1. Update workspace layout to fetch all user workspaces:
   - Use `auth.api.listOrganizations()` to get all workspaces (already done for current workspace)
   - For each workspace, fetch member count using auth.api.listMembers (or add to query)
   - Pass `workspaces` array to WorkspaceSidebar with: id, name, slug, logo, memberCount, lastActivityAt
   - LastActivityAt: Query latest message timestamp per workspace (can be approximated or null initially)

2. Update WorkspaceSidebar:
   - Add `workspaces` prop (array of workspace objects)
   - Replace the workspace name link in header with WorkspaceSwitcher component:
     ```tsx
     <WorkspaceSwitcher
       currentWorkspace={workspace}
       workspaces={workspaces}
     />
     ```
   - Keep NotificationBell next to switcher

3. Register workspace unread socket handlers in `socket/index.ts`:
   - Import setupWorkspaceUnreadHandlers and handleWorkspaceUnreadEvents from Plan 01
   - Call setupWorkspaceUnreadHandlers in server initialization
   - Call handleWorkspaceUnreadEvents in socket connection handler
   - Follow pattern of existing handler registration

4. Wire up the existing unread handlers to also emit workspace:unreadUpdate:
   - When a channel or conversation unread changes, calculate and emit workspace-level update
   - This can be done by extending notifyUnreadIncrement to also emit workspace:unreadUpdate to the user
  </action>
  <verify>
1. `npm run dev` - Application starts without errors
2. Navigate to workspace - Switcher visible in header with current workspace name
3. Click switcher - Dropdown shows all user's workspaces with unread counts
4. Select different workspace - Navigates and restores last position
  </verify>
  <done>
- WorkspaceSidebar uses WorkspaceSwitcher in header
- Layout passes all user workspaces to sidebar
- Socket handlers registered and emit workspace unread updates
- Switcher fully functional with real-time unread counts
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Workspace switcher visible in sidebar header
3. All user's workspaces appear in dropdown
4. Unread counts display per workspace
5. Workspace switch navigates correctly
6. Last-visited position restored on switch
7. "Browse workspaces" link visible at bottom
</verification>

<success_criteria>
- [ ] WorkspaceSwitcher dropdown renders in header
- [ ] WorkspaceCard shows name, logo, unread count, member count, last activity
- [ ] Unread counts update in real-time when messages arrive
- [ ] Switching workspaces works via dropdown
- [ ] Last-visited position stored and restored
- [ ] "Browse workspaces" link present and functional
</success_criteria>

<output>
After completion, create `.planning/phases/33-workspace-management/33-02-SUMMARY.md`
</output>
