---
phase: 09-authorization-fixes
plan: 08
type: execute
wave: 4
depends_on: []
files_modified:
  - src/db/schema/channel.ts
  - src/db/schema/conversation.ts
  - drizzle/migrations/XXXX_fix_created_by_fk.sql
autonomous: true

must_haves:
  truths:
    - "Channel created_by allows NULL values"
    - "Conversation created_by allows NULL values"
    - "User deletion does not violate foreign key constraints"
    - "Existing created_by references are preserved"
  artifacts:
    - path: "src/db/schema/channel.ts"
      provides: "Channel schema with nullable created_by"
      contains: "createdBy.*text.*\\.references"
    - path: "src/db/schema/conversation.ts"
      provides: "Conversation schema with nullable created_by"
      contains: "createdBy.*text.*\\.references"
  key_links:
    - from: "src/db/schema/channel.ts"
      to: "database"
      via: "column definition"
      pattern: "createdBy"
---

<objective>
Fix foreign key constraints on created_by columns to handle user deletion.

Purpose: The `created_by` columns are `NOT NULL` but use `onDelete: "set null"`, which will violate constraints when users are deleted. Need to make columns nullable to match the onDelete behavior.

Output: Modified schema with nullable created_by columns and migration applied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant source files
@src/db/schema/channel.ts (file to modify - created_by at line 15)
@src/db/schema/conversation.ts (file to modify - created_by at line 12)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make created_by columns nullable in schema</name>
  <files>src/db/schema/channel.ts, src/db/schema/conversation.ts</files>
  <action>
1. Modify `src/db/schema/channel.ts`:

   Change line 15-17 from:
   ```typescript
   createdBy: text("created_by")
     .notNull()
     .references(() => users.id, { onDelete: "set null" }),
   ```

   To:
   ```typescript
   createdBy: text("created_by")
     .references(() => users.id, { onDelete: "set null" }),
   ```

   Remove the `.notNull()` call so the column allows NULL values, which is required for `onDelete: "set null"` to work.

2. Modify `src/db/schema/conversation.ts`:

   Change line 12-14 from:
   ```typescript
   createdBy: text("created_by")
     .notNull()
     .references(() => users.id, { onDelete: "set null" }),
   ```

   To:
   ```typescript
   createdBy: text("created_by")
     .references(() => users.id, { onDelete: "set null" }),
   ```

   Same change - remove `.notNull()`.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
NOT NULL removed: `grep -A 2 "createdBy" src/db/schema/channel.ts | grep -v "notNull"`
  </verify>
  <done>
Both channel.ts and conversation.ts have nullable created_by columns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply migration</name>
  <files>drizzle/migrations</files>
  <action>
1. Generate the migration:
   ```bash
   npx drizzle-kit generate
   ```

2. Review the generated migration - it should contain ALTER TABLE statements to drop NOT NULL constraints:
   ```sql
   ALTER TABLE "channels" ALTER COLUMN "created_by" DROP NOT NULL;
   ALTER TABLE "conversations" ALTER COLUMN "created_by" DROP NOT NULL;
   ```

3. Apply the migration:
   ```bash
   npx drizzle-kit migrate
   ```

4. Verify the schema change:
   ```bash
   psql $DATABASE_URL -c "\d channels" | grep created_by
   psql $DATABASE_URL -c "\d conversations" | grep created_by
   ```

   Both should show the column without "not null" constraint.

Note: This is a safe migration - it only relaxes a constraint, doesn't change data, and existing non-null values remain intact.
  </action>
  <verify>
Migration applied: `npx drizzle-kit migrate` exits 0
Column allows null: `psql $DATABASE_URL -c "\d channels" 2>/dev/null | grep -i created_by || echo "Check manually"`
  </verify>
  <done>
Migration applied, created_by columns now allow NULL for user deletion scenarios.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Schema changes present: `grep -c "notNull" src/db/schema/channel.ts src/db/schema/conversation.ts` (createdBy should not have notNull)
3. Migration applied successfully
4. Dev server starts: `npm run dev` (briefly, then ctrl+c)
</verification>

<success_criteria>
- Channel and conversation schemas have nullable created_by columns
- Migration generated and applied
- onDelete: "set null" will now work without constraint violations
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-authorization-fixes/09-08-SUMMARY.md`
</output>
