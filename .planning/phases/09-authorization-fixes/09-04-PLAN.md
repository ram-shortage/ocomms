---
phase: 09-authorization-fixes
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/server/socket/handlers/reaction.ts
autonomous: true

must_haves:
  truths:
    - "reaction:toggle validates user has access to the channel/DM containing the message"
    - "reaction:get validates user has access to the channel/DM containing the message"
    - "Unauthorized reaction operations emit error and return early"
  artifacts:
    - path: "src/server/socket/handlers/reaction.ts"
      provides: "Reaction handlers with authorization checks"
      contains: "isChannelMember|isConversationParticipant|getMessageContext"
  key_links:
    - from: "src/server/socket/handlers/reaction.ts"
      to: "src/server/socket/authz.ts"
      via: "import and call"
      pattern: "import.*authz|getMessageContext"
---

<objective>
Add authorization checks to all reaction event handlers.

Purpose: Currently any authenticated user can add/remove reactions or list reactions on any message if they know the message ID. This bypasses channel/DM membership controls.

Output: Modified `src/server/socket/handlers/reaction.ts` with membership validation on all operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summary (helpers created in 09-01)
@.planning/phases/09-authorization-fixes/09-01-SUMMARY.md

# Relevant source files
@src/server/socket/handlers/reaction.ts (file to modify)
@src/server/socket/authz.ts (authorization helpers from 09-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add authorization to reaction:toggle handler</name>
  <files>src/server/socket/handlers/reaction.ts</files>
  <action>
Modify `handleReactionToggle` function (starts at line 16):

1. Import authorization helpers at top of file:
   ```typescript
   import { isChannelMember, isConversationParticipant, getMessageContext } from "../authz";
   ```

2. Add authorization check at the start of the try block, before the existing reaction check:
   ```typescript
   async function handleReactionToggle(
     socket: SocketWithData,
     io: SocketIOServer,
     data: { messageId: string; emoji: string }
   ): Promise<void> {
     const userId = socket.data.userId;
     const userName = socket.data.user?.name || socket.data.user?.email || "Unknown";
     const { messageId, emoji } = data;

     try {
       // Verify user has access to the message's channel/DM
       const context = await getMessageContext(messageId);
       if (!context) {
         socket.emit("error", { message: "Message not found" });
         return;
       }

       if (context.channelId) {
         const isMember = await isChannelMember(userId, context.channelId);
         if (!isMember) {
           socket.emit("error", { message: "Not authorized to react to this message" });
           return;
         }
       } else if (context.conversationId) {
         const isParticipant = await isConversationParticipant(userId, context.conversationId);
         if (!isParticipant) {
           socket.emit("error", { message: "Not authorized to react to this message" });
           return;
         }
       }

       // ... rest of existing function (check if reaction exists, toggle, broadcast)
     }
   }
   ```

Note: The existing code already queries the message later (line 67-71) to get channelId/conversationId for broadcasting. You can either:
- Add the auth check first using getMessageContext, then reuse context.channelId/conversationId later
- Or query message once and use for both auth and room determination

Preferred: Use getMessageContext first for auth, then use its values for room determination, removing the duplicate query at line 67-71.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Authorization check present: `grep -A 3 "getMessageContext" src/server/socket/handlers/reaction.ts`
  </verify>
  <done>
reaction:toggle validates membership before allowing reaction toggle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add authorization to reaction:get handler</name>
  <files>src/server/socket/handlers/reaction.ts</files>
  <action>
Modify `handleGetReactions` function (starts at line 103):

Add authorization check at start of function:
```typescript
async function handleGetReactions(
  socket: SocketWithData,
  data: { messageId: string },
  callback: (response: { success: boolean; reactions?: ReactionGroup[] }) => void
): Promise<void> {
  const userId = socket.data.userId;
  const { messageId } = data;

  try {
    // Verify user has access to the message's channel/DM
    const context = await getMessageContext(messageId);
    if (!context) {
      callback({ success: false });
      return;
    }

    if (context.channelId) {
      const isMember = await isChannelMember(userId, context.channelId);
      if (!isMember) {
        socket.emit("error", { message: "Not authorized to view reactions on this message" });
        callback({ success: false });
        return;
      }
    } else if (context.conversationId) {
      const isParticipant = await isConversationParticipant(userId, context.conversationId);
      if (!isParticipant) {
        socket.emit("error", { message: "Not authorized to view reactions on this message" });
        callback({ success: false });
        return;
      }
    }

    // ... rest of existing function for fetching and grouping reactions
  }
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Both handlers have auth: `grep -c "isChannelMember\|isConversationParticipant" src/server/socket/handlers/reaction.ts` (should be >= 2)
  </verify>
  <done>
reaction:get validates membership before returning reactions.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Authorization import present: `grep "import.*authz" src/server/socket/handlers/reaction.ts`
3. Both handlers have authorization checks
</verification>

<success_criteria>
- reaction:toggle and reaction:get validate channel/DM membership
- Unauthorized attempts emit error and return without performing operation
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-authorization-fixes/09-04-SUMMARY.md`
</output>
