---
phase: 09-authorization-fixes
plan: 06
type: execute
wave: 3
depends_on: ["09-01"]
files_modified:
  - src/lib/actions/channel.ts
  - src/lib/actions/conversation.ts
autonomous: true

must_haves:
  truths:
    - "createChannel validates user is member of target organization"
    - "getChannels validates user is member of target organization"
    - "joinChannel validates user is member of channel's organization"
    - "getWorkspaceMembers validates user is member of target organization"
    - "createConversation validates all participants belong to target organization"
    - "Cross-organization requests are rejected with 403-equivalent error"
  artifacts:
    - path: "src/lib/actions/channel.ts"
      provides: "Channel actions with organization membership validation"
      contains: "members.*organizationId|isOrgMember"
    - path: "src/lib/actions/conversation.ts"
      provides: "Conversation actions with organization membership validation"
      contains: "members.*organizationId|isOrgMember"
  key_links:
    - from: "src/lib/actions/channel.ts"
      to: "src/db/schema/auth.ts"
      via: "members table query"
      pattern: "members.*where"
    - from: "src/lib/actions/conversation.ts"
      to: "src/db/schema/auth.ts"
      via: "members table query"
      pattern: "members.*where"
---

<objective>
Add organization membership validation to channel and conversation server actions.

Purpose: Currently these actions trust the organizationId parameter without verifying the requesting user belongs to that organization. This enables cross-org channel creation and member listing with guessed IDs.

Output: Modified server actions that validate organization membership before performing operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant source files
@src/lib/actions/channel.ts (file to modify)
@src/lib/actions/conversation.ts (file to modify)
@src/db/schema/auth.ts (members table for org membership)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add organization membership helper and fix channel actions</name>
  <files>src/lib/actions/channel.ts</files>
  <action>
Modify `src/lib/actions/channel.ts`:

1. Add helper function at top (after imports):
   ```typescript
   async function verifyOrgMembership(userId: string, organizationId: string): Promise<boolean> {
     const membership = await db.query.members.findFirst({
       where: and(
         eq(members.userId, userId),
         eq(members.organizationId, organizationId)
       ),
     });
     return !!membership;
   }
   ```

2. Add validation to `createChannel` (after session check, around line 24):
   ```typescript
   // Verify user is member of target organization
   const isOrgMember = await verifyOrgMembership(session.user.id, formData.organizationId);
   if (!isOrgMember) {
     throw new Error("Not authorized to create channels in this organization");
   }
   ```

3. Add validation to `getChannels` (after session check, around line 54):
   ```typescript
   // Verify user is member of target organization
   const isOrgMember = await verifyOrgMembership(session.user.id, organizationId);
   if (!isOrgMember) {
     throw new Error("Not authorized to view channels in this organization");
   }
   ```

4. Add validation to `joinChannel` (after channel exists check, around line 94):
   ```typescript
   // Verify user is member of channel's organization
   const isOrgMember = await verifyOrgMembership(session.user.id, channel.organizationId);
   if (!isOrgMember) {
     throw new Error("Not authorized to join channels in this organization");
   }
   ```

5. Add validation to `getWorkspaceMembers` (after session check, around line 254):
   ```typescript
   // Verify user is member of target organization
   const isOrgMember = await verifyOrgMembership(session.user.id, organizationId);
   if (!isOrgMember) {
     throw new Error("Not authorized to view members of this organization");
   }
   ```

Note: `getUserChannels` is already secure - it queries for user's own memberships and filters by org.
Note: `getChannel`, `updateChannelTopic`, `updateChannelDescription`, `leaveChannel`, `inviteToChannel` already validate channel membership which implicitly validates org access.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Org checks present: `grep -c "verifyOrgMembership\|isOrgMember" src/lib/actions/channel.ts` (should be >= 4)
  </verify>
  <done>
createChannel, getChannels, joinChannel, and getWorkspaceMembers validate organization membership.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix conversation actions</name>
  <files>src/lib/actions/conversation.ts</files>
  <action>
Modify `src/lib/actions/conversation.ts`:

1. Add helper function at top (after imports):
   ```typescript
   async function verifyOrgMembership(userId: string, organizationId: string): Promise<boolean> {
     const membership = await db.query.members.findFirst({
       where: and(
         eq(members.userId, userId),
         eq(members.organizationId, organizationId)
       ),
     });
     return !!membership;
   }
   ```

2. Import `members` from schema if not already imported:
   ```typescript
   import { conversations, conversationParticipants, members } from "@/db/schema";
   ```

3. Add comprehensive validation to `createConversation` (after session check, around line 16):
   ```typescript
   // Verify requester is member of target organization
   const isRequesterMember = await verifyOrgMembership(session.user.id, formData.organizationId);
   if (!isRequesterMember) {
     throw new Error("Not authorized to create conversations in this organization");
   }

   // Verify all participants are members of the organization
   for (const participantId of formData.participantIds) {
     const isParticipantMember = await verifyOrgMembership(participantId, formData.organizationId);
     if (!isParticipantMember) {
       throw new Error("All participants must be members of the organization");
     }
   }
   ```

4. The `addParticipant` function should also validate the new participant is an org member.
   Add after the "not a participant" check (around line 163):
   ```typescript
   // Verify new participant is member of the conversation's organization
   const isNewMemberInOrg = await verifyOrgMembership(userId, conversation.organizationId);
   if (!isNewMemberInOrg) {
     throw new Error("User must be a member of the organization");
   }
   ```

   Note: Need to include organizationId in the conversation query. Update the findFirst query to include it.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Org checks present: `grep -c "verifyOrgMembership\|isRequesterMember\|isParticipantMember" src/lib/actions/conversation.ts` (should be >= 3)
  </verify>
  <done>
createConversation validates requester and all participants are organization members.
addParticipant validates new participant is organization member.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Channel actions have org validation: `grep "verifyOrgMembership" src/lib/actions/channel.ts`
3. Conversation actions have org validation: `grep "verifyOrgMembership" src/lib/actions/conversation.ts`
</verification>

<success_criteria>
- createChannel rejects non-org members
- getChannels rejects non-org members
- joinChannel rejects non-org members
- getWorkspaceMembers rejects non-org members
- createConversation rejects non-org members and validates all participants
- addParticipant validates new participant is org member
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-authorization-fixes/09-06-SUMMARY.md`
</output>
