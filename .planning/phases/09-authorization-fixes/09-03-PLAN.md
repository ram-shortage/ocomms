---
phase: 09-authorization-fixes
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/server/socket/handlers/thread.ts
autonomous: true

must_haves:
  truths:
    - "thread:reply validates user has access to the channel/DM containing the parent message"
    - "thread:join validates user has access to the channel/DM containing the thread"
    - "thread:getReplies validates user has access to the channel/DM containing the thread"
    - "Unauthorized thread operations emit error and return early"
  artifacts:
    - path: "src/server/socket/handlers/thread.ts"
      provides: "Thread handlers with authorization checks"
      contains: "isChannelMember|isConversationParticipant|getMessageContext"
  key_links:
    - from: "src/server/socket/handlers/thread.ts"
      to: "src/server/socket/authz.ts"
      via: "import and call"
      pattern: "import.*authz|getMessageContext"
---

<objective>
Add authorization checks to all thread event handlers.

Purpose: Currently any authenticated user can read or post thread replies to any message if they know the message ID. This bypasses channel/DM membership controls.

Output: Modified `src/server/socket/handlers/thread.ts` with membership validation on all operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summary (helpers created in 09-01)
@.planning/phases/09-authorization-fixes/09-01-SUMMARY.md

# Relevant source files
@src/server/socket/handlers/thread.ts (file to modify)
@src/server/socket/authz.ts (authorization helpers from 09-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add authorization to thread:reply handler</name>
  <files>src/server/socket/handlers/thread.ts</files>
  <action>
Modify `handleThreadReply` function (starts at line 15):

1. Import authorization helpers at top of file:
   ```typescript
   import { isChannelMember, isConversationParticipant, getMessageContext } from "../authz";
   ```

2. Add authorization check after getting parent message (around line 36, after the parent null check):
   ```typescript
   // Verify user has access to the channel/DM containing this thread
   if (parent.channelId) {
     const isMember = await isChannelMember(userId, parent.channelId);
     if (!isMember) {
       socket.emit("error", { message: "Not authorized to reply in this channel" });
       callback?.({ success: false });
       return;
     }
   } else if (parent.conversationId) {
     const isParticipant = await isConversationParticipant(userId, parent.conversationId);
     if (!isParticipant) {
       socket.emit("error", { message: "Not authorized to reply in this conversation" });
       callback?.({ success: false });
       return;
     }
   }
   ```

Insert this check after the "Parent message not found" check and before the "cannot reply to a reply" check.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Authorization check present: `grep -A 5 "isChannelMember\|isConversationParticipant" src/server/socket/handlers/thread.ts`
  </verify>
  <done>
thread:reply validates membership in the parent message's channel/DM before allowing reply.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add authorization to thread:join and thread:getReplies handlers</name>
  <files>src/server/socket/handlers/thread.ts</files>
  <action>
1. Modify `handleJoinThread` function (starts at line 158):

   Change from sync to async and add authorization:
   ```typescript
   async function handleJoinThread(socket: SocketWithData, data: { threadId: string }): Promise<void> {
     const userId = socket.data.userId;

     // Get the message context to verify access
     const context = await getMessageContext(data.threadId);
     if (!context) {
       socket.emit("error", { message: "Thread not found" });
       return;
     }

     // Verify membership
     if (context.channelId) {
       const isMember = await isChannelMember(userId, context.channelId);
       if (!isMember) {
         socket.emit("error", { message: "Not authorized to view this thread" });
         return;
       }
     } else if (context.conversationId) {
       const isParticipant = await isConversationParticipant(userId, context.conversationId);
       if (!isParticipant) {
         socket.emit("error", { message: "Not authorized to view this thread" });
         return;
       }
     }

     socket.join(getRoomName.thread(data.threadId));
     console.log(`[Thread] User ${userId} joined thread: ${data.threadId}`);
   }
   ```

2. Modify `handleGetReplies` function (starts at line 176):

   Add authorization check at start:
   ```typescript
   async function handleGetReplies(
     socket: SocketWithData,
     data: { threadId: string },
     callback: (response: { success: boolean; replies?: Message[] }) => void
   ): Promise<void> {
     const userId = socket.data.userId;

     try {
       // Get the message context to verify access
       const context = await getMessageContext(data.threadId);
       if (!context) {
         callback({ success: false });
         return;
       }

       // Verify membership
       if (context.channelId) {
         const isMember = await isChannelMember(userId, context.channelId);
         if (!isMember) {
           socket.emit("error", { message: "Not authorized to view this thread" });
           callback({ success: false });
           return;
         }
       } else if (context.conversationId) {
         const isParticipant = await isConversationParticipant(userId, context.conversationId);
         if (!isParticipant) {
           socket.emit("error", { message: "Not authorized to view this thread" });
           callback({ success: false });
           return;
         }
       }

       // ... rest of existing function for fetching replies
     }
   }
   ```

3. Update handleThreadEvents to make thread:join async:
   ```typescript
   socket.on("thread:join", async (data) => {
     await handleJoinThread(socket, data);
   });
   ```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
All handlers have auth checks: `grep -c "isChannelMember\|isConversationParticipant" src/server/socket/handlers/thread.ts` (should be >= 3)
  </verify>
  <done>
thread:join and thread:getReplies validate membership before allowing thread access.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Authorization import present: `grep "import.*authz" src/server/socket/handlers/thread.ts`
3. All three handlers have authorization: Count should be at least 3 occurrences of membership checks
</verification>

<success_criteria>
- thread:reply, thread:join, and thread:getReplies all validate channel/DM membership
- Unauthorized attempts emit error and return without performing operation
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-authorization-fixes/09-03-SUMMARY.md`
</output>
