---
phase: 09-authorization-fixes
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/server/socket/index.ts
autonomous: true

must_haves:
  truths:
    - "room:join validates channel/DM membership before subscribing user to room"
    - "workspace:join validates organization membership before subscribing user to workspace room"
    - "Unauthorized room:join emits error and does not subscribe socket"
    - "Unauthorized workspace:join emits error and does not subscribe socket"
  artifacts:
    - path: "src/server/socket/index.ts"
      provides: "Authorized room and workspace join handlers"
      contains: "isChannelMember|isConversationParticipant|isOrganizationMember"
  key_links:
    - from: "src/server/socket/index.ts"
      to: "src/server/socket/authz.ts"
      via: "import and call"
      pattern: "import.*authz|isChannelMember|isOrganizationMember"
---

<objective>
Add authorization checks to Socket.IO room:join and workspace:join handlers.

Purpose: Currently any authenticated user can subscribe to any channel/DM room or workspace presence by knowing the ID. This allows unauthorized users to receive real-time messages and presence updates they shouldn't see.

Output: Modified `src/server/socket/index.ts` with membership validation before room/workspace joins.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summary (helpers created in 09-01)
@.planning/phases/09-authorization-fixes/09-01-SUMMARY.md

# Relevant source files
@src/server/socket/index.ts (file to modify - see room:join at line 100, workspace:join at line 109)
@src/server/socket/authz.ts (authorization helpers from 09-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add authorization to room:join handler</name>
  <files>src/server/socket/index.ts</files>
  <action>
Modify the `room:join` handler (around line 100) in src/server/socket/index.ts:

1. Import authorization helpers at top of file:
   ```typescript
   import { isChannelMember, isConversationParticipant, isOrganizationMember } from "./authz";
   ```

2. Replace the room:join handler with authorized version:
   ```typescript
   socket.on("room:join", async (data) => {
     const userId = socket.data.userId;

     // Validate membership before joining room
     if (data.roomType === "channel") {
       const isMember = await isChannelMember(userId, data.roomId);
       if (!isMember) {
         socket.emit("error", { message: "Not authorized to join this channel" });
         console.log(`[Socket.IO] Unauthorized room:join attempt: user ${userId} -> channel ${data.roomId}`);
         return;
       }
     } else {
       const isParticipant = await isConversationParticipant(userId, data.roomId);
       if (!isParticipant) {
         socket.emit("error", { message: "Not authorized to join this conversation" });
         console.log(`[Socket.IO] Unauthorized room:join attempt: user ${userId} -> dm ${data.roomId}`);
         return;
       }
     }

     const roomName = data.roomType === "channel"
       ? getRoomName.channel(data.roomId)
       : getRoomName.conversation(data.roomId);
     socket.join(roomName);
     console.log(`[Socket.IO] User ${userId} joined room: ${roomName}`);
   });
   ```

Keep the existing logic for determining room name, just add authorization check first.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Grep for authorization import: `grep "isChannelMember" src/server/socket/index.ts`
  </verify>
  <done>
room:join handler validates channel/DM membership before allowing room subscription.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add authorization to workspace:join handler</name>
  <files>src/server/socket/index.ts</files>
  <action>
Modify the `workspace:join` handler (around line 109) in src/server/socket/index.ts:

Replace with authorized version:
```typescript
socket.on("workspace:join", async (data) => {
  const { workspaceId } = data;
  const userId = socket.data.userId;

  // Validate organization membership before joining workspace
  const isMember = await isOrganizationMember(userId, workspaceId);
  if (!isMember) {
    socket.emit("error", { message: "Not authorized to join this workspace" });
    console.log(`[Socket.IO] Unauthorized workspace:join attempt: user ${userId} -> workspace ${workspaceId}`);
    return;
  }

  // Store workspaceId in socket data for presence handlers
  socket.data.workspaceId = workspaceId;

  // Join workspace room for presence broadcasts
  socket.join(getRoomName.workspace(workspaceId));
  console.log(`[Socket.IO] User ${userId} joined workspace: ${workspaceId}`);

  // Set user as online and start presence heartbeat
  if (presenceManager) {
    await presenceManager.setOnline(userId, workspaceId);
    socket.startPresenceHeartbeat?.();
  }
});
```

The only change is adding the membership check before any state changes or room joins.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Grep for org membership check: `grep "isOrganizationMember" src/server/socket/index.ts`
  </verify>
  <done>
workspace:join handler validates organization membership before allowing workspace subscription and presence updates.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Authorization helpers imported: `grep "import.*authz" src/server/socket/index.ts`
3. room:join has membership check: `grep -A 10 "room:join" src/server/socket/index.ts | grep "isChannelMember\|isConversationParticipant"`
4. workspace:join has membership check: `grep -A 10 "workspace:join" src/server/socket/index.ts | grep "isOrganizationMember"`
</verification>

<success_criteria>
- room:join validates channel membership for channels and conversation participation for DMs
- workspace:join validates organization membership
- Unauthorized attempts emit error and do not subscribe socket to room
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-authorization-fixes/09-02-SUMMARY.md`
</output>
