---
phase: 09-authorization-fixes
plan: 09
type: execute
wave: 4
depends_on: []
files_modified:
  - src/app/api/admin/export/route.ts
autonomous: true

must_haves:
  truths:
    - "Export endpoint queries user membership scoped to target organization"
    - "Notification filtering only includes notifications for target org's channels/conversations"
    - "Multi-org users cannot export data from other organizations"
    - "Owner check uses both userId AND organizationId"
  artifacts:
    - path: "src/app/api/admin/export/route.ts"
      provides: "Export endpoint with proper org-scoped queries"
      contains: "organizationId.*userId|conversationIds.*includes"
  key_links:
    - from: "src/app/api/admin/export/route.ts"
      to: "src/db/schema/auth.ts"
      via: "scoped membership query"
      pattern: "members.*userId.*organizationId"
---

<objective>
Fix export endpoint to properly scope data to the requesting user's organization.

Purpose: Current ownership check queries by organizationId first, then separately checks user membership. The notification filtering also includes any conversationId without verifying it belongs to the target org. This can cause incorrect denials and cross-org data leakage for multi-org users.

Output: Modified export endpoint with properly scoped queries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant source files
@src/app/api/admin/export/route.ts (file to modify - ownership check at line 81, notification filtering at line 220)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ownership verification to properly scope to org</name>
  <files>src/app/api/admin/export/route.ts</files>
  <action>
The current code (lines 76-94) has a bug:
1. It queries ANY membership by organizationId (line 77-78)
2. Then separately queries user's membership by userId only (line 81-83)
3. Then checks if the user's membership is for this org (line 86-88)

This is convoluted and could fail for multi-org users. Fix it:

Replace lines 76-95 with a single, correct query:
```typescript
// Verify user is owner of the organization
const userMembership = await db.query.members.findFirst({
  where: and(
    eq(members.userId, session.user.id),
    eq(members.organizationId, organizationId)
  ),
});

if (!userMembership || userMembership.role !== "owner") {
  return NextResponse.json(
    { error: "Only organization owners can export data" },
    { status: 403 }
  );
}
```

This directly queries for the user's membership in the target organization and checks owner role in one step.

Note: Need to import `and` from drizzle-orm if not already imported.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Single scoped query: `grep -A 5 "userMembership" src/app/api/admin/export/route.ts | grep "userId.*organizationId\|organizationId.*userId"`
  </verify>
  <done>
Ownership verification queries user's membership scoped to both userId AND organizationId.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix notification filtering to scope conversations to org</name>
  <files>src/app/api/admin/export/route.ts</files>
  <action>
The current notification filter (lines 219-224) has a bug:
```typescript
const orgNotifications = userNotifications.filter(
  (n) =>
    (n.channelId && channelIds.includes(n.channelId)) ||
    n.conversationId  // <-- BUG: includes ANY conversationId
);
```

This includes notifications for conversations that might belong to OTHER organizations.

Fix by also checking if conversationId is in the org's conversations:

1. First, create a set of conversation IDs from orgConversations (before the notification loop):
   ```typescript
   const conversationIds = orgConversations.map((c) => c.id);
   ```

2. Update the filter:
   ```typescript
   const orgNotifications = userNotifications.filter(
     (n) =>
       (n.channelId && channelIds.includes(n.channelId)) ||
       (n.conversationId && conversationIds.includes(n.conversationId))
   );
   ```

The conversationIds array should be created around line 169 (after orgConversations is populated) and used in the filter at line 220.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Fix applied: `grep "conversationIds.includes" src/app/api/admin/export/route.ts`
  </verify>
  <done>
Notification filtering only includes notifications for channels AND conversations belonging to the target organization.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Ownership check is scoped: `grep -B 2 -A 5 "userMembership" src/app/api/admin/export/route.ts`
3. Notification filter is scoped: `grep "conversationIds.includes" src/app/api/admin/export/route.ts`
</verification>

<success_criteria>
- Ownership verification uses single query scoped to both userId and organizationId
- Notification filtering validates conversationId belongs to target org
- Multi-org users cannot accidentally export cross-org data
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-authorization-fixes/09-09-SUMMARY.md`
</output>
