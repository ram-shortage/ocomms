---
phase: 14-security-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/socket/handlers/message.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Messages have sequential order numbers without race conditions"
    - "Server rejects messages exceeding size limit"
    - "Rate-limited users receive clear feedback"
  artifacts:
    - path: "src/server/socket/handlers/message.ts"
      provides: "Atomic sequence + length validation + rate limiting"
      contains: "RateLimiterMemory"
    - path: "package.json"
      provides: "rate-limiter-flexible dependency"
      contains: "rate-limiter-flexible"
  key_links:
    - from: "src/server/socket/handlers/message.ts"
      to: "db.insert"
      via: "atomic INSERT with subquery"
      pattern: "sql.*COALESCE.*MAX.*sequence"
    - from: "src/server/socket/handlers/message.ts"
      to: "socket.emit"
      via: "rate limit error response"
      pattern: "RATE_LIMITED"
---

<objective>
Fix message handler with atomic sequence generation, server-side length validation, and rate limiting.

Purpose: Prevent race conditions in message ordering, enforce message size limits, and protect against message spam.

Output: Updated message.ts handler with SECFIX-03, SECFIX-05 (server), and SECFIX-06 (server) fixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-security-fixes/14-CONTEXT.md
@.planning/phases/14-security-fixes/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install rate-limiter-flexible</name>
  <files>package.json</files>
  <action>
Install the rate-limiter-flexible package for message rate limiting:

```bash
npm install rate-limiter-flexible
```

This provides memory-based rate limiting with proper sliding windows and automatic cleanup.
  </action>
  <verify>
Run `npm list rate-limiter-flexible` to confirm installation.
Check package.json contains "rate-limiter-flexible" in dependencies.
  </verify>
  <done>rate-limiter-flexible is installed and in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Add atomic sequence, length check, and rate limiting to message handler (SECFIX-03, SECFIX-05, SECFIX-06)</name>
  <files>src/server/socket/handlers/message.ts</files>
  <action>
Update handleSendMessage in message.ts with three security fixes:

1. Add imports at top of file:
```typescript
import { RateLimiterMemory } from 'rate-limiter-flexible';
```

2. Add constants and rate limiter after imports:
```typescript
const MAX_MESSAGE_LENGTH = 10_000;

// SECFIX-06: Rate limiter - 10 messages per 60 seconds per user
const messageRateLimiter = new RateLimiterMemory({
  points: 10,
  duration: 60,
  keyPrefix: 'message',
});
```

3. Update handleSendMessage function to:

a) Add rate limit check at start of try block (before membership validation):
```typescript
// SECFIX-06: Rate limit check
try {
  await messageRateLimiter.consume(userId);
} catch (rejRes: any) {
  socket.emit("error", {
    message: "Message rate limit reached. Please wait.",
    code: "RATE_LIMITED",
    retryAfter: Math.ceil(rejRes.msBeforeNext / 1000),
  });
  callback?.({ success: false });
  return;
}
```

b) Add length validation after rate limit (before membership check):
```typescript
// SECFIX-05: Server-side length validation
if (content.length > MAX_MESSAGE_LENGTH) {
  socket.emit("error", {
    message: `Message exceeds maximum length of ${MAX_MESSAGE_LENGTH.toLocaleString()} characters`,
    code: "MESSAGE_TOO_LONG",
  });
  callback?.({ success: false });
  return;
}
```

c) Replace the existing sequence generation (lines 57-66) with atomic INSERT using subquery:
```typescript
// SECFIX-03: Atomic sequence generation with retry
const insertMessageWithRetry = async (retries = 3): Promise<typeof messages.$inferSelect> => {
  const condition = targetType === "channel"
    ? sql`channel_id = ${targetId}`
    : sql`conversation_id = ${targetId}`;

  for (let attempt = 0; attempt < retries; attempt++) {
    try {
      const [newMessage] = await db
        .insert(messages)
        .values({
          content,
          authorId: userId,
          channelId: targetType === "channel" ? targetId : null,
          conversationId: targetType === "dm" ? targetId : null,
          sequence: sql`(SELECT COALESCE(MAX(sequence), 0) + 1 FROM messages WHERE ${condition})`,
        })
        .returning();
      return newMessage;
    } catch (error: any) {
      // PostgreSQL unique constraint violation - retry
      if (error.code === '23505' && attempt < retries - 1) {
        continue;
      }
      throw error;
    }
  }
  throw new Error('Failed to insert message after retries');
};

const newMessage = await insertMessageWithRetry();
```

Remove the old sequence generation code (the SELECT MAX + INSERT pattern).

Make sure to import `sql` from drizzle-orm if not already imported:
```typescript
import { eq, and, isNull, sql, max } from "drizzle-orm";
// Note: max is no longer needed, can be removed
```
  </action>
  <verify>
Read the updated message.ts and confirm:
1. RateLimiterMemory is imported and instantiated
2. MAX_MESSAGE_LENGTH constant is 10_000
3. Rate limit check happens before message processing
4. Length validation check happens before message insert
5. Sequence uses SQL subquery pattern (COALESCE(MAX(sequence), 0) + 1)
6. Retry logic handles PostgreSQL error code 23505
7. No SELECT MAX + separate INSERT pattern remains
  </verify>
  <done>Message handler has atomic sequences, length limit, and rate limiting</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run TypeScript compilation:
```bash
npx tsc --noEmit
```

2. Run existing tests:
```bash
npm test
```

3. Code inspection:
- Rate limiter: 10 points per 60 seconds
- Length limit: 10,000 characters
- Sequence: Atomic subquery in INSERT with retry on conflict

4. Error messages match CONTEXT.md decisions:
- Rate limit: "Message rate limit reached. Please wait."
- Length: "Message exceeds maximum length of 10,000 characters"
</verification>

<success_criteria>
- [ ] rate-limiter-flexible installed in package.json
- [ ] Message handler rejects messages over 10,000 characters
- [ ] Message handler rate limits to 10 messages per 60 seconds
- [ ] Sequence generation uses atomic INSERT with subquery
- [ ] Retry logic handles unique constraint violations
- [ ] TypeScript compiles without errors
- [ ] Existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-security-fixes/14-02-SUMMARY.md`
</output>
