---
phase: 14-security-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware.ts
  - src/lib/actions/channel.ts
  - src/lib/audit-logger.ts
autonomous: true

must_haves:
  truths:
    - "Middleware returns 401/403 on validation errors (never passes invalid requests)"
    - "getChannel rejects requests for channels outside user's organization"
    - "Audit logging does not block request processing"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Fail-closed session validation"
      contains: "redirect.*login"
    - path: "src/lib/actions/channel.ts"
      provides: "Organization membership check in getChannel"
      contains: "verifyOrgMembership"
    - path: "src/lib/audit-logger.ts"
      provides: "Async file operations"
      contains: "appendFile"
  key_links:
    - from: "src/middleware.ts"
      to: "/login"
      via: "redirect on catch block"
      pattern: "catch.*redirect.*login"
    - from: "src/lib/actions/channel.ts"
      to: "verifyOrgMembership"
      via: "function call before channel query"
      pattern: "verifyOrgMembership.*getChannel"
---

<objective>
Harden server-side authorization with fail-closed middleware, organization-scoped channel access, and non-blocking audit logging.

Purpose: Fix three security concerns - middleware that fails open on errors, getChannel that doesn't verify org membership, and synchronous audit logging that blocks requests.

Output: Updated middleware.ts, channel.ts, and audit-logger.ts with security fixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-security-fixes/14-CONTEXT.md
@.planning/phases/14-security-fixes/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix middleware to fail closed (SECFIX-02)</name>
  <files>src/middleware.ts</files>
  <action>
Update the catch block in middleware.ts (lines 75-80) to fail closed instead of fail open.

Current behavior:
```typescript
} catch (error) {
  console.error("[Middleware] Session validation error:", error);
  // On error, allow through (fail open for availability)
  return NextResponse.next();
}
```

Required change:
```typescript
} catch (error) {
  console.error("[Middleware] Session validation error:", error);
  // SECFIX-02: Fail closed - redirect to login on any validation error
  const response = NextResponse.redirect(new URL("/login", request.url));
  response.cookies.delete("better-auth.session_token");
  return response;
}
```

This ensures authentication errors result in denial, not access. The user is redirected to login with their session cookie cleared.
  </action>
  <verify>
Read the updated middleware.ts and confirm:
1. The catch block redirects to /login
2. The session cookie is deleted on error
3. No NextResponse.next() in catch block
  </verify>
  <done>Middleware returns redirect to /login on any session validation error</done>
</task>

<task type="auto">
  <name>Task 2: Add organization check to getChannel (SECFIX-04)</name>
  <files>src/lib/actions/channel.ts</files>
  <action>
Update the `getChannel` function (lines 208-235) to verify organization membership BEFORE querying for the channel.

Current getChannel checks channel membership for private channels but doesn't verify the user belongs to the organization. A user could potentially access channels in an organization they don't belong to.

Add organization membership check at the start of getChannel:

```typescript
export async function getChannel(organizationId: string, slug: string) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");

  // SECFIX-04: Verify organization membership FIRST
  const isOrgMember = await verifyOrgMembership(session.user.id, organizationId);
  if (!isOrgMember) {
    return null; // Don't reveal channel exists - per CONTEXT.md
  }

  // ... rest of function unchanged
}
```

Note: verifyOrgMembership already exists in this file (line 10-18), so just add the check.

Per CONTEXT.md: Return null (same as "not found") rather than throwing an error. This prevents revealing whether a channel exists to unauthorized users.
  </action>
  <verify>
Read the updated channel.ts and confirm:
1. getChannel calls verifyOrgMembership before querying channels
2. Returns null (not throws) if user is not org member
3. The check happens before the db.query.channels.findFirst call
  </verify>
  <done>getChannel returns null for users outside the organization</done>
</task>

<task type="auto">
  <name>Task 3: Convert audit logger to async (SECFIX-08)</name>
  <files>src/lib/audit-logger.ts</files>
  <action>
Convert the audit logger from synchronous to asynchronous file operations.

Changes needed:

1. Update imports at top of file:
```typescript
import { appendFile, mkdir } from "fs/promises";
import { existsSync } from "fs";
import * as path from "path";
```

2. Update `ensureLogsDir` to be async:
```typescript
async function ensureLogsDir(): Promise<void> {
  const logsDir = getLogsDir();
  if (!existsSync(logsDir)) {
    await mkdir(logsDir, { recursive: true });
  }
}
```

3. Update `auditLog` to be async (signature stays fire-and-forget compatible):
```typescript
export async function auditLog(data: AuditEventData): Promise<void> {
  try {
    const event: AuditEvent = {
      ...data,
      timestamp: new Date().toISOString(),
    };

    await ensureLogsDir();

    const logPath = path.join(getLogsDir(), getLogFilename());
    const line = JSON.stringify(event) + "\n";

    // SECFIX-08: Async append - non-blocking
    await appendFile(logPath, line);
  } catch (error) {
    // Fire-and-forget - log errors but don't throw
    console.error("Audit log write failed:", error);
  }
}
```

Call sites using `void auditLog(...)` or `auditLog(...).catch(...)` patterns remain unchanged since the function is still fire-and-forget.
  </action>
  <verify>
Read the updated audit-logger.ts and confirm:
1. Imports use fs/promises for appendFile and mkdir
2. ensureLogsDir is async
3. auditLog is async and returns Promise<void>
4. No synchronous fs calls (appendFileSync, mkdirSync) remain in auditLog
  </verify>
  <done>Audit logging uses async file operations and does not block request processing</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run TypeScript compilation to ensure no type errors:
```bash
npx tsc --noEmit
```

2. Run existing tests to ensure no regressions:
```bash
npm test
```

3. Manual verification:
- Middleware: Any session validation error now redirects to /login
- getChannel: Returns null for non-org-members (cannot be exploited to find channels)
- Audit logger: Async operations (verify with code inspection)
</verification>

<success_criteria>
- [ ] Middleware catch block redirects to /login and deletes session cookie
- [ ] getChannel verifies org membership before querying channel
- [ ] Audit logger uses async fs/promises methods
- [ ] TypeScript compiles without errors
- [ ] Existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-security-fixes/14-01-SUMMARY.md`
</output>
