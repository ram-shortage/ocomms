# Milestone v0.3.0: Mobile & Polish

**Status:** SHIPPED 2026-01-19
**Phases:** 14-20
**Total Plans:** 23

## Overview

Complete UI gaps, add PWA support with offline capability and push notifications for mobile access.

## Phases

### Phase 14: Security Fixes

**Goal**: Harden existing code with scoping fixes, input limits, and async improvements
**Depends on**: Nothing (runs first to stabilize before new features)
**Plans**: 3 plans

Plans:
- [x] 14-01: Server-side security (fail-closed middleware, getChannel org check, async audit)
- [x] 14-02: Message handler fixes (atomic sequence, length limit, rate limiting)
- [x] 14-03: Client UX and scoping (@mention org scope, character counter, rate limit UI)

**Details:**
- @mention autocomplete only shows users in the same organization
- Middleware returns 401/403 on validation errors (never passes invalid requests)
- Messages have sequential order numbers without race conditions
- getChannel rejects requests for channels outside user's organization
- Server rejects messages exceeding size limit; rate-limited users receive clear feedback

### Phase 15: PWA Foundation

**Goal**: Users can install the app to their home screen with fast initial load
**Depends on**: Phase 14
**Plans**: 3 plans

Plans:
- [x] 15-01: PWA infrastructure (manifest, Serwist config, icons)
- [x] 15-02: Service worker and offline page
- [x] 15-03: PWA components (install prompt, iOS guide, update notification, offline banner)

**Details:**
- Browser shows install prompt after user engagement; clicking installs to home screen
- App loads instantly from cache on repeat visits
- Custom offline page displays when network unavailable (not browser error)
- Update notification appears when new version available; user can refresh to update
- iOS users see "Add to Home Screen" instructions (Safari doesn't have native install)

### Phase 16: Message Caching

**Goal**: Users can read recent messages when offline
**Depends on**: Phase 15 (requires service worker)
**Plans**: 2 plans

Plans:
- [x] 16-01: IndexedDB foundation (Dexie schema, cache operations, initialization)
- [x] 16-02: Cache integration (React hooks, MessageList wiring, offline fallback)

**Details:**
- Messages populate IndexedDB when user views a channel
- User can scroll through cached messages with no network connection
- Messages older than 7 days are automatically cleaned up

### Phase 17: Offline Send Queue

**Goal**: Users can compose and send messages while offline
**Depends on**: Phase 16 (requires IndexedDB schema)
**Plans**: 4 plans

Plans:
- [x] 17-01: Queue infrastructure (Dexie sendQueue table, queue operations, backoff utility)
- [x] 17-02: Queue processing and sync (socket integration, reconnect listeners)
- [x] 17-03: Optimistic UI hooks (useSendMessage, useSendQueue, MessageInput update)
- [x] 17-04: Status indicators and polish (MessageStatus, retry UI, thread integration)

**Details:**
- User can type and submit a message with no network; message appears immediately
- Pending messages show distinct indicator (pending/sent/failed status visible)
- When network returns, queued messages send automatically
- Failed messages retry with backoff; user can see retry attempts
- Optimistic UI shows message instantly before server confirmation

### Phase 18: Push Notifications

**Goal**: Users receive push notifications for DMs and mentions
**Depends on**: Phase 15 (requires service worker)
**Plans**: 5 plans

Plans:
- [x] 18-01: Push infrastructure (VAPID config, push subscription schema, SW push handlers)
- [x] 18-02: Subscription API (VAPID public key endpoint, subscribe/unsubscribe routes)
- [x] 18-03: Push delivery (sendPushToUser utility, mention and DM push triggers)
- [x] 18-04: Push UI (usePushSubscription hook, permission prompt, settings panel)
- [x] 18-05: Integration and verification (PWAProvider integration, settings page, e2e testing)

**Details:**
- Server generates VAPID keys on first start (stored in environment)
- User can enable push notifications (double-permission pattern)
- User receives push when someone sends a DM
- User receives push when mentioned in a channel
- Clicking notification opens the specific conversation
- User can configure per-channel notification preferences (all/mentions/none)

### Phase 19: Mobile Layout

**Goal**: App provides native-like mobile experience
**Depends on**: Phase 15 (PWA installed for full experience)
**Plans**: 3 plans

Plans:
- [x] 19-01: Viewport and CSS foundation (viewportFit, overscroll-behavior, dvh, useIsMobile hook)
- [x] 19-02: Bottom tab bar and responsive layout (MobileTabBar, sidebar/tabs switching)
- [x] 19-03: Touch targets and input fixes (pull-to-refresh, message-input safe-area)

**Details:**
- Bottom tab bar visible on mobile (Home, DMs, Mentions, Search, Profile)
- Layout adapts correctly to phone screen sizes
- All interactive elements meet 44px minimum touch target
- Pull-to-refresh reloads current view
- Virtual keyboard doesn't break input positioning

### Phase 20: UI Polish

**Goal**: Complete remaining UI gaps and documentation
**Depends on**: Phase 19
**Plans**: 3 plans

Plans:
- [x] 20-01: HSTS security and logout button (config update, sidebar integration)
- [x] 20-02: USER-SETUP.md documentation (deployment, config, maintenance)
- [x] 20-03: Admin UI (audit log viewer, data export, settings navigation)

**Details:**
- Sidebar shows navigation links to /threads and /search pages
- Logout button visible and functional in layout
- Admin can view audit logs with filtering and export
- Admin can export organization data as JSON/CSV
- USER-SETUP.md provides complete setup instructions
- HSTS max-age set to 31536000 (1 year) for production

---

## Milestone Summary

**Key Decisions:**

- Serwist for service worker (maintained Workbox fork, Next.js App Router support)
- Dexie.js for IndexedDB (React hooks, TypeScript support, compound indexes)
- 7-day cache retention (matches Safari ITP policy)
- VAPID keys in environment (generated once, stored securely)
- Double-permission pattern for push (in-app prompt before browser permission)
- dvh units for mobile layout (accounts for browser chrome and virtual keyboards)
- Engagement-based prompts (3 pages OR 30 seconds)
- Fail-closed middleware (redirect to login on validation errors)
- Atomic message sequences (SQL COALESCE subquery with retry on 23505)
- 10 msg/60s rate limiting (balance UX with spam prevention)

**Issues Resolved:**

- @mention autocomplete leaking users from other organizations
- Race condition in message sequence numbers
- Middleware passing invalid sessions through
- Synchronous audit logging blocking requests

**Issues Deferred:**

- useIsMobile hook exported but unused (CSS breakpoints used instead)

**Technical Debt Incurred:**

- Minor: useIsMobile hook available for future use if needed

---

_For current project status, see .planning/ROADMAP.md (will be deleted for next milestone)_

---
*Archived: 2026-01-19 as part of v0.3.0 milestone completion*
